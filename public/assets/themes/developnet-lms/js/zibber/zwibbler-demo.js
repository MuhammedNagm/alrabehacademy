/**
   Zwibbler

   Copyright 2019 Hanov Solutions Inc. All Rights Reserved. This software is
   NOT open source. For licensing information, contact the author.

   steve.hanov@gmail.com

   @license
 */
(function(){var aa="function"==typeof Object.defineProperties?Object.defineProperty:function(c,a,b){c!=Array.prototype&&c!=Object.prototype&&(c[a]=b.value)},ba="undefined"!=typeof window&&window===this?this:"undefined"!=typeof global&&null!=global?global:this;function ca(c,a){if(a){for(var b=ba,d=c.split("."),e=0;e<d.length-1;e++){var f=d[e];f in b||(b[f]={});b=b[f]}d=d[d.length-1];e=b[d];f=a(e);f!=e&&null!=f&&aa(b,d,{configurable:!0,writable:!0,value:f})}}var da;
if("function"==typeof Object.setPrototypeOf)da=Object.setPrototypeOf;else{var ea;a:{var fa={qp:!0},ha={};try{ha.__proto__=fa;ea=ha.qp;break a}catch(c){}ea=!1}da=ea?function(c,a){c.__proto__=a;if(c.__proto__!==a)throw new TypeError(c+" is not extensible");return c}:null}var ia=da;ca("Object.setPrototypeOf",function(c){return c||ia});function ja(){ja=function(){};ba.Symbol||(ba.Symbol=ka)}var ka=function(){var c=0;return function(a){return"jscomp_symbol_"+(a||"")+c++}}();
function ma(){ja();var c=ba.Symbol.iterator;c||(c=ba.Symbol.iterator=ba.Symbol("iterator"));"function"!=typeof Array.prototype[c]&&aa(Array.prototype,c,{configurable:!0,writable:!0,value:function(){return na(this)}});ma=function(){}}function na(c){var a=0;return oa(function(){return a<c.length?{done:!1,value:c[a++]}:{done:!0}})}function oa(c){ma();c={next:c};c[ba.Symbol.iterator]=function(){return this};return c}
function pa(c,a){ma();c instanceof String&&(c+="");var b=0,d={next:function(){if(b<c.length){var e=b++;return{value:a(e,c[e]),done:!1}}d.next=function(){return{done:!0,value:void 0}};return d.next()}};d[Symbol.iterator]=function(){return d};return d}ca("Array.prototype.values",function(c){return c?c:function(){return pa(this,function(a,b){return b})}});
ca("Array.prototype.fill",function(c){return c?c:function(a,b,d){var e=this.length||0;0>b&&(b=Math.max(0,e+b));if(null==d||d>e)d=e;d=Number(d);0>d&&(d=Math.max(0,e+d));for(b=Number(b||0);b<d;b++)this[b]=a;return this}});ca("Array.prototype.keys",function(c){return c?c:function(){return pa(this,function(a){return a})}});
var n=function(){var c=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(a,b){a.__proto__=b}||function(a,b){for(var d in b)b.hasOwnProperty(d)&&(a[d]=b[d])};return function(a,b){function d(){this.constructor=a}c(a,b);a.prototype=null===b?Object.create(b):(d.prototype=b.prototype,new d)}}();function qa(c){for(var a="",b,d,e,f,g,h,k=0;k<c.length;)b=c.charCodeAt(k++),d=c.charCodeAt(k++),e=c.charCodeAt(k++),f=b>>2,b=(b&3)<<4|d>>4,g=(d&15)<<2|e>>6,h=e&63,isNaN(d)?g=h=64:isNaN(e)&&(h=64),a=a+"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".charAt(f)+"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".charAt(b)+"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".charAt(g)+"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".charAt(h);
return a};var sa=function(){function c(a,b,d){void 0===d&&(d="");this.name=a;this.attributes=b;this.text=d;this.children=[]}c.prototype.toString=function(){var a=[];this.nm(a,"");a=a.join("");for(var b="",d=0;d<a.length;d++){var e=a.charCodeAt(d);128>e?b+=String.fromCharCode(e):(127<e&&2048>e?b+=String.fromCharCode(e>>6|192):(b+=String.fromCharCode(e>>12|224),b+=String.fromCharCode(e>>6&63|128)),b+=String.fromCharCode(e&63|128))}return b};c.prototype.nm=function(a,b){var d;if(this.hasAttributes()||0!==this.children.length){a.push(b);
a.push("<");a.push(this.name);for(d in this.attributes)this.attributes.hasOwnProperty(d)&&(a.push(" "),a.push(d),void 0!==this.attributes[d]&&null!==this.attributes[d]&&(a.push('="'),a.push(this.dm(""+this.attributes[d])),a.push('"')));if(this.children.length||""!==this.text){a.push(">\n");for(d=0;d<this.children.length;d++)this.children[d].nm(a,b+"  ");""!==this.text&&a.push(b+"  "+this.dm(this.text));a.push(b+"</"+this.name+">")}else a.push("/>");a.push("\n")}};c.prototype.hasAttributes=function(){for(var a in this.attributes)if(this.attributes.hasOwnProperty(a))return!0;
return!1};c.prototype.Qi=function(a){for(var b in a)a.hasOwnProperty(b)&&(this.attributes[b]=a[b])};c.prototype.pd=function(a){this.children.push(a)};c.prototype.dm=function(a){return(""+a).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")};return c}();var u=function(){function c(a,b){this.type=a;this.values=b}c.bi=function(a){a.toLowerCase()in c.Ml&&(a=c.Ml[a.toLowerCase()]);var b=/#([0-9a-f])([0-9a-f])([0-9a-f])/i,d=/rgb\( *([0-9]+) *, *([0-9]+) *, *([0-9]+) *\)/,e=/rgba\( *([0-9]+) *, *([0-9]+) *, *([0-9]+) *, *([0-9\.]+) *\)/;var f=/#([0-9a-f][0-9a-f])([0-9a-f][0-9a-f])([0-9a-f][0-9a-f])/i.exec(a);if(null!==f)a=parseInt(f[1],16)/255,b=parseInt(f[2],16)/255,d=parseInt(f[3],16)/255,f=1;else if(f=e.exec(a),null!==f)a=parseFloat(f[1])/255,b=parseFloat(f[2])/
255,d=parseFloat(f[3])/255,f=parseFloat(f[4]);else if(f=d.exec(a),null!==f)a=parseFloat(f[1])/255,b=parseFloat(f[2])/255,d=parseFloat(f[3])/255,f=1;else if(f=b.exec(a),null!==f)a=parseInt(f[1],16),a=(16*a+a)/255,b=parseInt(f[2],16),b=(16*b+b)/255,d=parseInt(f[2],16),d=(16*d+d)/255,f=1;else return null;return new c(c.RGBA,[a,b,d,f])};c.td=function(a){return c.bi(a)||new c(c.RGBA,[1,0,1,1])};c.us=function(a){var b=/#[0-9a-f]+|rgba?\([^\)]+\)|[a-z]+/gi,d=[],e;do(e=b.exec(a))&&d.push(e[0]);while(e);return d};
c.prototype.toString=function(){function a(a){a=Math.round(255*a);return 16>a?"0"+a.toString(16):a.toString(16)}var b=this.Mh(c.RGBA);return 1===b.values[3]?"#"+a(b.values[0])+a(b.values[1])+a(b.values[2]):"rgba("+Math.round(255*b.values[0])+","+Math.round(255*b.values[1])+","+Math.round(255*b.values[2])+","+b.values[3]+")"};c.prototype.Mh=function(a){return c.$p[this.type][a](this)};c.prototype.vb=function(a){a.type!==this.type&&(a=a.Mh(this.type));if(this.type===c.oe){var b=this.values[0],d=a.values[0];
b=b>d?Math.min(b-d,d-b+360):Math.min(d-b,b-d+360);b/=360;return Math.pow(b*b+(this.values[1]-a.values[1])*(this.values[1]-a.values[1])+(this.values[2]-a.values[2])*(this.values[2]-a.values[2]),.5)}return Math.pow((this.values[0]-a.values[0])*(this.values[0]-a.values[0])+(this.values[1]-a.values[1])*(this.values[1]-a.values[1])+(this.values[2]-a.values[2])*(this.values[2]-a.values[2]),.5)};c.RGBA=0;c.Xl=1;c.oe=2;c.Yo=3;c.eu=3;c.$p=[[ta,ua,va,wa],[ya,ta,za,Aa],[Ba,Ca,ta,Ea],[Fa,Ga,Ha,ta]];c.Ml={aliceblue:"#f0f8ff",
antiquewhite:"#faebd7",aqua:"#00ffff",aquamarine:"#7fffd4",azure:"#f0ffff",beige:"#f5f5dc",bisque:"#ffe4c4",black:"#000000",blanchedalmond:"#ffebcd",blue:"#0000ff",blueviolet:"#8a2be2",brown:"#a52a2a",burlywood:"#deb887",cadetblue:"#5f9ea0",chartreuse:"#7fff00",chocolate:"#d2691e",coral:"#ff7f50",cornflowerblue:"#6495ed",cornsilk:"#fff8dc",crimson:"#dc143c",cyan:"#00ffff",darkblue:"#00008b",darkcyan:"#008b8b",darkgoldenrod:"#b8860b",darkgray:"#a9a9a9",darkgreen:"#006400",darkkhaki:"#bdb76b",darkmagenta:"#8b008b",
darkolivegreen:"#556b2f",darkorange:"#ff8c00",darkorchid:"#9932cc",darkred:"#8b0000",darksalmon:"#e9967a",darkseagreen:"#8fbc8f",darkslateblue:"#483d8b",darkslategray:"#2f4f4f",darkturquoise:"#00ced1",darkviolet:"#9400d3",deeppink:"#ff1493",deepskyblue:"#00bfff",dimgray:"#696969",dodgerblue:"#1e90ff",firebrick:"#b22222",floralwhite:"#fffaf0",forestgreen:"#228b22",fuchsia:"#ff00ff",gainsboro:"#dcdcdc",ghostwhite:"#f8f8ff",gold:"#ffd700",goldenrod:"#daa520",gray:"#808080",green:"#008000",greenyellow:"#adff2f",
honeydew:"#f0fff0",hotpink:"#ff69b4",indianred:"#cd5c5c",indigo:"#4b0082",ivory:"#fffff0",khaki:"#f0e68c",lavender:"#e6e6fa",lavenderblush:"#fff0f5",lawngreen:"#7cfc00",lemonchiffon:"#fffacd",lightblue:"#add8e6",lightcoral:"#f08080",lightcyan:"#e0ffff",lightgoldenrodyellow:"#fafad2",lightgreen:"#90ee90",lightgrey:"#d3d3d3",lightpink:"#ffb6c1",lightsalmon:"#ffa07a",lightseagreen:"#20b2aa",lightskyblue:"#87cefa",lightslategray:"#778899",lightsteelblue:"#b0c4de",lightyellow:"#ffffe0",lime:"#00ff00",
limegreen:"#32cd32",linen:"#faf0e6",magenta:"#ff00ff",maroon:"#800000",mediumaquamarine:"#66cdaa",mediumblue:"#0000cd",mediumorchid:"#ba55d3",mediumpurple:"#9370d8",mediumseagreen:"#3cb371",mediumslateblue:"#7b68ee",mediumspringgreen:"#00fa9a",mediumturquoise:"#48d1cc",mediumvioletred:"#c71585",midnightblue:"#191970",mintcream:"#f5fffa",mistyrose:"#ffe4e1",moccasin:"#ffe4b5",navajowhite:"#ffdead",navy:"#000080",oldlace:"#fdf5e6",olive:"#808000",olivedrab:"#6b8e23",orange:"#ffa500",orangered:"#ff4500",
orchid:"#da70d6",palegoldenrod:"#eee8aa",palegreen:"#98fb98",paleturquoise:"#afeeee",palevioletred:"#d87093",papayawhip:"#ffefd5",peachpuff:"#ffdab9",peru:"#cd853f",pink:"#ffc0cb",plum:"#dda0dd",powderblue:"#b0e0e6",purple:"#800080",red:"#ff0000",rosybrown:"#bc8f8f",royalblue:"#4169e1",saddlebrown:"#8b4513",salmon:"#fa8072",sandybrown:"#f4a460",seagreen:"#2e8b57",seashell:"#fff5ee",sienna:"#a0522d",silver:"#c0c0c0",skyblue:"#87ceeb",slateblue:"#6a5acd",slategray:"#708090",snow:"#fffafa",springgreen:"#00ff7f",
steelblue:"#4682b4",tan:"#d2b48c",teal:"#008080",thistle:"#d8bfd8",tomato:"#ff6347",transparent:"rgba(0,0,0,0.0)",turquoise:"#40e0d0",violet:"#ee82ee",wheat:"#f5deb3",white:"#ffffff",whitesmoke:"#f5f5f5",yellow:"#ffff00",yellowgreen:"#9acd32"};return c}(),Ia=.9505,Ja=1,Ka=1.089;
function Ba(c){var a=c.values[0],b=c.values[1],d=c.values[2];0>a&&(a+=360);var e=a/60-Math.floor(a/60),f=d*(1-b),g=d*(1-e*b);b=d*(1-(1-e)*b);var h=e=0,k=0;switch(Math.floor(a/60)%6){case 0:e=d;h=b;k=f;break;case 1:e=g;h=d;k=f;break;case 2:e=f;h=d;k=b;break;case 3:e=f;h=g;k=d;break;case 4:e=b;h=f;k=d;break;case 5:e=d,h=f,k=g}return new u(u.RGBA,[e,h,k,c.values[3]])}
function va(c){var a=c.values[0],b=c.values[1],d=c.values[2],e=Math.max(a,b,d),f=Math.min(a,b,d);return new u(u.oe,[e===f?0:e===a?(60*(b-d)/(e-f)+360)%360:e===b?60*(d-a)/(e-f)+120:60*(a-b)/(e-f)+240,0===e?0:1-f/e,e,c.values[3]])}function Aa(c){function a(a){return a>6/29*(6/29)*(6/29)?Math.pow(a,1/3):1/3*(29/6)*(29/6)*a+4/29}var b=a(c.values[1]/Ja);return new u(u.Yo,[116*b-16,500*(a(c.values[0]/Ia)-b),200*(b-a(c.values[2]/Ka)),c.values[3]])}
function Ga(c){var a=(c.values[0]+16)/116,b=a+c.values[1]/500,d=a-c.values[2]/200,e=6/29;return new u(u.Xl,[b>e?Ia*b*b*b:3*(b-16/116)*e*e*Ia,a>e?Ja*a*a*a:3*(a-16/116)*e*e*Ja,d>e?Ka*d*d*d:3*(d-16/116)*e*e*Ka,c.values[3]])}function ua(c){for(var a=[],b=0;3>b;b++)a[b]=.04045>=c.values[b]?c.values[b]/12.92:Math.pow((c.values[b]+.055)/1.055,2.4);return new u(u.Xl,[.4124*a[0]+.3576*a[1]+.1805*a[2],.2126*a[0]+.7152*a[1]+.0722*a[2],.0193*a[0]+.1192*a[1]+.9505*a[2],c.values[3]])}
function ya(c){var a=[],b=[0,0,0,0];a[0]=3.241*c.values[0]-1.5374*c.values[1]-.4986*c.values[2];a[1]=-.9692*c.values[0]+1.876*c.values[1]+.0416*c.values[2];a[2]=.0556*c.values[0]-.204*c.values[1]+1.057*c.values[2];for(var d=0;3>d;d++)b[d]=.0031308>=a[d]?12.92*a[d]:1.055*Math.pow(a[d],1/2.4)-.055;b[3]=c.values[3];return new u(u.RGBA,b)}function ta(c){return new u(c.type,c.values.concat())}function wa(c){return Aa(ua(c))}function Fa(c){return ya(Ga(c))}function za(c){return va(ya(c))}
function Ca(c){return ua(Ba(c))}function Ea(c){return wa(Ba(c))}function Ha(c){return za(Ga(c))};var w=new (function(){function c(){this.disabled={};this.Ig=[];this.Wp=!1}c.prototype.enable=function(a,b){void 0===b&&(b=!0);this.disabled[a]=!b};c.prototype.create=function(a,b){void 0===b&&(b=!0);!1===b&&(this.disabled[a]=!0);var d=this;return function(){for(var b=0;b<arguments.length;b++);d.Sr(a,arguments)}};c.prototype.addListener=function(a){this.Ig.push(a);return a};c.prototype.removeListener=function(a){for(var b=0;b<this.Ig.length;b++)if(this.Ig[b]===a){this.Ig.splice(b,1);break}};c.prototype.tq=
function(){this.Wp||this.addListener(function(a,b){console.log(a+": "+b)})};c.prototype.Sr=function(a,b){var d=[],e;if(!this.disabled[a]){var c=b[0].split("%s");d.push(c[0]);for(e=1;e<c.length;e++)e-1>=b.length-1?d.push("<too few args>"):"string"===typeof b[e]||"number"===typeof b[e]?d.push(b[e]):void 0===b[e]?d.push("(undefined)"):null===b[e]?d.push("(null)"):b[e]instanceof Object&&b[e].toString instanceof Function?d.push(b[e].toString()):d.push(JSON.stringify(b[e])),d.push(c[e]);d=d.join("");e=
0;for(c=this.Ig;e<c.length;e++)(0,c[e])(a,d)}};return c}());var La=function(){function c(a){this.code="en";this.data={};this.log=w.create("LANGUAGE");this.data=this.$n(a,{})}c.prototype.xo=function(a){a=a.split(",");this.log("Choice of languages: %s",a);for(var b=0;b<a.length;b++){var d=a[b].split("-")[0];if(d in this.data){this.log("Using language code %s",d);this.code=d;break}else this.log("No language for code %s",d)}};c.prototype.yj=function(a){this.$n(a,this.data)};c.prototype.$n=function(a,b){for(var d=a.split("\n"),e=/^([ \t]*)([^:]+):([^:]+):(.*)/,
c=0;c<d.length;c++){var g=e.exec(d[c]);if(g){var h=g[2],k=g[3];g=g[4];h in b||(b[h]={});k in b[h]&&this.log("Warning: Replacing %s:%s",h,k);b[h][k]=g}}return b};c.prototype.fn=function(){var a=this;return function(b){for(var d=[],e=1;e<arguments.length;e++)d[e-1]=arguments[e];return a.fm(b,d)}};c.prototype.get=function(a){for(var b=[],d=1;d<arguments.length;d++)b[d-1]=arguments[d];return this.fm(a,b)};c.prototype.fm=function(a,b){var d="<not translated:"+a+">";this.code in this.data&&a in this.data[this.code]&&
(d=this.data[this.code][a]);for(var e=0;e<b.length;e++)d=d.replace("^"+e,b[e]);return d};return c}();function Ma(c,a){function b(a){for(var b=a.changedTouches,d=0;d<b.length;d++){var e;a:{var c=b[d],f=-1;if("identifier"in c)for(e=0;e<k.length;e++){if(c.identifier===k[e].identifier)break a}else{var l=0;for(e=0;e<k.length;e++){var m=k[e].jq(c);if(-1===f||m<l)f=e,l=m}}e=f}-1===e?"touchend"!==a.type&&(k.push(new h(b[d])),g("New touch %s",b[d].identifier)):"touchend"!==a.type?(k[e].pageX=b[d].pageX,k[e].pageY=b[d].pageY):(g("Remove touch %s",b[d].identifier),k.splice(e,1))}}function d(){for(var a=0,b=
0,d=0;d<k.length;d++)g("Active touch: %s,%s",k[d].pageX,k[d].pageY),a+=k[d].pageX,b+=k[d].pageY;return{x:a/k.length,y:b/k.length}}function e(a,b){for(var d=0,e=0;e<k.length;e++){var c=k[e];d+=Math.sqrt((c.pageX-a)*(c.pageX-a)+(c.pageY-b)*(c.pageY-b))}return d/k.length}function f(a,b){a.preventDefault=function(){b.preventDefault()};a.stopPropagation=function(){b.stopPropagation()};return a}var g=w.create("GESTURES");if(c.su)c.addEventListener("gesture",a,!1),g("No emulation needed");else{var h=function(){function a(a){this.eh=
a.pageX;this.fh=a.pageY;this.pageX=a.pageX;this.pageY=a.pageY;this.identifier=a.identifier}a.prototype.jq=function(a){return Math.sqrt((this.pageX-a.pageX)*(this.pageX-a.pageX)+(this.pageY-a.pageY)*(this.pageY-a.pageY))};return a}(),k=[],l=!1,m=1,q=0,p,t;c.addEventListener("touchstart",function(c){b(c);g("touchend; inGesture=%s active.length=%s",l,k.length);2<=k.length&&!l&&(l=!0,t=d(),p=e(t.x,t.y),m=1,q=0,a(f({type:"gesturestart",pageX:t.x,pageY:t.y,scale:m,rotation:q},c)))});c.addEventListener("touchmove",
function(c){b(c);if(2<=k.length){t=d();m=e(t.x,t.y)/p;for(var g=t.x,h=t.y,l=0,r=0;r<k.length;r++)l+=Math.atan2(k[r].pageY-h,k[r].pageX-g)-Math.atan2(k[r].fh-h,k[r].eh-g);q=l/k.length/Math.PI*180;a(f({type:"gesturechange",pageX:t.x,pageY:t.y,scale:m,rotation:q},c))}});c.addEventListener("touchend",function(d){b(d);g("touchend; inGesture=%s active.length=%s",l,k.length);l&&2>k.length&&(l=!1,a(f({type:"gestureend",pageX:t.x,pageY:t.y,scale:m,rotation:q},d)))})}};var Na=function(){function c(a){this.next=a}c.prototype.Po=function(a){for(var b=0;b<a.length;b++)this.Ab(a.charCodeAt(b))};c.prototype.Ab=function(a){this.next.Ab(a)};c.prototype.flush=function(){this.next.flush()};c.prototype.Df=function(){return this.next.Df()};return c}(),Oa=function(){function c(){this.data="";this.log=w.create("BYTESTREAM")}c.prototype.Po=function(a){for(var b=0;b<a.length;b++)this.Ab(a.charCodeAt(b))};c.prototype.Df=function(){return this};c.prototype.Ab=function(a){if(255<
a||0>a)throw"Bad data written to byte buffer";this.data+=String.fromCharCode(a)};c.prototype.flush=function(){};c.prototype.toString=function(){return this.data};c.prototype.Sb=function(){for(var a=[],b=0;b<this.data.length;b++)a.push(this.data.charCodeAt(b));return a};c.ap=function(a){c.Pl.LZWEncoder=a};c.fg=function(a){var b=new c;a=a.split(",");a.reverse();for(var d=0;d<a.length;d++){var e=a[d];e.length&&(b=c.Pl[e](b))}return b};c.Pl={};return c}();function Pa(){}var Sa=setTimeout,Ta=[],Ua=!1;function Va(){for(var c=0;c<Ta.length;c++)Ta[c][0](Ta[c][1]);Ta=[];Ua=!1}function Wa(c,a){Ta.push([c,a]);Ua||(Ua=!0,Sa(Va,0))}function Xa(c,a){function b(b){Ya(a,b)}function d(b){Za(a,b)}try{c(b,d)}catch(e){d(e)}}function $a(c){var a=c.qs,b=a.Kd;a=a.Oj;var d=c.ll[b];c=c.then;if("function"===typeof d){b="fulfilled";try{a=d(a)}catch(e){Za(c,e)}}ab(c,a)||("fulfilled"===b&&Ya(c,a),"rejected"===b&&Za(c,a))}
function ab(c,a){var b=!1;try{if(c===a)throw new TypeError("A promises callback cannot return that same promise.");if(a&&("function"===typeof a||"object"===typeof a)){var d=a.then;if("function"===typeof d)return d.call(a,function(d){b||(b=!0,a!==d?Ya(c,d):bb(c,d))},function(a){b||(b=!0,Za(c,a))}),!0}}catch(e){return b||Za(c,e),!0}return!1}function Ya(c,a){c!==a&&ab(c,a)||bb(c,a)}function bb(c,a){"pending"===c.Kd&&(c.Kd="sealed",c.Oj=a,Wa(cb,c))}
function Za(c,a){"pending"===c.Kd&&(c.Kd="sealed",c.Oj=a,Wa(db,c))}function eb(c){var a=c.ol;c.ol=[];for(c=0;c<a.length;c++)$a(a[c])}function cb(c){c.Kd="fulfilled";eb(c)}function db(c){c.Kd="rejected";eb(c)}
var ib=function(){function c(a){this.Kd="pending";this.Oj=void 0;this.ol=[];Xa(a,this)}c.prototype.then=function(a,b){var d={qs:this,then:new c(Pa),ll:{}};d.ll.fulfilled=a;d.ll.rejected=b;"fulfilled"===this.Kd||"rejected"===this.Kd?Wa($a,d):this.ol.push(d);return d.then};c.prototype["catch"]=function(a){return this.then(null,a)};c.resolve=function(a){return a&&"object"===typeof a&&a.constructor===this?a:new this(function(b){b(a)})};c.reject=function(a){return new this(function(b,d){d(a)})};return c}();
ib.prototype.then=ib.prototype.then;var jb=function(){function c(a){this.Ga=a}c.prototype.Gc=function(a){for(var b in a){if(0<=b.indexOf("-"))throw Error("setStyle: styles must be camelcase; not "+b);this.Ga.style[b]=""+a[b]}return this};c.prototype.Qi=function(a){for(var b in a)this.Ga.setAttribute(b,a[b]);return this};c.prototype.Qd=function(a){a.appendChild(this.Ga);return this};c.prototype.pk=function(a){a.parentNode&&a.parentNode.insertBefore(this.Ga,a.nextSibling)};c.prototype.remove=function(){this.Ga.parentNode&&this.Ga.parentNode.removeChild(this.Ga);
return this};c.prototype.Le=function(a){return window.getComputedStyle(this.Ga)[a]||""};c.prototype.dc=function(){var a=this.Ga.getBoundingClientRect();return{top:a.top+window.pageYOffset,left:a.left+window.pageXOffset}};c.prototype.Si=function(a){var b=(b=this.tr())?b.dc():{left:0,top:0};this.Ga.style.left=a.left-b.left+"px";this.Ga.style.top=a.top-b.top+"px"};c.prototype.tr=function(){if(!(this.Ga instanceof HTMLElement)||"fixed"===this.Le("position"))return z(document.body);for(var a=this.Ga.parentElement;a&&
"static"===z(a).Le("position");)a=a.parentElement;return a?z(a):null};c.prototype.se=function(a){this.Ga.classList.add(a);return this};c.prototype.sl=function(a,b){b?this.Ga.classList.add(a):this.Ga.classList.remove(a)};c.prototype.addEventListener=function(a,b){for(var d=0,e=a.split(" ");d<e.length;d++)this.Ga.addEventListener(e[d],b);return this};c.prototype.matches=function(a){if(this.Ga.matches)return this.Ga.matches(a);var b=0;for(a=a.split(",");b<a.length;b++){var d=a[b];d=d.trim();if(0!=d.length)return"["==
d[0]?this.Ga.hasAttribute(d.substr(1,d.length-2)):this.Ga.tagName===d.toUpperCase()}return!1};return c}();function z(c){if("string"===typeof c){if("<"==c[0]){var a=document.createElement("div");a.innerHTML=c;c=[];for(a=a.firstChild;a;)a instanceof HTMLElement&&c.push(a),a=a.nextSibling;return new jb(c[0])}return new jb(document.createElement(c))}return new jb(c)}
function kb(c){return new ib(function(a,b){var d=new XMLHttpRequest;c.mimeType&&d.overrideMimeType(c.mimeType);c.withCredentials&&(d.withCredentials=!0);var e=c.method||"GET",f=c.ts||{},g=c.url,h="",k=!0,l;for(l in f)k||(h+="&"),k=!1,h+=l+"="+encodeURIComponent(f[l]);"GET"===e&&0<h.length&&(g+="?"+h,h="");d.onreadystatechange=function(){if(4===d.readyState)if(200===d.status)a(d);else{var e=d.statusText;0===d.status?e="Could not contact server.":d.getResponseHeader("status")&&(e=d.getResponseHeader("status"));
b(Error(d.status+" "+e))}};d.open(e,g,!0);"string"===typeof c.data&&(h=c.data);c.contentType?d.setRequestHeader("Content-type","application/json"):"POST"===e&&d.setRequestHeader("Content-Type","application/x-www-form-urlencoded");c.hq?setTimeout(function(){d.send(h)},c.hq):d.send(h)})}var lb=[],mb=null;
function nb(c){for(var a=0;a<lb.length;a++)if(lb[a]===c)return;lb.push(c);mb||(mb=document.createElement("style"),document.head&&document.head.insertBefore(mb,document.head.firstChild));mb.appendChild(document.createTextNode(c))};var ob=w.create("MISC");function pb(c){return"jQuery"in window&&c instanceof window.jQuery?c[0]:c instanceof HTMLElement?c:"string"===typeof c?document.querySelector(c):null}function qb(c){var a=document.createElement("canvas");c&&c.appendChild(a);a.style.background="transparent";return a}function rb(){return(new Date).getTime()}var sb=/MSIE ([0-9]{1,}[\.0-9]{0,})/,tb=0,ub=!1;
function vb(){if(ub)var c=tb;else{c=-1;if("Microsoft Internet Explorer"===navigator.appName){var a=sb.exec(navigator.userAgent);null!==a&&(c=parseFloat(a[1]))}tb=c;ub=!0;ob("IE version is %s",c)}return 0<=c&&9>c}function wb(){for(var c=document.getElementsByTagName("*"),a=0,b=0;b<c.length;b++){var d=parseInt(z(c[b]).Le("z-index"),10)||0;d>a&&(a=d)}return a}
function xb(){if(null===yb){var c=document.createElement("div");c.style.visibility="hidden";c.style.width="100px";document.body.appendChild(c);var a=c.offsetWidth;c.style.overflow="scroll";var b=document.createElement("div");b.style.width="100%";c.appendChild(b);b=b.offsetWidth;c.parentNode.removeChild(c);yb=a-b;ob("ScrollbarWidth calculated as %spx",yb)}return yb}var yb=0;function zb(c,a){var b=u.td(c);b.values[3]=a;return b.toString()}
function Ab(c){var a=atob(c.split(",")[1]);c=c.split(",")[0].split(":")[1].split(";")[0];for(var b=new ArrayBuffer(a.length),d=new Uint8Array(b),e=0;e<a.length;e++)d[e]=a.charCodeAt(e);return new Blob([b],{type:c})}
function Bb(){var c=document.documentElement,a=c.scrollWidth>c.clientWidth;c=c.scrollHeight>c.clientHeight?xb():0;a=a?xb():0;return{width:window.innerWidth-c,height:window.innerHeight-a,x:document.documentElement.scrollLeft||document.body.scrollLeft,y:document.documentElement.scrollTop||document.body.scrollTop}}function Cb(c){var a=Bb(),b=z(c).dc();b.left=Math.min(b.left,a.x+a.width-c.offsetWidth);b.top=Math.min(b.top,a.y+a.height-c.offsetHeight);z(c).Si(b)}
function Db(c){var a=c.getContext("2d");if(null===a)return"error";var b=a.getImageData(0,0,c.width,c.height);c=b.width;var d=b.height;a=c*d*3;var e=a+54,f=[66,77,e&255,e>>8&255,e>>16&255,e>>24&255,0,0,0,0,54,0,0,0],g=[40,0,0,0,c&255,c>>8&255,c>>16&255,c>>24&255,d&255,d>>8&255,d>>16&255,d>>24&255,1,0,24,0,0,0,0,0,a&255,a>>8&255,a>>16&255,a>>24&255,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];a=(4-3*c%4)%4;b=b.data;e=c<<2;for(var h=Oa.fg("Base64Encoder"),k=0;k<f.length;k++)h.Ab(f[k]);for(k=0;k<g.length;k++)h.Ab(g[k]);
do{f=e*(d-1);for(g=0;g<c;g++)k=g<<2,h.Ab(b[f+k+2]),h.Ab(b[f+k+1]),h.Ab(b[f+k]);for(f=0;f<a;f++)h.Ab(0)}while(--d);h.flush();return"data:image/bmp;base64,"+h.Df().toString()}
function Eb(c,a){"erase"===a?c.sf?(c.strokeStyle="#000000",c.globalCompositeOperation="destination-out",--c.lineWidth,c.stroke(),c.globalCompositeOperation="source-over",c.strokeStyle=c.sf,c.lineWidth+=2,c.stroke(),--c.lineWidth):(c.strokeStyle="#000000",c.globalCompositeOperation="destination-out",c.stroke(),c.globalCompositeOperation="source-over"):(c.strokeStyle=a,c.stroke())}
function Fb(){for(var c=0;c<arguments.length;c++);c=arguments[0];for(var a=1;a<arguments.length;a++){var b=arguments[a],d;for(d in b)b.hasOwnProperty(d)&&(c[d]=b[d])}return c};var Gb=function(){function c(a,b,d,e,c){void 0===a&&(a="transparent");void 0===b&&(b=0);void 0===d&&(d=0);void 0===e&&(e=0);void 0===c&&(c=0);this.ze=a;this.left=b;this.top=d;this.right=e;this.bottom=c;this.zIndex=1;this.insertBefore=null;this.sa=document.createElement("div")}c.prototype.Zd=function(){this.sa&&z(this.sa).remove()};c.prototype.show=function(a){z(this.sa).Gc({position:"fixed",background:this.ze,opacity:.25,left:this.left+"px",top:this.top+"px",right:this.right+"px",bottom:this.bottom+
"px",display:"block"});this.sa.addEventListener("click",a);this.sa.style.zIndex=this.zIndex.toString();this.insertBefore?this.insertBefore.parentNode&&this.insertBefore.parentNode.insertBefore(this.sa,this.insertBefore):document.body.appendChild(this.sa)};return c}();var Hb=w.create("Graphics",!0),A=function(){function c(a,b){this.x=a;this.y=b}c.prototype.vb=function(a){return Math.sqrt((a.x-this.x)*(a.x-this.x)+(a.y-this.y)*(a.y-this.y))};c.prototype.toString=function(){return"("+this.x+", "+this.y+")"};c.prototype.sd=function(a){return this.x===a.x&&this.y===a.y};c.prototype.clone=function(){return new c(this.x,this.y)};c.prototype.kq=function(a,b){var d=a.x,e=a.y,c=this.x,g=this.y,h=b.x-d,k=b.y-e,l=h*h+k*k;if(0===l)return this.vb(a);l=((c-d)*h+(g-e)*k)/l;1<
l?l=1:0>l&&(l=0);d=d+l*h-c;e=e+l*k-g;return Math.sqrt(d*d+e*e)};return c}();function Ib(c,a){this.width=c;this.height=a}function B(c,a,b,d){return Math.sqrt((c-b)*(c-b)+(a-d)*(a-d))}function C(c,a,b,d){var e=B(c,a,b,d);return 0===e?{x:1,y:0}:{x:(b-c)/e,y:(d-a)/e}}function Jb(c){c.x*=-1;c.y*=-1;return c}
var D=function(){function c(a,b,d,e){this.x=a;this.y=b;this.width=d;this.height=e;this.ko()}c.load=function(a){return new c(a.x,a.y,a.width,a.height)};c.gg=function(a){if(0===a.length)return new c(0,0,0,0);for(var b=a[0].x,d=a[0].x,e=a[0].y,f=a[0].y,g=1;g<a.length;g++)a[g].x<b&&(b=a[g].x),a[g].x>d&&(d=a[g].x),a[g].y<e&&(e=a[g].y),a[g].y>f&&(f=a[g].y);return new c(b,e,d-b,f-e)};c.prototype.save=function(){return{x:this.x,y:this.y,width:this.width,height:this.height}};c.prototype.clone=function(){return new c(this.x,
this.y,this.width,this.height)};c.prototype.sd=function(a){return this.x===a.x&&this.y===a.y&&this.width===a.width&&this.height===a.height};c.prototype.nh=function(a){a.x<this.x&&(this.width+=this.x-a.x,this.x=a.x);a.y<this.y&&(this.height+=this.y-a.y,this.y=a.y);a.x+a.width>this.x+this.width&&(this.width+=a.x+a.width-this.x-this.width);a.y+a.height>this.y+this.height&&(this.height+=a.y+a.height-this.y-this.height)};c.prototype.xl=function(a,b){a<this.x?(this.width+=this.x-a,this.x=a):a>this.x+this.width&&
(this.width=a-this.x);b<this.y?(this.height+=this.y-b,this.y=b):b>this.y+this.height&&(this.height=b-this.y)};c.prototype.contains=function(a){return this.x<=a.x&&this.x+this.width>a.x+a.width&&this.y<=a.y&&this.y+this.height>a.y+a.height};c.prototype.Wc=function(a,b,d){void 0===d&&(d=0);return this.x-d<=a&&this.x+this.width+d>a&&this.y-d<=b&&this.y+this.height+d>b};c.prototype.ko=function(){0>this.width&&(this.x+=this.width,this.width=-this.width);0>this.height&&(this.y+=this.height,this.height=
-this.height)};c.prototype.ed=function(a,b){void 0===b&&(b=a);this.x-=a/2;this.y-=b/2;this.width+=a;this.height+=b};c.prototype.transform=function(a){var b=a.apply(this.x,this.y);var d=a.apply(this.x+this.width,this.y);var e=a.apply(this.x+this.width,this.y+this.height);a=a.apply(this.x,this.y+this.height);this.x=Math.min(b.x,d.x,e.x,a.x);this.y=Math.min(b.y,d.y,e.y,a.y);this.width=Math.max(b.x,d.x,e.x,a.x)-this.x;this.height=Math.max(b.y,d.y,e.y,a.y)-this.y};c.prototype.right=function(){return this.x+
this.width};c.prototype.bottom=function(){return this.y+this.height};c.prototype.Vc=function(){return new A(this.x+this.width/2,this.y+this.height/2)};c.prototype.toString=function(){return"Rectangle("+this.x+", "+this.y+", "+this.width+", "+this.height+")"};return c}(),F=function(){function c(){this.log=w.create("MATRIX");this.Tb="Matrix";if(0===arguments.length)this.m11=1,this.m21=this.m12=0,this.m22=1,this.Da=this.Ca=0;else if(1===arguments.length){if(6!==arguments[0].length)throw"Bad array initializer for Matrix.";
this.m11=arguments[0][0];this.m12=arguments[0][1];this.m21=arguments[0][2];this.m22=arguments[0][3];this.Ca=arguments[0][4];this.Da=arguments[0][5]}else this.m11=arguments[0],this.m12=arguments[1],this.m21=arguments[2],this.m22=arguments[3],this.Ca=arguments[4],this.Da=arguments[5]}c.prototype.toString=function(){return"[ "+this.m11+" "+this.m12+" "+this.Ca+"    "+this.m21+" "+this.m22+" "+this.Da+"    0 0 1 ]"};c.prototype.Sb=function(){return[this.m11,this.m12,this.m21,this.m22,this.Ca,this.Da]};
c.prototype.sk=function(){return 1===this.m11&&0===this.m12&&0===this.m21&&1===this.m22&&0===this.Ca&&0===this.Da};c.prototype.sd=function(a){return this.m11===a.m11&&this.m12===a.m12&&this.m21===a.m21&&this.m22===a.m22&&this.Ca===a.Ca&&this.Da===a.Da};c.prototype.multiply=function(a){var b=new c;b.m11=this.m11*a.m11+this.m12*a.m21;b.m21=this.m21*a.m11+this.m22*a.m21;b.m12=this.m11*a.m12+this.m12*a.m22;b.m22=this.m21*a.m12+this.m22*a.m22;b.Ca=this.m11*a.Ca+this.m12*a.Da+this.Ca;b.Da=this.m21*a.Ca+
this.m22*a.Da+this.Da;return b};c.prototype.apply=function(a,b){return new A(this.m11*a+this.m12*b+this.Ca,this.m21*a+this.m22*b+this.Da)};c.prototype.bg=function(a){var b;void 0===b&&(b=!1);b?a.setTransform(this.m11,this.m21,this.m12,this.m22,this.Ca,this.Da):a.transform(this.m11,this.m21,this.m12,this.m22,this.Ca,this.Da)};c.prototype.clone=function(){return new c(this.m11,this.m12,this.m21,this.m22,this.Ca,this.Da)};c.prototype.inverse=function(){var a=this.m11*this.m22-this.m12*this.m21;return new c(this.m22/
a,-this.m12/a,-this.m21/a,this.m11/a,(this.m12*this.Da-this.Ca*this.m22)/a,(this.Ca*this.m21-this.m11*this.Da)/a)};c.prototype.Ko=function(){var a=this.m11,b=this.m21,d=this.m12,e=this.m22,f=Math.sqrt(a*a+b*b),g=Math.sqrt(d*d+e*e);return new c(a/f,d/g,b/f,e/g,this.Ca,this.Da)};c.prototype.yd=function(){return new A(Math.sqrt(this.m11*this.m11+this.m21*this.m21),Math.sqrt(this.m12*this.m12+this.m22*this.m22))};c.prototype.Lr=function(){return 1===this.m11&&1===this.m22&&0===this.m12&&0===this.m21};
c.prototype.translate=function(a,b){return this.multiply(new E(a,b))};c.prototype.rotate=function(a,b,d){return this.multiply(new Kb(a,b,d))};return c}(),Kb=function(c){function a(a,d,e){var b=Math.cos(a);a=Math.sin(a);return c.call(this,b,a,-a,b,-d*b-e*a+d,d*a-e*b+e)||this}n(a,c);return a}(F),E=function(c){function a(a,d){return c.call(this,1,0,0,1,a,d)||this}n(a,c);return a}(F),Lb=function(c){function a(a,d,e,f){return void 0===e||void 0===f?c.call(this,a,0,0,d,0,0)||this:c.call(this,a,0,0,d,e-
a*e,f-d*f)||this}n(a,c);return a}(F),Mb=function(c){function a(a,d,e){var b=Math.cos(2*a);a=Math.sin(2*a);return c.call(this,b,a,a,-b,-d*b-e*a+d,-d*a+e*b+e)||this}n(a,c);return a}(F);
function Nb(c,a,b,d,e,f,g,h,k,l){if(!(8<++Nb.depth)){var m=(a+d)/2,q=(b+e)/2,p=(d+f)/2,t=(e+g)/2,r=(f+h)/2,v=(g+k)/2,x=(m+p)/2,I=(q+t)/2;p=(p+r)/2;t=(t+v)/2;var y=(x+p)/2,J=(I+t)/2,P=h-a,la=k-b;d=Math.abs((d-h)*la-(e-k)*P);f=Math.abs((f-h)*la-(g-k)*P);(d+f)*(d+f)<l*(P*P+la*la)?c.push(new A(y,J)):(Nb(c,a,b,m,q,x,I,y,J,l),Nb(c,y,J,p,t,r,v,h,k,l))}--Nb.depth}(Nb||(Nb={})).depth=0;
function Ob(c,a,b,d,e,f,g,h){if(!(8<++Nb.depth)){var k=(a+d)/2,l=(b+e)/2,m=(d+f)/2,q=(e+g)/2,p=(k+m)/2,t=(l+q)/2,r=f-a,v=g-b;d=Math.abs((d-f)*v-(e-g)*r);d*d<=h*(r*r+v*v)?c.push(new A(p,t)):(Ob(c,a,b,k,l,p,t,h),Ob(c,p,t,m,q,f,g,h))}--Nb.depth}
function Pb(c,a,b){var d,e=!1,f=c.length;1<f&&c[f-1].x===c[0].x&&c[f-1].y===c[0].y&&--f;if(3>f)return!1;var g=c[f-1].x;var h=c[f-1].y;for(d=0;d<f;d++){var k=c[d].x;var l=c[d].y;if(k>g){var m=g;var q=k;var p=h;h=l}else m=k,q=g,p=l;k<a===a<=g&&(b-p)*(q-m)<(h-p)*(a-m)&&(e=!e);g=k;h=l}return e}function Qb(c,a,b,d){d*=d;for(var e=1;e<c.length;e++){var f=c[e-1].x,g=c[e-1].y,h=c[e].x-f,k=c[e].y-g,l=((a-f)*h+(b-g)*k)/(h*h+k*k);1<l?l=1:0>l&&(l=0);f=f+l*h-a;g=g+l*k-b;if(f*f+g*g<=d)return!0}return!1}
(function(){function c(a){this.Nb=a}c.prototype.clear=function(){for(var a=0;a<this.Nb.width*this.Nb.height*4;a++)this.Nb.data[a]=0};c.prototype.getImageData=function(){return this.Nb};c.prototype.width=function(){return this.Nb.width};c.prototype.height=function(){return this.Nb.height};c.prototype.get=function(a,b){var d=this.Nb.width*b*4+4*a;return this.Nb.data[d]|this.Nb.data[d+1]<<8|this.Nb.data[d+2]<<16|this.Nb.data[d+3]<<24};c.prototype.set=function(a,b,d){a=this.Nb.width*b*4+4*a;this.Nb.data[a]=
d&255;this.Nb.data[a+1]=d>>8&255;this.Nb.data[a+2]=d>>16&255;this.Nb.data[a+3]=d>>24&255};return c})();
(function(){function c(a,b){this.data=[];this.vf=a;this.xh=b;this.data=[]}c.prototype.width=function(){return this.vf};c.prototype.height=function(){return this.xh};c.prototype.getImageData=function(){var a=document.createElement("canvas");a.width=this.vf;a.height=this.xh;a=a.getContext("2d").getImageData(0,0,this.vf,this.xh);for(var b=this.vf*this.xh,d=0;d<b;d++){var e=!0===this.data[d]?255:0;a.data[4*d]=e;a.data[4*d+1]=e;a.data[4*d+2]=e;a.data[4*d+3]=255}return a};c.prototype.get=function(a,b){return!0===
this.data[this.vf*b+a]};c.prototype.set=function(a,b,d){this.data[this.vf*b+a]=d};return c})();
var H=function(){function c(a){this.closed=!1;this.ba=[];a instanceof D&&(this.moveTo(a.x,a.y),this.lineTo(a.x+a.width,a.y),this.lineTo(a.x+a.width,a.y+a.height),this.lineTo(a.x,a.y+a.height),this.lineTo(a.x,a.y),this.closePath())}c.prototype.clear=function(){this.closed=!1;this.ba=[]};c.prototype.beginPath=function(){};c.prototype.rect=function(){};c.prototype.moveTo=function(a,b){this.ba.push(c.jc,a,b)};c.prototype.lineTo=function(a,b){this.ba.push(c.ic,a,b)};c.prototype.bezierCurveTo=function(a,
b,d,e,f,g){this.ba.push(c.Nd,a,b,d,e,f,g)};c.prototype.quadraticCurveTo=function(a,b,d,e){this.ba.push(c.Pd,a,b,d,e)};c.prototype.arc=function(){};c.prototype.arcTo=function(){};c.prototype.closePath=function(){this.ba.push(c.hc)};c.prototype.ha=function(a){for(var b=0;b<this.ba.length;){switch(this.ba[b]){case c.jc:a.moveTo&&a.moveTo(this.ba[b+1],this.ba[b+2]);break;case c.ic:a.lineTo&&a.lineTo(this.ba[b+1],this.ba[b+2]);break;case c.Nd:a.bezierCurveTo&&a.bezierCurveTo(this.ba[b+1],this.ba[b+2],
this.ba[b+3],this.ba[b+4],this.ba[b+5],this.ba[b+6]);break;case c.Pd:a.quadraticCurveTo&&a.quadraticCurveTo(this.ba[b+1],this.ba[b+2],this.ba[b+3],this.ba[b+4]);break;case c.hc:a.closePath&&a.closePath();break;default:alert("Error!")}b+=c.kc[this.ba[b]]}};c.prototype.Os=function(){for(var a=0,b=0,d=0,e=[];a<this.ba.length;){switch(this.ba[a]){case c.hc:e.push([c.hc]);break;case c.jc:b=this.ba[a+1];d=this.ba[a+2];break;case c.ic:e.push([c.ic,b,d]);b=this.ba[a+1];d=this.ba[a+2];break;case c.Nd:e.push([c.Nd,
this.ba[a+3],this.ba[a+4],this.ba[a+1],this.ba[a+2],b,d]);b=this.ba[a+5];d=this.ba[a+6];break;case c.Pd:e.push([c.Pd,this.ba[a+1],this.ba[a+2],b,d]),b=this.ba[a+3],d=this.ba[a+4]}a+=c.kc[this.ba[a]]}this.ba.length&&e.push([c.jc,b,d]);a=new c;for(b=e.length-1;0<=b;b--)Array.prototype.push.apply(a.ba,e[b]);a.closed=this.closed;return a};c.prototype.ag=function(){for(var a=0,b,d=[];a<this.ba.length;){var e=c.Ul[this.ba[a]];for(b=0;b<e;b++)d.push(new A(this.ba[a+1+2*b],this.ba[a+1+2*b+1]));a+=c.kc[this.ba[a]]}return d};
c.prototype.transform=function(a){for(var b=0,d,e;b<this.ba.length;){e=c.Ul[this.ba[b]];for(d=0;d<e;d++){var f=a.apply(this.ba[b+1+2*d],this.ba[b+1+2*d+1]);this.ba[b+1+2*d]=f.x;this.ba[b+1+2*d+1]=f.y}b+=c.kc[this.ba[b]]}};c.prototype.clone=function(){var a=new c;a.ba=this.ba.concat();return a};c.prototype.zm=function(a){for(var b=0,d,e=d=0,f=new D(this.ba[1],this.ba[2],0,0),g;b<this.ba.length;){switch(this.ba[b]){case c.jc:case c.ic:d=this.ba[b+1];e=this.ba[b+2];f.xl(d,e);break;case c.Nd:var h=g=
[],k=this.ba[b+5],l=this.ba[b+6];Nb(h,d,e,this.ba[b+1],this.ba[b+2],this.ba[b+3],this.ba[b+4],k,l,a*a);h.push(new A(k,l));for(d=0;d<g.length;d++)f.xl(g[d].x,g[d].y);d=this.ba[b+5];e=this.ba[b+6];break;case c.Pd:h=g=[];k=this.ba[b+3];l=this.ba[b+4];Ob(h,d,e,this.ba[b+1],this.ba[b+2],k,l,a*a);h.push(new A(k,l));for(d=0;d<g.length;d++)f.xl(g[d].x,g[d].y);d=this.ba[b+3];e=this.ba[b+4]}b+=c.kc[this.ba[b]]}return f};c.prototype.append=function(a){this.ba=this.ba.concat(a.ba)};c.prototype.rl=function(a){for(var b=
0,d=0,e=0,f=new c,g;b<this.ba.length;){switch(this.ba[b]){case c.jc:d=this.ba[b+1];e=this.ba[b+2];f.moveTo(d,e);break;case c.ic:d=this.ba[b+1];e=this.ba[b+2];f.lineTo(d,e);break;case c.Nd:var h=g=[],k=this.ba[b+5],l=this.ba[b+6];Nb(h,d,e,this.ba[b+1],this.ba[b+2],this.ba[b+3],this.ba[b+4],k,l,a*a);h.push(new A(k,l));2===g.length&&1E-4>d*(g[0].y-g[1].y)+g[0].x*(g[1].y-e)+g[1].x*(e-g[0].y)&&(g[0]=g[1],g.length=1);for(d=0;d<g.length;d++)f.lineTo(g[d].x,g[d].y);d=this.ba[b+5];e=this.ba[b+6];break;case c.Pd:h=
g=[];k=this.ba[b+3];l=this.ba[b+4];Ob(h,d,e,this.ba[b+1],this.ba[b+2],k,l,a*a);h.push(new A(k,l));for(d=0;d<g.length;d++)f.lineTo(g[d].x,g[d].y);d=this.ba[b+3];e=this.ba[b+4];break;case c.hc:f.closePath()}b+=c.kc[this.ba[b]]}return f};c.prototype.xs=function(a,b){var d;void 0===d&&(d=0);return Pb(this.ag(),a,b)||0<d&&this.co(a,b,d)};c.prototype.co=function(a,b,d){var e=0,f=0,g=0;for(d*=d;g<this.ba.length;){switch(this.ba[g]){case c.jc:e=this.ba[g+1];f=this.ba[g+2];break;case c.ic:var h=this.ba[g+
1];var k=this.ba[g+2];var l=h-e;var m=k-f;var q=l*l+m*m;q=((a-e)*l+(b-f)*m)/q;1<q?q=1:0>q&&(q=0);e+=q*l;m=f+q*m;f=e-a;m-=b;f=f*f+m*m;if(f<=d)return!0;e=h;f=k}g+=c.kc[this.ba[g]]}return!1};c.prototype.Wh=function(a,b){for(var d=0,e=0,f=b[0],g,h=new A(0,0),k;d<this.ba.length;){switch(this.ba[d]){case c.jc:k=this.ba[d+1];g=this.ba[d+2];a.moveTo(k,g);h=new A(k,g);break;case c.ic:k=this.ba[d+1];var l=g=this.ba[d+2],m=new A(k,l);g=h.vb(m);if(!(0>=g)){for(;g>f;)h.x+=(m.x-h.x)*f/g,h.y+=(m.y-h.y)*f/g,e&1?
a.moveTo(h.x,h.y):a.lineTo(h.x,h.y),g-=f,e=(e+1)%b.length,f=b[e];g<=f&&(h=new A(k,l),e&1?a.moveTo(h.x,h.y):a.lineTo(h.x,h.y),f-=g)}}d+=c.kc[this.ba[d]]}};c.prototype.zp=function(){function a(a,b){f-=(a-d)*(b+e);d=a;e=b}for(var b=0,d,e,f=0;b<this.ba.length;){switch(this.ba[b]){case c.jc:d=this.ba[b+1];e=this.ba[b+2];break;case c.ic:a(this.ba[b+1],this.ba[b+2]);break;case c.Nd:a(this.ba[b+5],this.ba[b+6]);break;case c.Pd:a(this.ba[b+3],this.ba[b+4])}b+=c.kc[this.ba[b]]}return f/2};c.prototype.Nm=function(a){for(var b=
0,d=0,e=0,f=!1;b<this.ba.length;){switch(this.ba[b]){case c.jc:d=this.ba[b+1];e=this.ba[b+2];f=!0;break;case c.ic:a(d,e,this.ba[b+1],this.ba[b+2],f),d=this.ba[b+1],e=this.ba[b+2],f=!1}b+=c.kc[this.ba[b]]}};c.prototype.Kp=function(){var a=0;this.Nm(function(b,d,e,c){a+=B(b,d,e,c)});return a};c.prototype.Mp=function(a){var b=new c,d=0;this.Nm(function(e,c,g,h,k){if(d<=a){k&&b.moveTo(e,c);k=B(e,c,g,h);if(d+k>=a){var f=a-d;g=e+(g-e)*f/k;h=c+(h-c)*f/k}d+=k;b.lineTo(g,h)}});return b};c.jc=0;c.ic=1;c.Nd=
2;c.Pd=3;c.hc=4;c.kc=[3,3,7,5,1];c.Ul=[1,1,3,2,0];return c}();function Rb(c,a,b,d,e){var f;if(2>=d-b)e.push(c[b]);else{var g=c[b],h=c[d-1],k=0,l=0;for(f=b+1;f<d;f++){var m=c[f].kq(g,h);m>k&&(k=m,l=f)}0<l&&k>a?(Rb(c,a,b,l,e),Rb(c,a,l,d,e)):e.push(g)}}function Sb(c,a){var b=[];Rb(c,a,0,c.length,b);0<c.length&&0<b.length&&!c[c.length-1].sd(b[b.length-1])&&b.push(c[c.length-1]);return b}
var Tb=function(){function c(){this.la=[];if(1===arguments.length){var a=arguments[0];if(a instanceof D)this.la.push(new A(a.x,a.y)),this.la.push(new A(a.right(),a.y)),this.la.push(new A(a.right(),a.bottom())),this.la.push(new A(a.x,a.bottom()));else if(a instanceof Array)this.la=a;else throw alert("Bad parameter passed to Polygon() constructor."),"Error";}}c.prototype.transform=function(a){for(var b=0;b<this.la.length;b++)this.la[b]=a.apply(this.la[b].x,this.la[b].y)};c.prototype.add=function(a,
b){this.la.push(new A(a,b))};c.prototype.Wc=function(a,b,d){void 0===d&&(d=0);return Pb(this.la,a,b)||d&&Qb(this.la,a,b,d)};c.prototype.Jp=function(){return D.gg(this.la)};c.prototype.clone=function(){return new c(this.la.slice(0))};c.prototype.sd=function(a){if(this.la.length!==a.la.length)return!1;for(var b=0;b<this.la.length;b++){var d=this.la[b],e=a.la[b];if(d.x!==e.x||d.y!==e.y)return!1}return!0};c.prototype.ed=function(a){for(var b=[],d=0;d<this.la.length;d++){var e=this.la[0===d?this.la.length-
1:d-1],c=this.la[d],g=this.la[d===this.la.length-1?0:d+1],h=B(e.x,e.y,c.x,c.y),k=B(g.x,g.y,c.x,c.y);b.push({x:c.x+((c.x-e.x)/h+(c.x-g.x)/k)/Math.sqrt(2)*a,y:c.y+((c.y-e.y)/h+(c.y-g.y)/k)/Math.sqrt(2)*a})}this.la=b};c.prototype.ha=function(a){if(!(1>this.la.length)){a.moveTo(this.la[0].x,this.la[0].y);for(var b=1;b<this.la.length;b++)a.lineTo(this.la[b].x,this.la[b].y);a.closePath()}};c.prototype.ag=function(){return this.la};c.cu=function(a,b){for(var d=0,e=0,c=!1,g=[],h=[],k=0;k<b.length;k++)h.push(0);
for(;;){var l=0,m=-1;for(k=0;k<b.length;k++)if(h[k]<b[k].length){var q=b[k][h[k]];if(0===k||q<l){l=q;m=k;var p=1-h[k]%2}}if(-1===m)return g;h[m]+=1;"intersection"===a?p?(e+=1,e===b.length&&(d=l)):(e===b.length&&(g.push(d),g.push(l)),--e):p?(e+=1,0===m?(c=!0,1===e)&&(d=l):c&&2===e&&(g.push(d),g.push(l))):(c&&1===e&&(g.push(d),g.push(l)),--e,0===m&&(c=!1),c&&1===e&&(d=l))}};return c}();
function Ub(c,a,b,d,e,f,g,h){b-=c;d-=a;g-=e;h-=f;var k=-g*d+b*h;if(0===k)return null;e=(g*(a-f)-h*(c-e))/k;return new A(c+e*b,a+e*d)}
function Vb(c,a){function b(a){var b,e;var c=[];var k=b=0;for(e=a.length;k<e;k++){var l=a[k];a[b+1]&&(c[b]=d(l,a[b+1]));b+=1}return c}function d(a,b){return new A(a.x+(b.x-a.x)/2,a.y+(b.y-a.y)/2)}return a?Vb(b(b(function(a){var b,e;a=[a[0]].concat(a).concat(a[a.length-1]);var c=[];var k=b=0;for(e=a.length;k<e;k++){var l=a[k];c[2*b]=l;a[b+1]&&(c[2*b+1]=d(l,a[b+1]));b+=1}return c}(c))),a-1):c}
(function(){function c(){this.items=[];this.oa=new F}c.prototype.toString=function(){return this.items.join(" ")};c.prototype.arc=function(){throw Error("SvgPathContext.arc is not implemented.");};c.prototype.arcTo=function(){throw Error("SvgPathContext.arcTo is not implemented.");};c.prototype.moveTo=function(a,b){var d=this.oa.apply(a,b);this.items.push("M",d.x,d.y)};c.prototype.lineTo=function(a,b){var d=this.oa.apply(a,b);this.items.push("L",d.x,d.y)};c.prototype.transform=function(a,b,d,e,c,
g){a=new F(a,d,b,e,c,g);this.oa=this.oa.multiply(a)};c.prototype.rect=function(){};c.prototype.bezierCurveTo=function(a,b,d,e,c,g){a=this.oa.apply(a,b);d=this.oa.apply(d,e);c=this.oa.apply(c,g);this.items.push("C",a.x,a.y,d.x,d.y,c.x,c.y)};c.prototype.quadraticCurveTo=function(){throw Error("SvgPathContext.quadraticCurveTo is not implemented.");};c.prototype.beginPath=function(){};c.prototype.closePath=function(){this.items.push("Z")};return c})();
function Wb(c,a,b,d,e){if(!(2>a.length)){void 0===d&&(d=!0);void 0===e&&(e=!0);var f=a[0].x===a[a.length-1].x&&a[0].y===a[a.length-1].y,g=[],h=[],k=new A(0,0),l=k,m=k,q=k,p=k,t=[];b/=2;var r;for(r=1;r<a.length;r++){m=a[r-1];p=a[r];q=C(m.x,m.y,p.x,p.y);k=new A(q.y,-q.x);l=new A(m.x-q.x*b-k.x*b,m.y-q.y*b-k.y*b);m=new A(m.x-q.x*b+k.x*b,m.y-q.y*b+k.y*b);if(h.length){var v=h[h.length-1];var x=t[t.length-1];l=Ub(v.x,v.y,v.x+x.x,v.y+x.y,l.x,l.y,l.x+q.x,l.y+q.y)||l;v=g[g.length-1];m=Ub(v.x,v.y,v.x+x.x,v.y+
x.y,m.x,m.y,m.x+q.x,m.y+q.y)||m}h.push(l);g.push(m);t.push(q)}f?(v=h[0],x=t[0],l=Ub(v.x,v.y,v.x+x.x,v.y+x.y,l.x,l.y,l.x+q.x,l.y+q.y)||l,v=g[0],m=Ub(v.x,v.y,v.x+x.x,v.y+x.y,m.x,m.y,m.x+q.x,m.y+q.y)||m,h[0].x=l.x,h[0].y=l.y,g[0].x=m.x,g[0].y=m.y,h.push(l),g.push(m)):(h.push(new A(p.x+q.x*b-k.x*b,p.y+q.y*b-k.y*b)),g.push(new A(p.x+q.x*b+k.x*b,p.y+q.y*b+k.y*b)));if(e){c.moveTo(h[0].x,h[0].y);for(r=1;r<h.length;r++)c.lineTo(h[r].x,h[r].y);f&&(c.closePath(),c.moveTo(g[g.length-1].x,g[g.length-1].y))}else d&&
c.moveTo(g[g.length-1].x,g[g.length-1].y);if(d){for(r=g.length-1;0<=r;r--)c.lineTo(g[r].x,g[r].y);!f&&e&&c.lineTo(h[0].x,h[0].y)}}}
(function(){function c(a){this.la=a;this.n=0;this.mb=new A(0,0)}c.prototype.next=function(a){if(0===this.la.length)return null;if(0===this.n)return this.mb=this.la[0].clone(),this.n+=1,this.mb.clone();for(;this.n<this.la.length;){var b=this.mb.vb(this.la[this.n]);if(0===b)this.n+=1;else if(b<=a)a-=b,this.n+=1;else return this.mb.x+=(this.la[this.n].x-this.mb.x)*a/b,this.mb.y+=(this.la[this.n].y-this.mb.y)*a/b,this.mb.clone()}return null};return c})();function Xb(c){return"object"===typeof c&&"[object Array]"===Object.prototype.toString.apply(c)}function Yb(c){return"string"===typeof c}function K(c){return"number"===typeof c}function Zb(c){return"object"===typeof c};var L=function(){function c(a,b){this.id=a;this.ea=b;this.parent=null;this.aa={};this.rect=new D(0,0,1,1);this.yh=!1;this.Oa=new D(0,0,1,1);this.Yb=this.order=0;this.log=w.create("BaseNode");this.aa.matrix=new F;this.aa.layer="default";this.Bj(c.wa)}c.md=function(a,b){c.types[a]=b};c.create=function(a,b,d){return a in c.types?new c.types[a](b,d):null};c.prototype.Bj=function(a){for(var b in a)a.hasOwnProperty(b)&&(this.aa[b]=a[b])};c.prototype.clip=function(){};c.prototype.toString=function(){return this.type()+
":"+this.id};c.prototype.Fg=function(){return!1};c.prototype.pi=function(){return null};c.prototype.Xh=function(){};c.prototype.zn=function(){return!1};c.prototype.ni=function(){return"text"in this.aa};c.prototype.Tm=function(a,b){var d=typeof this.aa[a],e=typeof b;d!==e&&"string"===e&&"number"===d&&(this.log("Convert property %s to a number.",a),b=parseFloat(b));return b};c.prototype.clone=function(a){a=c.create(this.type(),a(),this.ea);a.Jb(this.ec());return a};c.prototype.ec=function(){var a={},
b;for(b in this.aa)this.aa.hasOwnProperty(b)&&(a[b]=this.ka(b));return a};c.prototype.Jb=function(a){for(var b in a)a.hasOwnProperty(b)&&this.setProperty(b,a[b])};c.prototype.xd=function(){var a=this.ka("layer");return a?""+a:"default"};c.prototype.Bn=function(){return void 0!==this.children};c.prototype.Cn=function(){return null!==this.parent&&null!==this.parent.parent&&"PageNode"!==this.parent.type()};c.prototype.type=function(){return"BaseNode"};c.prototype.Ea=function(){return this.ka("matrix")};
c.prototype.wd=function(){return this.Ea().inverse()};c.prototype.Vf=function(a){this.setProperty("matrix",a)};c.prototype.setProperty=function(a,b){b=this.Tm(a,b);if(a in this.aa||"customData"===a||"tag"===a||"locked"===a||"lockSize"===a||"lockRotation"===a||"lockPosition"===a||"lockEditMode"===a||"rotationHandles"===a||"lockAspectRatio"===a||"zIndex"===a||"snap"===a||"opacity"===a)Xb(b)&&(b=b.slice(0)),"opacity"===a&&(b=parseFloat(b)),this.aa[a]=b};c.prototype.ka=function(a){a=this.aa[a];a instanceof
Array&&(a=a.slice(0));return a};c.prototype.Zm=function(){var a=new Tb(this.Oa);a.transform(this.Ea());return a};c.prototype.Gf=function(){return this.ka("zIndex")||0};c.prototype.transform=function(a){this.Vf(a.multiply(this.Ea()))};c.prototype.format=function(){};c.prototype.xb=function(a,b){var d=this.wd().apply(a,b);return this.hidden()||this.ka("locked")||!this.Oa.Wc(d.x,d.y)?null:this};c.prototype.he=function(a){this.yh=a};c.prototype.hidden=function(){return this.yh};c.prototype.Wf=function(){};
c.prototype.Gk=function(){};c.prototype.Jk=function(){};c.prototype.Tg=function(a){if(a.Tg){var b={"zwibbler:id":""+this.id};if("tag"in this.aa){var d=this.aa.tag;"string"!==typeof d&&(d=JSON.stringify(d));b["zwibbler:tag"]=d}a.Tg(b)}};c.prototype.Sg=function(a){a.Sg&&a.Sg()};c.prototype.ha=function(a){a.save();this.Tg(a);var b=this.aa.matrix;a.transform(b.m11,b.m21,b.m12,b.m22,b.Ca,b.Da);"erase"===this.aa.strokeStyle?a.sf?a.strokeStyle=a.sf:(a.strokeStyle="#000000",a.globalCompositeOperation="destination-out"):
a.strokeStyle=this.aa.strokeStyle;a.fillStyle=this.aa.fillStyle;a.lineWidth=this.aa.lineWidth;this.aa.shadow&&(a.shadowOffsetX=3,a.shadowOffsetY=3,a.shadowBlur=5,a.shadowColor="rgba(0,0,0,0.5)");"opacity"in this.aa&&(a.globalAlpha=this.aa.opacity);this.pe(a);this.Sg(a);a.restore();c.Ol&&(a.save(),a.beginPath(),a.lineWidth=1,a.strokeStyle="#ff8000",a.rect(this.rect.x,this.rect.y,this.rect.width,this.rect.height),a.stroke(),a.restore())};c.prototype.pe=function(){};c.prototype.resolve=function(){return!1};
c.prototype.Nq=function(a,b,d,e){this.xg||(this.xg={});var c=this.xg[a];if(!c||c.No!==e){c&&e===c.No||(c={No:e,value:e},this.xg[a]=c);a=/url\(([^\)]+)\)/.exec(e);var g;a&&(g=a[1]);var h=this;g&&(c.value="rgba(0, 0, 0, 0.2)",d.add(this.id,"image",g,null,function(a){h.log("Got image response.");c.value=b.createPattern(a,"repeat")||"magenta";d.Rf(h.id)}))}};c.prototype.cr=function(a){return this.xg&&(a=this.xg[a])?a.value:"magenta"};c.prototype.vd=function(){return""};c.prototype.Ne=function(){};c.prototype.di=
function(){return null};c.prototype.ei=function(){return null};c.prototype.Ke=function(){return this.parent?this.parent.Xj(this):-1};c.wa={fillStyle:"#cccccc",strokeStyle:"#000000",lineWidth:2,shadow:!1};c.Ol=!1;c.types={};return c}();var $b=function(c){function a(a,d){var b=c.call(this,a,d)||this;b.la=[];b.cc=[];b.log=w.create("BRUSH",!0);b.log("New BrushNode created.");b.aa.points=[];b.aa.strokeStyle="#ff00ff";b.aa.lineWidth=10;return b}n(a,c);a.prototype.type=function(){return"BrushNode"};a.prototype.setProperty=function(a,d){"fillStyle"===a&&(a="strokeStyle");a in this.aa||"dashes"===a||"lineCap"===a?this.aa[a]=d:c.prototype.setProperty.call(this,a,d)};a.prototype.ka=function(a){"fillStyle"===a&&(a="strokeStyle");return c.prototype.ka.call(this,
a)};a.prototype.format=function(){var a,d;this.la.length=0;var e=this.aa.points;var c=a=0;for(d=e.length-1;a<=d;c=a+=2)this.la.push(new A(e[c],e[c+1]));c=D.gg(this.la);e=this.Ea().yd();a=this.aa.lineWidth;c.ed(a/e.x,a/e.y);this.Oa=c.clone();c=new Tb(c);c.transform(this.aa.matrix);this.rect=D.gg(c.la);this.cc=[];if("dashes"in this.aa)for(e=this.aa.dashes.split(","),c=0;c<e.length;c++)a=parseFloat(e[c]),isNaN(a)||this.cc.push(a);this.log("Format brushnode")};a.prototype.xb=function(a,d){if(this.rect.Wc(a,
d)){var b=this.wd().apply(a,d);if(Qb(this.la,b.x,b.y,12+this.aa.lineWidth/2))return this}return null};a.prototype.pe=function(b){var d=this.aa.points;if(0!==d.length){b.save();b.beginPath();var e=this.ka("lineCap")||"round";b.lineCap=e;b.lineJoin="round"===e?"round":"bevel";if(1<this.cc.length){e=this.la;var c=this.cc;if(0!==e.length){b.moveTo(e[0].x,e[0].y);var g=0;for(var h=1,k=c[0],l=e[0].clone(),m;h<e.length;)m=l.vb(e[h]),0===m?h+=1:m<=k?(l=e[h].clone(),g&1?b.moveTo(l.x,l.y):b.lineTo(l.x,l.y),
k-=m,h+=1):(l.x+=(e[h].x-l.x)*k/m,l.y+=(e[h].y-l.y)*k/m,g&1?b.moveTo(l.x,l.y):b.lineTo(l.x,l.y),g=(g+1)%c.length,k=c[g])}}else for(b.moveTo(d[0],d[1]),e=c=2,g=d.length-1;c<=g;e=c+=2)b.lineTo(d[e],d[e+1]);this.wd().bg(b);Eb(b,this.aa.strokeStyle);if(a.bp){this.Ea().bg(b);b.beginPath();e=c=0;for(g=d.length-1;c<=g;e=c+=2)b.rect(d[e]-2,d[e+1]-2,4,4);b.fillStyle="#ff0000";b.fill()}b.restore()}};a.bp=!1;return a}(L);L.md("BrushNode",$b);function ac(c){return{m11:c.m11,m12:c.m21,m21:c.m12,m22:c.m22,dx:c.Ca,dy:c.Da}}
var bc=function(){function c(a,b){this.node=a;this.request=b}c.prototype.Mq=function(a,b,d){this.node.Nq(b,a,this.request,d)};c.prototype.br=function(a){return this.node.cr(a)};c.prototype.Js=function(){this.request.Rf(this.node.id)};c.prototype.Qr=function(a,b){this.request.add(this.node.id,"image",a,null,b)};return c}(),cc=function(c){function a(a,d){var b=c.call(this,a,d)||this;b.Ua=null;b.log=w.create("CUSTOM");b.setProperty("matrix",new F);return b}n(a,c);a.prototype.type=function(){return"CustomNode"};
a.prototype.setProperty=function(a,d){if(null===this.Ua&&"nodeType"===a){var b=O.Mj[d];this.Ua=new b(this.id);for(var c in this.aa)this.setProperty(c,this.aa[c]);this.aa.nodeType=d}else this.aa[a]=d,"matrix"===a&&(d=ac(d)),this.Ua&&this.Ua.setProperty&&this.Ua.setProperty(a,d)};a.prototype.Fg=function(){return this.Ua&&this.Ua.hasEditMode?this.Ua.hasEditMode():!1};a.prototype.bk=function(){var a=[];this.Ua&&this.Ua.getEditHandles&&(a=this.Ua.getEditHandles());for(var d=this.Ea(),e=[],c=0;c<a.length;c++){var g=
a[c];e.push(d.apply(g.x||0,g.y||0))}return e};a.prototype.xb=function(a,d){var b=this.wd().apply(a,d);return this.hidden()||this.ka("locked")||!this.Oa.Wc(b.x,b.y)||this.Ua&&this.Ua.hittest&&!this.Ua.hittest(b.x,b.y)?null:this};a.prototype.Xh=function(a,d){a.beginPath();for(var b=10/d,c=2/d,g=0,h=this.bk();g<h.length;g++){var k=h[g];a.moveTo(k.x+b/d,k.y);a.arc(k.x,k.y,b,0,2*Math.PI,!1)}a.strokeStyle="#0050B7";a.lineWidth=c;a.stroke()};a.prototype.di=function(a){var b=this.bk();return a<b.length?b[a]:
null};a.prototype.pi=function(a,d,e){for(var b=this.bk(),c=0;c<b.length;c++)if(20>b[c].vb(new A(a,d))/e)return c;return null};a.prototype.Ne=function(a,d,e){this.Ua&&this.Ua.moveEditHandle&&(d=this.wd().apply(d,e),this.Ua.moveEditHandle(a,d.x,d.y))};a.prototype.ka=function(a){var b;this.Ua&&this.Ua.getProperty&&(b=this.Ua.getProperty(a));void 0===b&&(b=c.prototype.ka.call(this,a));"matrix"===a&&(b=b?new F(b.m11||1,b.m21||0,b.m12||0,b.m22||1,b.dx||0,b.dy||0):new F);return b};a.prototype.format=function(a,
d){if(this.Ua)if(this.Zj||(this.Zj=new bc(this,d)),"format"in this.Ua&&this.Ua.format(a,this.Zj),this.Ua.getUntransformedRect){var b=this.Ua.getUntransformedRect();this.Oa=new D(b.x||0,b.y||0,b.width||0,b.height||0);this.rect=this.Oa.clone();this.rect.transform(this.Ea())}else this.log("Error: NodeType %s missing getUntransformedRect()",this.aa.nodeType)};a.prototype.pe=function(a){a.save();a.getTransform=function(){return ac(a.Qo)};this.Ua.draw(a,this.Zj);a.restore()};return a}(L);
L.md("CustomNode",cc);bc.prototype.formatFill=bc.prototype.Mq;bc.prototype.getFill=bc.prototype.br;bc.prototype.reformat=bc.prototype.Js;bc.prototype.loadImage=bc.prototype.Qr;var dc=function(c){function a(a,d){var b=c.call(this,a,d)||this;b.element=null;b.Rh=void 0;b.uc=new Tb;b.nk=new Tb;b.Wd=new F;b.readOnly=!1;b.tb=!1;b.Ic=null;b.width=0;b.height=0;b.fc=null;b.log=w.create("DomNode",!0);b.aa.data="";b.aa.locked=!1;return b}n(a,c);a.prototype.type=function(){return"DomNode"};a.prototype.setProperty=function(a,d){if("data"===a)this.element&&(z(this.element).remove(),this.Rh=this.element=null);else if("border"===a||"lockSize"===a||"lockRotate"===a||"preview"===a){this.aa[a]=
d;return}c.prototype.setProperty.call(this,a,d)};a.prototype.ct=function(a){null!==this.Ic&&(this.log("Node %s receives DOM element and requests reformat",this.id),this.element&&(this.log("   Remove existing DOM element"),z(this.element).remove()),this.element=a,this.element.style.position="absolute","IFRAME"!==a.tagName&&(this.element.style.pointerEvents="none"),z(this.element).pk(this.Ic.canvas),this.width=this.element.offsetWidth||parseFloat(this.element.getAttribute("width")||"0"),this.height=
this.element.offsetHeight||parseFloat(this.element.getAttribute("height")||"0"),z(this.element).remove(),this.Wf(this.readOnly,!0),this.element.style.top="0px",this.element.style.left="0px",this.wj("transformOrigin","top left"),this.log("element height: %s, %s",this.element.offsetWidth,this.element.offsetHeight),this.Ic.Rf(this.id))};a.prototype.en=function(){return this.element};a.prototype.wj=function(a,d){if(null!==this.element){for(var b=a.charAt(0).toUpperCase()+a.substr(1),c=["ms","Webkit",
"O","Moz"],g=0;g<c.length;g++)this.element.style[c[g]+b]=d;this.element.style[a]=d}};a.prototype.he=function(a){L.prototype.he.call(this,a);this.element&&(this.element.style.visibility=this.yh?"hidden":"visible")};a.prototype.Wf=function(a,d){void 0===d&&(d=!1);if(d||this.readOnly!==a)this.readOnly=a,this.element&&this.Ic&&this.tb&&(z(this.element).pk(this.Ic.canvas),this.element.style.pointerEvents=a?"auto":"none")};a.prototype.format=function(a,d){var b=this;null===this.element&&this.Rh!==this.ka("data")&&
d&&(this.Rh=this.ka("data"),this.Ic=d,this.log("DomNode %s requests conversion to DOM element",this.id),this.Ic.Xp(this.Rh,this.id));if(this.element){var c=this.Wd;c=c.multiply(this.Ea());c.Lr()?(this.wj("transform",""),this.element.style.left=""+c.Ca+"px",this.element.style.top=""+c.Da+"px"):(this.element.style.left="0px",this.element.style.top="0px",this.wj("transform","matrix("+c.m11+","+c.m21+","+c.m12+","+c.m22+","+c.Ca+","+c.Da+")"));this.rect.x=0;this.rect.y=0;this.rect.width=this.width;this.rect.height=
this.height;this.element.style.visibility=this.yh?"hidden":"visible"}else this.rect.x=0,this.rect.y=0,this.rect.width=100,this.rect.height=22;this.uc=new Tb(this.rect);this.Oa=this.rect.clone();this.rect.transform(this.Ea());this.uc.transform(this.Ea());if(c=this.aa.border)this.rect.ed(c),this.nk=this.uc.clone(),this.nk.ed(c/2),this.uc.ed(c);!this.aa.preview||null!==this.fc&&this.fc.src===this.aa.preview?this.aa.preview||(this.fc=null):(this.log("Requesting new preview image for %s",this.aa.preview),
this.fc=document.createElement("img"),this.fc.src=this.aa.preview,this.fc.onload=function(){b.log("Preview image loaded.");d.Rf(b.id)},this.fc.onerror=function(){b.log("FAiled to load preview image")})};a.prototype.pe=function(a){var b=a.Qo;b&&this.Ic&&(b.m11!==this.Wd.m11||b.m21!==this.Wd.m21||b.m12!==this.Wd.m12||b.m22!==this.Wd.m22||b.Ca!==this.Wd.Ca||b.Da!==this.Wd.Da)&&(this.log("Moving DOM element as result of draw zooming"),this.Wd=b,this.format(a,this.Ic));if(this.element){if(b=this.aa.border){var e=
this.nk;a.setTransform(1,0,0,1,0,0);a.beginPath();a.lineWidth=b;a.strokeStyle="#cccccc";a.moveTo(e.la[0].x,e.la[0].y);a.lineTo(e.la[1].x,e.la[1].y);a.lineTo(e.la[2].x,e.la[2].y);a.lineTo(e.la[3].x,e.la[3].y);a.lineTo(e.la[0].x,e.la[0].y);a.closePath();a.stroke()}}else a.beginPath(),a.lineWidth=1,a.fillStyle="#888888",a.strokeStyle="#CCCCCC",a.rect(0,0,100,22),a.stroke(),a.font="20px Arial",a.textBaseline="top",a.fillText("DomNode",0,0);if(this.fc&&this.fc.naturalHeight){this.log("Drawing preview image %s,%s ->%s,s",
this.fc.naturalWidth,this.fc.naturalHeight,this.width,this.height);try{a.drawImage(this.fc,0,0,this.fc.naturalWidth,this.fc.naturalHeight,0,0,this.width,this.height)}catch(f){this.log("Tried to draw image, got error: %s",f.toString())}}};a.prototype.xb=function(a,d){return!this.aa.locked&&this.rect.Wc(a,d)&&this.uc.Wc(a,d,3)?this:null};a.prototype.Gk=function(){this.element&&this.Ic&&(this.log("Added DOM NODE %s",this.id),z(this.element).pk(this.Ic.canvas),this.element.style.pointerEvents=this.readOnly?
"auto":"none");this.tb=!0};a.prototype.Jk=function(){this.log("Removed DOM NODE %s",this.id);this.element&&z(this.element).remove();this.tb=!1};return a}(L);L.md("DomNode",dc);var ec=function(c){function a(a,d){var b=c.call(this,a,d)||this;b.children=[];return b}n(a,c);a.prototype.type=function(){return"GroupNode"};a.prototype.clone=function(b){for(var d=new a(b(),this.ea),e=0;e<this.children.length;e++){var c=this.children[e].clone(b);c.parent=d;d.children.push(c)}return d};a.prototype.format=function(a,d){for(var b=0;b<this.children.length;b++)this.children[b].format(a,d),0===b?this.rect=this.children[b].rect.clone():this.rect.nh(this.children[b].rect)};a.prototype.ha=
function(a){for(var b=0;b<this.children.length;b++)this.children[b].ha(a)};a.prototype.xb=function(a,d){for(var b=this.children.length-1;0<=b;b--){var c=this.children[b].xb(a,d);if(c)return c}return null};a.prototype.Xj=function(a){for(var b=0;b<this.children.length;b++)if(a===this.children[b])return b;return-1};return a}(L);L.md("GroupNode",ec);var fc=function(c){function a(a,d){var b=c.call(this,a,d)||this;b.xc=null;b.Zc=null;b.width=100;b.height=20;b.uc=new Tb;b.De=[];b.Kc=new D(0,0,b.width,b.height);b.bc=new D(0,0,b.width,b.height);b.log=w.create("IMAGE",!0);delete b.aa.fillStyle;delete b.aa.strokeStyle;delete b.aa.lineWidth;b.aa.url="";return b}n(a,c);a.prototype.type=function(){return"ImageNode"};a.prototype.setProperty=function(a,d){c.prototype.setProperty.call(this,a,d);switch(a){case "url":this.Zc=this.xc=null;break;case "brightness":case "contrast":case "gamma":this.Zc=
null;this.aa[a]=d;break;case "allowCrop":case "crop":case "blendMode":case "opacity":case "width":case "height":this.aa[a]=d}};a.prototype.Ys=function(a){a.x=Math.max(a.x,0);a.y=Math.max(a.y,0);a.width=Math.min(a.width,this.Kc.width);a.height=Math.min(a.height,this.Kc.height);a.width=Math.max(1,a.width);a.height=Math.max(1,a.height);this.aa.crop=[a.x,a.y,a.width,a.height].join()};a.prototype.bn=function(){var a=this.aa.crop,d=new D(0,0,this.Kc.width,this.Kc.height);a&&(a=a.split(","),d.x=parseFloat(a[0])|
0,d.y=parseFloat(a[1])|0,d.width=parseFloat(a[2])|0,d.height=parseFloat(a[3])|0);return d};a.prototype.Qs=function(){var a={brightness:this.ka("brightness"),contrast:this.ka("contrast"),gamma:this.ka("gamma")};this.Zc=void 0!==a.brightness&&void 0!==a.contrast&&void 0!==a.gamma&&this.xc?this.Aq(this.xc,a)||this.xc:this.xc};a.prototype.format=function(a,d){function b(a,b,d){l.De.push({x:l.bc.x+a*l.bc.width,y:l.bc.y+b*l.bc.height,Ad:d})}var c=this;null===this.xc&&"ImageSurface"in window?(this.xc=new window.ImageSurface(this.aa.url),
this.Kc=new D(0,0,this.xc.width,this.xc.height)):null===this.xc?(this.Kc=new D(0,0,this.width,this.height),d.add(this.id,"image",this.aa.url,null,function(a){c.log("Got image response.");c.xc=a;return d.Rf(c.id)})):this.Kc=new D(0,0,this.xc.width,this.xc.height);if(null===this.Zc&&(this.Qs(),this.Zc)){var g=this.ka("width"),h=this.ka("height");this.log("Override width/height as %s/%s",g,h);g&&(this.Zc.style.width=g+"px");h&&(this.Zc.style.height=h+"px")}this.bc=this.bn();this.rect=this.bc.clone();
if(g=this.ka("boundingPolygon")){h=[];for(var k=0;k<g.length;k+=2)h.push(new A(g[k],g[k+1]));this.uc=new Tb(h)}else this.uc=new Tb(this.rect);this.Oa=this.rect.clone();this.uc.transform(this.aa.matrix);this.rect.transform(this.aa.matrix);this.De.length=0;var l=this;b(.5,0,!0);b(1,.5,!1);b(.5,1,!0);b(0,.5,!1)};a.prototype.Zm=function(){return this.uc};a.prototype.xb=function(a,d){return!this.aa.locked&&this.uc.Wc(a,d,3)?this:null};a.prototype.pe=function(b){var d,e,c=!1;if(this.Zc)try{var g=b.globalCompositeOperation,
h=b.globalAlpha,k=this.ka("blendMode"),l=this.ka("opacity");k&&(b.globalCompositeOperation=""+k,this.log("Using globalCompsiteOperation=%s (requested %s)",b.globalCompositeOperation,k));void 0!==l&&(b.globalAlpha=l);var m=this.ka("lineWidth")||0;if(m){b.save();this.wd().bg(b);var q=this.uc.clone();q.ed(m/2);b.beginPath();q.ha(b);b.lineWidth=m;b.strokeStyle=this.ka("strokeStyle")||"#000000";b.stroke();b.restore()}b.drawImage(this.Zc,this.bc.x,this.bc.y,this.bc.width,this.bc.height,this.bc.x,this.bc.y,
this.bc.width,this.bc.height);b.globalAlpha=h;b.globalCompositeOperation=g;if(a.Nl){var p=this.uc.la;b.save();b.setTransform(1,0,0,1,0,0);b.beginPath();b.lineWidth=2;b.strokeStyle="#000000";b.moveTo(p[0].x,p[0].y);var t=d=1;for(e=p.length-1;d<=e;t=d+=1)b.lineTo(p[t].x,p[t].y);b.closePath();b.stroke();b.restore()}}catch(r){this.log("Error drawing image: %s",r.message),c=r}if(null===this.Zc||c)b.save(),b.lineWidth=1,b.strokeStyle="#cccccc",b.strokeRect(0,0,this.width,this.height),b.restore()};a.prototype.Fg=
function(){return!0===this.ka("allowCrop")&&!0!==this.ka("lockEditMode")};a.prototype.Xh=function(a,d){a.save();a.beginPath();a.lineWidth=1*d;a.strokeStyle="#0050B7";for(var b=this.Ea(),c=0;c<this.De.length;c++){var g=this.De[c],h=b.apply(g.x,g.y),k;if(g.Ad){var l=20;var m=k=0;var q=3;g=h.x-10;h=h.y-6}else l=0,k=20,m=3,q=0,g=h.x-6,h=h.y-10;for(var p=0;5>p;p++)a.moveTo(g,h),a.lineTo(g+l*d,h+k*d),g+=m*d,h+=q*d}a.stroke();a.restore()};a.prototype.pi=function(a,d,e){var b=this.Ea();e*=10;for(var c=0;c<
this.De.length;c++){var h=this.De[c];h=b.apply(h.x,h.y);if(h.x-e<=a&&a<h.x+e&&h.y-e<=d&&d<h.y+e)return c}return null};a.prototype.di=function(a){a=this.De[a];return this.Ea().apply(a.x,a.y)};a.prototype.Ne=function(a,d,e){var b=this.bn();d=this.wd().apply(d,e);d.x=Math.round(d.x);d.y=Math.round(d.y);0===a&&0<=d.y&&d.y<this.Kc.height?(b.height-=d.y-b.y,b.y=d.y):1===a&&0<=d.x&&d.x<this.Kc.width?b.width=d.x-b.x:2===a&&0<=d.y&&d.y<this.Kc.height?b.height=d.y-b.y:3===a&&0<=d.x&&d.x<this.Kc.width&&(b.width-=
d.x-b.x,b.x=d.x);this.Ys(b)};a.prototype.Aq=function(a,d){var b=a.width,c=a.height;if(!(a instanceof HTMLCanvasElement)){var g=document.createElement("canvas");g.width=b;g.height=c;g.getContext("2d").drawImage(a,0,0);a=g}g="number"===typeof d.brightness?d.brightness:-1;var h="number"===typeof d.contrast?d.contrast:-1,k="number"===typeof d.gamma?d.gamma:-1,l=document.createElement("canvas");this.log("filterSpec: %s",JSON.stringify(d));this.log("brightness=%s contrast=%s gamma=%s w=%s h=%s",g,h,k,b,
c);l.width=b+1;l.height=c;try{var m=a.getContext("2d").getImageData(0,0,b,c).data}catch(x){return this.log("Cannot filter external image."),null}b=l.getContext("2d").getImageData(0,0,b,c);c=b.data;for(var q=0;q<m.length;q+=4){var p=m[q]/255,t=m[q+1]/255,r=m[q+2]/255,v=m[q+3];0<=k&&(p=Math.pow(p,k),t=Math.pow(t,k),r=Math.pow(r,k));0<=g&&(p*=g,r*=g,t*=g);0<=h&&(p=p*h-.5*h+.5,t=t*h-.5*h+.5,r=r*h-.5*h+.5);c[q]=Math.min(255*p|0,255);c[q+1]=Math.min(255*t|0,255);c[q+2]=Math.min(255*r|0,255);c[q+3]=v}l.getContext("2d").putImageData(b,
0,0);return l};a.Nl=!1;return a}(L);L.md("ImageNode",fc);var gc=function(){function c(){this.text="";this.font="10px Arial";this.Vm="Arial";this.fontSize=10;this.lines=[];this.Cl="top";this.Eg="left";this.Dn=this.bold=!1;this.textDecoration="";this.log=w.create("TextBox");this.rect=new D(0,0,0,this.fontSize)}c.prototype.et=function(a,b,d,e,c){this.Vm=a;this.fontSize=b;this.bold=d;this.Dn=e;this.textDecoration=c};c.prototype.Bo=function(a){this.text=a};c.prototype.to=function(a,b){switch(a){case "left":case "center":case "right":this.Eg=a;break;case null:break;
default:this.log("Unknown alignment: %s",a)}switch(b){case "top":case "middle":case "bottom":this.Cl=b;break;case null:break;default:this.log("Unknnown alignment: %s",b)}};c.prototype.format=function(a,b,d){this.font=""+this.fontSize+'px "'+this.Vm+'"';this.bold&&(this.font="bold "+this.font);this.Dn&&(this.font="italic "+this.font);this.lines.length=0;var e;a.font=this.font;var c=0;this.rect.width=0;if(0===b){var g=this.text.split("\n");for(e=0;e<g.length;e++){var h=g[e];var k=a.measureText(h).width;
c+=this.fontSize;this.lines.push({x:0,y:c,width:k,text:h});this.rect.width=Math.max(this.rect.width,k)}}else{h=g=0;var l=!1;for(e=0;e<this.text.length;e++){var m=this.text.charAt(e);k=a.measureText(this.text.substr(g,e-g+1)).width;"\n"===m?l=!0:k>b?h?(e=h,l=!0):e>g&&(--e,l=!0):" "===m&&(h=e);l&&(k=" "===this.text.charAt(e)?a.measureText(this.text.substr(g,e-g)).width:a.measureText(this.text.substr(g,e-g+1)).width,c+=this.fontSize,this.lines.push({x:0,y:c,width:k,text:this.text.substr(g,e-g+1)}),g=
e+1,h=0,l=!1,this.rect.width=Math.max(this.rect.width,k))}k&&(c+=this.fontSize,this.lines.push({x:0,y:c,width:k,text:this.text.substr(g,e-g)}),this.rect.width=Math.max(this.rect.width,k))}this.rect.x=0;this.rect.y=0;this.rect.height=c;if("center"===this.Eg)for(e=0;e<this.lines.length;e++)a=this.lines[e],a.x=this.rect.width/2-a.width/2;else if("right"===this.Eg)for(e=0;e<this.lines.length;e++)a=this.lines[e],a.x=this.rect.width-a.width;b&&"center"===this.Eg?this.rect.x=b/2-this.rect.width/2:b&&"right"===
this.Eg&&(this.rect.x=b-this.rect.width);d&&"middle"===this.Cl?this.rect.y=d/2-this.rect.height/2:d&&"bottom"===this.Cl&&(this.rect.y=d-this.rect.height)};c.prototype.ha=function(a,b,d){this.fillText(a,b,d);this.Mm(a,b,d)};c.prototype.Mm=function(a,b,d){var e;if(0<=this.textDecoration.indexOf("underline")){a.save();a.beginPath();var c=1;for(e=0;e<this.lines.length;e++){var g=this.lines[e];a.moveTo(g.x+b,g.y+d+c);a.lineTo(g.x+b+g.width,g.y+d+c)}a.strokeStyle=a.fillStyle;a.lineWidth=1;a.stroke();a.beginPath();
a.restore()}if(0<=this.textDecoration.indexOf("line-through")){a.save();a.beginPath();c=.25*-this.fontSize;for(e=0;e<this.lines.length;e++)g=this.lines[e],a.moveTo(g.x+b,g.y+d+c),a.lineTo(g.x+b+g.width,g.y+d+c);a.strokeStyle=a.fillStyle;a.lineWidth=1;a.stroke();a.restore()}};c.prototype.fillText=function(a,b,d){a.textBaseline="alphabetic";a.font=this.font;for(var e=0;e<this.lines.length;e++){var c=this.lines[e];a.fillText(c.text,this.rect.x+c.x+b,this.rect.y+c.y+d)}};c.prototype.strokeText=function(a,
b,d){a.textBaseline="alphabetic";a.font=this.font;for(var e=0;e<this.lines.length;e++){var c=this.lines[e];a.strokeText(c.text,this.rect.x+c.x+b,this.rect.y+c.y+d)}};return c}();var hc=function(c){function a(b,d){var e=c.call(this,b,d)||this;e.ib=new gc;e.mk=0;e.border={lineWidth:0,ze:"#000000"};e.log=w.create("TEXT",!0);e.Bj(a.ep);e.aa.text="lorum ipsum dolor";return e}n(a,c);a.prototype.type=function(){return"TextNode"};a.prototype.setProperty=function(a,d){this.aa[a]=this.Tm(a,d);"textFillStyle"===a?this.aa.fillStyle=d:"fillStyle"===a&&(this.aa.textFillStyle=d)};a.prototype.format=function(a){this.ib.et(this.aa.fontName,this.aa.fontSize,this.aa.bold,this.aa.italic,this.aa.textDecoration);
var b=this.aa.text;b.length&&10===b.charCodeAt(b.length-1)&&(b=b.substr(0,b.length-1));this.ib.Bo(b);var e=this.aa.matrix;b=e.apply(0,0);e=e.apply(1,0);b=b.vb(e);e=this.ka("wrap");var c=!1!==this.ka("scaleFont");this.ib.to(this.aa.textAlign,"top");e?(e=this.aa.baseWidth,void 0===e&&(this.ib.format(a,0,0),e=Math.max(this.ib.rect.width,10),500<e&&(e=500),this.aa.baseWidth=e,this.log("Formatting text for first time; baseWidth=%s",e)),b=Math.ceil(b*e),this.ib.format(a,b,0),a=this.ib.rect.height,this.Oa=
new D(0,0,e,a)):c?(this.ib.format(a,0,0),b=this.ib.rect.width,a=this.ib.rect.height,this.Oa=new D(0,-(0+this.ka("fontSize")),b,a)):(this.ib.format(a,0,0),b=this.ib.rect.width,a=this.ib.rect.height,this.Oa=new D(0,0,b,a));a=new Tb(this.Oa);a.transform(this.Ea());this.rect=a.Jp();this.mk=this.rect.height;this.rect.height+=1.3*this.aa.fontSize;a=this.ka("lineWidth")+0;this.rect.ed(a,a);this.border=this.aa.border?this.vs(this.aa.border):{lineWidth:0,ze:"#000000"}};a.prototype.vs=function(a){var b={lineWidth:0,
ze:"#000000"};a=a.split(" ");for(var e=0;e<a.length;e++){var c=parseFloat(a[e]);if(isNaN(c)){if(c=u.bi(a[e]))b.ze=c.toString()}else b.lineWidth=c}return b};a.prototype.Ea=function(){return!1===this.ka("scaleFont")?c.prototype.Ea.call(this).Ko():c.prototype.Ea.call(this)};a.prototype.ha=function(a){if(0!==this.aa.text.length){a.save();this.Tg(a);this.ka("wrap")?this.Ea().Ko().bg(a):this.Ea().bg(a);"opacity"in this.aa&&(a.globalAlpha=this.aa.opacity);var b=this.aa.background;if(b||this.border.lineWidth)a.save(),
b&&(a.fillStyle=b,a.fillRect(this.Oa.x,this.Oa.y,this.Oa.width,this.Oa.height)),this.border.lineWidth&&(a.beginPath(),a.strokeStyle=this.border.ze,a.lineWidth=this.border.lineWidth,a.rect(this.Oa.x,this.Oa.y,this.Oa.width,this.Oa.height),a.stroke()),a.restore();a.strokeStyle=this.aa.strokeStyle;a.fillStyle=this.aa.fillStyle;a.lineWidth=this.aa.lineWidth;b=0;this.aa.wrap||!1===this.ka("scaleFont")||(b=-(0+this.ka("fontSize")));var e=this.Ea().yd();e=this.Oa.height*e.y;switch(this.aa.verticalAlign){case "bottom":b+=
e-this.ib.rect.height;break;case "middle":b+=(e-this.ib.rect.height)/2}this.aa.shadow&&(a.shadowOffsetX=3,a.shadowOffsetY=3,a.shadowBlur=5,a.shadowColor="rgba(0,0,0,0.5)");0<this.aa.lineWidth&&this.ib.strokeText(a,0,b);this.ib.fillText(a,0,b);this.ib.Mm(a,0,b);this.Sg(a);a.restore();L.Ol&&(a.save(),a.beginPath(),a.lineWidth=1,a.strokeStyle="#ff8000",a.rect(this.rect.x,this.rect.y,this.rect.width,this.rect.height),a.stroke(),a.restore())}};a.ep={textFillStyle:"#000000",fontName:"Arial",fontSize:20,
lineWidth:0,fillStyle:"#000000",wrap:!1,textAlign:"left",bold:!1,italic:!1,background:"rgba(0,0,0,0.0)",textDecoration:""};return a}(L);L.md("TextNode",hc);var ic=function(){function c(a,b){this.na=a;this.ga=b;this.rt=!0;this.log=w.create("MoveSegment")}c.prototype.ha=function(a){a.moveTo(this.ga.x,this.ga.y)};c.prototype.Jd=function(){return this.pc()};c.prototype.pc=function(){return{x:1,y:0}};return c}(),jc=function(){function c(a,b,d,e,c){this.na=a;this.ga=b;this.el=e;this.Id=c;this.log=w.create("LineSegment");this.df=0;this.ya=new A(0,0);this.Fa=new A(0,0);this.length=0;this.from=new A(0,0);this.ga=b;this.na=a;this.Id=c;this.el=e;d.next();this.Ii=
d.next();this.Ji=d.next();this.moveTo=this.ef=null;this.format()}c.prototype.format=function(){var a=B(this.na.ga.x,this.na.ga.y,this.ga.x,this.ga.y);this.df=this.length=a;var b=this.na.ga.clone();this.na instanceof c&&this.Id&&(this.Id=Math.min(this.Id,a/2,this.na.length/2),a=C(this.na.ga.x,this.na.ga.y,this.ga.x,this.ga.y),b.x+=a.x*this.Id,b.y+=a.y*this.Id,this.na.mt(this.Id),this.df-=this.Id);this.from=b;null===this.ef&&(this.ef=this.ga);a=this.df/10*this.el;10<a&&(a=10);var d=b.x,e=b.y,f=this.ga.x,
g=this.ga.y;d+=a;e+=a;this.ya=new A(d+this.Ii*(f+a-d),e+this.Ii*(g+a-e));d=b.x-a;f=this.ga.x-a;e=b.y-a;g=this.ga.y-a;this.Fa=new A(d+this.Ji*(f-d),e+this.Ji*(g-e))};c.prototype.mt=function(a){var b=C(this.from.x,this.from.y,this.ga.x,this.ga.y),d=this.ga.clone();d.x-=b.x*a;d.y-=b.y*a;this.ef=d;this.df-=a;a=this.df/10*this.el;10<a&&(a=10);b=this.from.x;var e=this.from.y,c=d.x,g=d.y;b+=a;e+=a;this.ya=new A(b+this.Ii*(c+a-b),e+this.Ii*(g+a-e));this.log("RECALC ctrl1=%s",this.ya);b=this.from.x-a;c=d.x-
a;e=this.from.y-a;g=d.y-a;this.Fa=new A(b+this.Ji*(c-b),e+this.Ji*(g-e))};c.prototype.$g=function(a){this.na=a;this.format();this.na instanceof c&&(this.moveTo=this.na.ef)};c.prototype.ha=function(a){null!==this.ef&&(this.Id&&(this.moveTo&&a.moveTo(this.moveTo.x,this.moveTo.y),a.quadraticCurveTo(this.na.ga.x,this.na.ga.y,this.from.x,this.from.y)),a.bezierCurveTo(this.ya.x,this.ya.y,this.Fa.x,this.Fa.y,this.ef.x,this.ef.y))};c.prototype.Jd=function(){return this.na?C(this.na.ga.x,this.na.ga.y,this.ya.x,
this.ya.y):this.pc()};c.prototype.pc=function(){return C(this.Fa.x,this.Fa.y,this.ga.x,this.ga.y)};return c}(),kc=function(){function c(a,b,d){this.fl=d;this.ga=b;this.na=a;this.fl=d;var e=B(a.ga.x,a.ga.y,b.x,b.y);e||(e=1);var c=(b.x-a.ga.x)/e,g=(b.y-a.ga.y)/e;this.Fa=new A(b.x-e*d*c,b.y-e*d*g);if((b=a.Fa)&&a.na){var h=C(a.na.ga.x,a.na.ga.y,a.ga.x,a.ga.y),k=B(a.na.ga.x,a.na.ga.y,a.ga.x,a.ga.y);c=.5*(c+h.x);g=.5*(g+h.y);b.x=a.ga.x-k*d*c;b.y=a.ga.y-k*d*g}this.ya=new A(a.ga.x+e*d*c,a.ga.y+e*d*g);this.length=
e}c.prototype.$g=function(a){this.na=a;var b=a.Fa,d=(this.ga.x-a.ga.x)/this.length,e=(this.ga.y-a.ga.y)/this.length,c=this.fl;if(b&&a.na){var g=C(a.na.ga.x,a.na.ga.y,a.ga.x,a.ga.y),h=B(a.na.ga.x,a.na.ga.y,a.ga.x,a.ga.y);d=.5*(d+g.x);e=.5*(e+g.y);b.x=a.ga.x-h*c*d;b.y=a.ga.y-h*c*e}this.ya=new A(a.ga.x+this.length*c*d,a.ga.y+this.length*c*e)};c.prototype.ha=function(a){a.bezierCurveTo(this.ya.x,this.ya.y,this.Fa.x,this.Fa.y,this.ga.x,this.ga.y)};c.prototype.Jd=function(){return this.na?C(this.na.ga.x,
this.na.ga.y,this.ya.x,this.ya.y):{x:1,y:0}};c.prototype.pc=function(){return 0<this.fl?C(this.Fa.x,this.Fa.y,this.ga.x,this.ga.y):C(this.na.ga.x,this.na.ga.y,this.ga.x,this.ga.y)};return c}(),lc=function(){function c(a,b,d){this.na=a;this.control=b;this.ga=d}c.prototype.ha=function(a){a.quadraticCurveTo(this.control.x,this.control.y,this.ga.x,this.ga.y)};c.prototype.Jd=function(){return this.na?C(this.na.ga.x,this.na.ga.y,this.control.x,this.control.y):{x:1,y:0}};c.prototype.pc=function(){return C(this.control.x,
this.control.y,this.ga.x,this.ga.y)};return c}(),mc=function(){function c(a,b,d,e){this.na=a;this.control=b;this.ga=d;this.Gd=e}c.prototype.ha=function(a){a.arcTo(this.control.x,this.control.y,this.ga.x,this.ga.y,this.Gd)};c.prototype.Jd=function(){return{x:1,y:0}};c.prototype.pc=function(){return C(0,0,1,0)};return c}(),nc=function(){function c(a,b,d,e,c,g,h){this.na=a;this.Vc=b;this.ga=d;this.Gd=e;this.il=c;this.vq=g;this.aq=h}c.prototype.ha=function(a){a.arc(this.Vc.x,this.Vc.y,this.Gd,this.il,
this.vq,0!==this.aq)};c.prototype.Jd=function(){return{x:1,y:0}};c.prototype.pc=function(){return C(0,0,1,0)};return c}(),oc=function(){function c(a,b,d,e){this.ya=b;this.Fa=d;this.ya=b;this.Fa=d;this.ga=e;this.na=a}c.prototype.ha=function(a){a.bezierCurveTo(this.ya.x,this.ya.y,this.Fa.x,this.Fa.y,this.ga.x,this.ga.y)};c.prototype.Jd=function(){return this.na?C(this.na.ga.x,this.na.ga.y,this.ya.x,this.ya.y):{x:1,y:0}};c.prototype.pc=function(){return C(this.Fa.x,this.Fa.y,this.ga.x,this.ga.y)};return c}(),
pc=function(){function c(a,b,d,e){this.na=a;this.ya=b;this.Fa=d;this.ga=e}c.prototype.ha=function(a){if(this.na){var b=[];this.na.Fa&&b.push(this.na.Fa);this.ya&&b.push(this.ya);2===b.length?a.bezierCurveTo(b[0].x,b[0].y,b[1].x,b[1].y,this.ga.x,this.ga.y):1===b.length&&a.quadraticCurveTo(b[0].x,b[0].y,this.ga.x,this.ga.y)}};c.prototype.$g=function(a){this.na=a};c.prototype.Jd=function(){return this.na&&this.na.Fa?C(this.na.ga.x,this.na.ga.y,this.ya.x,this.ya.y):{x:1,y:0}};c.prototype.pc=function(){return this.ya?
C(this.ya.x,this.ya.y,this.ga.x,this.ga.y):{x:1,y:0}};return c}(),qc=function(){function c(a,b,d,e,c){this.na=a;this.ng=b;this.ga=d;this.log=w.create("SEGMENT");this.na=a;this.ng=b;c*=2;var f=2*e.next()-1;e.next();e=this.na.pc();if(!this.na.rt&&e){var h=B(a.ga.x,a.ga.y,b.x,b.y);this.ya=new A(a.ga.x+.5522847498*e.x*h,a.ga.y+.5522847498*e.y*h)}else this.ya=new A(a.ga.x+.5522847498*(b.x-a.ga.x),a.ga.y+.5522847498*(b.y-a.ga.y));this.Fa=new A(d.x-.5522847498*(d.x-b.x)*(1-f*c),d.y-.5522847498*(d.y-b.y)*
(1-f*c));this.ga=d}c.prototype.$g=function(a){this.na=a;var b=this.na.pc();if(b){var d=B(a.ga.x,a.ga.y,this.ng.x,this.ng.y);this.ya=new A(a.ga.x+.5522847498*b.x*d,a.ga.y+.5522847498*b.y*d)}else this.ya=new A(a.ga.x+.5522847498*(this.ng.x-this.na.ga.x),a.ga.y+.5522847498*(this.ng.y-this.na.ga.y))};c.prototype.ha=function(a){a.bezierCurveTo(this.ya.x,this.ya.y,this.Fa.x,this.Fa.y,this.ga.x,this.ga.y)};c.prototype.Jd=function(){return this.na?C(this.na.ga.x,this.na.ga.y,this.ya.x,this.ya.y):{x:1,y:0}};
c.prototype.pc=function(){return C(this.Fa.x,this.Fa.y,this.ga.x,this.ga.y)};return c}();var rc=function(){function c(a){this.Kg=this.Jg=0;if("string"===typeof a){for(;8>a.length;)a+=a;for(var b=16777619,d=0;d<a.length;d++)b=(16777619*b^a.charCodeAt(d))&4294967295;a=b}this.ro=a;this.reset()}c.prototype.reset=function(){this.Kg=this.Jg=this.ro};c.prototype.next=function(){this.Kg=36969*(this.Kg&65535)+(this.Kg>>16);this.Jg=18E3*(this.Jg&65535)+(this.Jg>>16);return((this.Kg<<16)+this.Jg)/4294967295/2+.5};return c}();var sc=function(){function c(a){this.tc=a;this.Hh=[];this.Qk=!0;this.log=w.create("cloudAddon");this.Gd=a.ka("cloudRadius")}c.prototype.format=function(){var a=this.tc.Oc.ag();this.log("Format cloud; %s points",a.length);this.Hh=this.Tp(a,this.Gd)};c.prototype.Tp=function(a,b){var d=[],e=5/6*b*2,c,g=a[a.length-1];for(c=0;c<a.length;c++){var h=a[c];var k=h.x-g.x,l=h.y-g.y,m=Math.sqrt(k*k+l*l);k/=m;l/=m;var q=m/e+.5|0;1>q&&(q=1);q=m/q;for(var p=0;p+.1*q<m;p+=q)d.push({x:g.x+p*k,y:g.y+p*l,xm:0,end:0});
g=h}h=d[d.length-1];for(c=0;c<d.length;c++)e=d[c],k=e.x-h.x,l=e.y-h.y,g=.5*Math.sqrt(k*k+l*l)/b,-1>g&&(g=-1),1<g&&(g=1),k=Math.atan2(l,k),g=Math.acos(g),g=[k-g,Math.PI+k+g],h.end=g[0],e.xm=g[1],h=e;return d};c.prototype.ha=function(a){this.log("Drawing cloud with %s circles",this.Hh.length);var b=15*Math.PI/180,d=this.Gd;a.beginPath();for(var e=0;e<this.Hh.length;e++){var c=this.Hh[e];a.arc(c.x,c.y,d,c.xm,c.end+b)}a.stroke()};return c}();var tc=function(){function c(a){this.tc=a;this.Gd=0;this.Qk=!0;this.mi=!1;this.path=new H;this.Hi=new H;this.log=w.create("DoubleLineAddon")}c.prototype.format=function(){this.log("Formatting doubleline; thickness=%s",this.tc.ka("doubleLine"));var a=this.tc.Dj(!1).rl(Q.jj),b=this.tc.Rq();if(0<b){var d=a.Kp();d>b&&(a=a.Mp(d-b))}a=a.ag();b=this.tc.ka("doubleLine");this.path=new H;this.Hi=new H;d=this.tc.ka("doubleLineDashSide");this.mi=!1;"outer"===d?(Wb(this.path,a,b,!0,!1),Wb(this.Hi,a,b,!1,!0),this.mi=
!0):"inner"===d?(Wb(this.path,a,b,!1,!0),Wb(this.Hi,a,b,!0,!1),this.mi=!0):Wb(this.path,a,b,!0,!0)};c.prototype.ha=function(a){a.beginPath();this.tc.cc.length&&this.mi?(this.Hi.Wh(a,this.tc.cc),this.path.ha(a)):this.tc.cc.length?this.path.Wh(a,this.tc.cc):this.path.ha(a)};return c}();var uc=function(){function c(a){this.la=a;this.n=0;this.mb=new A(0,0)}c.prototype.next=function(a){if(0===this.la.length)return null;if(0===this.n)return this.mb=this.la[0].clone(),this.n+=1,this.mb.clone();for(;this.n<this.la.length;){var b=this.mb.vb(this.la[this.n]);if(0===b)this.n+=1;else if(b<=a)a-=b,this.n+=1;else return this.mb.x+=(this.la[this.n].x-this.mb.x)*a/b,this.mb.y+=(this.la[this.n].y-this.mb.y)*a/b,this.mb.clone()}return null};return c}(),vc=function(){function c(a){this.tc=a;this.Qk=
!0;this.la=[];this.log=w.create("WaveAddon");this.Gd=a.ka("waveRadius")}c.prototype.format=function(){var a=this.tc.Dj(!1).rl(Q.jj).ag();this.log("Format cloud; %s points",a.length);this.la=this.St(a,this.Gd)};c.prototype.St=function(a,b){var d=new uc(a),e=1,c=[];if(2>a.length)return c;var g=0;for(var h=1;h<a.length;h++)g+=B(a[h-1].x,a[h-1].y,a[h].x,a[h].y);b=g/Math.round(g/(2*b)+.5)/2;for(g=[];;){h=d.next(2*b);if(!h)break;g.push(h)}g.push(a[a.length-1]);var k=g[0];c.push(k);for(d=1;d<g.length;d++){h=
g[d];var l=C(k.x,k.y,h.x,h.y);var m=b,q=new A(l.y*e,-1*l.x*e);k=new A(k.x+(l.x+q.x)*m,k.y+(l.y+q.y)*m);c.push(k);c.push(h);e*=-1;k=h}for(d=2;d<c.length-1;d+=2)e=c[d-1],g=c[d+1],c[d].x=e.x+(g.x-e.x)/2,c[d].y=e.y+(g.y-e.y)/2;return c};c.prototype.ha=function(a){a.beginPath();a.moveTo(this.la[0].x,this.la[0].y);for(var b=1;b<this.la.length-1;b+=2)a.quadraticCurveTo(this.la[b].x,this.la[b].y,this.la[b+1].x,this.la[b+1].y)};return c}();var Q=function(c){function a(b,d){var e=c.call(this,b,d)||this;e.qa=[];e.xf=0;e.Rc=[];e.gl=[];e.Ho=!1;e.inverse=new F;e.origin=new A(0,0);e.cc=[];e.Oc=new H;e.qn=!1;e.backgroundImage=null;e.log=w.create("PATHNODE");e.log("New PathNode Created");e.Eb=new hc(0,d);e.Eb.setProperty("text",e.aa.text);e.Bj(a.wa);e.aa.closed=!1;e.aa.commands=[];e.aa.seed=0;return e}n(a,c);a.prototype.moveTo=function(b,d){var e=this.aa.commands;e.push(a.pf);e.push(b);e.push(d)};a.prototype.Hp=function(b,d,e,c,g,h){var f=
this.aa.commands;f.push(a.eg);f.push(g);f.push(h);f.push(b);f.push(d);f.push(e);f.push(c)};a.prototype.type=function(){return"PathNode"};a.prototype.ni=function(){return!0};a.prototype.setProperty=function(a,d){c.prototype.setProperty.call(this,a,d);switch(a){case "bold":case "fontName":case "fontSize":case "italic":case "text":case "textAlign":case "textDecoration":case "wrap":this.aa[a]=d;this.Eb.setProperty(a,d);break;case "textFillStyle":this.Eb.setProperty("fillStyle",d);this.aa[a]=d;break;case "textBackground":this.Eb.setProperty("background",
d);this.aa[a]=d;break;case "cloudRadius":case "waveRadius":case "doubleLine":case "doubleLineDashSide":case "spotHighlight":case "verticalAlign":this.aa[a]=d;break;case "backgroundImage":this.aa[a]=d,this.backgroundImage=null}};a.prototype.di=function(b){for(var d=0,e=this.aa.commands,c=b/3|0,g=0;g<c;g++)d+=a.Xa[e[d]]+1;g=b%3*2+1;c=e[d+g];d=e[d+g+1];this.log("getEditHandle(%s) = (%s, %s)",b,c,d);return this.Ea().apply(c,d)};a.prototype.Ne=function(b,d,e){for(var c=0,g=this.aa.commands,h=b/3|0,k=0;k<
h;k++)c+=a.Xa[g[c]]+1;h=this.inverse.apply(d,e);k=b%3*2+1;g[c+k]=h.x;g[c+k+1]=h.y;if(0===b&&this.aa.closed){for(b=null;c<g.length;)h=a.Xa[g[c]],2<=h&&(b=c),c+=h+1;b&&(c=b,h=this.inverse.apply(d,e),g[c+1]=h.x,g[c+2]=h.y)}};a.prototype.vd=function(){return"commands"};a.prototype.Ms=function(b){for(var d=this.aa.commands,e=0,c=0;c<b/3;c++)e+=a.Xa[d[e]]+1;d.splice(e,a.Xa[d[e]]+1)};a.prototype.Rq=function(){return this.ka("arrowXOffset")||this.ka("arrowSize")};a.prototype.format=function(b,d){var e=this,
c=null;this.qa.length=0;this.inverse=this.aa.matrix.inverse();var g=new A(0,0),h=this.aa.commands,k=null,l=this.aa.matrix,m=new rc(this.aa.seed);this.gl.length=0;for(var q=null,p=null,t=0;t<h.length;){switch(h[t++]){case a.pf:g=l.apply(h[t++],h[t++]);p=new ic(k,g);this.qa.push(p);null===c&&(c=g);this.gl.push(g);q=null;break;case a.Od:k&&(g=l.apply(h[t++],h[t++]),this.qa.push(new jc(k,g,m,this.aa.sloppiness,this.aa.roundRadius)),this.gl.push(g));break;case a.qf:if(k){g=l.apply(h[t++],h[t++]);var r=
l.apply(h[t++],h[t++]);this.qa.push(new lc(k,r,g))}break;case a.ij:if(k){g=l.apply(h[t++],h[t++]);r=l.apply(h[t++],h[t++]);var v=h[t++];this.qa.push(new mc(k,r,g,v))}break;case a.hj:if(k){g=l.apply(h[t++],h[t++]);r=l.apply(h[t++],h[t++]);v=h[t++];var x=h[t++],I=h[t++],y=h[t++];this.qa.push(new nc(k,r,g,v,x,I,y))}break;case a.eg:k&&(g=l.apply(h[t++],h[t++]),v=l.apply(h[t++],h[t++]),r=l.apply(h[t++],h[t++]),this.qa.push(new oc(k,v,r,g)));break;case a.Wl:k&&(g=l.apply(h[t++],h[t++]),v=l.apply(h[t++],
h[t++]),r=l.apply(h[t++],h[t++]),this.qa.push(new pc(k,v,r,g)));break;case a.qh:k&&(g=l.apply(h[t++],h[t++]),this.qa.push(new kc(k,g,this.aa.smoothness)));break;case a.kj:k&&(g=l.apply(h[t++],h[t++]),v=l.apply(h[t++],h[t++]),this.qa.push(new qc(k,v,g,m,this.aa.sloppiness)));break;case a.hc:this.aa.closed=!0;q&&k&&q!==k&&q.$g&&p&&(q.$g(k),k.ga=p.ga);break;default:t++}k=this.qa[this.qa.length-1];null!==q||k instanceof ic||(q=k)}this.origin=c||new A(0,0);this.xf=this.qa.length;this.Kq(m);this.rect.x=
this.origin.x;this.rect.y=this.origin.y;this.rect.width=0;this.rect.height=0;c=this.aa.dashes.split(",");this.cc=[];for(t=0;t<c.length;t++)g=parseFloat(c[t]),isNaN(g)||this.cc.push(g);c=this.cc.length?a.jj:a.Ro;this.Oc=this.Dj(!0).rl(c);t=0+this.ka("shapeWidth");0<t&&(this.Oc=this.Zp(this.Oc,t));this.rect=this.Oc.zm(c);t=this.rect.width-2*(this.aa.lineWidth/2+1);g=this.aa.lineWidth;h=this.Oc.clone();h.transform(this.wd());this.Oa=h.zm(c);c=this.Ea().yd();this.Oa.ed(Math.ceil(g/c.x),Math.ceil(g/c.y));
this.rect.ed(g+1,g+1);8>this.rect.width&&(this.rect.x+=this.rect.width/2-4,this.rect.width=8);8>this.rect.height&&(this.rect.y+=this.rect.height/2-4,this.rect.height=8);if(""!==this.aa.text){c=this.rect.Vc();this.Eb.setProperty("textAlign",this.aa.textAlign||"center");this.Eb.setProperty("baseWidth",t);this.Eb.format(b,d);t=c.x-this.Eb.rect.x-this.Eb.rect.width/2;g=0;switch(this.aa.verticalAlign){default:case "middle":g=c.y-this.Eb.rect.y-this.Eb.mk/2;break;case "top":g=this.rect.y-this.Eb.rect.y;
break;case "bottom":g=this.rect.bottom()-this.Eb.mk-this.Eb.rect.y}this.Eb.transform(new E(t,g));this.Eb.format(b,d)}this.Ho=0===u.td(this.aa.fillStyle).values[3]&&!this.backgroundImage;this.Rc.length=0;0<this.aa.cloudRadius?this.Rc.push(new sc(this)):0<this.aa.waveRadius?this.Rc.push(new vc(this)):this.aa.doubleLine&&this.Rc.push(new tc(this));for(t=0;t<this.Rc.length;t++)this.Rc[t].format(b);(t=this.ka("backgroundImage"))&&null===this.backgroundImage&&d.add(this.id,"image",t,null,function(a){e.backgroundImage=
a;d.Rf(e.id)})};a.prototype.hi=function(){return this.Oc};a.prototype.Kq=function(a){function b(b,d){b=b.clone();k&&(b.x+=d.x*g*.5,b.y+=d.y*g*.5);var f=b.x-d.x*g;var l=b.y-d.y*g;var m=f+d.y*c/2;var q=l-d.x*c/2;f+=-d.y*c/2;l+=d.x*c/2;e.qa.push(new ic(e.qa[e.qa.length-1],new A(f,l)));e.qa.push(new kc(e.qa[e.qa.length-1],b,h));e.qa.push(new kc(e.qa[e.qa.length-1],new A(m,q),h));"solid"===e.aa.arrowStyle&&e.qa.push(new jc(e.qa[e.qa.length-1],new A(f,l),a,e.aa.smoothness,0))}if(this.qn=0<this.aa.arrowSize&&
!this.aa.closed&&0<this.qa.length){var e=this,c=this.aa.arrowSize,g=this.aa.arrowXOffset,h=this.aa.smoothness,k=this.aa.doubleLine;null===g&&(g=c);var l=this.qa[this.qa.length-1];b(l.ga,l.pc());this.aa.doubleArrow&&b(this.qa[0].ga,Jb(this.qa[1].Jd()))}};a.prototype.close=function(){this.aa.commands.push(a.hc)};a.prototype.Dp=function(){var a=this.qa[this.qa.length-1];8>=B(a.ga.x,a.ga.y,this.origin.x,this.origin.y)&&this.close()};a.prototype.Zp=function(a,d){this.log("ConvertToRects: width=%s",d);
for(var b=0,c=a.ba,g=0,h=0,k,l,m=new H;b<c.length;){this.log("cmd %s %s %s",c[b],c[b+1],c[b+2]);switch(c[b]){case H.jc:g=c[b+1];h=c[b+2];break;case H.ic:k=c[b+1];l=c[b+2];this.log("(%s,%s-%s,%s)",g,h,k,l);if(0<B(g,h,k,l)){var q=C(g,h,k,l),p=q.y*d/2;q=-q.x*d/2;m.moveTo(g+p,h+q);m.lineTo(k+p,l+q);m.lineTo(k-p,l-q);m.lineTo(g-p,h-q);m.closePath()}g=k;h=l}b+=H.kc[c[b]]}return m};a.prototype.clip=function(a){if(this.aa.closed){var b=new H;this.log("Clipping to a path");for(var e=0;e<this.qa.length;e++)this.qa[e].ha(b);
b.closePath();0>b.zp()&&(b=b.Os());b.ha(a)}};a.prototype.ha=function(a){this.aa.spotHighlight?this.log("Not drawing node %s due to spothighlight",this.id):c.prototype.ha.call(this,a)};a.prototype.pe=function(a){var b=this.inverse;a.save();a.lineJoin="round";a.transform(b.m11,b.m21,b.m12,b.m22,b.Ca,b.Da);a.beginPath();a.lineCap="round";b=!0;var e;for(e=0;e<this.Rc.length;e++)this.Rc[e].Qk&&(b=!1);if(b)for(e=0;e<this.qa.length;e++)this.qa[e].ha(a);for(e=0;e<this.Rc.length;e++)this.Rc[e].ha(a);if(!b&&
0<this.aa.arrowSize)for(e=this.xf;e<this.qa.length;e++)this.qa[e].ha(a);if(this.aa.closed){a.closePath();if(this.backgroundImage){a.fillStyle=a.createPattern(this.backgroundImage,"no-repeat")||"magenta";e=Math.max(this.rect.width/this.backgroundImage.naturalWidth,this.rect.height/this.backgroundImage.naturalHeight);var c=this.rect.width-this.backgroundImage.naturalWidth*e,g=this.rect.height-this.backgroundImage.naturalHeight*e;a.translate(this.rect.x+c/2,this.rect.y+g/2);a.scale(e,e);a.fill();a.scale(1/
e,1/e);a.translate(-this.rect.x-c/2,-this.rect.y-g/2)}else a.fill();a.shadowColor="rgba(0,0,0,0.0)"}b&&(this.cc.length&&0<this.aa.lineWidth?(a.beginPath(),this.Oc.Wh(a,this.cc),a.lineCap="butt"):0<0+this.ka("shapeWidth")&&(a.beginPath(),this.Oc.ha(a)));0<this.aa.lineWidth&&a.stroke();if(this.aa.arrowSize&&"solid"===this.aa.arrowStyle){a.beginPath();for(e=this.xf;e<this.qa.length;e++)this.qa[e].ha(a);a.fillStyle=this.aa.strokeStyle;a.fill()}""!==this.aa.text&&this.Eb.ha(a);a.restore()};a.prototype.xb=
function(a,d){if(this.hidden()||this.ka("locked"))return null;var b=12+this.aa.shapeWidth/2+this.aa.lineWidth/2;if(a>=this.rect.x-b&&a<this.rect.x+b+this.rect.width&&d>=this.rect.y-b&&d<this.rect.y+b+this.rect.height)if(this.aa.closed&&!this.Ho){if(this.Oc.xs(a,d))return this}else if(this.Oc.co(a,d,b)||""!==this.aa.text&&this.Eb.xb(a,d))return this;return null};a.prototype.Dj=function(a){var b=new H;if(0<this.aa.arrowSize&&!a)for(a=0;a<this.xf;a++)this.qa[a].ha(b);else for(a=0;a<this.qa.length;a++)this.qa[a].ha(b);
this.aa.closed&&b.closePath();return b};a.prototype.lineTo=function(b,d){var e=this.aa.commands;e.push(a.Od);e.push(b);e.push(d)};a.prototype.pg=function(b,d){var e=this.aa.commands;e.push(a.qh);e.push(b);e.push(d)};a.prototype.Fg=function(){return!1!==this.aa.editable&&!0!==this.aa.lockEditMode};a.prototype.pi=function(a,d,e){e*=8;if(a>=this.origin.x-e&&a<this.origin.x+e&&d>=this.origin.y-e&&d<this.origin.y+e)return 0;for(var b=0;b<this.xf;b++){var c=this.qa[b];if(a>=this.qa[b].ga.x-e&&a<this.qa[b].ga.x+
e&&d>=this.qa[b].ga.y-e&&d<this.qa[b].ga.y+e)return 3*b;if(c.control){if(a>=c.control.x-e&&a<c.control.x+e&&d>=c.control.y-e&&d<c.control.y+e)return 3*b+1}else if(c.ya){if(a>=c.ya.x-e&&a<c.ya.x+e&&d>=c.ya.y-e&&d<c.ya.y+e)return 3*b+1;if(c.Fa&&a>=c.Fa.x-e&&a<c.Fa.x+e&&d>=c.Fa.y-e&&d<c.Fa.y+e)return 3*b+2}}return null};a.prototype.ei=function(b){var d=this.aa.commands;b/=3;var e=0,c=!1,g=0,h;for(h=0;h<d.length;){var k=d[h];if(k===a.hc){c=!0;break}g+=1;h+=a.Xa[d[h]]+1}0===b&&c&&(b=g-1);for(h=0;h<d.length;e++){c=
null;switch(d[h]){case a.pf:c="move_to";break;case a.Od:c="line_to";break;case a.qf:c="quadratic_to"}if(b===e)return c;h+=a.Xa[d[h]]+1}return null};a.cp=function(b,d,e){d/=3;var c=0,g=[],h=new A(0,0),k=!1,l=0,m;for(m=0;m<b.length;){var q=b[m];if(q===a.hc){k=!0;break}l+=1;m+=a.Xa[b[m]]+1}0===d&&k&&(d=l-1);for(m=0;m<b.length;c++){q=b[m];k=!1;d===c&&(q===a.qf&&"line_to"===e?(g.push(a.Od,b[m+1],b[m+2]),k=!0):q===a.Od&&"quadratic_to"===e&&(g.push(a.qf,b[m+1],b[m+2],(h.x+b[m+1])/2,(h.y+b[m+2])/2),k=!0));
h=new A(b[m+1],b[m+2]);if(!k)for(q=0;q<1+a.Xa[b[m]];q++)g.push(b[m+q]);m+=a.Xa[b[m]]+1}return g};a.prototype.zn=function(){return!0};a.prototype.Xh=function(a,d,e){a.save();a.lineWidth=1*d;a.strokeStyle="#0050B7";a.fillStyle="#0050B7";d*=8;0===e?a.fillRect(this.origin.x-d,this.origin.y-d,2*d,2*d):a.strokeRect(this.origin.x-d,this.origin.y-d,2*d,2*d);for(var b=1;b<this.xf;b++){var c=this.qa[b];a.beginPath();if(c.control)a.arc(c.control.x,c.control.y,d,0,2*Math.PI),a.arc(c.control.x,c.control.y,2*d,
0,2*Math.PI),e===3*b+1?a.fill():a.stroke();else if(c instanceof oc||c instanceof pc){var h=c.ya;var k=c.Fa;var l=c.na.ga;h&&(a.moveTo(l.x,l.y),a.lineTo(h.x,h.y),a.moveTo(h.x+d,h.y),a.arc(h.x,h.y,d,0,2*Math.PI),e===3*b+1?a.fill():a.stroke());a.beginPath();a.moveTo(c.ga.x,c.ga.y);a.lineTo(k.x,k.y);a.moveTo(k.x+d,k.y);a.arc(k.x,k.y,d,0,2*Math.PI);e===3*b+2?a.fill():a.stroke()}e===3*b?a.fillRect(this.qa[b].ga.x-d,this.qa[b].ga.y-d,2*d,2*d):a.strokeRect(this.qa[b].ga.x-d,this.qa[b].ga.y-d,2*d,2*d)}a.restore()};
a.To=function(a){var b=new R,e=0;for(a=a.ba;e<a.length;){switch(a[e]){case H.jc:b.moveTo(a[e+1],a[e+2]);break;case H.ic:b.lineTo(a[e+1],a[e+2]);break;case H.Nd:b.bezierCurveTo(a[e+1],a[e+2],a[e+3],a[e+4],a[e+5],a[e+6]);break;case H.Pd:b.quadraticCurveTo(a[e+1],a[e+2],a[e+3],a[e+4]);break;case H.hc:b.close()}e+=H.kc[a[e]]}return b.Sb()};a.wa={strokeStyle:"#000000",fillStyle:"#ffffff",fontName:"Arial",fontSize:20,lineWidth:2,dashes:"",shapeWidth:0,smoothness:.3,sloppiness:0,shadow:!1,closed:!1,arrowSize:0,
arrowXOffset:null,arrowStyle:"simple",doubleArrow:!1,text:"",roundRadius:0,wrap:!1};a.Ro=8;a.jj=2;a.pf=0;a.Od=1;a.qf=2;a.ij=3;a.eg=4;a.qh=5;a.kj=6;a.hc=7;a.Wl=8;a.hj=9;a.du=.5522847498;a.Xa=[];return a}(L);Q.Xa[Q.pf]=2;Q.Xa[Q.Od]=2;Q.Xa[Q.qf]=4;Q.Xa[Q.ij]=5;Q.Xa[Q.eg]=6;Q.Xa[Q.qh]=2;Q.Xa[Q.kj]=4;Q.Xa[Q.hc]=0;Q.Xa[Q.Wl]=6;Q.Xa[Q.hj]=8;
var R=function(){function c(a){void 0===a&&(a=[]);this.ba=a}c.prototype.beginPath=function(){};c.prototype.we=function(a,b,d){for(var e=0,c=0;c<a;c++)e+=Q.Xa[this.ba[e]]+1;this.ba[e+1]=b;this.ba[e+2]=d};c.prototype.moveTo=function(a,b){this.ba.push(Q.pf);this.ba.push(a);this.ba.push(b)};c.prototype.lineTo=function(a,b){this.ba.push(Q.Od);this.ba.push(a);this.ba.push(b)};c.prototype.pg=function(a,b){this.ba.push(Q.qh);this.ba.push(a);this.ba.push(b)};c.prototype.quadraticCurveTo=function(a,b,d,e){this.ba.push(Q.qf);
this.ba.push(d);this.ba.push(e);this.ba.push(a);this.ba.push(b)};c.prototype.Be=function(a,b,d,e){this.ba.push(Q.kj);this.ba.push(d);this.ba.push(e);this.ba.push(a);this.ba.push(b)};c.prototype.bezierCurveTo=function(a,b,d,e,c,g){this.ba.push(Q.eg);this.ba.push(c);this.ba.push(g);this.ba.push(a);this.ba.push(b);this.ba.push(d);this.ba.push(e)};c.prototype.arc=function(a,b,d,e,c,g){void 0===g&&(g=!0);var f=(new Kb(-c,a,b)).apply(a+d,b);this.ba.push(Q.hj);this.ba.push(f.x);this.ba.push(f.y);this.ba.push(a);
this.ba.push(b);this.ba.push(d);this.ba.push(e);this.ba.push(c);this.ba.push(g?1:0)};c.prototype.arcTo=function(a,b,d,e,c){this.ba.push(Q.ij);this.ba.push(d);this.ba.push(e);this.ba.push(a);this.ba.push(b);this.ba.push(c)};c.prototype.Ym=function(){for(var a=[],b=0;b<this.ba.length;){for(var d=this.ba[b],e=0;e<Q.Xa[d];e+=2)a.push(new A(this.ba[b+1+e],this.ba[b+1+e+1]));b+=Q.Xa[d]+1}a=D.gg(a);return{x:a.x,y:a.y,width:a.width,height:a.height}};c.prototype.translate=function(a,b){for(var d=0;d<this.ba.length;){for(var e=
this.ba[d],c=0;c<Q.Xa[e];c+=2)this.ba[d+1+c]+=a,this.ba[d+2+c]+=b;d+=Q.Xa[e]+1}};c.prototype.closePath=function(){this.ba.push(Q.hc)};c.prototype.close=function(){this.closePath()};c.prototype.Sb=function(){return this.ba};return c}();R.prototype.change=R.prototype.we;R.prototype.moveTo=R.prototype.moveTo;R.prototype.lineTo=R.prototype.lineTo;R.prototype.curveTo=R.prototype.pg;R.prototype.quadraticCurveTo=R.prototype.quadraticCurveTo;R.prototype.cornerTo=R.prototype.Be;R.prototype.bezierCurveTo=R.prototype.bezierCurveTo;
R.prototype.arc=R.prototype.arc;R.prototype.arcTo=R.prototype.arcTo;R.prototype.getBoundingBox=R.prototype.Ym;R.prototype.translate=R.prototype.translate;R.prototype.closePath=R.prototype.closePath;R.prototype.close=R.prototype.close;R.prototype.toArray=R.prototype.Sb;L.md("PathNode",Q);R.prototype.beginPath=R.prototype.beginPath;R.prototype.change=R.prototype.we;R.prototype.moveTo=R.prototype.moveTo;R.prototype.lineTo=R.prototype.lineTo;R.prototype.curveTo=R.prototype.pg;
R.prototype.quadraticTo=R.prototype.tu;R.prototype.cornerTo=R.prototype.Be;R.prototype.bezierTo=R.prototype.Hp;R.prototype.arc=R.prototype.arc;R.prototype.arcTo=R.prototype.arcTo;R.prototype.getBoundingBox=R.prototype.Ym;R.prototype.translate=R.prototype.translate;R.prototype.closePath=R.prototype.closePath;R.prototype.close=R.prototype.close;R.prototype.toArray=R.prototype.Sb;var xc=function(){function c(){this.items=[];this.next=0;this.Td=!1;this.log=w.create("UNDOSTACK")}c.prototype.pa=function(a,b,d){void 0===b&&(b=!1);a=a instanceof wc?[a]:a;if(0!==a.length){this.next<this.items.length&&(this.items.length=this.next);if(!b)for(b=0;b<a.length;b++)a[b].wb(d);for(d=this.top();d;)if(d[d.length-1].Nn(a[0])){if(a.shift(),0===a.length)break}else break;a.length&&this.items.push(a);this.Td=!0;this.next=this.items.length}};c.prototype.kb=function(a){this.log("Undo index %s of %s",
this.next,this.items.length);if(this.od()){for(var b=this.items[--this.next],d=b.length-1;0<=d;d--)b[d].kb(a);return this.Td=!0}return!1};c.prototype.Hd=function(a){this.log("Redo index %s of %s",this.next,this.items.length);if(this.nd()){for(var b=this.items[this.next++],d=0;d<b.length;d++)b[d].wb(a);return this.Td=!0}return!1};c.prototype.od=function(){return 0<this.next};c.prototype.nd=function(){return this.next<this.items.length};c.prototype.clear=function(){this.next=this.items.length=0;this.Td=
!1};c.prototype.top=function(){return this.items.length?this.items[this.items.length-1]:null};return c}(),wc=function(){function c(){}c.prototype.wb=function(){};c.prototype.kb=function(){};c.prototype.Nn=function(){return!1};return c}();var yc=function(c){function a(a,d){var b=c.call(this,a,d)||this;b.Ch="UnknownNode";b.width=100;b.height=20;b.ib=new gc;b.log=w.create("UNKNOWN",!0);b.ib.to("center","middle");return b}n(a,c);a.prototype.jt=function(a){this.Ch=a;this.ib.Bo(a);this.log("Creating placeholder for node type %s",a)};a.prototype.type=function(){return this.Ch};a.prototype.setProperty=function(a,d){this.aa[a]=d};a.prototype.format=function(a){this.log("Formatting placeholder for %s",this.Ch);this.rect=new D(0,0,this.width,
this.height);this.rect.transform(this.aa.matrix);this.ib.format(a,this.width,this.height)};a.prototype.pe=function(a){this.log("Drawing placeholder for for %s",this.Ch);a.save();a.lineWidth=1;a.fillStyle="#888888";a.fillRect(0,0,this.width,this.height);a.fillStyle="#000000";this.ib.ha(a,0,0);a.restore()};a.Nl=!1;return a}(L);L.md("UnknownNode",yc);var zc=function(c){function a(){var a=null!==c&&c.apply(this,arguments)||this;a.Tb="Action";a.log=w.create("ACTION");return a}n(a,c);a.prototype.wb=function(){};a.prototype.toString=function(){return""+this.Tb+"()"};return a}(wc),Ac=w.create("ACTION");function Bc(c,a,b){var d=L.create(c,a,b);d||(c in O.Mj?(d=new cc(a,b),d.setProperty("nodeType",c)):(Ac("Bad node type: %s",c),a=L.create("UnknownNode",a,b),a.jt(c),d=a));return d}
var S=function(c){function a(a,d,e,f,g){void 0===f&&(f=null);void 0===g&&(g=-1);var b=c.call(this)||this;b.id=a;b.type=d;b.aa=e;b.Gi=f;b.index=g;b.node=null;b.Tb="CreateAction";return b}n(a,c);a.prototype.wb=function(a){var b=Bc(this.type,this.id,a);b.Jb(this.aa);null===this.Gi&&(this.Gi=a.hk().id,this.index=-1);var e=a.va(this.Gi,!1);e instanceof ec&&(a.ob(e,b,this.index),this.log("Add %s id %s to parent %s index %s",b.type(),this.id,e.type(),this.index),this.node=b)};a.prototype.toString=function(){return""+
this.Tb+"("+this.type+NaN+this.id+", "+JSON.stringify(this.aa)+", parent="+this.Gi+", index="+this.index+")"};a.prototype.kb=function(a){this.node&&a.removeNode(this.node)};return a}(zc),Cc=function(c){function a(a){var b=c.call(this)||this;b.Na=a;b.ae=[];b.Tb="DeleteAction";return b}n(a,c);a.prototype.wb=function(a){var b;this.ae.length=0;var e=this.Na;var c=0;for(b=e.length;c<b;c++){var g=e[c];(g=a.va(g,!1))&&this.ae.push({node:g,parent:g.parent,index:a.removeNode(g)})}};a.prototype.kb=function(a){for(var b,
e=this.ae.length-1;0<=e;--e)b=this.ae[e],b.node&&b.parent&&a.ob(b.parent,b.node,b.index)};return a}(zc),Dc=function(c){function a(a,d,e){var b=c.call(this)||this;b.Na=a;b.name=d;b.value=e;b.Cd=[];b.Tb="SetAction";return b}n(a,c);a.prototype.wb=function(a){var b;this.Cd.length=0;var e=this.Na;var c=0;for(b=e.length;c<b;c++){var g=e[c];if(g=a.va(g,!0))this.Cd.push(g.ka(this.name)),a.vc(g,this.name,this.value)}};a.prototype.kb=function(a){var b,e,c;if(0!==this.Na.length){var g=e=0;for(c=this.Na.length-
1;0<=c?e<=c:e>=c;g=0<=c?++e:--e)(b=a.va(this.Na[g],!0))&&a.vc(b,this.name,this.Cd[g])}};a.prototype.Nn=function(b){if(!(b instanceof a)||this.name!==b.name)return!1;switch(this.name){case "arrowSize":case "arrowStyle":case "arrowXOffset":case "background":case "bold":case "border":case "cloudRadius":case "dashes":case "doubleArrow":case "fillStyle":case "fontName":case "fontSize":case "italic":case "lineWidth":case "opacity":case "roudRadius":case "strokeStyle":case "textDecoration":break;default:return!1}this.Na.sort();
b.Na.sort();if(this.Na.length!==b.Na.length)return!1;for(var d=0;d<this.Na.length;d++)if(this.Na[d]!==b.Na[d])return!1;this.log("Merging property change %s",this.name);this.value=b.value;return!0};return a}(zc),Ec=function(c){function a(a,d){var b=c.call(this)||this;b.Na=a;b.oa=d;b.Tb="TransformAction";b.inverse=d.inverse();return b}n(a,c);a.prototype.wb=function(a){for(var b=a.fk(this.Na,!0,!0),c=0;c<b.length;c++){var f=b[c],g=f.Ea();f.transform(this.oa);a.Wb.Jb(f.id,{matrix:f.Ea()},{matrix:g})}};
a.prototype.kb=function(a){for(var b=a.fk(this.Na,!0,!0),c=0;c<b.length;c++){var f=b[c],g=f.Ea();f.transform(this.inverse);a.Wb.Jb(f.id,{matrix:f.Ea()},{matrix:g})}};return a}(zc),Fc=function(c){function a(a,d,e,f,g,h){var b=c.call(this)||this;b.id=a;b.handle=d;b.fs=e;b.gs=f;b.x=g;b.y=h;b.Tb="MoveEditHandleAction";return b}n(a,c);a.prototype.wb=function(a){var b;if(b=a.va(this.id,!0)){var c={};c[b.vd()]=b.ka(b.vd());b.Ne(this.handle,this.x,this.y);var f={};f[b.vd()]=b.ka(b.vd());a.Wb.Jb(b.id,f,c)}};
a.prototype.kb=function(a){var b;if(b=a.va(this.id,!0)){var c={};c[b.vd()]=b.ka(b.vd());b.Ne(this.handle,this.fs,this.gs);var f={};f[b.vd()]=b.ka(b.vd());a.Wb.Jb(b.id,f,c)}};return a}(zc),Gc=function(c){function a(a,d){var b=c.call(this)||this;b.id=a;b.Na=d;b.ae=[];b.node=null;b.Tb="GroupAction";return b}n(a,c);a.prototype.wb=function(a){var b;this.ae.length=0;var c=this.Na;var f=0;for(b=c.length;f<b;f++){var g=c[f];(g=a.va(g))&&this.ae.push({node:g,parent:g.parent,index:g.parent.Xj(g)})}this.node=
a.og(this.id,this.Na)};a.prototype.kb=function(a){var b,c;if(0!==this.Na.length&&this.node){for(b=c=this.Na.length-1;0<=c&&!(0>b);b=c+=-1)b=this.ae[b],b.parent&&b.node&&a.ob(b.parent,b.node,b.index);a.removeNode(this.node)}};a.prototype.toString=function(){return"GroupAction("+JSON.stringify(this.Na)+")"};return a}(zc),Hc=function(c){function a(a){var b=c.call(this)||this;b.Na=a;b.zd=[];b.Tb="UngroupAction";return b}n(a,c);a.prototype.wb=function(a){var b,c,f={};var g=this.Na;var h=0;for(b=g.length;h<
b;h++){var k=g[h];k=a.va(k);if(k instanceof ec){var l=k;if(!(l.id in f)){f[l.id]=!0;var m={node:l,parent:l.parent,children:l.children.concat(),index:0};var q=m.children;var p=0;for(c=q.length;p<c;p++)k=q[p],a.ob(l.parent,k,-1);m.index=a.removeNode(l);this.zd.push(m)}}}};a.prototype.kb=function(a){var b,c,f,g;if(0!==this.zd.length){for(b=f=this.zd.length-1;0<=f&&!(0>b);b=f+=-1)if(b=this.zd[b],0!==b.children.length)for(a.ob(b.parent,b.node,b.index),c=g=b.children.length-1;0<=g&&!(0>c);c=g+=-1)a.ob(b.node,
b.children[c],-1);a.ai=!0}};return a}(zc);function Ic(c,a){var b;if(c.Bn()){var d=c.children;var e=0;for(b=d.length;e<b;e++){var f=d[e];Ic(f,a)}}else c.transform(a)}
var Jc=function(c){function a(a,d,e){var b=c.call(this)||this;b.Na=a;b.offsetX=d;b.offsetY=e;b.ra=[];b.Tb="DuplicateAction";return b}n(a,c);a.prototype.wb=function(a){var b;var c=new E(this.offsetX,this.offsetY);this.ra.length=0;var f=function(){return a.$a()};var g=this.Na;var h=0;for(b=g.length;h<b;h++){var k=g[h];if(k=a.va(k))k=k.clone(f),c.sk()||Ic(k,c),a.Dh(k),this.ra.push(k)}};a.prototype.kb=function(a){var b,c;if(0!==this.ra.length)for(b=c=this.ra.length-1;0<=c&&!(0>b);b=c+=-1)a.removeNode(this.ra[b])};
return a}(zc),Kc=function(c){function a(a,d,e){var b=c.call(this)||this;b.Na=a;b.type=d;b.On=e;b.ra=[];b.Fk=[];b.Tb="ChangeOrderAction";return b}n(a,c);a.prototype.wb=function(b){var d,c;this.Fk.length=0;this.ra.length=0;var f=this.Na;var g=0;for(c=f.length;g<c;g++){var h=f[g];if(h=b.va(h))if(d=h.parent){var k=h.Ke();this.Fk.push(k);this.ra.push(h);switch(this.type){case a.Kl:b.ob(d,h,-1);break;case a.mj:b.ob(d,h,0);break;case a.Sl:0<k?b.ob(d,h,k-1):b.ob(d,h,k);break;case a.Tl:k<d.children.length?
b.ob(d,h,k+1):b.ob(d,h,k);break;case a.Vl:void 0===this.On?b.ob(d,h,-1):b.ob(d,h,this.On)}}}};a.prototype.kb=function(a){var b,c,f;if(0!==this.Na.length)for(b=f=this.Na.length-1;0<=f&&!(0>b);b=f+=-1){var g=this.ra[b];(c=g.parent)&&g&&a.ob(c,g,this.Fk[b])}};a.Kl=0;a.mj=1;a.Tl=2;a.Sl=3;a.Vl=4;return a}(zc),Lc=function(c){function a(a,d,e){var b=c.call(this)||this;b.id=a;b.xt=d;b.wt=e;b.Tb="MoveNodeAction";b.Sn=0;b.Pe=0;return b}n(a,c);a.prototype.wb=function(a){var b=a.va(this.id),c=a.va(this.xt);if(c&&
!(c instanceof ec)&&b)throw console.log("FATAL: Parent node: "+c.id+":"+c.type()+" child "+b.id+":"+b.type()),Error("Tried to move to a non-group node!");b&&b.parent&&c&&(this.Sn=b.parent.id,this.Pe=b.Ke(),a.ob(c,b,this.wt))};a.prototype.kb=function(a){var b=a.va(this.id),c=a.va(this.Sn);b&&b.parent&&c&&a.ob(c,b,this.Pe)};return a}(zc),Mc=function(c){function a(a){var b=c.call(this)||this;b.aa=a;b.Cd={};b.Tb="SetDocumentPropertiesAction";return b}n(a,c);a.prototype.wb=function(a){var b;this.Cd={};
for(b in this.aa)this.aa.hasOwnProperty(b)&&(this.Cd[b]=a.ka(b),a.setProperty(b,this.aa[b]))};a.prototype.kb=function(a){for(var b in this.Cd)this.Cd.hasOwnProperty(b)&&a.setProperty(b,this.Cd[b])};return a}(zc),Nc=function(c){function a(a){var b=c.call(this)||this;b.rs=a;b.Rn=0;b.Tb="SetPageAction";return b}n(a,c);a.prototype.wb=function(a){this.Rn=a.Ra;a.Rb(this.rs)};a.prototype.kb=function(a){a.Rb(this.Rn)};return a}(zc);function Oc(c){c=c.replace(/\+/g," ");return decodeURIComponent(c)};var Pc=function(){function c(){this.Bi=!1;this.Sa={};this.log=w.create("EventEmitter")}c.prototype.ua=function(a){for(var b=this,d=1;d<arguments.length;d++);var c=Array.prototype.slice.apply(arguments);setTimeout(function(){b.Cf.apply(b,c)},0)};c.prototype.Cf=function(a){for(var b=1;b<arguments.length;b++);this.Sa||(this.Sa={});b=Array.prototype.slice.call(arguments,1);var d,c=!1;if(a in this.Sa){var f=this.Sa[a];var g=0;for(d=f.length;g<d;g++){var h=f[g];this.Bi||c||(this.log("Emit %s",a),c=!0);
h.apply(null,b)}}};c.prototype.Ka=function(a,b){this.Sa||(this.Sa={});this.bind(a,b)};c.prototype.once=function(a,b){function d(){c.Io(a,d);b.apply(null,arguments)}var c=this;c.bind(a,d)};c.prototype.bind=function(a,b){a in this.Sa?this.Sa[a].push(b):this.Sa[a]=[b];return b};c.prototype.removeListener=function(a,b){return this.Io(a,b)};c.prototype.Io=function(a,b){var d,c;if(a in this.Sa){var f=this.Sa[a];var g=d=0;for(c=f.length-1;d<=c;g=d+=1)if(f[g]===b){f.splice(g,1);break}0===f.length&&delete this.Sa[a]}};
return c}();var Qc=function(){var c;if(document.currentScript&&(c=document.currentScript.getAttribute("src")))return c;if(!document.getElementsByTagName)return"";c=document.getElementsByTagName("script");if(0===c.length)return"";c=c[c.length-1];return void 0!==c.getAttribute.length?c.src:c.getAttribute("src")||""}(),Rc={adaptiveBrushWidth:!1,adaptiveLineWidth:!1,angleArcs:0,allowSelectBox:"auto",allowResize:!0,allowTextInShape:!0,allowPointerEvents:!0,allowSystemClipboard:!1,allowZoom:!0,autoPickTool:!0,autoPickToolText:!0,
autoSnap:0,background:"clear",backgroundImage:null,collaborationServer:"zwibbler",clickToDrawShapes:!1,colourPicker:"wheel",colourPalette:"auto",debug:!1,defaultArrowStyle:"simple",defaultArrowSize:15,defaultArrowXOffset:null,defaultItalic:!1,defaultBold:!1,defaultBrushColour:"#000000",defaultBrushWidth:10,defaultFillStyle:"#e0e0e0",defaultFont:"Arial",defaultFontSize:20,defaultLineWidth:2,defaultPaperSize:"none",defaultRoundRectRadius:10,defaultSmoothness:"smooth",defaultStrokeStyle:"#000000",defaultText:"Lorum ipsum dolor",
defaultTextBackground:"rgba(0,0,0,0.0)",defaultTextAlign:"left",defaultTextDecoration:"none",defaultTextFillStyle:"#000000",defaultTextStrokeStyle:"#000000",defaultTextLineWidth:0,defaultZoom:1,drawShapeStyle:"box",fonts:["Arial","Times New Roman"],gridBlocks:10,gridColour:"#cccccc",gridSpacing:20,imageFolder:"$SCRIPT",iPadNoScrollText:!1,keyBringToFront:"Home",keyCancel:"ESC",keyCopy:"Ctrl+C,\u2318+C",keyCurveTool:"C",keyCut:"Ctrl+X,\u2318+X,Shift+Delete",keyDelete:"Delete,Backspace",keyDown:"Down,Ctrl+Down",
keyDuplicate:"Ctrl+D",keyEnter:"Enter",keyGroup:"Ctrl+G",keyLeft:"Left,Ctrl+Left",keyLineTool:"L",keyMoveDown:"PageDown",keyMoveUp:"PageUp",keyNext:"Down,Right",keyNextPage:"Shift+PageDown",keyPaste:"Ctrl+V,\u2318+V,Shift+Insert",keyPrevious:"Left,Up",keyPreviousPage:"Shift+Pageup",keyRedo:"Ctrl+Shift+Z",keyRight:"Right,Ctrl+Right",keySelectNone:"ESC",keySelectAll:"Ctrl+A",keySendToBack:"End",keyUndo:"Ctrl+Z",keyUngroup:"Ctrl+Shift+G",keyUp:"Up,Ctrl+Up",keyZoomIn:"+,Shift+=",keyZoomNormal:"=",keyZoomOut:"-",
keyZoomToPage:"F4",keyZoomToWidth:"Shift+F4",language:"en",latency:0,leaveTextToolOnBlur:!1,maximumZoom:0,minimumZoom:0,multilineText:!1,nudge:10,outsidePageColour:"#808080",pageBorderColour:"rbga(0,0,0,0.0)",pageInflation:20,pagePlacement:"centre",pageSelectorDiv:"",pageShadow:!0,pageView:!1,pasteOffset:10,pasteOffsetX:0,pasteOffsetY:0,persistent:!1,pixelsPerUnit:1,preciseNudge:1,readOnly:!1,scrollbars:!0,setFocus:!0,showArrowTool:!0,showBackgroundSelector:!1,showBrushTool:!0,showCircleTool:!0,showColourPanel:!0,
showCopyPaste:!0,showCurveTool:!0,showDebug:!1,showFontNameProperty:!0,showFontSizeProperty:!0,showHints:!0,showImageSelector:!1,showImageTool:!1,showKeyboardHelp:!0,showLineTool:!0,showMathTool:!1,showMoveToFrontBack:!1,showPageSelector:!1,showPageSelectorControls:!0,showPickTool:!0,showPropertyPanel:!1,showRoundRectTool:!1,showRuler:!1,showShapeBrushTool:!1,showSloppinessProperty:!0,showSmoothnessProperty:!0,showSquareTool:!0,showTextTool:!0,showToolbar:!0,showUndoRedo:!0,simulateGestures:!1,singleStrokeBrush:!1,
sloppy:!1,snap:0,spotHighlightColour:"rgba(0,0,0,0.2)",spotHighlightZIndex:1,symmetry:0,textMode:"interactive",toolbarButtonSize:50,useTouch:"auto",units:"",drawCircleStyle:"box",enableArrowKeysNudge:!1,showMenu:!1},Sc={},Tc;for(Tc in Rc)Sc[Tc.toLowerCase()]=Tc;
var Uc=function(c){function a(a,d){var b=c.call(this)||this;b.options=JSON.parse(JSON.stringify(Rc));b.Bc="";b.log=w.create("CONFIG");for(var f in d)f.toLowerCase()in Sc||alert("Zwibbler: Unknown option '"+f+"'"),b.set(f,d[f],!0);a.addEventListener(window,"hashchange",function(){b.log("Reload parameters from url hash");b.Hn()});b.Hn();""===b.Bc&&b.set("imageFolder",b.options.imageFolder);"auto"===b.options.useTouch&&b.log("Detected touch support: %s","ontouchstart"in window||"onmsgesturechange"in
window);b.log("Detect clipboard support: %s",b.rk());for(var g in b.options)b.log("%s=%s",g,b.options[g]);return b}n(a,c);a.prototype.Hn=function(){if(void 0===a)var a=window.location.hash;0===a.indexOf("#/")&&(a="#"+a.substr(2));var d=a,c;a={};var f=d.indexOf("#");0<=f&&(d=d.substr(f+1));f=d.indexOf("#");0<=f&&(d=d.substr(0,f));d=d.split("&");f=0;for(c=d.length;f<c;f++){var g=d[f];var h=g.split("=");g=Oc(h[0]);h=1<h.length?Oc(h[1]):"";g.length&&(a[g]=h)}for(var k in a)this.set(k,a[k])};a.Xo=function(a){return a.toLowerCase()in
Sc};a.prototype.set=function(a,d,c){void 0===c&&(c=!1);a.toLowerCase()in Sc&&(a=Sc[a.toLowerCase()]);"debug"===a&&(a="showDebug");if(!(a in this.options))return this.log("Error: %s is not a configuration option.",a),!1;if("defaultZoom"===a){if("page"!==d&&"width"!==d&&!K(d)&&(d=parseFloat(d),isNaN(d)))return this.log("Error: Config option %s must be a number or 'page' or 'width'",a),!1}else if("allowSelectBox"!==a)if("imageFolder"===a){var b=this.wr();""===b?(this.Bc=d.replace("$SCRIPT/",""),this.Bc=
this.Bc.replace("$SCRIPT","")):this.Bc=d.replace("$SCRIPT/","$SCRIPT").replace("$SCRIPT",b);""!==this.Bc&&"/"!==this.Bc[this.Bc.length-1]&&(this.Bc+="/");this.log("scriptPath=%s imageFolder=%s, result:%s",b,this.options.imageFolder,this.Bc)}else if("colourPalette"===a)"auto"!==d&&"string"===typeof d&&(d=u.us(d));else if("string"===typeof d)if("number"===typeof this.options[a]){if(d=parseFloat(d),isNaN(d))return this.log("Error: Config option %s expects a number",a),!1}else if("boolean"===typeof this.options[a]||
"useTouch"===a&&"auto"!==d)d="1"===d||"true"===d||""===d;this.log("Set config %s=%s",a,d);this.options[a]=d;c||(this.Cf("update",a,d),this.Cf(a,d,!1));return!0};a.prototype.Ka=function(a,d){if("update"!==a&&!(a in this.options))throw Error(a+" is not a valid config setting.");d(this.options[a],!0);return c.prototype.Ka.call(this,a,d)};a.prototype.wr=function(){var a=Qc;var d=a.lastIndexOf("/");return a=0<=d?a.substr(0,d+1):""};a.prototype.uu=function(){return this.options.showBrushTool};a.prototype.xu=
function(){return this.options.showPropertyPanel};a.prototype.vu=function(){return this.options.showColourPanel};a.prototype.wu=function(){return this.options.showDebug};a.prototype.yu=function(){return this.options.showToolbar};a.prototype.Ma=function(a){if(!(a in this.options))throw Error(a+" is not a valid config setting.");return this.options[a]};a.prototype.get=function(a){switch(a){case "useTouch":return this.dg();default:return this.Ma(a)}};a.prototype.dg=function(){return"auto"===this.options.useTouch?
"ontouchstart"in window||"onmsgesturechange"in window:this.options.useTouch};a.prototype.Qq=function(){if("auto"===this.options.allowSelectBox){var a=this.dg(),d=document.documentElement.offsetHeight,c=window.innerHeight,f=!a||a&&0<c-d+50;this.log("Allowing select box: %s (useTouch=%s, documentHeight=%s, windowHeight=%s)",f,a,d,c);return f}return this.options.allowSelectBox};a.prototype.Yq=function(){var a=(""+this.options.defaultSmoothness).toLowerCase();return"sharpest"===a?0:"sharper"===a?.1:"sharp"===
a?.2:"smoothest"===a?.5:.3};a.prototype.ek=function(a){return 0===a.indexOf("http:")||0===a.indexOf("https:")||0===a.indexOf("/")?a:this.Bc+a};a.prototype.en=function(){return pb(this.get(void 0))};a.prototype.Bp=function(a){function b(a){for(var b="",d=0;d<a.length;d++){var c=a.charAt(d);b=c===c.toUpperCase()?b+("-"+c.toLowerCase()):b+c}return b}var c=this,f={keyCut:1,keyCopy:1,keyPaste:1},g;for(g in this.options)this.options.hasOwnProperty(g)&&(0!==g.indexOf("key")||f[g]||a.map(this.options[g],
b(g).substr(4)));this.Ka("allowSystemClipboard",function(){var b=!c.rk();b?c.log("Not using system clipboard. Mapping cut/copy/paste keys"):c.log("Using system clipboard. Ignore keyCut/keyCopy/keyPaste.");a.map(c.options.keyCut,"cut",b);a.map(c.options.keyCopy,"copy",b);a.map(c.options.keyPaste,"paste",b)})};a.prototype.dn=function(){return"radial"===this.get("drawCircleStyle")||"radial"===this.get("drawShapeStyle")?"circle":"rectangle"};a.prototype.Sk=function(a){var b=a;0<this.options.maximumZoom&&
(a=Math.min(a,this.options.maximumZoom));0<this.options.minimumZoom&&(a=Math.max(a,this.options.minimumZoom));a!==b&&this.log("Zoom restricted to %s",a);return a};a.prototype.rk=function(){var a=document;return this.get("allowSystemClipboard")&&void 0!==a.oncopy&&void 0!==a.oncut&&void 0!==a.onpaste};return a}(Pc);var Vc=function(){function c(a,b){this.name=b;this.sa=z("div").Gc({borderTop:"1px solid #888",padding:"5px",cursor:"default"}).Qd(a);this.update(0)}c.prototype.update=function(a){this.sa.Ga.innerText=this.name+"... "+Math.round(100*a)+"%"};c.prototype.error=function(a){var b=this,d=document.createElement("input");d.setAttribute("type","button");d.value="OK";d.addEventListener("click",function(){b.done()});this.sa.Ga.innerText=this.name+"... "+a+" ";this.sa.Ga.appendChild(d)};c.prototype.done=function(){this.sa.remove()};
c.all=[];return c}();var T=function(){function c(){this.keys={}}c.prototype.contains=function(a){return a in this.keys};c.prototype.add=function(a){if(a instanceof Array)for(var b=0;b<a.length;b++)this.keys[a[b]]=!0;else this.keys[a]=!0};c.prototype.remove=function(a){delete this.keys[a]};c.prototype.Bf=function(a){var b,d;void 0===d&&(d="");if(!(a instanceof c))throw d||"Assertion failed";d=new c;for(b in this.keys)a.contains(b)||d.add(b);return d};c.prototype.Sb=function(){var a;var b=[];for(a in this.keys)this.keys.hasOwnProperty(a)&&
b.push(a);return b};c.prototype.kd=function(){var a;var b=[];for(a in this.keys)this.keys.hasOwnProperty(a)&&b.push(parseFloat(a));return b};c.prototype.clear=function(){this.keys={}};c.prototype.oc=function(a){for(var b in this.keys)if(this.keys.hasOwnProperty(b)&&a(b))break};c.prototype.empty=function(){for(var a in this.keys)if(this.keys.hasOwnProperty(a))return!1;return!0};return c}();var Wc=function(c){function a(b,d){var e=c.call(this,b,d,a)||this;e.log=w.create("PAGE",!0);e.children=[];return e}n(a,c);a.prototype.type=function(){return"PageNode"};a.prototype.format=function(){};a.prototype.xb=function(){return null};a.prototype.ha=function(){};return a}(ec);L.md("PageNode",Wc);var Xc=function(){function c(){this.log=w.create("NullObserver")}c.prototype.createNode=function(a,b,d,c){this.log("Create node "+c.type+" "+a+" at "+b+":"+d)};c.prototype.zc=function(a,b,d){this.log("Delete node "+a+" from "+b+":"+d)};c.prototype.Oe=function(a,b,d,c,f){this.log("Move node "+a+" from "+c+":"+f+" to "+b+":"+d)};c.prototype.Jb=function(a,b){this.log("Set properties for node "+a+" to "+JSON.stringify(b))};c.prototype.pa=function(){};return c}(),Yc=function(c){function a(a){void 0===
a&&(a=!1);var b=c.call(this)||this;b.ku=a;b.Wb=new Xc;b.$b=new xc;b.ra={};b.fe=new T;b.Wm=!0;b.ai=!0;b.nb=0;b.Mc=new T;b.removedNodes=new T;b.Rd=new T;b.root=new ec(b.$a(),b);b.Ui=0;b.hl="magenta";b.readOnly=!1;b.Rj=new T;b.aa={};b.oi=new T;b.Jl=new T;b.hd=[];b.cb=[];b.Ra=0;b.ug=0;b.mu=-1;b.Kf=0;b.oo=0;b.log=w.create("DOC");b.ra[b.root.id]=b.root;b.Kn();a||(b.rj(b.root,0),b.Rb(b.ui(0)));return b}n(a,c);a.prototype.empty=function(){return 0===this.root.children.length};a.prototype.Kn=function(){this.oo=
this.$b.next};a.prototype.Td=function(){return this.oo!==this.$b.next};a.prototype.$a=function(){for(;;){var a=this.nb++;if(!(a in this.ra))return a}};a.prototype.Ee=function(a){return a in this.ra};a.prototype.rj=function(a,d,c,f,g){void 0===c&&(c=!0);void 0===f&&(f=null);void 0===g&&(g=0);var b,e=!1;if(a.id in this.ra)null!==f&&a.parent&&(this.Wb.Oe(a.id,a.parent.id,a.Ke(),f,g),this.log("Node %s inserted at %s:%s; was at %s",a.id,a.parent.id,a.Ke(),g));else if(e=!0,this.ra[a.id]=a,a.parent&&(f=
a.ec(),f.type=a.type(),this.Wb.createNode(a.id,a.parent.id,a.Ke(),f)),a instanceof ec){var l=a.children;g=0;for(b=l.length;g<b;g++)f=l[g],this.rj(f,d,c)}"PageNode"!==a.type()&&e&&(this.Mc.add(a.id),this.removedNodes.remove(a.id));a.Wf(this.readOnly);c&&this.fe.add(a.id);this.Jl.add(a.Gf());a.ka("spotHighlight")&&"PathNode"===a.type()&&this.hd.push(a);this.Kf=void 0===d||null===d?this.ad(a.id)||0:d;"DomNode"===a.type()?this.Rj.add(a.id):"PageNode"===a.type()&&(this.ug=-1);e&&a.Gk()};a.prototype.Lg=
function(a){this.Rd.add(a);this.Kf=this.ad(a)||0;this.fe.add(a)};a.prototype.Dh=function(a){this.cb[this.Ra]||console.log("FATAL: Asked to add a node but bad page.",this.Ra,this.cb);this.ob(this.cb[this.Ra],a,-1)};a.prototype.va=function(a,d){void 0===d&&(d=!1);if(a in this.ra){var b=this.ra[a];d&&(this.fe.add(a),this.Rd.add(a),this.Kf=this.ad(a)||0);return b}return null};a.prototype.ad=function(a){for(a=this.va(a,!1);;)if(a)if("PageNode"===a.type())break;else{if(null===a.parent)return null;a=a.parent}else return null;
for(var b=0;b<this.cb.length;b++)if(this.cb[b]===a)return b;return null};a.prototype.fk=function(a,d,c){for(var b=[],e=0;e<a.length;e++){var h=this.va(a[e],c);h&&b.push(h)}return b=d?this.xq(b):this.Ih(b)};a.prototype.Fq=function(a){var b=[],c;for(c in this.ra)if(this.ra.hasOwnProperty(c)){var f=this.ra[c];f.ka("tag")===a&&b.push(f)}return b};a.prototype.pa=function(a,d){void 0===d&&(d=!1);this.Mc=new T;this.removedNodes=new T;this.Rd=new T;if(d){this.log("Performing actions without adding to undo stack");
for(var b=0;b<a.length;b++)a[b].wb(this)}else this.$b.pa(a,!1,this);this.Wb.pa();b=this.Mc.kd();for(var c=0;c<b.length;c++){var g=b[c];g>=this.nb&&(this.nb=g+1)}return{ac:b,bf:this.removedNodes.kd(),cg:this.Rd.Bf(this.Mc).Bf(this.removedNodes).kd()}};a.prototype.kb=function(){this.Mc=new T;this.removedNodes=new T;this.Rd=new T;this.$b.kb(this);this.Wb.pa();return{ac:this.Mc.kd(),bf:this.removedNodes.kd(),cg:this.Rd.Bf(this.Mc).Bf(this.removedNodes).kd()}};a.prototype.Hd=function(){this.Mc=new T;this.removedNodes=
new T;this.Rd=new T;this.$b.Hd(this);this.Wb.pa();return{ac:this.Mc.kd(),bf:this.removedNodes.kd(),cg:this.Rd.Bf(this.Mc).Bf(this.removedNodes).kd()}};a.prototype.od=function(){return this.$b.od()};a.prototype.nd=function(){return this.$b.nd()};a.prototype.Vg=function(){this.$b=new xc};a.prototype.format=function(a,d){var b=this,c;var g=[];if(this.Wm)for(l in this.ra)g.push(this.ra[l]);else this.fe.oc(function(a){g.push(b.ra[parseInt(a,10)]);return!1});var h=this.Ih(g);var k=0;for(c=h.length;k<c;k++){var l=
h[k];l.format(a,d)}this.fe.clear();this.Wm=!1;return g.length};a.prototype.qq=function(a,d,c){if(0!==this.hd.length&&d===this.Ui){a.save();a.beginPath();d=c||this.bd();a.moveTo(d.x,d.y);a.lineTo(d.x,d.bottom());a.lineTo(d.right(),d.bottom());a.lineTo(d.right(),d.y);a.closePath();c=!1;for(var b=0;b<this.hd.length;b++)this.ad(this.hd[b].id)===this.Ra&&(this.hd[b].clip(a),c=!0);c&&(a.clip(),a.fillStyle=this.hl,a.fillRect(d.x,d.y,d.width,d.height));a.restore()}};a.prototype.rd=function(a,d){var b=d||
this.bd(),c=this.aa.background;c&&(c=u.bi(c))&&(a.fillStyle=c.toString(),a.fillRect(b.x,b.y,b.width,b.height))};a.prototype.ha=function(a,d){function b(b){g.Ce(function(d){g.oi.contains(d.xd())||d.Gf()===b&&(d.hidden()||d.ha(a))});g.qq(a,b,d)}var c,g=this;this.Jl.add(this.Ui);var h=this.Jl.kd();h.sort(function(a,b){return a-b});var k=0;for(c=h.length;k<c;k++)b(h[k])};a.prototype.xb=function(a,d,c,f){var b=null;this.Ce(function(e){e.xd()===c&&e.xb(a,d)&&(!(null===b||b.Gf()<=e.Gf())||f&&f!==e.type()||
(b=e))});return b};a.prototype.sr=function(a){var b=[];this.Ce(function(d){a.contains(d.rect)&&b.push(d)});return b};a.prototype.Ih=function(a){var b,c;var f=[];var g={};var h=0;for(c=a.length;h<c;h++){for(b=a[h];b.Cn()&&b.parent;)this.log("Node type %s:%s is a group member",b.id,b.type()),b=b.parent;b.id in g||(g[b.id]=b,f.push(b))}this.st(f);return f};a.prototype.xq=function(a){function b(a){if(!(a.id in f)&&(f[a.id]=a,c.push(a),a.children))for(var d=0;d<a.children.length;d++)b(a.children[d])}for(var c=
[],f={},g=0;g<a.length;g++)b(a[g]);return c};a.prototype.oc=function(a,d){function b(c){var e;if(c.children){a&&d(c);var f=c.children;var k=0;for(e=f.length;k<e;k++)c=f[k],b(c)}else d(c)}b(this.root)};a.prototype.Ce=function(a,d){function b(d){if(d.children)for(var c=0;c<d.children.length;c++)b(d.children[c]);else"PageNode"!==d.type()&&a(d)}void 0===d&&(d=this.Ra);d<this.cb.length&&b(this.cb[d||0])};a.prototype.filter=function(a){var b=[];this.oc(!1,function(d){if(a(d))return b.push(d)});return b};
a.prototype.st=function(a){var b=0;this.ai&&(this.ai=!1,this.oc(!0,function(a){a.order=b++}));a.sort(function(a,b){return a.order-b.order})};a.prototype.og=function(a,d){var b;var c=new ec(a,this);this.Dh(c);var g=0;for(b=d.length;g<b;g++){var h=d[g];this.ob(c,this.ra[h],-1)}return c};a.prototype.Rs=function(a){var b,c=[];var f=0;var g=this.Ih(a);var h=0;for(b=g.length;h<b;h++)a=g[h],f=this.jm(a,c,f,null);return"zwibblerclip."+JSON.stringify(c)};a.prototype.jm=function(a,d,c,f){var b=a.ec(),e={},
k;for(k in b){var l=b[k];l instanceof F&&(l=["Matrix",l.m11,l.m12,l.m21,l.m22,l.Ca,l.Da]);e[k]=l}d.push({type:"CreateAction",node:a.type(),parent:f,properties:e});f=c+1;if(a.children)for(b=0,a=a.children;b<a.length;b++)f=this.jm(a[b],d,f,c);return f};a.prototype.In=function(a,d){var b,c;0===a.indexOf("zwibblerclip.")&&(a=a.substr(13));var g=[];var h=JSON.parse(a);var k=[];var l={},m=0,q=0;var p=0;for(c=h.length;p<c;p++){var t=h[p];if("GroupAction"===t.type){var r=this.$a();l[m++]=r;var v=[];var x=
0;for(t=t.members;x<t.length;x++)v.push(l[t[x]]);k.push(new Gc(r,v));g.push(r)}else if("CreateAction"===t.type){x=t.properties;v={};for(b in x)x.hasOwnProperty(b)&&(r=x[b],"[object Array]"===Object.prototype.toString.apply(r)&&"Matrix"===r[0]&&(r.splice(0,1),r=new F(r)),v[b]=r);r=this.$a();l[m++]=r;x=null;var I=-1;"parent"in t&&t.parent in l?x=l[t.parent]:"PageNode"===t.node&&(x=this.root.id,I=this.Ra+1+q,q+=1);k.push(new S(r,t.node,v,x,I));g.push(r)}}0!==q||d.sk()||k.push(new Ec(g,d));return k};
a.prototype.ob=function(a,d,c){var b=null,e=0;d.parent&&(b=d.parent.id,e=d.Ke(),this.removeNode(d,!1));-1===c?a.children.push(d):a.children.splice(c,0,d);d instanceof Wc&&(-1===c?this.cb.push(d):this.cb.splice(c,0,d));d.parent=a;this.rj(d,this.ad(a.id),!0,b,e);this.ai=!0};a.prototype.Ls=function(a,d){var b="function"!==typeof d?function(a){return a===d}:d;for(var c=0,g=0;g<a.length;g++)b(a[g])?c+=1:c&&(a[g-c]=a[g]);a.length-=c};a.prototype.removeNode=function(a,d){void 0===d&&(d=!0);var b=this,c=
this.ad(a.id);if(!a.parent||null===c)return this.log("Error: removeNode -- should not happen!"),-1;var g=a.parent.Xj(a);if(0<=g&&(d&&this.Wb.zc(a.id,a.parent.id,g),a.parent.children.splice(g,1),a.parent=null,d)){var h=function(a){var d;delete b.ra[a.id];b.Mc.remove(a.id);b.removedNodes.add(a.id);a.Jk();b.fe.remove(a.id);if(a.children){var c=a.children;var e=0;for(d=c.length;e<d;e++){var f=c[e];h(f)}}a.ka("spotHighlight")&&b.Ls(b.hd,a);b.Rj.remove(a.id)};h(a)}"PageNode"===a.type()?(this.cb.splice(g,
1),g===this.Ra&&(this.log("Removed current page."),this.Rb(Math.min(g,this.cb.length-1)),this.Kf=this.Ra),this.ug=-1):this.Kf=c;return g};a.prototype.$m=function(a){function b(a){if(!k||a.rect.x<c)c=a.rect.x;if(!k||a.rect.right()>f)f=a.rect.right();if(!k||a.rect.y<g)g=a.rect.y;if(!k||a.rect.bottom()>h)h=a.rect.bottom();k=!0}var c=0,f=0,g=0,h=0,k=!1;"number"===typeof a?this.Ce(b,a):this.oc(!1,b);return k?new D(c,g,f-c,h-g):new D(0,0,10,10)};a.prototype.bd=function(a){return this.aa.width?new D(0,0,
this.aa.width,this.aa.height):this.$m(a)};a.prototype.ka=function(a){return this.aa[a]};a.prototype.sn=function(a){return a in this.aa};a.prototype.setProperty=function(a,d){var b=this.aa[a]||null;null===d?a in this.aa&&delete this.aa[a]:this.aa[a]=d;var c={};c[a]=d;var g={};g[a]=b;this.Wb.Jb(this.root.id,c,g)};a.prototype.vc=function(a,d,c){a===this.root&&this.setProperty(d,c);var b={};b[d]=c;var e={};e[d]=a.ka(d);a.setProperty(d,c);this.Wb.Jb(a.id,b,e);if("spotHighlight"===d&&"PathNode"===a.type()){for(d=
0;d<this.hd.length;d++)if(this.hd[d]===a){this.hd.splice(d,1);break}c?(this.log("Added node %s to spotHighlightNodes",a.id),this.hd.push(a)):this.log("Removed node %s from spotHighlightNodes",a.id)}};a.prototype.bh=function(a,d){this.log("showLayer(%s, %s)",a,d);d?this.oi.remove(a):this.oi.add(a)};a.prototype.tk=function(a){return!this.oi.contains(a)};a.prototype.ui=function(a){this.log("Adding page to document with index %s",a);if(a>this.cb.length)return this.log("Error: Can insert page with index %s",
a),-1;var b=L.create("PageNode",this.$a(),this);this.ob(this.root,b,a);return a};a.prototype.Jc=function(){return this.cb.length};a.prototype.Rb=function(a){if(a!==this.Ra){if(0<=a&&a<this.cb.length)return this.log("Set current page to %s/%s",a,this.cb.length),this.Ra=a,!0;this.log("Tried to set page to non-existing %s",a);return!1}};a.prototype.nt=function(){this.ug!==this.Ra&&(this.tl(this.ug,!1),this.tl(this.Ra,!0),this.ug=this.Ra)};a.prototype.tl=function(a,d){var b=this;d?this.Ce(function(a){"DomNode"===
a.type()&&a.Gk()},a):this.Rj.oc(function(a){(a=b.va(parseInt(a,10),!1))&&a.Jk()})};a.prototype.hk=function(a){return 0===this.cb.length?this.root:void 0===a?this.cb[this.Ra]:this.cb[a]};a.prototype.ik=function(){var a=816,d=1056;"width"in this.aa&&(a=this.aa.width);"height"in this.aa&&(d=this.aa.height);return new Ib(a,d)};a.prototype.Wf=function(a){this.oc(!1,function(b){b.Wf(a)})};a.prototype.getRootNode=function(){return this.root};a.prototype.yo=function(a,d){void 0===d&&(d=!0);this.Wb=a;d&&(this.Wb.Jb(this.root.id,
this.aa,{}),this.oc(!0,function(b){if(b.parent){var d=b.ec();d.type=b.type();a.createNode(b.id,b.parent.id,b.Ke(),d)}}),this.Wb.pa())};return a}(Pc);var Zc=function(){function c(a,b){void 0===b&&(b="repeat");this.Ha=a;this.repeat=b}c.prototype.loaded=function(){return this.Ha instanceof HTMLImageElement?this.Ha.complete:!0};c.prototype.setTransform=function(){};return c}(),$c=function(){function c(a,b,d,c){this.ut=[];this.from=new A(a,b);this.ga=new A(d,c)}c.prototype.addColorStop=function(a,b){this.ut.push({offset:a,ze:b})};return c}(),ad=function(){function c(){this.stack=[];this.oa=new F;this.lineCap="butt";this.lineJoin="miter";this.lineWidth=
1;this.strokeStyle=this.fillStyle="#000000";this.textBaseline="top";this.font="10px arial";this.globalCompositeOperation="source-over";this.globalAlpha=1;this.shadowBlur=this.shadowOffsetY=this.shadowOffsetX=0;this.shadowColor="rgba(0,0,0,0)"}c.prototype.save=function(){this.stack.push({oa:this.oa.clone(),fillStyle:this.fillStyle,font:this.font,lineJoin:this.lineJoin,lineCap:this.lineCap,lineWidth:this.lineWidth,strokeStyle:this.strokeStyle,textBaseline:this.textBaseline,globalCompositeOperation:this.globalCompositeOperation,
globalAlpha:this.globalAlpha,shadowOffsetX:this.shadowOffsetX,shadowOffsetY:this.shadowOffsetY,shadowBlur:this.shadowBlur,shadowColor:this.shadowColor,ye:this.qj()})};c.prototype.restore=function(){var a=this.stack.pop();a&&(this.oa=a.oa,this.fillStyle=a.fillStyle,this.font=a.font,this.lineJoin=a.lineJoin,this.lineCap=a.lineCap,this.lineWidth=a.lineWidth,this.oa=a.oa,this.strokeStyle=a.strokeStyle,this.textBaseline=a.textBaseline,this.globalCompositeOperation=a.globalCompositeOperation,this.globalAlpha=
a.globalAlpha,this.shadowOffsetX=a.shadowOffsetX,this.shadowOffsetY=a.shadowOffsetY,this.shadowBlur=a.shadowBlur,this.shadowColor=a.shadowColor,this.tj(a.ye))};c.prototype.drawImage=function(a,b,d,c,f,g,h,k,l){var e=a.width,q=a.height,p=0,t=e,r=q;void 0!==c&&void 0!==f&&void 0!==g&&void 0!==h&&void 0!==k&&void 0!==l?(p=b,0-d,t=c,r=f,b=g,d=h,e=k,q=l):void 0!==c&&void 0!==f&&(e=c,q=f);this.oj(a,p,0,t,r,b,d,e,q)};c.prototype.beginPath=function(){};c.prototype.closePath=function(){};c.prototype.arc=function(a,
b,d,c,f,g){g&&(g=c,c=f,f=g);for(;0>c;)c+=2*Math.PI;for(;0>f;)f+=2*Math.PI;c>f&&(c-=2*Math.PI);var e=2*Math.PI;var k=c%e;var l=f%e;l===k&&(l+=2*Math.PI);f=[];c=Math.PI/2;g=k<l?1:-1;var m=k;for(e=Math.min(e,Math.abs(l-k));1E-5<e;){k=m+g*Math.min(e,c);var q=(k-m)/2,p=d*Math.cos(q),t=d*Math.sin(q),r=.5522847498*Math.tan(q);l=p+r*t;p=-t+r*p;t=-p;r=q+m;q=Math.cos(r);r=Math.sin(r);f.push({Tt:d*Math.cos(m),Xt:d*Math.sin(m),Ut:l*q-p*r,Yt:l*r+p*q,Vt:l*q-t*r,Zt:l*r+t*q,Wt:d*Math.cos(k),$t:d*Math.sin(k)});e-=
Math.abs(k-m);m=k}for(d=0;d<f.length;d++)c=f[d],0===d&&this.moveTo(c.Tt+a,c.Xt+b),this.bezierCurveTo(c.Ut+a,c.Yt+b,c.Vt+a,c.Zt+b,c.Wt+a,c.$t+b)};c.prototype.arcTo=function(){};c.prototype.strokeRect=function(a,b,d,c){this.beginPath();this.rect(a,b,d,c);this.stroke()};c.prototype.setTransform=function(a,b,d,c,f,g){this.oa=new F(a,d,b,c,f,g)};c.prototype.transform=function(a,b,d,c,f,g){a=new F(a,d,b,c,f,g);this.oa=this.oa.multiply(a)};c.prototype.translate=function(a,b){this.transform(1,0,0,1,a,b)};
c.prototype.scale=function(a,b){this.transform(a,0,0,b,0,0)};c.prototype.rotate=function(a){var b=Math.cos(a);a=Math.sin(a);this.transform(b,a,-a,b,0,0)};c.prototype.rect=function(a,b,d,c){this.beginPath();this.moveTo(a,b);this.lineTo(a+d,b);this.lineTo(a+d,b+c);this.lineTo(a,b+c);this.lineTo(a,b);this.closePath()};c.prototype.fillRect=function(a,b,d,c){this.rect(a,b,d,c);this.fill()};c.prototype.re=function(a){var b=null,d="10",c="normal",f="normal",g="normal",h="normal",k=!1;a=a.split(/\s+/);a:for(;;){var l=
a.shift();if(!l)break;switch(l){case "normal":break;case "italic":case "oblique":c=l;break;case "small-caps":g=l;break;case "bold":case "bolder":case "lighter":case "100":case "200":case "300":case "400":case "500":case "600":case "700":case "800":case "900":f=l;break;default:if(k){b=l;a.length&&(b+=" "+a.join(" "));2<b.length&&('"'===b.charAt(0)||"'"===b.charAt(0))&&(b=b.substr(1,b.length-2));break a}else l=l.split("/"),d=l[0],k=!0,1<l.length&&(h=l[1])}}return{fontStyle:c,fontVariant:g,fontWeight:f,
fontSize:d,lineHeight:h,fontFamily:b}};c.prototype.createPattern=function(a,b){return new Zc(a,b)};c.prototype.createLinearGradient=function(a,b,d,c){return new $c(a,b,d,c)};return c}();var bd=function(c){function a(a){a=c.call(this,a)||this;a.Se=0;a.gd=0;a.Ln=[0,1,3,7,15,31,63,127,255,511,1023,2047,4095,8193];a.log=w.create("BITWRITER");return a}n(a,c);a.prototype.Ab=function(a){this.Oo(a,8)};a.prototype.Oo=function(a,d){this.Se=this.Se<<d|a&this.Ln[d];for(this.gd+=d;8<=this.gd;)this.next.Ab(this.Se>>>this.gd-8&255),this.gd-=8,this.Se&=this.Ln[this.gd]};a.prototype.flush=function(){this.gd&&(this.next.Ab(this.Se<<8-this.gd),this.Se=this.gd=0);this.next.flush()};return a}(Na);var cd=function(c){function a(a){var b=c.call(this,a)||this;b.Lf=258;b.lu=0;b.kf=0;b.first=!0;b.mg=[];b.Mk=[];b.Aj=[];b.qu=0;b.Hj=9;b.log=w.create("LZWEncoder");b.Ip=new bd(a);b.am();return b}n(a,c);a.prototype.Ab=function(a){if(this.first)this.kf=a,this.first=!1;else{var b=this.ip(this.kf,a);void 0!==this.mg[b]?this.kf=this.mg[b]:(this.Bh(this.kf),this.mg[b]=this.Lf,this.Mk[b]=this.kf,this.kf=this.Aj[b]=a,4095>this.Lf?(this.Lf+=1,this.Hj=Math.ceil(Math.log(this.Lf)/Math.log(2))):this.am())}};a.prototype.ip=
function(a,d){var b;var c=d<<4^a;for(b=0===c?1:18041-c;;){if(void 0===this.mg[c]||this.Mk[c]===a&&this.Aj[c]===d)return c;c-=b;0>c&&(c+=18041)}};a.prototype.am=function(){this.Bh(a.So);this.Lf=258;this.Hj=9;this.mg.length=0;this.Mk.length=0;this.Aj.length=0};a.prototype.flush=function(){this.first||(this.Bh(this.kf),this.Bh(a.Wo))};a.prototype.Bh=function(a){this.Ip.Oo(a,this.Hj)};a.So=256;a.Wo=257;return a}(Na);Oa.ap(function(c){return new cd(c)});var dd=function(){function c(a,b,d,c){this.x=a;this.y=b;this.width=d;this.height=c;this.Vb=[];this.fonts={};this.images=[];this.$i={};this.nb=1;this.Vp=!0;this.page={};this.log=w.create("PdfWriter");this.cb=this.object("Pages",{Kids:[],Count:0});this.Np=this.object("Catalog",{Pages:this.cb._id+" 0 R"});this.Zf()}c.prototype.Hr=function(){if(null!==c.sj)return c.sj;var a=document.createElement("canvas"),b=!1;a.width=10;a.height=10;"toDataURL"in a&&(b=0<a.toDataURL("image/jpeg").indexOf("jpeg"));c.sj=
b;this.log("JPEG supported: %s",b);return b};c.prototype.Zf=function(a,b,d,c){void 0===a&&(a=this.x);void 0===b&&(b=this.x);void 0===d&&(d=this.width);void 0===c&&(c=this.height);this.log("StartPage MediaBox=[%s %s %s %s]",a,b,d,c);this.page=this.object("Page",{MediaBox:[a,b,a+d,b+c],Parent:this.cb._id+" 0 R"});this.cb.Kids.push(this.page._id+" 0 R");this.cb.Count+=1;this.$i={}};c.prototype.object=function(a,b){var d=this.Vb.length+1;a&&(b.Type=a);b._id=d;this.Vb.push(b);return b};c.prototype.xp=
function(a){this.page.Contents=a._id+" 0 R"};c.prototype.stream=function(a){if(this.Vp){var b=Oa.fg("LZWEncoder");b.Po(a);b.flush();a=b.Df().toString();a=this.object(null,{_stream:a,Filter:"[/LZWDecode]",DecodeParms:"[ << /EarlyChange 0 >> ]"})}else a=this.object(null,{_stream:a});return a};c.prototype.Ht=function(a){if(!(a in this.fonts)){var b="F"+this.nb;this.nb+=1;var d="/"+a.replace(/ /g,"");b=this.object("Font",{_name:b,BaseFont:d,Encoding:"/StandardEncoding",Subtype:"/Type1"});this.fonts[a]=
b}this.uh("Font",this.fonts[a]);return"/"+this.fonts[a]._name};c.prototype.Mo=function(a,b){var d=""+a+"-"+b;if(!(d in this.$i)){var c="gs"+this.nb;this.nb+=1;var f=this.object("ExtGState",{_name:c});b?f.ca=this.Fc(a):f.CA=this.Fc(a);this.$i[d]=c;this.uh("ExtGState",f)}return this.$i[d]};c.prototype.uh=function(a,b){"Resources"in this.page||(this.page.Resources={});a in this.page.Resources||(this.page.Resources[a]={});this.page.Resources[a][b._name]=b._id+" 0 R"};c.prototype.pj=function(a,b){void 0===
b&&(b="");for(var d=0;d<this.images.length;d++)if(this.images[d].Gg===a&&b===this.images[d].vn)return this.images[d].Pg;return null};c.prototype.cj=function(a,b){var d,c=this.pj(a);if(!c){var f="I"+this.nb;this.nb+=1;b instanceof HTMLCanvasElement?c=b:(c=document.createElement("canvas"),c.width=b.width,c.height=b.height,c.getContext("2d").drawImage(b,0,0));var g=c.getContext("2d").getImageData(0,0,c.width,c.height),h=!1;if(this.Hr()){this.log("Using JPEG encoding");var k="[/DCTDecode]";var l=Oa.fg("");
for(d=0;d<g.data.length;d+=4)h=h||255>g.data[d+3];d=c.toDataURL("image/jpeg");var m=atob(d.split(",")[1]);for(d=0;d<m.length;d++)l.Ab(m.charCodeAt(d))}else{this.log("Using LZW encoding");k="[/LZWDecode]";l=Oa.fg("LZWEncoder");for(d=0;d<g.data.length;d+=4)l.Ab(g.data[d]),l.Ab(g.data[d+1]),l.Ab(g.data[d+2]),h=h||255>g.data[d+3];var q="[ <</EarlyChange 0 >> ]"}l.flush();l=l.Df().toString();f=this.object("XObject",{Subtype:"/Image",Width:c.width,Height:c.height,ColorSpace:"/DeviceRGB",BitsPerComponent:8,
Length:l.length,Interpolate:"true",Filter:k,_name:f,_stream:l});q&&(f.DecodeParms=q);if(h){l=Oa.fg("LZWEncoder");for(d=0;d<g.data.length;d+=4)l.Ab(g.data[d+3]);l.flush();l=l.Df().toString();q=this.object("XObject",{Subtype:"/Image",Width:c.width,Height:c.height,ColorSpace:"/DeviceGray",BitsPerComponent:8,Length:l.length,Filter:"[/LZWDecode]",DecodeParms:"[ << /EarlyChange 0 >> ]",_stream:l});f.SMask=q._id+" 0 R"}this.images.push({Gg:a,vn:"",Pg:f});c=f}this.uh("XObject",c);return"/"+c._name};c.prototype.dj=
function(a,b){var d=this.pj(a.Ha,b.toString());if(!d){d="P"+this.nb;this.nb+=1;this.cj(a.Ha,a.Ha);var c=this.pj(a.Ha),f=new F(a.Ha.width,0,0,-a.Ha.height,0,a.Ha.height);f=b.multiply(f);var g="1",h="1",k=b.yd();k=Math.max(k.x,k.y);if("no-repeat"===a.repeat||"repeat-y"===a.repeat)g=""+Math.ceil(this.width/a.Ha.width/k);if("no-repeat"===a.repeat||"repeat-x"===a.repeat)h=""+Math.ceil(this.height/a.Ha.height/k);d=this.object("Pattern",{_name:d,PatternType:"1",PaintType:"1",TilingType:"2",BBox:"[0 0 1 1]",
XStep:g,YStep:h,Matrix:"[ "+this.Fc(f.m11,f.m21,f.m12,f.m22,f.Ca,f.Da)+"]",Resources:"<< /XObject << /"+c._name+" "+c._id+" 0 R >> >>"});d._stream="/"+c._name+" Do";this.images.push({Gg:a.Ha,vn:b.toString(),Pg:d})}this.uh("Pattern",d);return"/"+d._name};c.prototype.cf=function(){var a=[],b=[],d;a.push("%PDF-1.4\n%\u0080\u0081\u0082\u0083\n");for(d=0;d<this.Vb.length;d++)this.om(a,b,this.Vb[d],!1);var c=a.join("").length;a.push("xref\n0 "+(this.Vb.length+1)+"\n");a.push("0000000000 65535 f\n");for(d=
0;d<this.Vb.length;d++){for(var f=""+b[d];10>f.length;)f="0"+f;a.push(f+" 00000 n \n")}a.push("trailer\n");a.push("<< /Size "+(this.Vb.length+1)+"\n");a.push("   /Root "+this.Np._id+" 0 R\n");a.push(">>\n");a.push("startxref\n");a.push(c+"\n");a.push("%%EOF\n");return a.join("")};c.prototype.toBlob=function(){for(var a=this.cf(),b=new Uint8Array(a.length),d=0;d<a.length;d++)b[d]=a.charCodeAt(d);return new Blob([b],{type:"application/pdf"})};c.prototype.om=function(a,b,d,c){c?a.push("<<\n"):(b.push(a.join("").length),
a.push(d._id+" 0 obj\n"),"Type"in d?a.push("<< /Type /"+d.Type+"\n"):a.push("<<\n"));"_stream"in d&&(d.Length=d._stream.toString().length);for(var e in d)if(d.hasOwnProperty(e)&&"Type"!==e&&"_"!==e.charAt(0)){c&&a.push("    ");a.push("   /"+e+" ");var g=d[e];"object"===typeof g&&"[object Array]"===Object.prototype.toString.apply(g)?a.push("[ "+g.join(" ")+" ]"):"object"===typeof g?this.om(a,b,g,!0):a.push(g);a.push("\n")}c&&a.push("    ");a.push(">>\n");"_stream"in d&&(a.push("stream\n"),a.push(d._stream+
"\n"),a.push("endstream\n"));c||a.push("endobj\n")};c.prototype.wq=function(a){return"("+a.replace(/\\/g,"\\\\").replace(/\(/g,"\\(").replace(/\)/g,"\\)")+")"};c.prototype.Fc=function(){for(var a=[],b=0;b<arguments.length;b++)a[b]=arguments[b];b=[];for(var d=0;d<a.length;d++){var c=""+a[d];0<c.indexOf("e")&&(c=a[d].toFixed(20));b.push(c)}return b.join(" ")};c.sj=null;return c}(),ed=function(c){function a(a,d){var b=c.call(this)||this;b.Iq=d;b.path=[];b.x=0;b.y=0;b.ao=[];b.Ue="";b.$e="";b.Ze=-1;b.Ye=
"";b.Xe="";b.We="";b.Ve="";b.Te=-1;b.log=w.create("PDFContext");b.Fd=a.clone();b.Fd.transform(new Lb(.75,.75,0,0));b.lb=new dd(72*a.x/96,72*a.y/96,72*a.width/96,72*a.height/96);b.stream=[];b.x=0;b.y=0;b.fillStyle="#000000";b.strokeStyle="#000000";b.lm=b.op;b.km();return b}n(a,c);a.prototype.save=function(){c.prototype.save.call(this);this.stream.push("q");this.ao.push({Ue:this.Ue,$e:this.$e,Ze:this.Ze,Ye:this.Ye,Xe:this.Xe,We:this.We,Ve:this.Ve,Te:this.Te})};a.prototype.restore=function(){c.prototype.restore.call(this);
var a=this.ao.pop();a&&(this.stream.push("Q"),this.Ue=a.Ue,this.$e=a.$e,this.Ze=a.Ze,this.Ye=a.Ye,this.Xe=a.Xe,this.We=a.We,this.Ve=a.Ve,this.Te=a.Te)};a.prototype.Zf=function(a){var b=new Lb(.75,.75,0,0);a&&(this.Fd=a.clone(),this.Fd.transform(b));this.Vj();this.lb.Zf(this.Fd.x,this.Fd.y,this.Fd.width,this.Fd.height);this.km();this.beginPath()};a.prototype.beginPath=function(){this.path.length=0};a.prototype.km=function(){this.log("Start page: %s",this.Fd);this.setTransform(1,0,0,1,0,0);this.$e=
this.Ue="";this.Ze=-1;this.Ve=this.We=this.Xe=this.Ye="";this.Te=-1};a.prototype.Vj=function(){this.stream.length&&this.lb.xp(this.lb.stream(this.stream.join("\n")));this.stream.length=0};a.prototype.toString=function(){this.Vj();return this.lb.cf()};a.prototype.toBlob=function(){this.Vj();return this.lb.toBlob()};a.prototype.setTransform=function(a,d,c,f,g,h){var b=this.Fd.Vc();this.oa=(new F(a,c,d,f,g,h)).multiply(new Mb(0,b.x,b.y)).multiply(new Lb(.75,.75,0,0))};a.prototype.closePath=function(){this.path.push("h")};
a.prototype.fill=function(){this.uj();for(var a=0;a<this.path.length;a++)this.stream.push(this.path[a]);this.stream.push("f")};a.prototype.stroke=function(){this.vj();for(var a=0;a<this.path.length;a++)this.stream.push(this.path[a]);this.stream.push("S")};a.prototype.moveTo=function(a,d){var b=this.oa.apply(a,d);this.path.push(this.lb.Fc(b.x,b.y)+" m");this.x=a;this.y=d};a.prototype.lineTo=function(a,d){var b=this.oa.apply(a,d);this.path.push(this.lb.Fc(b.x,b.y)+" l");this.x=a;this.y=d};a.prototype.bezierCurveTo=
function(a,d,c,f,g,h){a=this.oa.apply(a,d);c=this.oa.apply(c,f);f=this.oa.apply(g,h);this.path.push(this.lb.Fc(a.x,a.y,c.x,c.y,f.x,f.y)+" c");this.x=g;this.y=h};a.prototype.quadraticCurveTo=function(a,d,c,f){this.bezierCurveTo(2/3*a+1/3*this.x,2/3*d+1/3*this.y,2/3*a+1/3*c,2/3*d+1/3*f,c,f)};a.prototype.fillText=function(a,d,c){this.lm(a,d,c,0)};a.prototype.strokeText=function(a,d,c){this.lm(a,d,c,1)};a.prototype.uj=function(){if(this.Ue!==this.fillStyle){if(this.fillStyle instanceof Zc){var a=this.lb.dj(this.fillStyle,
this.oa);this.stream.push("/Pattern cs");this.stream.push(a+" scn")}else"string"===typeof this.fillStyle&&(a=u.td(this.fillStyle).Mh(u.RGBA),this.stream.push(this.lb.Fc(a.values[0],a.values[1],a.values[2])+" rg"),a=this.lb.Mo(a.values[3],!0),this.stream.push("/"+a+" gs"));this.Ue=this.fillStyle}};a.prototype.vj=function(){function a(a){return"bevel"===a?2:"round"===a?1:0}function d(a){return"butt"===a?0:"round"===a?1:2}if(this.$e!==this.strokeStyle){if(this.strokeStyle instanceof Zc){var c=this.lb.dj(this.strokeStyle,
this.oa);this.stream.push("/Pattern CS");this.stream.push(c+" SCN")}else"string"===typeof this.strokeStyle&&(c=u.td(this.strokeStyle).Mh(u.RGBA),this.stream.push(this.lb.Fc(c.values[0],c.values[1],c.values[2])+" RG"),c=this.lb.Mo(c.values[3],!1),this.stream.push("/"+c+" gs"));this.$e=this.strokeStyle}this.Ze!==this.lineWidth&&(this.Ze=this.lineWidth,this.stream.push(this.lb.Fc(72*this.lineWidth/96)+" w"));this.Ye!==this.lineJoin&&(this.Ye=this.lineJoin,this.stream.push(a(this.lineJoin)+" j"));this.Xe!==
this.lineCap&&(this.Xe=this.lineCap,this.stream.push(d(this.lineCap)+" J"))};a.prototype.pp=function(a,d,c,f){var b=this.re(this.font);if(this.We!==b.fontSize||this.Ve!==b.fontFamily){var e=this.lb.Ht(b.fontFamily);this.stream.push(e+" "+this.lb.Fc(parseFloat(b.fontSize))+" Tf");this.We=b.fontSize;this.Ve=b.fontFamily}this.Te!==f&&(this.stream.push(f+" Tr"),this.Te=f);0===f?this.uj():this.vj();this.stream.push("BT");d=this.oa.multiply(new F(1,0,0,-1,d,c));this.stream.push(this.lb.Fc(d.m11,d.m21,d.m12,
d.m22,d.Ca,d.Da)+" Tm");this.stream.push(this.lb.wq(a)+" Tj");this.stream.push("ET")};a.prototype.op=function(a,d,c,f){var b=this.re(this.font),e=this.Iq.get(b.fontFamily);e?(0===f?this.uj():this.vj(),this.beginPath(),e.rq(this,a,d,c,parseFloat(b.fontSize)),0===f?this.fill():this.stroke()):this.pp(a,d,c,f)};a.prototype.measureText=function(){return{width:1}};a.prototype.re=function(a){var b="",c="",f="normal",g="normal",h="normal",k="normal";a=a.split(/\s+/);a:for(;;){var l=a.shift();if(!l)break;
switch(l){case "normal":break;case "italic":case "oblique":f=l;break;case "small-caps":h=l;break;case "bold":case "bolder":case "lighter":case "100":case "200":case "300":case "400":case "500":case "600":case "700":case "800":case "900":g=l;break;default:if(""===c)l=l.split("/"),c=l[0],1<l.length&&(k=l[1]);else{b=l;a.length&&(b+=" "+a.join(" "));break a}}}b&&(b=b.replace(/"/g,""));return{fontStyle:f,fontVariant:h,fontWeight:g,fontSize:c,lineHeight:k,fontFamily:b}};a.prototype.oj=function(a,d,c,f,
g,h,k,l,m){this.log("DrawImage(%s, %s, %s, %s, %s, %s, %s %s)",d,c,f,g,h,k,l,m);k+=m;var b=document.createElement("canvas"),e=b.getContext("2d");b.width=f;b.height=g;e.drawImage(a,-d,-c);a=this.lb.cj(a instanceof HTMLImageElement?[a.src,d,c,f,g].join():a,b);this.stream.push("q");h=this.oa.multiply(new F(l,0,0,-m,h,k));this.stream.push(this.lb.Fc(h.m11,h.m21,h.m12,h.m22,h.Ca,h.Da)+" cm");this.stream.push(a+" Do");this.stream.push("Q")};a.prototype.cf=function(){return this.lb.cf()};a.prototype.qj=
function(){return{}};a.prototype.tj=function(){};a.prototype.clip=function(){for(var a=0;a<this.path.length;a++)this.stream.push(this.path[a]);this.stream.push("W");this.stream.push("n");this.path.length=0};return a}(ad);var fd=function(){function c(){this.ba=[]}c.prototype.lineTo=function(a,b,d){a.apply(b,d);this.ba.push({lg:"L",Of:a.apply(b,d)})};c.prototype.moveTo=function(a,b,d){a.apply(b,d);this.ba.push({lg:"M",Of:a.apply(b,d)})};c.prototype.quadraticCurveTo=function(a,b,d,c,f){this.ba.push({lg:"Q",Of:a.apply(b,d),Ei:a.apply(c,f)})};c.prototype.bezierCurveTo=function(a,b,d,c,f,g,h){this.ba.push({lg:"C",Of:a.apply(b,d),Ei:a.apply(c,f),Lk:a.apply(g,h)})};c.prototype.closePath=function(){this.ba.push({lg:"Z"})};
c.prototype.ql=function(a){a=a.inverse();for(var b="",d=0;d<this.ba.length;d++){var c=this.ba[d];0<d&&(b+=" ");b+=c.lg;if(c.Of){var f=a.apply(c.Of.x,c.Of.y);b+=f.x+","+f.y;c.Ei&&(f=a.apply(c.Ei.x,c.Ei.y),b+=","+f.x+","+f.y,c.Lk&&(c=a.apply(c.Lk.x,c.Lk.y),b+=","+c.x+","+c.y))}}return b};return c}(),gd=function(c){function a(a){var b=c.call(this)||this;b.oa=new F;b.ba=[];b.path=new fd;b.ye="";b.Vb=[];b.nb=0;b.log=w.create("SvgContext");b.hg=1;b.rf=2;b.lj=4;b.log("SVG context rect: %s",a);b.root=new sa("svg",
{xmlns:"http://www.w3.org/2000/svg","xmlns:xlink":"http://www.w3.org/1999/xlink","xmlns:zwibbler":"http://zwibbler.com/xml",version:1.2,baseProfile:"tiny",width:a.width,height:a.height,viewBox:a.x+" "+a.y+" "+a.width+" "+a.height});b.Th=new sa("defs",{});b.root.pd(b.Th);b.zd=[b.root];return b}n(a,c);a.prototype.Ur=function(){return"clip"+this.nb++};a.prototype.Tg=function(a){a=new sa("g",a||{});this.Kj().pd(a);this.zd.push(a)};a.prototype.Sg=function(){var a=this.zd.pop();if(a&&1===a.children.length){var d=
a.children[0];d.Qi(a.attributes);a.name=d.name;a.attributes=d.attributes;a.children=d.children;a.text=d.text}};a.prototype.Kj=function(){return this.zd[this.zd.length-1]};a.prototype.node=function(a,d,c,f){function b(a,b){if(b instanceof Zc)c[a]="url(#"+e.dj(b)+")";else if("string"===typeof b){var d=u.td(b),f=d.values[3];1>f&&(d.values[3]=1,c[a+"-opacity"]=""+f);c[a]=d.toString()}}void 0===c&&(c={});var e=this;this.oa.sk()||(c.transform="matrix("+this.oa.m11+" "+this.oa.m21+" "+this.oa.m12+" "+this.oa.m22+
" "+this.oa.Ca+" "+this.oa.Da+")");d&this.hg?b("fill",this.fillStyle):c.fill="none";d&this.rf&&(b("stroke",this.strokeStyle),c["stroke-width"]=this.lineWidth,"miter"!==this.lineJoin&&(c["stroke-linejoin"]=this.lineJoin),"butt"!==this.lineCap&&(c["stroke-linecap"]=this.lineCap));d&this.lj&&(d=this.re(this.font),c["font-weight"]=d.fontWeight,c["font-size"]=parseFloat(d.fontSize),c["font-style"]=d.fontStyle,c["font-family"]=d.fontFamily);""!==this.ye&&(c["clip-path"]="url(#"+this.ye+")");this.vp(new sa(a,
c,f))};a.prototype.vp=function(a){var b=!0,c=null,f={},g,h=this.Kj();0===h.children.length?b=!1:c=h.children[h.children.length-1];!c||a.name===c.name&&a.text===c.text||(b=!1);if(b&&c)for(g in c.attributes)if(c.attributes.hasOwnProperty(g))if(g in a.attributes){var k=c.attributes[g],l=a.attributes[g];if(k!==l)if(0===g.indexOf("fill")||0===g.indexOf("stroke"))if("none"===k)f[g]=l;else if("none"===l)f[g]=k;else{b=!1;break}else{b=!1;break}}else f[g]=c.attributes[g];if(b&&c)for(g in a.attributes)a.attributes.hasOwnProperty(g)&&
(g in c.attributes||(f[g]=a.attributes[g]));b&&c?c.Qi(f):h.pd(a)};a.prototype.vi=function(a){if(a===this.rf){if(0===this.lineWidth)return!1;a=this.strokeStyle}else a=this.fillStyle;return a instanceof Zc?!0:"string"===typeof a?0<u.td(a).values[3]:!1};a.prototype.em=function(a){for(var b=0;b<this.Vb.length;b++)if(this.Vb[b].Gg===a)return this.Vb[b].Pg;return null};a.prototype.cj=function(a){var b=this.em(a);if(b)return b;b="image"+this.Vb.length;this.Vb.push({Gg:a,Pg:b});var c=document.createElement("canvas"),
f=c.getContext("2d");c.width=a.width;c.height=a.height;f.drawImage(a,0,0);c=c.toDataURL();a=new sa("image",{id:b,x:0,y:0,width:a.width,height:a.height,"xlink:href":c});this.Th.pd(a);return b};a.prototype.dj=function(a){var b=this.em(a);if(b)return b;var c=this.cj(a.Ha);b="pattern"+this.Vb.length;this.Vb.push({Gg:a,Pg:b});var f=new sa("pattern",{id:b});"no-repeat"===a.repeat?(f.attributes.width="1",f.attributes.height="1"):"repeat-x"===a.repeat?(f.attributes.patternUnits="userSpaceOnUse",f.attributes.width=
a.Ha.width,f.attributes.height=1E4):("repeat-y"===a.repeat?(f.attributes.patternUnits="userSpaceOnUse",f.attributes.width=1E4):(f.attributes.patternUnits="userSpaceOnUse",f.attributes.width=a.Ha.width),f.attributes.height=a.Ha.height);f.pd(new sa("use",{"xlink:href":"#"+c}));this.Th.pd(f);return b};a.prototype.toString=function(){return'<?xml version="1.0" encoding="UTF-8"?>\n'+this.root.toString()};a.prototype.toBlob=function(){for(var a=this.toString(),d=new Uint8Array(a.length),c=0;c<a.length;c++)d[c]=
a.charCodeAt(c);return new Blob([d],{type:"image/svg+xml"})};a.prototype.beginPath=function(){this.path=new fd};a.prototype.transform=function(a,d,c,f,g,h){a=new F(a,c,d,f,g,h);this.oa=this.oa.multiply(a)};a.prototype.closePath=function(){this.path.closePath()};a.prototype.fill=function(){this.vi(this.hg)&&this.node("path",this.hg,{d:this.path.ql(this.oa)})};a.prototype.stroke=function(){this.vi(this.rf)&&this.node("path",this.rf,{d:this.path.ql(this.oa)})};a.prototype.moveTo=function(a,d){this.path.moveTo(this.oa,
a,d)};a.prototype.lineTo=function(a,d){this.path.lineTo(this.oa,a,d)};a.prototype.quadraticCurveTo=function(a,d,c,f){this.path.quadraticCurveTo(this.oa,a,d,c,f)};a.prototype.bezierCurveTo=function(a,d,c,f,g,h){this.path.bezierCurveTo(this.oa,a,d,c,f,g,h)};a.prototype.fillText=function(a,d,c){this.vi(this.hg)&&(this.re(this.font),this.node("text",this.hg|this.lj,{x:d,y:c},a))};a.prototype.strokeText=function(a,d,c){this.vi(this.rf)&&(this.re(this.font),this.node("text",this.rf|this.lj,{x:d,y:c},a))};
a.prototype.oj=function(a,d,c,f,g,h,k,l,m){var b=document.createElement("canvas"),e=b.getContext("2d");b.width=f;b.height=g;e.drawImage(a,-d,-c);a=b.toDataURL();this.Kj().pd(new sa("image",{transform:"matrix("+this.oa.m11+" "+this.oa.m21+" "+this.oa.m12+" "+this.oa.m22+" "+this.oa.Ca+" "+this.oa.Da+")",x:h,y:k,width:l,height:m,"xlink:href":a}))};a.prototype.measureText=function(){return{width:1}};a.prototype.Zf=function(){};a.prototype.qj=function(){return{name:this.ye}};a.prototype.tj=function(a){this.ye=
a?a.name:""};a.prototype.clip=function(){var a=this.Ur(),d=new sa("clipPath",{id:a});d.pd(new sa("path",{d:this.path.ql(this.oa)}));this.Th.pd(d);this.ye=a;this.path=new fd};return a}(ad);var hd=new (function(){function c(){this.log=w.create("serializer");this.Ll={pdf:"application/pdf",svg:"image/svg+xml",png:"image/png",jpeg:"image/jpeg",jpg:"image/jpeg",bmp:"image/bmp"}}c.prototype.sh=function(a){if(a instanceof Array)var b=this.xn(a);else{if("string"!==typeof a)return this.log("Can only open an array or string as a document."),null;if("{"===a.charAt(0))b=this.Rr(a);else if(0===a.indexOf("zwibbler3."))b=JSON.parse(a.substr(10)),b=this.xn(b);else if(0===a.indexOf("zwibblerclip."))b=
new Yc(!1),a=b.In(a,new F),b.pa(a),b.Vg();else throw Error("Format detection failed.");}for(a=1;a<b.Jc();a++)b.tl(a,!1);return b};c.prototype.Rr=function(a){function b(a){var b=new F;b.m11=a.m11;b.m12=a.m12;b.m21=a.m21;b.m22=a.m22;b.Ca=a.dx;b.Da=a.dy;return b}function d(a,c){switch(a.type){case "Node":for(var e=[],h=a.children,k=h.length-1;0<=k;k--){var l=f.nb;try{d(h[k],c+1)}catch(y){continue}e.push(l)}0<c&&g.push(new Gc(f.$a(),e));break;case "PathNode":case "ArrowNode":var r=a;h=0;"arrowSize"in
r&&(h=r.arrowSize,r=r.path);e=b(r.matrix);h={strokeStyle:r.strokeStyle,fillStyle:r.fillStyle,lineWidth:r.lineWidth,smoothness:r.smoothness,sloppiness:r.sloppiness,shadow:r.shadow,arrowSize:h,seed:Math.round(65535*Math.random())};"textNode"in r&&(k=r.textNode,h.fontSize=k.fontSize,h.fontName=k.fontName,h.text=k.text,h.textFillStyle="textFillStyle"in k?k.textFillStyle:k.fillStyle);"path"in r&&(r=r.path);var v=r.startX,x=r.startY;k=r.closed;l=new R;r=r.segments;v=e.apply(v,x);l.moveTo(v.x,v.y);for(v=
0;v<r.length;v++){var I=r[v];switch(I.type){case 1:x=e.apply(I.x,I.y);l.lineTo(x.x,x.y);break;case 2:x=e.apply(I.x,I.y);l.pg(x.x,x.y);break;case 3:x=e.apply(I.x1,I.y1);I=e.apply(I.x,I.y);l.Be(x.x,x.y,I.x,I.y);break;default:throw"Unknown path segment type: "+I.type;}}k&&l.close();h.commands=l.Sb();g.push(new S(f.$a(),"PathNode",h));break;case "TextNode":e=b(a.matrix);e=e.multiply(new E(0,1.3*a.fontSize));e={fillStyle:a.fillStyle,lineWidth:0,text:a.text,fontName:a.fontName,fontSize:a.fontSize,matrix:e};
g.push(new S(f.$a(),"TextNode",e));break;default:throw Error("Unknown node type: "+a.type);}}var c=w.create("IMPORT"),f=new Yc,g=[];try{var h=JSON.parse(a)}catch(k){a=a.replace(/\\\\/g,"\\").replace(/\\"/g,'"');try{h=JSON.parse(a)}catch(l){throw c("Couldn't parse file."),"Couldn't parse file.";}}c("Successfully parsed!");d(h,0);f.pa(g);return f};c.prototype.xn=function(a){function b(a,d){if(void 0!==a){var e={};for(var g in a)a.hasOwnProperty(g)&&"children"!==g&&"parent"!==g&&"id"!==g&&"type"!==g&&
(e[g]="matrix"===g?new F(a[g]):a[g]);g=f;0!==a.id&&c.push(new S(g,a.type,e,d,-1));f+=1;if(void 0!==a.children)for(e=0;e<a.children.length;e++)b(a.children[e],g)}}var d;a=JSON.parse(JSON.stringify(a));var c=[],f=0,g={},h=!1;for(d=0;d<a.length;d++){var k=a[d];if("document"===k.type)delete k.type,c.push(new Mc(k));else{"PageNode"===k.type&&(h=!0);if("parent"in k){if(!(k.parent in g))throw"Error: child "+k.id+" references parent "+k.parent+" before it was defined.";var l=g[k.parent];void 0!==l.children?
l.children.push(k):l.children=[k]}"GroupNode"!==k.type&&"PageNode"!==k.type||void 0!==k.children||(k.children=[]);g[k.id]=k}}h||(f+=1);b(g[0],f);for(d=0;d<c.length;d++)this.log(c[d].toString());a=new Yc(h);a.pa(c);a.Vg();return a};c.prototype.Qm=function(a){function b(a,c){var e={id:c.id,type:c.type()};d.push(e);a&&(e.parent=a.id);var f=c.ec(),g;for(g in f)f.hasOwnProperty(g)&&("matrix"===g?e[g]=f[g].Sb():"inverse"!==g&&(e[g]=f[g]));if(c.Bn()&&c.children)for(e=0;e<c.children.length;e++)b(c,c.children[e])}
var d=[],c={type:"document"},f=!1,g;for(g in a.aa)a.aa.hasOwnProperty(g)&&(c[g]=a.aa[g],f=!0);f&&d.push(c);b(null,a.getRootNode());return d};c.prototype.th=function(a,b,d){b in this.Ll&&(b=this.Ll[b]);if("list"===b)a=this.Qm(a),b="application/json";else if("zwibbler3"===b)a=this.Qm(a),a="zwibbler3."+JSON.stringify(a),b="application/octet-stream";else if("image/svg+xml"===b){var c=a.bd();var f=new gd(c);a.rd(f);a.ha(f);a=f;b="image/svg+xml"}else if("application/pdf"===b){c=a.bd();f=new ed(new D(0,
0,c.width,c.height),O.fonts);var g=a.Ra;for(b=0;b<a.Jc();b++)0<b&&f.Zf(),f.translate(-c.x,-c.y),a.Rb(b),a.rd(f),a.ha(f);a.Rb(g);a=f;b="application/pdf"}else if(!(c="image/png"===b||"image/bmp"===b)&&(c="image/jpeg"==b)&&(c=document.createElement("canvas"),f=!1,c.width=10,c.height=10,"toDataURL"in c&&(f=0<c.toDataURL("image/jpeg").indexOf("jpeg")),ob("JPEG supported: %s",f),c=f),c)f=document.createElement("canvas"),c=a.bd(),f.width=c.width,f.height=c.height,g=f.getContext("2d"),g.translate(-c.x,-c.y),
a.rd(g),a.ha(g),a="image/bmp"===b?Db(f):f.toDataURL(b),a=a.split(",")[1],a=atob(a);else throw"Unknown save format: "+b;if("string"===typeof a)if("string"===d)var h=a;else if("data-uri"===d)h="data:"+b+";base64,"+qa(a);else{if("blob"===d)for(d=new Uint8Array(a.length),b=0;b<a.length;b++)d[b]=a.charCodeAt(b)}else if(a.toBlob&&a.toString)"string"===d?h=a.toString():"data-uri"===d?h="data:"+b+";base64,"+qa(a.toString()):"blob"===d&&(h=a.toBlob());else if("object"===d)h=a;else throw"Error in ZwibblerDocument.save()";
return h};return c}());var id=function(){function c(a,b,d){void 0===d&&(d=!1);var c=this;this.sa=a;this.Bk=0;this.vk={};this.tb=!1;this.timeout=null;this.lines=[];this.filter=null;this.Ij="#ffffff #008800 #008888 #880000 #880088 #884400 #888888 #444444 #0000ff #00ff00 #00ffff #ff0000 #ff00ff #ffff00".split(" ");nb('\n\n.z-inner-debug.black {\n    background: #000;\n}\n\n.z-inner-debug.white {\n    background: #fff;\n}\n\n.z-debug-panel {\n    font-family: "monospace";\n    font-size: 12px;\n    display: flex;\n    flex-flow: column nowrap;\n}\n\n.z-inner-debug {\n    flex: 1 1 auto;\n    overflow: scroll;\n}\n\n.z-inner-debug.black div {\n    border-bottom: 1px solid #222;\n    margin-bottom: 3px;\n}\n\n.z-inner-debug.white div {\n    border-bottom: 1px solid #eee;\n    margin-bottom: 3px;\n}\n');
a.classList.add("z-debug-panel");var f=0;z("input").Qi({type:"text",placeholder:"regexp...",onclick:"this.select()"}).Qd(a).addEventListener("input",function(a){f&&window.clearTimeout(f);f=setTimeout(function(){c.dt(a.target.value);f=0},200)});this.fd=z("div").se("z-inner-debug").Qd(a).Ga;this.Pr=w.addListener(function(a,b){return c.pm(a,b)});b.add(function(){w.removeListener(c.Pr)});this.pm("DEBUG","Debug window starting");z(this.fd).se(d?"white":"black");this.Ij[0]=d?"#000000":"#ffffff"}c.prototype.show=
function(){this.sa.style.display="flex";this.tb=!0;this.Yl();this.fd.scrollTop=this.fd.scrollHeight};c.prototype.Zd=function(){this.sa.style.display="none";this.tb=!1};c.prototype.Uq=function(a){a in this.vk||(this.vk[a]=this.Ij[this.Bk],this.Bk=(this.Bk+1)%this.Ij.length);return this.vk[a]};c.prototype.pm=function(a,b){for(var d=this,c=0,f=b.split("\n");c<f.length;c++)this.lines.push({key:a,line:f[c]});this.tb&&null===this.timeout&&(this.timeout=setTimeout(function(){d.timeout=null;d.Yl()},100))};
c.prototype.dt=function(a){this.filter=2>a.length?null:new RegExp(a,"i");for(a=this.fd.firstChild;a;){var b=a;1===b.nodeType&&"DIV"===b.tagName&&(!this.filter||this.filter.exec(b.textContent)?b.style.display="block":b.style.display="none");a=a.nextSibling}};c.prototype.Yl=function(){for(var a=this.fd.scrollTop>this.fd.scrollHeight-this.fd.clientHeight-100,b=0,c=this.lines;b<c.length;b++){var e=c[b],f=this.Uq(e.key),g=document.createElement("div");g.style.color=f;e=e.key+": "+e.line;this.filter&&!this.filter.exec(e)&&
(g.style.display="none");g.appendChild(document.createTextNode(e));this.fd.appendChild(g)}a&&(this.fd.scrollTop=this.fd.scrollHeight);this.lines.length=0};return c}();var jd=function(){function c(){this.tg=[];this.log=w.create("DESTRUCTOR")}c.prototype.add=function(a){this.tg.push(a)};c.prototype.addEventListener=function(a,b,c){a.addEventListener(b,c);this.add(function(){a.removeEventListener(b,c)})};c.prototype.rg=function(){this.log("Running %s destructors",this.tg.length);for(var a=this.tg.length-1;0<=a;a--)this.tg[a]();this.tg.length=0};return c}();var kd=function(c){function a(){var a=c.call(this)||this;a.keys={};a.Bi=!0;a.tt=new RegExp("alt backspace cmd command control ctrl del delete down end enter esc escape f4 home ins insert left meta pagedown pageup right shift up \u2318".split(" ").sort(function(a,b){return b.length-a.length}).join("|"),"g");a.log=w.create("KEYMAP");a.pn=function(b){a.Dr(b)};return a}n(a,c);a.prototype.map=function(a,c,e){void 0===e&&(e=!0);a=a.toLowerCase().split(",");var b;if("string"===typeof c)for(c=c.split(","),
b=0;b<a.length;b++)for(var d=0;d<c.length;d++)this.Zl(a[b],c[d],!e);else for(b=0;b<a.length;b++)this.Zl(a[b],c,!e)};a.prototype.Zl=function(a,c,e){if(0!==a.length){var b=a.match(this.tt)||[],d=!1,h=!1,k=!1,l=!1,m=[],q;for(q=0;q<b.length;q++)switch(b[q]){case "alt":k=!0;break;case "control":case "ctrl":h=!0;break;case "shift":d=!0;break;case "home":m.push(36);break;case "end":m.push(35);break;case "pageup":m.push(33);break;case "pagedown":m.push(34);break;case "delete":case "del":m.push(46);break;
case "backspace":m.push(8);break;case "up":m.push(38);break;case "right":m.push(39);break;case "down":m.push(40);break;case "left":m.push(37);break;case "escape":case "esc":m.push(27);break;case "enter":m.push(13);break;case "ins":case "insert":m.push(45);break;case "f4":m.push(115);break;case "meta":case "command":case "cmd":case "\u2318":l=!0;break;default:alert("key entry not found: "+b[q])}var p=this;b=function(a){d&&-1===a.indexOf("-shift")&&(a+="-shift");h&&-1===a.indexOf("-control")&&(a+="-control");
k&&-1===a.indexOf("-alt")&&(a+="-alt");l&&-1===a.indexOf("-meta")&&(a+="-meta");"string"===typeof c?p.log("%sKeyboard mapping: %s->%s",e?"Remove ":"",a,c):p.log("%sKeyboard mapping: %s->%s",e?"Remove ":"",a,"function()");if(e){if(a in p.keys){for(var b=[],f=0,g=p.keys[a];f<g.length;f++){var m=g[f];m!==c&&b.push(m)}p.keys[a]=b}}else if(a in p.keys){f=p.keys[a];for(b=0;b<f.length&&f[b]!==c;b++);b===f.length&&p.keys[a].push(c)}else p.keys[a]=[c]};if(0===m.length)switch(a=a.toUpperCase().charAt(a.length-
1),a){case "=":b("107-shift");b("187");b("61");break;case "+":b("107");b("61-shift");break;case "-":b("109");b("189");b("173");break;default:m.push(a.charCodeAt(0))}for(q=0;q<m.length;q++)b(""+m[q])}};a.prototype.hr=function(a){var b="";a.keyCode&&(b+=a.keyCode);a.shiftKey&&(b+="-shift");a.ctrlKey&&(b+="-control");a.altKey&&(b+="-alt");a.metaKey&&(b+="-meta");return b};a.prototype.translate=function(a){var b=[];a=this.hr(a);a in this.keys&&(b=this.keys[a]);this.log("%s",a);return b};a.prototype.Dr=
function(a){for(var b=0,c=this.translate(a);b<c.length;b++){var f=c[b];"string"===typeof f?(this.log("action: %s",f),this.Cf("*",f,a)):f(a)}};a.prototype.Cp=function(a){a.addEventListener("keydown",this.pn)};a.prototype.detach=function(a){a.removeEventListener("keydown",this.pn)};return a}(Pc);var ld=new (function(){function c(){this.Wj={}}c.prototype.Fh=function(){if("localStorage"in window)try{var a=window.localStorage}catch(b){}return void 0!==a};c.prototype.setItem=function(a,b){this.Fh()?window.localStorage.setItem(a,b):this.Wj[a]=""+b};c.prototype.getItem=function(a){return this.Fh()?window.localStorage.getItem(a):this.Wj[a]};c.prototype.removeItem=function(a){this.Fh()?window.localStorage.removeItem(a):delete this.Wj[a]};return c}());function md(c){function a(a){b&&clearTimeout(b);b=setTimeout(function(){b=null;c()},arguments.length?a:1E3)}var b=null;a.cancel=function(){b&&(clearTimeout(b),b=null)};return a};var od=function(){function c(a,b,c,e,f,g,h){this.view=a;this.node=b;this.handle=c;this.af=g;this.fh=this.eh=0;this.log=w.create("MoveEditNode");this.Zn=b.di(c);this.La=b.ka("snap")||0;this.Ta(e,f,h)}c.prototype.Hc=function(){this.log("Entering MoveEditNode")};c.prototype.Cc=function(){this.log("Leaving MoveEditNode")};c.prototype.rb=function(a){if("touchmove"===a.type){var b=a.touches[0];b=this.view.Za(b.pageX,b.pageY);return this.Va(b.x,b.y,a)}return"touchend"===a.type?(b=a.changedTouches[0],b=this.view.Za(b.pageX,
b.pageY),this.Wa(b.x,b.y,a)):!1};c.prototype.Ta=function(a,b){var c=this.view.La(new A(a,b),this.La);a=c.x;b=c.y;this.log("onMouseDown(%s,%s)",a,b);this.eh=a;this.fh=b;return!0};c.prototype.Va=function(a,b){var c=this.view.La(new A(a,b),this.La);a=c.x;b=c.y;this.node.Ne(this.handle,a,b);this.node.format(this.view.ia,this.view.request);this.view.ha();return!1};c.prototype.Wa=function(a,b){var c=this.view.La(new A(a,b),this.La);a=c.x;b=c.y;this.log("onMouseUp(%s,%s)",a,b,this.eh,this.fh);a!==this.eh||
b!==this.fh?this.view.pa([new Fc(this.node.id,this.handle,this.Zn.x,this.Zn.y,a,b)]):this.view.Ts(this.node.id,this.handle);this.view.ha();this.view.fb(this.af||new nd(this.view));return!0};return c}();var pd=function(){function c(a,b,c,e){this.view=a;this.af=b;this.Da=this.Ca=0;this.Qa=!1;this.log=w.create("SELECT");this.Wn(c,e)}c.prototype.rb=function(a){if("touchmove"===a.type){var b=this.view.Zb(a.changedTouches[0]);this.Va(b.x,b.y,a)}else"touchend"===a.type&&(b=this.view.Zb(a.changedTouches[0]),this.Wa(b.x,b.y,a));return!0};c.prototype.bb=function(a){this.log("Gesture detected; aborting select box.");this.view.fb(this.af);return this.af.bb?this.af.bb(a):!1};c.prototype.Ta=function(a,b){return this.Wn(a,
b)};c.prototype.Wn=function(a,b){this.Ca=a;this.Da=b;return this.Qa=!0};c.prototype.Va=function(a,b){if(this.Qa){var c=this;this.view.ha(function(d){d.save();d.strokeStyle="#0050B7";d.lineWidth=2/c.view.scale;d.fillStyle="rgba(0, 80, 183, 0.2)";var e=new D(c.Ca+.5,c.Da+.5,a-c.Ca,b-c.Da);d.fillRect(e.x,e.y,e.width,e.height);d.strokeRect(e.x,e.y,e.width,e.height);d.restore()});return!0}return!1};c.prototype.Wa=function(a,b){this.Qa=!1;this.view.pb();this.view.Ss(new D(this.Ca,this.Da,a-this.Ca,b-this.Da));
this.view.Mb();this.view.ha();this.view.fb(this.af);return!0};return c}();var qd={type:"translate",position:new A(0,0),offset:new A(0,0),Me:""},rd={type:"translate",position:new A(0,0),offset:new A(0,0),Me:""},sd={type:"translate",position:new A(0,0),offset:new A(0,0),Me:""},td=function(){function c(a,b,c){this.ke=a;this.oa=b;this.Oa=c}c.prototype.ki=function(a,b){void 0===a&&(a=this.oa);void 0===b&&(b=1);var c=a.yd();return new A(this.Oa.x+this.Oa.width*this.ke.position.x+this.ke.offset.x/c.x/b,this.Oa.y+this.Oa.height*this.ke.position.y+this.ke.offset.y/c.y/b)};c.prototype.jk=
function(){var a=this.ki();return this.oa.apply(a.x,a.y)};c.prototype.ha=function(a,b,c,e){a.save();e=e.multiply(this.oa);var d=e.yd();d.x=1/d.x/c;d.y=1/d.y/c;c=this.ki(e,c);e=e.multiply(new Lb(d.x,d.y,c.x,c.y));e.bg(a);(b=b.get(this.ke.Me))?(e=b.width,d=b.height,a.drawImage(b,c.x-e/2,c.y-d/2,e,d)):this.Tj(a,c);a.restore()};c.prototype.Tj=function(a,b){a.strokeStyle="red";a.lineWidth=1;a.strokeRect(b.x-10,b.y-10,20,20)};c.prototype.xb=function(a,b,c,e,f){var d=a.get(this.ke.Me);a=this.ki(this.oa,
f);b=this.oa.inverse().apply(b,c);c=this.oa.yd();c.x*=f;c.y*=f;d?(e=d.width,f=d.height,a=new D(a.x-e/2/c.x,a.y-f/2/c.y,e/c.x,f/c.y)):a=new D(a.x-e/c.x,a.y-e/c.y,2*e/c.x,2*e/c.y);return a.Wc(b.x,b.y,0)};c.prototype.click=function(){return!1};return c}(),ud=function(c){function a(a,d,e,f){a=c.call(this,a,d,e)||this;a.origin=f;return a}n(a,c);a.prototype.Ff=function(a){var b=1,c=1,f=this.oa.inverse(),g=this.jk(),h=this.ki();a=f.apply(g.x+a.x,g.y+a.y);h=new A(h.x-this.origin.x,h.y-this.origin.y);a=new A(a.x-
this.origin.x,a.y-this.origin.y);a=(a.x*h.x+a.y*h.y)/(h.x*h.x+h.y*h.y);0!==h.x&&0!==h.y?c=b=a:0!==h.x?b=a:c=a;return this.oa.multiply(new Lb(b,c,this.origin.x,this.origin.y)).multiply(f)};a.prototype.Tj=function(a,c){a.beginPath();a.strokeStyle="#000";a.lineWidth=1;a.rect(c.x-4,c.y-4,8,8);a.stroke()};return a}(td),vd=function(c){function a(a,d,e,f,g){a=c.call(this,a,d,e)||this;a.Lh=g;a.log=w.create("RotationSelHandle");d=a.jk();a.origin=a.oa.apply(f.x,f.y);a.il=Math.atan2(d.y-a.origin.y,d.x-a.origin.x);
a.Lh=g;return a}n(a,c);a.prototype.Ff=function(a){var b=this.jk();a=Math.atan2(b.y+a.y-this.origin.y,b.x+a.x-this.origin.x)-this.il;this.Lh&&(b=Math.PI/16,a=Math.floor(a/b)*b);return new Kb(-a,this.origin.x,this.origin.y)};a.prototype.Tj=function(a,c){a.beginPath();a.strokeStyle="#008000";a.lineWidth=3;a.moveTo(c.x,c.y);a.arc(c.x,c.y,6,0,1.5*Math.PI,!1);a.stroke()};return a}(td),wd=function(c){function a(a,d){return c.call(this,a,d,new D(0,0,0,0))||this}n(a,c);a.prototype.Ff=function(a){return new E(a.x,
a.y)};return a}(td),xd=function(c){function a(){return c.call(this,sd,new F,new D(0,0,0,0))||this}n(a,c);a.prototype.Ff=function(){return new F};return a}(td),yd=function(c){function a(a,d,e){return c.call(this,a,d,e)||this}n(a,c);a.prototype.click=function(){this.ke.Cm&&this.ke.Cm();return!0};a.prototype.Ff=function(){return new F};return a}(td);
function zd(c,a,b,d){var e=void 0,f=new A(0,0),g=b.yd();f.x=a.x+a.width*c.position.x+c.offset.x/g.x;f.y=a.y+a.height*c.position.y+c.offset.y/g.y;switch(c.type){case "translate":return new wd(c,b);case "scale":return e||(e=new A(a.right()-c.position.x*a.width,a.bottom()-c.position.y*a.height)),new ud(c,b,a,e);case "rotate":return e||(e=a.Vc()),new vd(c,b,a,e,d||!1);case "click":return new yd(c,b,a)}};function Ad(c){for(var a=[],b=0;b<c.length;b++)a.push(c[b].id);return a}
var Bd=function(){function c(a,b,c,e,f,g){this.view=a;this.handle=b;this.yt=c;this.Wg=new D(0,0,0,0);this.ra=[];this.Jf=[];this.jd=new A(0,0);this.log=w.create("TransformSelectionBehaviour");this.un=!1;this.La=0;this.Ta(e,f,g)}c.prototype.rb=function(a){var b;if(this.un||"touchmove"!==a.type&&"touchstart"!==a.type&&"touchend"!==a.type)return!1;for(b=0;b<a.touches.length;){b=a.touches[b];b=this.view.Za(b.pageX,b.pageY);"touchmove"===a.type&&this.Va(b.x,b.y,a);break}for(b=0;b<a.changedTouches.length;){b=
a.changedTouches[b];b=this.view.Za(b.pageX,b.pageY);"touchend"===a.type&&this.Wa(b.x,b.y,a);break}return!0};c.prototype.bb=function(a){if("gesturestart"!==a.type&&"gesturechange"!==a.type&&"gestureend"!==a.type)return!1;this.log("%s scale=%s rotation=%s",a.type,a.scale,a.rotation);this.un=!0;var b=this.Wg.x+this.Wg.width/2,c=this.Wg.y+this.Wg.height/2,e=a.scale;this.view.Ni||(e=1);var f=-a.rotation/180*Math.PI;if(0<this.view.fa.get("snap")){var g=Math.PI/16;f=Math.floor(f/g)*g}e=new Lb(e,e,b,c);b=
new Kb(f,b,c);b=e.multiply(b);for(c=0;c<this.ra.length;c++)this.ra[c].Vf(b.multiply(this.Jf[c])),this.ra[c].format(this.view.ia,this.view.request);this.view.Zi(b);this.view.ha();if("gestureend"===a.type){for(c=0;c<this.ra.length;c++)this.ra[c].Vf(this.Jf[c]);this.view.pa([new Ec(Ad(this.ra),b)]);this.Pm()}return!0};c.prototype.Ta=function(a,b){this.ra=this.view.Ac();this.zq(this.ra);this.jd=this.view.La(new A(a,b),this.La);this.log("onMouseDown(%s,%s)",this.jd.x,this.jd.y);this.Wg=new D(this.view.Qc.x,
this.view.Qc.y,this.view.Qc.width,this.view.Qc.height);return!0};c.prototype.zq=function(a){this.Jf=[];for(var b=0;b<a.length;b++)this.Jf.push(a[b].Ea()),this.La=this.La||a[b].ka("snap")};c.prototype.Va=function(a,b){var c=this;var e=this.view.La(new A(a,b),this.La);var f=e.x;var g=e.y;for(var h=this.handle.Ff(new A(e.x-this.jd.x,e.y-this.jd.y)),k=0;k<this.ra.length;k++)e=h.multiply(this.Jf[k]),this.ra[k].Vf(e),this.ra[k].format(this.view.ia,this.view.request);this.view.Zi(h);this.view.ha(function(){if(c.handle instanceof
vd){var a=c.view.ia;a.save();a.beginPath();a.strokeStyle="#0050B7";a.lineWidth=1/c.view.scale;a.moveTo(c.handle.origin.x,c.handle.origin.y);a.lineTo(f,g);a.stroke();a.restore()}});return!0};c.prototype.Wa=function(a,b){var c=a,e=b,f=this.view.La(new A(a,b),this.La);a=f.x;b=f.y;this.log("onMouseUp(%s,%s)",a,b);if(f.sd(this.jd))this.yt?(c=this.view.ea.xb(c,e,this.view.Pa))&&c.Fg()?(this.log("Didn't move, and has edit mode. Selecting node %s",c.id),this.view.pb(),this.view.hf(c)):this.log("Didn't move, but node has no edit mode or failed hittest"):
this.log("Didn't move, but toggleEditNode=false");else{this.log("Moved by %s,%s",a-this.jd.x,b-this.jd.y);c=this.handle.Ff(new A(f.x-this.jd.x,f.y-this.jd.y));for(e=0;e<this.ra.length;e++)this.ra[e].Vf(this.Jf[e]);this.view.pa([new Ec(Ad(this.ra),c)])}this.Pm();return!0};c.prototype.Pm=function(){this.view.Zi(new F);this.view.zf();this.view.update(!0);this.view.eb()};return c}();var Cd=function(){function c(a,b){this.view=a;this.aa=b;this.Zh=!1;this.xa=this.Xd=this.ja=null;this.fillStyle="#000000";this.Xi=!1;this.ml="normal";this.log=w.create("Text");this.multiline=a.fa.get("multilineText");this.qb=document.createElement("div");a.fa.get("iPadNoScrollText")&&null!==navigator.userAgent.match(/iPad|iPhone|Android/i)&&(this.ml="top")}c.prototype.Hc=function(){this.log("Entering text mode");this.view.canvas.style.cursor="text"};c.prototype.Cc=function(){this.Zh&&this.Ph();this.view.canvas.style.cursor=
"default";this.log("Leaving text mode");this.ja&&this.ja.parentNode&&(this.ja.parentNode.removeChild(this.ja),this.ja=null);this.qb.parentNode&&this.qb.parentNode.removeChild(this.qb)};c.prototype.rb=function(a){if("touchstart"!==a.type&&"touchend"!==a.type&&"touchmove"!==a.type)return!1;for(var b=0;b<a.touches.length;b++){var c=a.touches[b];c=this.view.Za(c.pageX,c.pageY);"touchstart"===a.type&&this.Ta(c.x,c.y,a)}return!0};c.prototype.Ta=function(a,b,c){this.log("onMouseDown(%s)",c.type);this.Zh?
(this.log("Editing somewhere else on mousedown; submit that first."),this.Ph(),this.view.fa.get("autoPickToolText")&&this.view.eb()):(c=this.view.ea.xb(a,b,this.view.Pa),this.kl(c,a,b));this.log("Eating click");this.view.Yh=!0;return!1};c.prototype.yq=function(){if(this.qb&&this.ja){this.qb.style.fontSize=this.ja.style.fontSize;this.qb.style.fontFamily=this.ja.style.fontFamily;this.qb.style.fontWeight=this.ja.style.fontWeight;this.qb.style.fontStyle=this.ja.style.fontStyle;this.qb.style.whiteSpace=
"pre-line";this.qb.style.position="absolute";this.qb.style.visibility="hidden";this.qb.style.backgroundColor="rgba(0,0,0,0.2)";document.body.appendChild(this.qb);this.qb.style.left="0";for(this.qb.style.top="0";this.qb.firstChild;)this.qb.removeChild(this.qb.firstChild);this.qb.appendChild(document.createTextNode(this.ja.value));var a=this.qb.clientWidth,b=this.ja.clientWidth;b<a&&(b=a,this.view.fa.get("multilineText")&&b>500*this.view.scale&&(b=500*this.view.scale),this.ja.style.width=b+2+"px")}};
c.prototype.kl=function(a,b,c){function d(){p.ja&&(p.log("Set editBox height to %s",""+p.ja.scrollHeight+"px"),p.ja.style.height=""+p.ja.scrollHeight+"px",p.ja.style.width=""+p.ja.scrollWidth+"px");t=null}function f(){null===p.xa&&p.yq()}var g=0;this.Xi=!1;if(a&&"TextNode"===a.type()||a&&"PathNode"===a.type()&&this.view.fa.get("allowTextInShape")){this.xa=a;"top"!==this.ml&&"TextNode"===a.type()&&this.xa.he(!0);this.view.ha();this.Xd=new A(a.rect.x,a.rect.y);var h=a.ka("fontName");var k=a.ka("fontSize");
var l=a.ka("bold");var m=a.ka("italic");var q=a.ka("textDecoration");g=a.rect.width*this.view.scale;g=Math.max(g,200);this.fillStyle=a.ka("textFillStyle")||this.gb("textFillStyle")}else this.xa=null,this.Xd=new A(b,c),h=this.gb("fontName"),k=this.gb("fontSize"),l=this.gb("bold"),m=this.gb("italic"),q=this.gb("textDecoration"),this.fillStyle=this.aa.fillStyle||this.gb("textFillStyle")||this.gb("fillStyle"),this.gb("wrap")&&(c-=k);var p=this;this.ja=document.createElement("textarea");a=this.ja.clientHeight;
this.ja.style.width=g?""+g+"px":"auto";g=this.view.Qj(this.Xd.x,this.Xd.y);this.ja.style.position="absolute";this.ja.style.fontFamily=h;this.ja.style.fontSize=""+k*this.view.scale+"px";this.ja.style.overflow="auto";this.ja.style.fontWeight=l?"bold":"normal";this.ja.style.fontStyle=m?"italic":"normal";this.ja.style.padding="0";this.ja.style.border="1px solid #888";this.ja.style.color=this.fillStyle;this.ja.style.backgroundColor=this.gb("background");this.xa&&"PathNode"===this.xa.type()&&(this.ja.style.backgroundColor=
"white");this.ja.style.textDecoration=q||"none";this.ja.style.textAlign=this.gb("textAlign");this.ja.style.zIndex=""+(this.view.Gf()+1);this.log("Using z-index %s",this.ja.style.zIndex);"#ffffff"===u.td(this.fillStyle).toString()&&(this.ja.style.backgroundColor="#808080");h=this.view.canvas.parentElement;k=z(h).dc();m=l=0;"top"===this.ml?(m=z(this.view.canvas).dc(),l=this.view.canvas.clientWidth,g=this.ja.clientWidth,l=m.left+l/2-g/2,m=m.top):(l=Math.round(g.x)-1,m=Math.round(g.y)-1);this.ja.style.WebkitTransitionDuration=
"0";this.ja.style.MozTransitionDuration="0";this.ja.style.msTransitionDuration="0";this.ja.style.OTransitionDuration="0";this.ja.style.transitionDuration="0";this.ja.style.left=l-k.left+"px";this.ja.style.top=m-k.top+"px";h.appendChild(this.ja);Cb(this.ja);this.Zh=!0;this.Xd=new A(b,c+a);this.xa&&(this.ja.value=this.xa.ka("text"));var t=null;t=setTimeout(d,0);this.ja.addEventListener("keydown",function(a){"keydown"===a.type&&(27===a.keyCode&&p.multiline||13===a.keyCode&&(a.shiftKey||!p.multiline)?
(p.log("Enter pressed. create text."),p.Ph(),p.view.za.tb&&p.view.ot(a),p.view.fa.get("autoPickToolText")&&p.view.eb()):27===a.keyCode?(p.log("ESC pressed; cancel."),p.cancel(),p.view.eb(),p.view.qc.ua("goto-toolbar")):13===a.keyCode&&(t||(t=setTimeout(d,0))))});this.ja.addEventListener("input",f);this.ja.addEventListener("propertychange",f);this.view.fa.get("leaveTextToolOnBlur")&&(this.ja.addEventListener("focus",function(){p.log("Text focus received.")}),this.ja.addEventListener("blur",function(){p.ja&&
!p.ja.Ok&&(p.log("Text blur received -- removing=%s",!0===p.ja.Ok),p.ja.Ok=!0,p.Ph())}));setTimeout(function(){p.ja&&p.ja.focus()},200);this.ja.focus();this.view.Aa.ua("edit-text-shown",p.ja)};c.prototype.cancel=function(){this.ja&&(this.ja.Ok=!0,this.ja.parentNode&&this.ja.parentNode.removeChild(this.ja),this.view.Aa.ua("edit-text-hidden"),this.view.za.tb&&this.view.qc.ua("goto-canvas"));this.ja=null;this.Zh=!1;this.xa&&(this.xa.he(!1),this.view.ha())};c.prototype.gb=function(a){return a in this.aa?
this.aa[a]:"background"===a?this.view.fa.get("defaultTextBackground"):"wrap"===a?this.view.fa.get("multilineText"):this.view.wa[a]};c.prototype.Ph=function(){if(this.ja){var a=this.ja.value;this.cancel();if(this.xa&&this.xa.ka("text")===a&&!this.Xi)this.log("Text was not changed.");else if(null===this.xa&&""===a)this.log("No text entered.");else if(this.xa)this.log("Update text in node %s",this.xa.id),a=[new Dc([this.xa.id],"text",a),new Dc([this.xa.id],"textFillStyle",this.fillStyle),new Dc([this.xa.id],
"textAlign",this.gb("textAlign")),new Dc([this.xa.id],"textDecoration",this.gb("textDecoration"))],"bold"in this.aa&&a.push(new Dc([this.xa.id],"bold",this.aa.bold)),"italic"in this.aa&&a.push(new Dc([this.xa.id],"italic",this.aa.bold)),this.view.pa(a);else if(this.Xd){this.log("Create new text node.");var b=this.view.ea.nb,c=0,e=this.gb("fontSize");this.view.fa.get("multilineText")||(c=e);c=new E(this.Xd.x,this.Xd.y+c);this.view.pa([new S(this.view.ea.$a(),"TextNode",Fb({text:a,background:this.gb("background"),
fontSize:e,fontName:this.gb("fontName"),bold:this.gb("bold"),italic:this.gb("italic"),textAlign:this.gb("textAlign"),textFillStyle:this.gb("textFillStyle"),textDecoration:this.gb("textDecoration"),strokeStyle:this.gb("textStrokeStyle"),lineWidth:this.gb("textLineWidth"),layer:this.aa.layer||this.view.Pa,wrap:this.view.fa.get("multilineText")},this.aa)),new Ec([b],c)])}}};c.prototype.Va=function(){return!1};c.prototype.Nc=function(a){this.log("keyboard: %s",a);"cancel"===a&&null===this.ja&&(this.view.eb(),
this.view.qc.ua("goto-toolbar"))};c.prototype.be=function(a){this.log("Set text colour to %s",a);this.Xi=!0;this.fillStyle=a;this.aa.textFillStyle=a;this.ja&&(this.ja.style.color=a,"#ffffff"===u.td(a).toString()?this.ja.style.backgroundColor="#808080":this.ja.style.backgroundColor="#ffffff")};c.prototype.de=function(a,b){this.view.bl(a,b)};c.prototype.Dd=function(a,b){"defaultBold"===a?(a="bold",this.ja&&(this.ja.style.fontWeight=b?"bold":"normal")):"defaultItalic"===a?(a="italic",this.ja&&(this.ja.style.fontStyle=
b?"italic":"normal")):"defaultTextBackground"===a?(a="background",this.ja&&(this.ja.style.backgroundColor=b)):"defaultFont"===a?(a="fontName",this.ja&&(this.ja.style.fontFamily=b)):"defaultFontSize"===a?(a="fontSize",this.ja&&(this.ja.style.fontSize=b+"px")):"defaultTextFillStyle"===a?(a="textFillStyle",this.ja&&(this.ja.style.color=b)):"defaultTextDecoration"===a?(a="textDecoration",this.ja&&(this.ja.style.textDecoration=b)):"defaultTextAlign"===a&&(a="textAlign",this.ja&&(this.ja.style.textAlign=
b));this.log("Update %s=%s",a,b);this.Xi=!0;this.aa[a]=b};c.prototype.cd=function(){return"text"};c.prototype.ie=function(a,b){this.aa[a]=b};return c}();var Dd=function(){function c(a){this.view=a;this.start=new A(0,0);this.jl=new A(0,0);this.active=!1;this.rect=null;this.log=w.create("PanZoomMixin")}c.prototype.bb=function(a){this.log("onGesture(%s)",a.type);if(!this.view.fa.get("allowZoom"))return!1;if("gesturestart"===a.type)this.start=new A(a.pageX,a.pageY),this.jl=this.view.Za(a.pageX,a.pageY),this.rect=this.view.Yd(),this.active=!0;else if("gesturechange"===a.type&&this.rect){var b=a.pageX-this.start.x,c=a.pageY-this.start.y;a=this.view.fa.Sk(1/
a.scale);a=new Lb(a,a,this.jl.x,this.jl.y);a=(new E(-b/this.view.scale,-c/this.view.scale)).multiply(a);b=this.rect.clone();b.transform(a);this.view.ah(b)}else"gestureend"===a.type&&(this.active=!1);return!0};return c}();var nd=function(){function c(a){this.view=a;this.po=1;this.log=w.create("DefaultBehaviour");this.view.Ri("");if(this.dg=this.view.fa.dg())this.po=2;this.Xb=new Dd(a)}c.prototype.Hc=function(){this.log("Entering pick tool.");this.view.canvas.style.cursor="default"};c.prototype.Cc=function(){this.log("Leaving pick tool.")};c.prototype.rb=function(a){if("touchmove"!==a.type&&"touchstart"!==a.type&&"touchend"!==a.type)return!1;for(var b=0;b<a.touches.length;b++){var c=a.touches[b];c=this.view.Za(c.pageX,
c.pageY);if("touchstart"===a.type)return this.Ta(c.x,c.y,a);if("touchend"===a.type)return this.Wa(c.x,c.y,a)}return!1};c.prototype.bb=function(a){return this.Xb.bb(a)};c.prototype.Ta=function(a,b,c){var d,f;this.log("onMouseDown");if(c.button)return this.log("   -- not main button. ignore."),!1;if(this.view.fa.get("readOnly"))return(d=this.view.ea.xb(a,b,this.view.Pa))?(this.log("layer=%s active=%s",d.xd(),this.view.Pa),this.view.Aa.ua("node-clicked",d.id,a,b)):this.log("readOnly mode: Ignoring click."),
!1;if(f=this.view.er(a,b)){if(f.click())return!0;this.view.fb(new Bd(this.view,f,!1,a,b,c));return!0}this.view.selection.length&&this.view.Jr(c)&&this.view.qg();if(this.view.xa&&(d=this.view.xa,f=d.pi(a,b,1/this.view.scale*this.po),null!==f))return this.view.fb(new od(this.view,d,f,a,b,this,c)),!0;if(d=this.view.ea.xb(a,b,this.view.Pa))this.log("layer=%s active=%s",d.xd(),this.view.Pa),this.view.Aa.ua("node-clicked",d.id,a,b);if(d&&d.xd()===this.view.Pa){f=d===this.view.xa;var g=this.view.Ir(d);this.log("wasEditNode: %s, wasSelected: %s",
f,g);g||(c.shiftKey||this.view.pb(),this.view.te(d),this.view.Mb());this.view.fb(new Bd(this.view,this.view.Tf?new wd(qd,d.Ea()):new xd,!f&&g,a,b,c))}else if(this.view.bo(a,b))this.view.fb(new Bd(this.view,this.view.Tf?new wd(qd,this.view.selection[0].Ea()):new xd,!0,a,b,c));else if(this.view.fa.Qq())this.view.hf(null),this.view.fb(new pd(this.view,this,a,b));else return this.log("Disabled select box -- mobile touch active."),this.view.hf(null),this.view.pb(),this.view.Mb(),this.view.ha(),!1;return!0};
c.prototype.Wa=function(){this.log("onMouseUp");return!1};c.prototype.Nc=function(a,b){this.log("keyboard: %s on target %s",a,b.target.tagName);if("INPUT"!==b.target.tagName){var c=!0,e=this.view.fa.get("nudge");b&&b.ctrlKey&&(e=this.view.fa.get("preciseNudge"));var f=this.view.za.tb;switch(a){case "bring-to-front":this.view.Gh();break;case "send-to-back":this.view.Oi();break;case "left":f||this.view.Ci(-1,0,e)||(this.view.ub=Math.min(this.view.ub+16,0),this.view.mc(),this.view.ha());break;case "right":f||
this.view.Ci(1,0,e)||(e=this.view.ve.width,this.view.ub=Math.max(-(e*this.view.scale-e),this.view.ub-16),this.view.mc(),this.view.ha());break;case "up":f||this.view.Ci(0,-1,e)||(this.view.jb=Math.min(this.view.jb+16,0),this.view.mc(),this.view.ha());break;case "down":f||this.view.Ci(0,1,e)||(e=this.view.ve.height,this.view.jb=Math.max(-(e*this.view.scale-e),this.view.jb-16),this.view.mc(),this.view.ha());break;case "select-none":this.view.pb();this.view.Mb();this.view.ha();f&&this.view.qc.ua("goto-toolbar");
break;case "select-all":var g=[];this.view.ea.Ce(function(a){g.push(a)});this.view.selectNodes(g);this.view.ha();f&&this.view.qc.ua("goto-toolbar");break;case "duplicate":this.view.duplicate();break;case "move-up":this.view.zi();break;case "move-down":this.view.yi();break;case "delete":this.view.qg();break;case "curve-tool":this.view.Gm({});break;case "line-tool":this.view.Gn({},!1,!1);break;case "group":this.view.group();break;case "ungroup":this.view.mh();break;case "undo":this.view.kb();break;
case "redo":this.view.Hd();break;case "cut":this.view.Nj();break;case "copy":this.view.Ae();break;case "paste":this.view.Rg();break;case "zoom-normal":this.view.fa.get("allowZoom")?this.view.wc(1):this.log("Zooming is disabled.");break;case "zoom-in":this.view.fa.get("allowZoom")?this.view.ej():this.log("Zooming is disabled.");break;case "zoom-out":this.view.fa.get("allowZoom")?this.view.fj():this.log("Zooming is disabled.");break;default:c=!1}c&&(b.preventDefault(),b.stopPropagation())}};c.prototype.be=
function(a,b){if(b){this.view.Bb=a;this.view.Ub=a;var c="fillStyle"}else this.view.Lb=a,c="strokeStyle";this.view.setProperty(c,a)};c.prototype.de=function(a,b){b?(this.view.Bb=zb(this.view.Bb,a),this.view.Ub=zb(this.view.Ub,a)):this.view.Lb=zb(this.view.Lb,a);this.view.bl(a,b)};c.prototype.ce=function(a,b){this.log("onDoubleClick");var c=this.view.ea.xb(a,b,this.view.Pa);this.log("hittest: %s, hasText: %s",null!==c,null!==c&&c.ni());this.view.Aa.ua("double-click",a,b,c?c.id:null);if(c&&"PathNode"===
c.type()&&!this.view.fa.get("allowTextInShape"))this.log("Editing text in shape is disabled.");else if(c&&c.ni()&&!this.view.fa.get("readOnly"))this.log("Text double-clicked."),this.view.nl({}),this.view.ma instanceof Cd&&this.view.ma.kl(c,a,b);else return!1;return!0};c.prototype.cd=function(){return"pick"};return c}();var Ed=w.create("FitCurve");
function Fd(c){function a(a,b){y.bezierCurveTo(b[1].x,b[1].y,b[2].x,b[2].y,b[3].x,b[3].y);Ed("Bezier: (%s,%s), (%s,%s), (%s,%s), (%s,%s)",b[0].x,b[0].y,b[1].x,b[1].y,b[2].x,b[2].y,b[3].x,b[3].y)}function b(a,b){return a.x*b.x+a.y*b.y}function d(a){var b=1-a;return 3*a*b*b}function e(a){return 3*a*a*(1-a)}function f(a,b){var c=a.x-b.x,d=a.y-b.y;return Math.sqrt(c*c+d*d)}function g(a){return a.x*a.x+a.y*a.y}function h(a,b){var c=Math.sqrt(g(a));0!==c&&(a.x*=b/c,a.y*=b/c);return a}function k(a,b,c){void 0===
c&&Ed("Undef!");c.x=a.x+b.x;c.y=a.y+b.y;return c}function l(a,b){return{x:a.x+b.x,y:a.y+b.y}}function m(a,b){return{x:a.x*b,y:a.y*b}}function q(a,b){return{x:a.x-b.x,y:a.y-b.y}}function p(a,c,g,p,t,r){var N,y=[],x=[[],[]],J=[];var v=[{x:0,y:0},{x:0,y:0},{x:0,y:0},{x:0,y:0}];var I=g-c+1;for(N=0;N<I;N++){var P={x:t.x,y:t.y};var G={x:r.x,y:r.y};h(P,d(p[N]));h(G,e(p[N]));y[N]=[P,G]}x[0][0]=0;x[0][1]=0;x[1][0]=0;x[1][1]=0;J[0]=0;for(N=J[1]=0;N<I;N++)x[0][0]+=b(y[N][0],y[N][0]),x[0][1]+=b(y[N][0],y[N][1]),
x[1][0]=x[0][1],x[1][1]+=b(y[N][1],y[N][1]),P=1-p[N],G=p[N],P=q(a[c+N],l(m(a[c],P*P*P),l(m(a[c],d(p[N])),l(m(a[g],e(p[N])),m(a[g],G*G*G))))),J[0]+=b(y[N][0],P),J[1]+=b(y[N][1],P);p=x[0][0]*x[1][1]-x[1][0]*x[0][1];N=x[0][0]*J[1]-x[0][1]*J[0];J=J[0]*x[1][1]-J[1]*x[0][1];0===p&&(p=x[0][0]*x[1][1]*1E-11);x=J/p;J=N/p;if(0>x||0>J)return x=f(a[g],a[c])/3,v[0]=a[c],v[3]=a[g],k(v[0],h(t,x),v[1]),k(v[3],h(r,x),v[2]),v;v[0]=a[c];v[3]=a[g];k(v[0],h(t,x),v[1]);k(v[3],h(r,J),v[2]);return v}function t(a,b,c){var d;
var e=[];for(d=0;d<=a;d++)e[d]={x:b[d].x,y:b[d].y};for(d=1;d<=a;d++)for(b=0;b<=a-d;b++)e[b].x=(1-c)*e[b].x+c*e[b+1].x,e[b].y=(1-c)*e[b].y+c*e[b+1].y;return e[0]}function r(a){var b=Math.sqrt(Math.sqrt(g(a)));0!==b&&(a.x/=b,a.y/=b);return a}function v(a,b,c,d,e){var f,h=(c-b+1)/2;var k=0;for(f=b+1;f<c;f++){var l=t(3,d,e[f-b]);l=q(l,a[f]);l=g(l);l>=k&&(k=l,h=f)}return{Mn:k,Do:h}}function x(b,c,d,e,g,l){var m;var y=[{x:0,y:0},{x:0,y:0},{x:0,y:0},{x:0,y:0}];var J=l*l;if(2===d-c+1)l=f(b[d],b[c])/3,y[0]=
b[c],y[3]=b[d],k(y[0],h(e,l),y[1]),k(y[3],h(g,l),y[2]),a(3,y);else{var U=[0];for(m=c+1;m<=d;m++)U[m-c]=U[m-c-1]+f(b[m],b[m-1]);for(m=c+1;m<=d;m++)U[m-c]/=U[d-c];var P=U;y=p(b,c,d,P,e,g);m=v(b,c,d,y,P);U=m.Mn;m=m.Do;if(U<l)a(3,y);else{if(U<J||I)for(J=0;4>J;J++){m=b;U=c;var G=d;var la=y;var Da=[];for(y=U;y<=G;y++){var Qa=Da,xe=y-U,M,Ra=la,fb=m[y],gb=P[y-U],ra=[];var xa=[];var hb=t(3,Ra,gb);for(M=0;2>=M;M++)ra[M]={x:0,y:0},ra[M].x=3*(Ra[M+1].x-Ra[M].x),ra[M].y=3*(Ra[M+1].y-Ra[M].y);for(M=0;1>=M;M++)xa[M]=
{x:0,y:0},xa[M].x=2*(ra[M+1].x-ra[M].x),xa[M].y=2*(ra[M+1].y-ra[M].y);M=t(2,ra,gb);xa=t(1,xa,gb);Qa[xe]=gb-((hb.x-fb.x)*M.x+(hb.y-fb.y)*M.y)/(M.x*M.x+M.y*M.y+(hb.x-fb.x)*xa.x+(hb.y-fb.y)*xa.y)}G=Da;y=p(b,c,d,G,e,g);m=v(b,c,d,y,G);U=m.Mn;m=m.Do;if(U<l||I){a(3,y);return}P=G}G={x:0,y:0};J=q(b[m-1],b[m]);U=q(b[m],b[m+1]);G.x=(J.x+U.x)/2;G.y=(J.y+U.y)/2;J=G=r(G);x(b,c,m,e,J,l);J.x=-J.x;J.y=-J.y;x(b,m,d,J,g,l)}}}var I=!0;void 0===I&&(I=!1);var y=new H;y.moveTo(c[0].x,c[0].y);(function(a,b,c){var d=q(a[1],
a[0]);d=r(d);var e=b-1;e=q(a[e-1],a[e]);e=r(e);x(a,0,b-1,d,e,c)})(c,c.length,25);return y};var Gd=function(){function c(a,b,c,e){var d=this;this.view=a;this.af=b;this.options=c;this.mode=e;this.Qa=!1;this.Qb=[];this.kh={};this.from=this.Fe=null;this.log=w.create("Brush");this.Xb=new Dd(this.view);this.view.pb(!0);this.lo=function(){return d.Qe()}}c.prototype.Qe=function(){this.yk(this.$c()/2)};c.prototype.Hc=function(){this.view.canvas.style.cursor="crosshair";this.yk(this.$c()/2);window.addEventListener("resize",this.lo)};c.prototype.Cc=function(){this.view.canvas.style.cursor="default";
this.view.ha();window.removeEventListener("resize",this.lo)};c.prototype.reset=function(){this.Qa=!1;this.Qb=[];this.kh={}};c.prototype.bb=function(a){a=this.Xb.bb(a);this.Qa&&this.Xb.active&&this.reset();return a};c.prototype.yk=function(a){var b=document.createElement("canvas");a*=this.view.scale;a=Math.ceil(a+1);b.width=2*a+2;b.height=2*a+2;var c=b.getContext("2d");c.beginPath();"round"===(this.options.lineCap||"round")?c.arc(a+1,a+1,a,0,2*Math.PI):c.rect(1,1,2*a-2,2*a-2);c.lineWidth=2;c.strokeStyle=
"#ffffff";c.stroke();c.lineWidth=1;c.strokeStyle="#000000";c.stroke();b=b.toDataURL();this.view.canvas.style.cursor="url("+b+") "+(a+1)+" "+(a+1)+", auto"};c.prototype.Yg=function(a){this.options.strokeStyle=a};c.prototype.$c=function(){var a=this.options.lineWidth;this.view.fa.get("adaptiveBrushWidth")&&(a/=this.view.scale);return a};c.prototype.Xk=function(a){this.options.lineWidth=a;this.yk(this.$c()/2)};c.prototype.rb=function(a){var b;if(this.Xb.active)return!0;if("touchstart"===a.type){var c=
a.changedTouches;var e=0;for(b=c.length;e<b;e++){var f=c[e];a=this.view.Za(f.pageX,f.pageY,!0);this.Qb.push([a]);f.identifier&&(this.kh[f.identifier]=this.Qb[this.Qb.length-1])}this.Qa=!0;1===this.Qb.length&&(this.Fe=this.view.Ak())}else if("touchmove"===a.type){var g=a.changedTouches;b=0;for(c=g.length;b<c;b++)f=g[b],a=this.view.Za(f.pageX,f.pageY,!0),f.identifier?f.identifier in this.kh?e=this.kh[f.identifier]:(e=[a],this.Qb.push(e),this.kh[f.identifier]=e):e=this.Dq(a),e?a.x===e[e.length-1].x&&
a.y===e[e.length-1].y||e.push(a):this.log("WARNING: Can't find path for touch!");!1===this.Qa&&(this.Fe=this.view.Ak(),this.Qa=!0);this.Fe?this.Fe.ha(this.Qg,this):this.view.ha()}else"touchend"===a.type&&this.Qa&&0===a.touches.length&&(this.pa(),this.Qa=!1);return!0};c.prototype.Dq=function(a){var b=0,c;var e=null;for(c=0;c<this.Qb.length;c++){var f=this.Qb[c],g=f[f.length-1].vb(a);if(null===e||g<b)e=f,b=g}e||(e=[a],this.Qb.push(e));return e};c.prototype.Ta=function(a,b){var c=new A(a,b);this.Qa=
!0;this.Qb.push([c]);1===this.Qb.length&&(this.Fe=this.view.Ak());return!0};c.prototype.Qg=function(a){var b,c,e,f=this.view.Dm();a.lineCap=this.options.lineCap||"round";a.lineJoin="round"===a.lineCap?"round":"bevel";a.lineWidth=this.$c();var g=a.globalAlpha;"opacity"in this.options&&(a.globalAlpha=this.options.opacity);a.beginPath();var h=this.Qb;var k=0;for(c=h.length;k<c;k++){var l=h[k];a.moveTo(l[0].x,l[0].y);var m=b=1;for(e=l.length-1;b<=e;m=b+=1)m=l[m],a.lineTo(m.x,m.y)}Eb(a,this.options.strokeStyle);
f&&a.restore();a.globalAlpha=g};c.prototype.Va=function(a,b){var c=new A(a,b);this.Qa&&(this.from=this.Qb[0][this.Qb[0].length-1],c.x!==this.from.x||c.y!==this.from.y)&&(this.Qb[0].push(c),this.Fe?this.Fe.ha(this.Qg,this):this.view.ha());return!0};c.prototype.Wa=function(a,b,c){this.Va(a,b,c);this.Qa=!1;this.pa();return!0};c.prototype.pa=function(){var a,b,c,e;var f=[];var g=this.Qb;var h=this.view.ea.nb;var k=0;for(c=g.length;k<c;k++){var l=g[k];if("brush"===this.mode){var m=[];1===l.length&&l.push(new A(l[0].x+
.1,l[0].y+.1));if(1<l.length){var q=a=0;for(b=l.length-1;a<=b;q=a+=1)m.push(l[q].x),m.push(l[q].y);f.push(new S(this.view.ea.$a(),"BrushNode",Fb({points:m,layer:this.view.Pa},this.options,{lineWidth:this.$c()})))}}else{if("shapebrush"===this.mode){l=Sb(l,20);b=l;if(!(2>b.length)){l=b[0];q=b[b.length-1];m=40>l.vb(q);for(a=0;a<b.length;a++){var p=b[a];for(e=a+1;e<b.length;e++){var t=b[e];20>Math.abs(p.x-t.x)&&(t.x=p.x);20>Math.abs(p.y-t.y)&&(t.y=p.y)}}p=D.gg(b).Vc();for(a=0;a<b.length;a++)e=b[a],20>
Math.abs(e.x-p.x)&&(e.x=p.x),20>Math.abs(e.y-p.y)&&(e.y=p.y);m&&(l.x=q.x,l.y=q.y)}l=b}else if("freehand"===this.mode)m=l,m=Sb(m,2),m=Vb(m,4),l=m=Sb(m,.5);else if("quadratic"===this.mode){l=Sb(l,10);a=Fd(l);m=a.ba[1];q=a.ba[2];e=a.ba[4];b=a.ba[5];l=a.ba[8];a=a.ba[9];e=((3*e-m)/2+(3*e-l)/2)/2;b=((3*b-q)/2+(3*b-a)/2)/2;p=new H;p.moveTo(m,q);p.quadraticCurveTo(e,b,l,a);m=p;m=Q.To(m);f.push(new S(this.view.ea.$a(),"PathNode",Fb({commands:m,fillStyle:this.view.Bb,sloppiness:0,layer:this.view.Pa},this.options,
{lineWidth:this.$c()})));continue}1===l.length&&"freehand"===this.mode&&l.push(new A(l[0].x+.1,l[0].y+.1));if(1<l.length){m=new R;m.moveTo(l[0].x,l[0].y);a=l[0].sd(l[l.length-1]);q=b=1;for(e=l.length-1;b<=e;q=b+=1)m.lineTo(l[q].x,l[q].y);a&&m.close();f.push(new S(this.view.ea.$a(),"PathNode",Fb({commands:m.Sb(),fillStyle:this.view.Bb,sloppiness:0,layer:this.view.Pa},this.options,{lineWidth:this.$c()})))}}}this.view.pa(f);this.view.pb();k=this.view.ea.va(h,!1);f.length&&"quadratic"===this.mode?(k&&
this.view.hf(k),this.view.eb()):this.view.fa.get("singleStrokeBrush")?(k&&this.view.te(k),this.view.eb()):this.reset();this.view.Mb()};c.prototype.be=function(a,b){this.options.strokeStyle=a;if(b){this.view.Bb=a;this.view.Ub=a;var c="fillStyle"}else this.view.Lb=a,c="strokeStyle";this.view.setProperty(c,a)};c.prototype.de=function(a){this.view.Ub=zb(this.view.Ub,a);this.options.strokeStyle=zb(this.options.strokeStyle,a);this.view.Bb=this.view.Ub};c.prototype.Nc=function(a){this.log("keyboard: %s",
a);"cancel"===a&&(this.log("ESC pressed. Abort brush and go back to toolbar."),this.view.eb(),this.view.qc.ua("goto-toolbar"))};c.prototype.Dd=function(a,b){"defaultBrushWidth"===a?this.Xk(b):"defaultBrushColour"===a&&this.Yg(b)};c.prototype.cd=function(){return"circle"===this.mode?"ellipse":this.mode};return c}();var Hd=function(){function c(a,b,c,e,f,g){void 0===c&&(c="");void 0===e&&(e={});void 0===f&&(f=!1);void 0===g&&(g=!1);this.view=a;this.type=b;this.url=c;this.aa=e;this.pt=f;this.Lh=g;this.node=null;this.Yj=new A(0,0);this.wk=new A(0,0);this.index=0;this.state="start";this.log=w.create("DRAWLINES");"wrap"in this.aa||(this.aa.wrap=this.view.fa.get("multilineText"));"fontSize"in this.aa||(this.aa.fontSize=this.view.fa.get("defaultFontSize"));this.Xb=new Dd(this.view);this.view.pb(!0)}c.prototype.Hc=
function(){this.log("Entering DrawLinesBehaviour");this.view.canvas.style.cursor="crosshair";this.view.fa.dg()||this.view.Ri("click-to-place-first-point-of-line");this.view.ha()};c.prototype.reset=function(){this.Hc()};c.prototype.rb=function(a){if("touchstart"===a.type){var b=a.changedTouches[0];b=this.view.Za(b.pageX,b.pageY);return this.Ta(b.x,b.y,a)}return"touchmove"===a.type?(b=a.changedTouches[0],b=this.view.Za(b.pageX,b.pageY),this.Va(b.x,b.y,a)):"touchend"===a.type?(b=a.changedTouches[0],
b=this.view.Za(b.pageX,b.pageY),this.Wa(b.x,b.y,a)):!1};c.prototype.bb=function(a){a=this.Xb.bb(a);this.Xb.active&&this.node&&this.reset();return a};c.prototype.Nc=function(a){"cancel"===a&&(null!==this.node&&this.view.za.tb&&"curve"===this.type&&this.pa(),null!==this.node&&this.view.ea.removeNode(this.node),this.view.za.tb?this.view.qc.ua("goto-toolbar"):this.view.eb())};c.prototype.done=function(){this.view.fa.get("autoPickTool")?(this.view.eb(),this.view.fo()):this.state="start"};c.prototype.qm=
function(a,b){this.node instanceof Q&&("curve"===this.type||"arrow"===this.type||"linear-bezier"===this.type?this.node.pg(a,b):this.node.lineTo(a,b))};c.prototype.Ta=function(a,b){var c=this.view.La(new A(a,b));if("start"===this.state){this.Yj=new A(a,b);this.node=new Q(this.view.ea.$a(),this.view.ea);this.node.setProperty("seed",Math.round(65535*Math.random()));this.node.setProperty("strokeStyle",this.view.Lb);this.node.setProperty("lineWidth",this.$c());this.node.setProperty("sloppiness",this.view.wa.sloppiness);
this.node.setProperty("smoothness",this.view.wa.smoothness);for(var e in this.aa)this.aa.hasOwnProperty(e)&&this.node.setProperty(e,this.aa[e]);this.view.ea.Dh(this.node);"arrow"===this.type&&(this.node.setProperty("arrowSize",this.view.fa.Ma("defaultArrowSize")),this.node.setProperty("arrowStyle",this.view.fa.Ma("defaultArrowStyle")),this.node.setProperty("arrowXOffset",this.view.fa.Ma("defaultArrowXOffset")));this.node.moveTo(c.x,c.y);this.qm(c.x,c.y);this.index=3;this.view.update();this.state=
"predrag"}else if("placing"===this.state)if("arrow"!==this.type&&8>this.Yj.vb(new A(a,b))&&3<this.index)this.log("Clicked close to start; automatically closing path"),this.node instanceof Q&&this.node.close(),this.pa(),this.done();else if(8>this.wk.vb(new A(a,b)))3<this.index?(this.node instanceof Q&&this.node.Ms(this.index),this.pa()):this.cancel(),this.done();else{if(this.pt)return this.pa(),this.done(),!0;this.node&&(this.qm(c.x,c.y),this.index+=3,this.view.ea.Lg(this.node.id),this.view.update())}else return this.log("Invalid state %s",
this.state),!0;this.wk=new A(c.x,c.y);return!0};c.prototype.Wa=function(a,b){var c=new A(a,b);c=this.Yj.vb(c);this.log("onMouseUp (%s,%s) %s",a,b,this.state);"predrag"===this.state&&(this.log("MovedBy: %s",c),10<c?(this.pa(),this.done()):(this.state="placing",this.view.Ri("click-to-place-another-point-or-double-click-to-end-the-line")));return!0};c.prototype.Va=function(a,b,c){b=this.view.La(new A(a,b));a=b.x;b=b.y;if(c.ctrlKey||this.Lh){c=this.wk;var d=Math.atan2(b-c.y,a-c.x),f=Math.PI/8;d>=-f&&
d<f?b=c.y:d>=f&&d<3*f?(a=Math.max(b-c.y,a-c.x),b=c.y+a,a=c.x+a):d>=3*f&&d<5*f?a=c.x:d>=5*f&&d<7*f?(a=Math.max(b-c.y,c.x-a),b=c.y+a,a=c.x-a):d>=7*f||d<=7*-f?b=c.y:d<5*-f?(a=Math.max(c.y-b,c.x-a),b=c.y-a,a=c.x-a):d<3*-f?a=c.x:(a=Math.max(c.y-b,a-c.x),b=c.y-a,a=c.x+a)}this.node&&(this.node.Ne(this.index,a,b),this.node.format(this.view.ia,this.view.request),this.view.ha());return!1};c.prototype.Ed=function(){this.log("onMouseClick()");return!0};c.prototype.Yp=function(a){for(var b=0,c=[],e,f,g,h,k,l;b<
a.length;){var m=a[b];switch(m){case Q.pf:g=a[b+1];h=a[b+2];c.push(m,g,h);break;case Q.Od:e=a[b+1],f=a[b+2],void 0!==g&&void 0!==h&&void 0!==k&&void 0!==l&&c.push(Q.eg,e,f,(k+g)/2,(l+h)/2,(g+e)/2,(h+f)/2),k=g,l=h,g=e,h=f}b+=Q.Xa[m]+1}return c};c.prototype.pa=function(){if(this.node){this.node instanceof Q&&this.node.Dp();this.view.ea.removeNode(this.node);var a=this.view.fa.Ma("defaultArrowSize"),b=this.node.ka("commands");"linear-bezier"===this.type&&(b=this.Yp(b));a={arrowSize:"arrow"===this.type?
a:0,arrowStyle:this.view.fa.Ma("defaultArrowStyle"),arrowXOffset:this.view.fa.Ma("defaultArrowXOffset"),commands:b,seed:this.node.ka("seed"),fillStyle:this.view.Bb,strokeStyle:this.view.Lb,lineWidth:this.$c(),sloppiness:this.view.wa.sloppiness,smoothness:this.view.wa.smoothness,layer:this.view.Pa};for(var c in this.aa)this.aa.hasOwnProperty(c)&&(a[c]=this.aa[c]);this.view.pa([new S(this.view.ea.$a(),"PathNode",a)]);this.node=null}};c.prototype.cancel=function(){this.node&&(this.view.ea.removeNode(this.node),
this.node=null)};c.prototype.Cc=function(){this.cancel();this.view.canvas.style.cursor="default";this.view.Ri("");this.view.ha()};c.prototype.be=function(a,b){if(b){this.view.Bb=a;this.view.Ub=a;var c="fillStyle";this.log("We are drawing lines. Set strokeStyle instead of fillStyle")}else c="strokeStyle";this.view.Lb=a;this.view.setProperty(c,a)};c.prototype.de=function(a,b){b?(this.view.Bb=zb(this.view.Bb,a),this.view.Ub=zb(this.view.Ub,a)):this.view.Lb=zb(this.view.Lb,a);this.view.bl(a,b)};c.prototype.cd=
function(){return this.type};c.prototype.ie=function(a,b){this.aa[a]=b};c.prototype.$c=function(){return this.view.jg(this.view.wa.lineWidth)};return c}();var Id=function(){function c(a,b,c,e,f,g,h,k){var d=this;this.view=a;this.nodeType=b;this.aa=c;this.width=e;this.height=f;this.qo=g;this.At=h;this.state="initial";this.start=new A(0,0);this.end=new A(0,0);this.node=null;this.log=w.create("DrawShape");"rectangle-tl"===g&&(this.Lm=function(a){a.lineWidth=1/d.view.scale;a.strokeStyle="#ccc";a.beginPath();a.rect(d.start.x,d.start.y,d.end.x-d.start.x,d.end.y-d.start.y);a.stroke()});this.vm=null===k?this.view.fa.get("autoPickTool"):k;this.Xb=new Dd(this.view);
this.view.pb(!0)}c.prototype.Lm=function(){};c.prototype.Hc=function(){this.log("Entering DrawShapeBehaviour");this.view.canvas.style.cursor="crosshair"};c.prototype.Cc=function(){this.log("Leaving DrawShapeBehaviour");this.cancel()};c.prototype.cancel=function(){this.node&&(this.view.ea.removeNode(this.node),this.view.update(),this.node=null);this.state="initial"};c.prototype.bb=function(a){a=this.Xb.bb(a);this.node&&this.Xb.active&&(this.view.ea.removeNode(this.node),this.node=null,this.state="initial");
return a};c.prototype.Nc=function(a){"cancel"===a&&this.view.eb()};c.prototype.rb=function(a){if("touchstart"===a.type){var b=a.changedTouches[0];b=this.view.Za(b.pageX,b.pageY);return this.Ta(b.x,b.y)}return"touchmove"===a.type?(b=a.changedTouches[0],b=this.view.Za(b.pageX,b.pageY),this.Va(b.x,b.y,a)):"touchend"===a.type?(b=a.changedTouches[0],b=this.view.Za(b.pageX,b.pageY),this.Wa(b.x,b.y,a)):!1};c.prototype.Ta=function(a,b){"initial"===this.state&&(this.start=this.view.La(new A(a,b)),this.state=
"predraw",this.log("initial -> predraw"));return!0};c.prototype.Va=function(a,b,c){a=this.view.La(new A(a,b));c=c.ctrlKey;"predraw"===this.state&&10<this.start.vb(a)&&(this.create(),this.state="drawing",this.log("predraw -> drawing"));"drawing"===this.state&&(this.transform(this.start,a,c),this.end=a,this.view.update(!1,this.Lm));return!0};c.prototype.Wa=function(a,b,c){"predraw"===this.state?this.view.fa.get("clickToDrawShapes")?(this.create(),this.transform(this.start,null,c.ctrlKey),this.pa(),
this.vm&&this.view.eb(),this.state="initial"):this.cancel():"drawing"===this.state&&(this.transform(this.start,this.view.La(new A(a,b)),c.ctrlKey),this.pa(),this.vm&&this.view.eb(),this.state="initial");return!0};c.prototype.create=function(){if(this.node=Bc(this.nodeType,this.view.ea.$a(),this.view.ea))this.node.Jb(this.aa),this.view.ea.Dh(this.node)};c.prototype.transform=function(a,b,c){if(b)if("circle"===this.qo){var d=a;a=a.vb(b);var f=2*a/this.width;a=2*a/this.height}else{if("rectangle-tl"===
this.qo)a=a.clone(),b=b.clone(),a.x>b.x&&(f=a.x,a.x=b.x,b.x=f),a.y>b.y&&(f=a.y,a.y=b.y,b.y=f),d=a;else if(f=[a,b],0===f.length)d=new A(0,0);else{d=f[0].x;for(var g=f[0].y,h=1;h<f.length;h++)d+=f[h].x,g+=f[h].y;d=new A(d/f.length,g/f.length)}f=(b.x-a.x)/this.width;a=(b.y-a.y)/this.height}else d=a,a=f=1;c&&(a=f=Math.min(f,a));c=new E(d.x,d.y);c=c.multiply(new Lb(f,a));this.node&&(this.node.Vf(c),this.view.ea.Lg(this.node.id))};c.prototype.pa=function(){this.node&&(this.aa.matrix=this.node.Ea(),this.view.ea.removeNode(this.node),
this.node=null,this.view.pa([new S(this.view.ea.$a(),this.nodeType,this.aa)]))};c.prototype.Xk=function(a){this.aa.lineWidth=this.view.jg(a)};c.prototype.be=function(a,b){nd.prototype.be.call(this,a,b);this.aa[b?"fillStyle":"strokeStyle"]=a};c.prototype.de=function(a,b){nd.prototype.de.call(this,a,b);var c=b?"fillStyle":"strokeStyle",e=zb(this.aa[c],a);this.log("oldColour=%s+opacity %s = %s",this.aa[c],a,e);this.aa[c]=e};c.prototype.cd=function(){return this.At};c.prototype.ie=function(a,b){this.aa[a]=
b};c.prototype.Dd=function(a,b){"defaultLineWidth"===a&&this.Xk(b)};return c}();function Jd(c,a,b){this.Ha=c;this.Vi=a;this.fn=b;this.Yi=0}
var Kd=new (function(){function c(){this.zb=[];this.pl=!1;this.log=w.create("ImageLoader")}c.prototype.timeout=function(){var a=[];this.log("Timeout running... %s images remaining",this.zb.length);for(var b=0;b<this.zb.length;b++)this.zb[b].Ha.complete?this.zb[b].fn(this.zb[b].Ha,this.zb[b].Vi):5E3>this.zb[b].Yi?(this.zb[b].Yi+=250,a.push(this.zb[b])):this.zb[b].fn(this.zb[b].Ha,this.zb[b].Vi);this.zb=a;this.zb.length?setTimeout(this.timeout,250):(this.log("Timeout Stopped"),this.pl=!1)};c.prototype.load=
function(a,b,c){var d=this;void 0===c&&(c=!1);var f=document.createElement("img"),g=new Jd(f,a,b);this.zb.push(g);var h=0<=a.indexOf("://"),k="://"+window.location.host,l=0!==a.indexOf("data:")&&h&&-1===a.indexOf(k);l&&!c&&(this.log("Using cross origin request for img"),f.crossOrigin="");f.addEventListener("load",function(){d.log("LoadFn called. complete=%s",f.complete);if(f.complete)for(var a=0;a<d.zb.length;a++){var c=d.zb[a];if(c.Ha===f){d.zb.splice(a,1);b(f,c.Vi);break}}else d.pl||(d.pl=!0,setTimeout(d.timeout,
250),g.Yi=250)},!1);f.addEventListener("error",function(){d.log("Error loading %s; useCors=%s disableCors=%s",a,l,c);!l||c?b(null,g.Vi):d.load(a,b,!0)},!1);f.src=a;return f};return c}());var Ld=function(c){function a(){var a=c.call(this)||this;a.Qf=[];a.yf=!1;a.canvas=null;a.log=w.create("FORMAT",!0);return a}n(a,c);a.prototype.add=function(a,c,e,f,g){var b;var d=this.Qf;var l=0;for(b=d.length;l<b;l++){var m=d[l];m.type===c&&m.Ck===a&&(m.dl=!0)}this.log("Request URL %s",e.substr(0,64));this.Qf.push({Ck:a,type:c,url:e,ts:f||{},Lp:g,dl:!1});this.check()};a.prototype.check=function(){for(var a=0;!this.yf&&a<this.Qf.length;)this.Qf[a].dl?this.Qf.shift():(this.mp(this.Qf[0]),a+=1);this.yf||
this.ua("done")};a.prototype.mp=function(a){var b=this;b.yf=!0;b.log("Processing request for item %s url=%s",a.Ck,a.url.substr(0,64));0===a.type.indexOf("image")&&Kd.load(a.url,function(c,d){null!==c?(b.log("Image request completed for item %s url %s",a.Ck,d.substr(0,64)),a.Lp(c,d)):b.log("Image request failed for url %s",d);b.yf=!1;a.dl=!0;b.check()})};a.prototype.Xp=function(a,c){this.ua("convert-dom-request",a,c)};a.prototype.Rf=function(a){this.ua("reformat",a)};a.prototype.ud=function(){if(null===
this.canvas)return new D(0,0,0,0);var a=z(this.canvas).dc();return new D(a.left,a.top,this.canvas.width,this.canvas.height)};return a}(Pc);var Md=function(){function c(a,b,c){this.view=a;this.aa=b;this.Zr=c;this.state="none";this.scale=1;this.log=w.create("ImageStamp");this.Ha=document.createElement("img");this.url=this.Ha.src=b.url;"scale"in this.aa&&(this.scale=this.aa.scale,delete this.aa.scale)}c.prototype.Hc=function(){this.log("Entering ImageStampBehaviour");this.view.canvas.style.cursor="move"};c.prototype.Cc=function(){this.log("Leaving ImageStampBehaviour");this.view.ha()};c.prototype.rb=function(a){if("touchstart"===a.type){var b=
a.changedTouches[0];b=this.view.Za(b.pageX,b.pageY);return this.Ta(b.x,b.y,a)}return"touchmove"===a.type?(b=a.changedTouches[0],b=this.view.Za(b.pageX,b.pageY),this.Va(b.x,b.y,a)):"touchend"===a.type?(b=a.changedTouches[0],b=this.view.Za(b.pageX,b.pageY),this.Wa(b.x,b.y,a)):!1};c.prototype.La=function(a,b){this.Ha.complete&&(a-=this.Ha.width/2,b-=this.Ha.height/2);return this.view.La(new A(a,b))};c.prototype.Ta=function(a,b,c){this.log("onMouseDown type %s",c.type);a=this.La(a,b);this.view.pa([new S(this.view.ea.$a(),
"ImageNode",Fb({},this.aa,{url:this.url,layer:this.view.Pa,matrix:(new E(a.x,a.y)).multiply(new Lb(this.scale,this.scale))}))]);this.Zr||(this.log("MultiStamp not set; return to pick mode."),this.view.eb());return!0};c.prototype.Va=function(a,b){this.Ha.complete||this.log("Don't draw; image not loaded.");var c=this.La(a,b),e=this;this.view.ha(function(a){var b=a.globalAlpha;a.globalAlpha=.5;a.drawImage(e.Ha,c.x,c.y,e.Ha.naturalWidth*e.scale,e.Ha.naturalHeight*e.scale);a.globalAlpha=b});return!0};
c.prototype.Wa=function(){return!0};c.prototype.Nc=function(a){"cancel"===a&&(this.view.eb(),this.view.qc.ua("goto-toolbar"))};return c}();var Nd=function(){function c(a){this.view=a;this.state="none";this.start=new A(0,0);this.Go=this.Fo=0;this.log=w.create("PanTool");this.Xb=new Dd(a)}c.prototype.Hc=function(){this.log("Entering PanToolBehaviour");this.view.canvas.style.cursor="all-scroll"};c.prototype.Cc=function(){this.log("Leaving PanToolBehaviour")};c.prototype.bb=function(a){return this.Xb.bb(a)};c.prototype.rb=function(a){if("touchstart"===a.type){var b=a.changedTouches[0];b=this.view.Za(b.pageX,b.pageY);return this.Ta(b.x,b.y,
a)}return"touchmove"===a.type?(b=a.changedTouches[0],b=this.view.Za(b.pageX,b.pageY),this.Va(b.x,b.y,a)):"touchend"===a.type?(b=a.changedTouches[0],b=this.view.Za(b.pageX,b.pageY),this.Wa(b.x,b.y,a)):!0};c.prototype.ln=function(a){switch(a.type){case "touchend":case "touchstart":case "touchmove":return new A(a.changedTouches[0].pageX,a.changedTouches[0].pageY);case "mousedown":case "mouseup":case "mousemove":case "pointerdown":case "pointermove":case "pointerup":return new A(a.pageX,a.pageY);default:return this.log("Can't handle event: %s",
a.type),new A(0,0)}};c.prototype.Ta=function(a,b,c){this.log("onMouseDown type %s",c.type);this.state="dragging";this.start=this.ln(c);this.Fo=this.view.ub;this.Go=this.view.jb;return!0};c.prototype.Va=function(a,b,c){if("dragging"!==this.state)return!1;a=this.ln(c);b=this.Go+a.y-this.start.y;this.view.ub=this.Fo+a.x-this.start.x;this.view.jb=b;this.view.mc();this.view.ha();return!0};c.prototype.Wa=function(){this.state="none";return!0};c.prototype.Ik=function(a,b,c,e){if(!this.view.fa.get("allowZoom"))return this.log("Zooming is disabled."),
!1;this.log("onMouseWheel(%s, %s, %s)",a,b,c);c=0<c?1/1.1:1.1;a=new Lb(c,c,a,b);b=this.view.Yd();b.transform(a);this.view.ah(b);e.stopPropagation();e.preventDefault();return!0};c.prototype.Nc=function(a){"cancel"===a&&this.view.eb()};c.prototype.cd=function(){return"pan"};return c}();var Od=function(c){function a(a,d,e){var b=c.call(this)||this;b.id=a;b.Ad=d;b.Bi=!0;b.width=32;b.height=500;b.zu=0;b.Fb=new D(0,0,0,0);b.Qa=!1;b.Ep="#c0c0c0";b.ym="#808080";b.borderWidth=1;b.Vd=0;b.Ud=100;b.Dl=10;b.position=5;b.offset=0;b.log=w.create("SCROLLBAR",!0);b.Bi=!0;b.canvas=qb(document.body);b.canvas.style.position="absolute";b.canvas.style.border="none";b.canvas.classList.add("zwibbler-scrollbar");b.ia=b.canvas.getContext("2d");b.canvas.addEventListener("mousedown",function(a){b.Ta(a)});
e.addEventListener(document.body,"mousemove",function(a){b.Va(a)});e.addEventListener(document.body,"mouseup",function(a){b.Wa(a)});b.canvas.addEventListener("touchstart",function(a){b.rb(a)});e.addEventListener(document.body,"touchmove",function(a){b.rb(a)});e.addEventListener(document.body,"touchend",function(a){b.rb(a)});b.format();return b}n(a,c);a.prototype.Qd=function(a){a.appendChild(this.canvas)};a.prototype.moveTo=function(a,c){this.canvas.style.left=""+a+"px";this.canvas.style.top=""+c+
"px"};a.prototype.Xf=function(a,c){this.width=a;this.height=c;this.canvas.width=this.width;this.canvas.height=c;this.format();this.ha()};a.prototype.Zd=function(){this.canvas.style.display="none"};a.prototype.show=function(){this.canvas.style.display="block"};a.prototype.Kr=function(){return"block"===this.canvas.style.display};a.prototype.Ao=function(a,c,e,f){this.Vd=a;this.Ud=c-a;this.Dl=e;this.position=f;this.format();this.ha()};a.prototype.format=function(){var a=this.Ad?this.width:this.height;
var c=this.Dl/this.Ud*a;a*=(this.position-this.Vd)/this.Ud;this.Fb=this.Ad?new D(a,0,c-1,this.height-1):new D(0,a,this.width-1,c-1);this.Fb.x=Math.round(this.Fb.x)+.5;this.Fb.y=Math.round(this.Fb.y)+.5;this.Fb.width=Math.round(this.Fb.width);this.Fb.height=Math.round(this.Fb.height)};a.prototype.ha=function(){this.ia.beginPath();this.ia.fillStyle=this.Ep;this.ia.strokeStyle=this.ym;this.ia.lineWidth=this.borderWidth;this.ia.rect(this.borderWidth/2,this.borderWidth/2,this.width-this.borderWidth,this.height-
this.borderWidth);this.ia.fill();this.ia.stroke();this.ia.beginPath();this.ia.fillStyle=this.ym;this.ia.strokeStyle="#000000";this.ia.rect(this.Fb.x,this.Fb.y,this.Fb.width,this.Fb.height);this.ia.fill();this.ia.stroke()};a.prototype.Rm=function(a){var b=z(this.canvas).dc(),c=0,f=0;if("touchstart"===a.type||"touchend"===a.type||"touchmove"===a.type)c=a.changedTouches[0].pageX,f=a.changedTouches[0].pageY;else if("mousedown"===a.type||"mouseup"===a.type||"mousemove"===a.type)c=a.pageX,f=a.pageY;return new A(c-
b.left,f-b.top)};a.prototype.rb=function(a){switch(a.type){case "touchstart":this.Ta(a);break;case "touchend":this.Wa(a);break;case "touchmove":this.Va(a)}};a.prototype.eo=function(a){a=this.Ad?a.x/this.width*this.Ud+this.Vd:a.y/this.height*this.Ud+this.Vd;a=Math.min(a,this.Ud-this.Dl+this.Vd);return a=Math.max(a,this.Vd)};a.prototype.Ta=function(a){a.preventDefault();a=this.Rm(a);this.Fb.Wc(a.x,a.y)?this.Ad?(this.offset=a.x-this.Fb.x,a.x-=this.offset):(this.offset=a.y-this.Fb.y,a.y-=this.offset):
(this.position=this.eo(a),this.offset=0,this.Ad?this.Fb.x=(this.position-this.Vd)/this.Ud*this.width:this.Fb.y=(this.position-this.Vd)/this.Ud*this.height,this.ua("scroll",this.position),this.ha());this.Qa=!0};a.prototype.Va=function(a){this.Qa&&(this.Qa&&"mousemove"===a.type&&0===a.buttons?this.Qa=!1:(a.preventDefault(),a=this.Rm(a),this.Ad?a.x-=this.offset:a.y-=this.offset,this.position=this.eo(a),this.ua("scroll",this.position),this.format(),this.ha()))};a.prototype.Wa=function(){this.Qa&&(this.Qa=
!1)};a.prototype.kk=function(){return this.Ad?this.height:this.width};a.hu=0;a.fu=1;a.bu=2;a.gu=3;return a}(Pc);function Pd(c,a,b,d,e,f){var g=!1;c.save();switch(b){case 0:case 3:var h=a.height;var k=a.width;break;default:h=a.width,k=a.height}switch(b){case 2:g=!0}c.translate(a.x,a.y);c.fillStyle="rgba(0, 0, 0, 0.2)";c.fillStyle="#ccc";c.fillRect(0,0,a.width,a.height);c.lineWidth=1;c.fillStyle="black";c.strokeStyle="black";c.font="10px sans-serif";a=Math.ceil(50/e);b=f/e;var l=Math.ceil(b/a)*a;f=l;c.beginPath();if(g)for(b=(l-b)*e;b<k;)c.moveTo(0,b),c.lineTo(h,b),g=f.toString()+d,c.fillText(g,0,b+1+10),f+=a,
b+=e*a;else for(b=(l-b)*e;b<k;)c.moveTo(b,h),c.lineTo(b,0),g=f.toString()+d,c.fillText(g,b+1,10),f+=a,b+=e*a;c.stroke();c.restore()};var Qd=function(){function c(){this.images={}}c.prototype.add=function(a,b){var c=this.images[a];c||(c={Ha:null,Ki:0},Kd.load(b,function(a){c.Ha=a}),this.images[a]=c);c.Ki+=1};c.prototype.release=function(a){var b=this.images[a];b&&(--b.Ki,0>=b.Ki&&delete this.images[a])};c.prototype.get=function(a){return(a=this.images[a])&&a.Ha?a.Ha:null};return c}();for(var Rd,Sd=[],Td=0;4>Td;Td++)Sd.push(String.fromCharCode(">2$-".charCodeAt(Td)^"zwibbler3".charCodeAt(Td%9)));Rd=Sd.join("");for(var Ud,Vd=[115,116,114,111,107,101,84,101,120,116],Wd=[],Xd=0;Xd<Vd.length;Xd++)Wd.push(String.fromCharCode(Vd[Xd]));Ud=Wd.join("");
var Yd=function(){function c(a,b,d,e,f,g,h){var k=this;this.canvas=a;this.ea=b;this.qc=d;this.fa=e;this.language=f;this.Aa=g;this.Ja=h;this.ld="none";this.jh=this.ih=0;this.scale=1;this.jb=this.ub=0;this.Qc=new D(0,0,0,0);this.Uk=new Tb;this.Tf=this.Xg=this.Ni=!0;this.Mi=new F;this.selection=[];this.ff=[];this.Pa="default";this.je=this.Yh=!1;this.Tc=this.background=this.ue=null;this.backgroundRepeat="no-repeat";this.Yc=this.xa=null;this.Ql=4;this.Rl=2*this.Ql;this.le=this.vg=null;this.Uj=!1;this.Xc=
null;this.tf=!1;this.Ub=this.Bb=this.Lb="#000000";this.Af=5;this.Hf="";this.Yb=0;this.Dk=new D(0,0,0,0);this.Ek=new D(0,0,0,0);this.za={tb:!1,Qa:!1,Fj:!1,x:100,y:100};this.fo=function(){};this.ti=new Qd;this.li=[];this.log=w.create("VIEW");this.ia=this.canvas.getContext("2d");this.je=!0===e.get("pageView");this.Ks();this.ma=new nd(this);this.Ja.add(function(){k.ma&&k.ma.Cc&&k.ma.Cc()});this.dd=new Od("horizontal",!0,this.Ja);this.dd.Qd(this.canvas.parentNode);this.gc=new Od("vertical",!1,this.Ja);
this.gc.Qd(this.canvas.parentNode);this.Di=this.Cg();this.ve=new Ib(this.canvas.width/this.Di,this.canvas.height/this.Di);var l=this;this.request=new Ld;this.request.canvas=this.canvas;this.request.Ka("reformat",function(a){l.log("Node %s requests reformat",a);l.ea.Ee(a)&&(l.log("   Reformatting... zoom=%s",l.ld),l.ea.Lg(a));l.update();a===l.Tc&&l.Nh();l.Sf();l.Aa.ua("resource-loaded")});this.request.Ka("convert-dom-request",function(a,b){l.Aa.ua("convert-dom-request",b,a)});e.Ka("useTouch",function(){l.le=
null;l.Rl=2*l.Ql});this.gc.Ka("scroll",function(a){l.jb=-a*l.scale;l.ha()});this.dd.Ka("scroll",function(a){l.ub=-a*l.scale;l.ha()});this.Nh();this.ea=this.gf(b);(a=window.requestAnimationFrame||window.mozRequestAnimationFrame||window.webkitRequestAnimationFrame)?(this.log("Using requestAnimationFrame"),this.requestAnimationFrame=a):this.log("Emulating requestAnimationFrame");this.fa.Ka("update",function(a,b){l.Dd(a,b)});this.Ja.addEventListener(document,"webkitfullscreenchange",function(){0<=navigator.userAgent.search("Safari")&&
0>navigator.userAgent.search("Chrome")&&(k.log("SAFARI WORKAROUND: Disabling requestAnimationFrame."),k.requestAnimationFrame=c.prototype.requestAnimationFrame)});a=document;a.fonts&&this.Ja.addEventListener(a.fonts,"loadingdone",function(){k.log("Font loading done, redraw now.");k.ha()});this.yc(.5,0,0,-30,"","rotate");this.yc(0,0,0,0,"","scale");this.yc(1,0,0,0,"","scale");this.yc(1,1,0,0,"","scale");this.yc(0,1,0,0,"","scale");this.yc(.5,0,0,0,"","scale");this.yc(1,.5,0,0,"","scale");this.yc(.5,
1,0,0,"","scale");this.yc(0,.5,0,0,"","scale");this.ma=this.eb()}c.prototype.jg=function(a){this.fa.get("adaptiveBrushWidth")&&(a/=this.scale);return a};c.prototype.nn=function(a){var b,c=-1,e=!1;for(b=0;b<a.bf.length;b++){var f=a.bf[b];f===this.Tc&&(this.log("Background node has been removed"),c=-1)}for(b=0;b<a.ac.length;b++){f=a.ac[b];var g=this.ea.va(f,!1);"background"===g.ka("layer")&&(this.log("Background node has been added"),c=f)}for(b=0;b<a.cg.length;b++)f=a.cg[b],g=this.ea.va(f,!1),"background"===
g.ka("layer")?(this.log("Background node has been changed"),c=f,e=!0):f===this.Tc&&(this.log("Node removed from background layer"),c=-1);-1===c||!e&&c===this.Tc||(this.Tc=c,this.Nh(),this.Tc&&this.ea.va(this.Tc,!1).he(!0));a.ac.length&&this.Aa.ua("nodes-added",a.ac);a.cg.length&&this.Aa.ua("nodes-changed",a.cg);a.bf.length&&this.Aa.ua("nodes-removed",a.bf)};c.prototype.requestAnimationFrame=function(a){a()};c.prototype.$j=function(){return parseInt(z(this.canvas).Le("borderLeftWidth"),10)||0};c.prototype.zg=
function(){this.log("getActiveLayer() -> %s",this.Pa);return this.Pa};c.prototype.Pi=function(a){this.log("setActiveLayer(%s)",a);this.Pa=a;this.pb();this.Mb();this.ha()};c.prototype.bh=function(a,b){this.ea.bh(a,b);b||a!==this.Pa||(this.pb(),this.Mb());this.ha()};c.prototype.gf=function(a){this.log("setDocument()");this.eb();this.ea=a;this.scale=1;this.jb=this.ub=0;this.selection=[];this.Yc=this.xa=null;this.Yb=1;this.Qc=new D(0,0,0,0);this.Uk=new Tb(this.Qc);this.Mi=new F;this.Hf="";this.Pa="default";
this.Bb="#ffffff";this.Ub=this.fa.Ma("defaultBrushColour");this.Lb=this.fa.Ma("defaultStrokeStyle");this.wa={};this.wa.lineWidth=this.fa.Ma("defaultLineWidth");this.wa.sloppiness=.5;this.wa.fontName=this.fa.Ma("defaultFont");this.wa.fontSize=this.fa.Ma("defaultFontSize");this.wa.bold=this.fa.Ma("defaultBold");this.wa.italic=this.fa.Ma("defaultItalic");this.wa.smoothness=.3;this.wa.textFillStyle=this.fa.Ma("defaultTextFillStyle");this.wa.textStrokeStyle=this.fa.Ma("defaultTextStrokeStyle");this.wa.textLineWidth=
this.fa.Ma("defaultTextLineWidth");this.wa.textDecoration=this.fa.Ma("defaultTextDecoration");this.wa.textAlign=this.fa.Ma("defaultTextAlign");this.Af=this.fa.get("defaultBrushWidth");var b=this.Je();this.ub=-b.x;this.jb=-b.y;this.mc();this.ea.hl=this.fa.get("spotHighlightColour");this.ea.Ui=this.fa.get("spotHighlightZIndex");this.ea.format(this.ia,this.request);this.Ek=new D(0,0,0,0);this.Dk=new D(0,0,0,0);"none"!==this.ld?this.wc(this.ld):(this.wc(this.fa.get("defaultZoom")),this.ha());return a};
c.prototype.Dd=function(a,b){var c=!1;switch(a){case "allowResize":this.zf();this.ha();break;case "defaultBrushColour":this.Ub=b;break;case "defaultFillStyle":this.Bb=this.wa.fillStyle=b;break;case "defaultStrokeStyle":this.Lb=b;this.wa.strokeStyle=b;break;case "defaultLineWidth":this.wa.lineWidth=b;break;case "defaultFont":this.wa.fontName=b;break;case "defaultBold":this.wa.bold=b;break;case "defaultTextAlign":this.wa.textAlign=b;break;case "defaultTextDecoration":this.wa.textDecoration=b;break;
case "defaultItalic":this.wa.italic=b;break;case "defaultFontSize":this.wa.fontSize=b;break;case "defaultTextFillStyle":this.wa.textFillStyle=b;break;case "defaultTextStokeStyle":this.wa.textStrokeStyle=b;break;case "defaultTextLineWidth":this.wa.textLineWidth=b;break;case "defaultBrushWidth":this.Af=b;break;case "defaultZoom":this.wc(b);break;case "pageView":this.je=b;c=!0;break;case "pagePlacement":case "pageInflation":this.wc(this.ld);break;case "snap":case "background":case "gridSpacing":case "gridBlocks":case "gridColour":case "backgroundImage":this.Nh();
c=!0;break;case "pageShadow":case "outsidePageColour":c=!0;break;case "readOnly":!0===b&&(this.eb(),this.pb(),this.Mb(),c=!0);this.ea.Wf(b);break;case "spotHighlightColour":this.ea.hl=b;c=!0;break;case "spotHighlightZIndex":this.ea.Ui=b;c=!0;break;case "showRuler":case "pixelsPerUnit":case "units":c=!0}this.ma.Dd&&this.ma.Dd(a,b);c&&this.ha()};c.prototype.ge=function(a,b){this.wa[a]=b;"fillStyle"===a?this.Bb=b:"strokeStyle"===a&&(this.Lb=b)};c.prototype.wc=function(a){a!==this.ld&&this.log("Zooming to: %s",
a);var b=this.ud().width-20;var c=this.ea.sn("width");var e=!0;this.ld=a;c||"number"===typeof a||(this.log("WARNING: Cannot zoom to page/width because the document size has not been set."),e="page"===a||"width"===a);if("number"===typeof a)this.scale=a;else if("none"===a||this.ea.empty()||!c)this.scale=1;else{if("page"===a)return c=this.Je(),this.ah(c,"centre"===this.fa.get("pagePlacement"),!0),this.ld=a,this.ma.Qe&&this.ma.Qe(),e;"width"===a&&(c=this.Je(),this.scale=b/c.width,this.ub=-c.x*this.scale,
this.jb=-c.y*this.scale,this.log("RECT=%s scale=%s tx=%s ty=%s",c,this.scale,this.ub,this.jb),this.ld=a)}this.mc();this.ha();this.ma.Qe&&this.ma.Qe();return e};c.prototype.Za=function(a,b,c){void 0===c&&(c=!1);a=this.lk().apply(a,b);c||(a=this.La(a));return a};c.prototype.Qj=function(a,b){return this.lk().inverse().apply(a,b)};c.prototype.es=function(a,b,c){return a.wd().multiply(this.lk()).apply(b,c)};c.prototype.Zb=function(a){return this.Za(a.pageX,a.pageY,!0)};c.prototype.Nc=function(a,b){this.ma.Nc&&
this.ma.Nc(a,b);if("TEXTAREA"!==b.target.tagName&&"INPUT"!==b.target.tagName&&!this.Cr(a,b)){switch(a){case "next-page":this.Rb(this.ea.Ra+1);break;case "previous-page":this.Rb(this.ea.Ra-1);break;case "zoom-to-page":this.fa.get("allowZoom")&&this.wc("page");break;case "zoom-to-width":this.fa.get("allowZoom")&&this.wc("width")}b.preventDefault();b.stopPropagation()}};c.prototype.Ks=function(){function a(a){c.log(a.type)}function b(a){a.stopPropagation();a.preventDefault()}var c=this,e=this;this.$j();
this.canvas.addEventListener("gesturestart",function(a){e.log("GestureStart");e.ma.bb&&!1!==e.ma.bb(a)?(a.stopPropagation(),a.preventDefault()):e.log("Pass to browser")});this.canvas.addEventListener("gesturechange",function(a){e.ma.bb&&!1!==e.ma.bb(a)?(a.stopPropagation(),a.preventDefault()):e.log("Pass to browser")});this.canvas.addEventListener("gestureend",function(a){e.log("GestureEnd");e.ma.bb&&!1!==e.ma.bb(a)?(a.stopPropagation(),a.preventDefault()):e.log("Pass to browser")});"ongesturestart"in
this.canvas?this.log("Using native gestures"):(this.log("Using emulated gestures"),Ma(this.canvas,function(a){e.ma.bb&&!1!==e.ma.bb(a)?(a.stopPropagation(),a.preventDefault()):e.log("Allow %s event to pass through",a.type)}));var f="ontouchstart"in window,g="onpointerdown"in window,h="ongesturestart"in window,k="onmousedown"in window;this.log("Have TouchEvents: %s",f);this.log("Have PointerEvents: %s",g);this.log("Have GestureEvents: %s",h);this.log("Have MouseEvents: %s",k);g&&!this.fa.get("allowPointerEvents")&&
(this.log("Configuration does not allow PointerEvents"),g=!1);var l=new A(0,0),m=0,q=0,p=!1,t=!1,r;this.fo=function(){e.log("Preventing next double click.");p=!0};if(f){this.log("Using touch events for screen movement.");var v=new Date,x=new A(0,0);this.canvas.addEventListener("touchstart",function(a){if(e.ma.rb&&"touchstart"===a.type){var b=!0;300<(new Date).getTime()-v.getTime()?b=!1!==e.ma.rb(a):e.ma.ce&&(r=new A(a.changedTouches[0].pageX,a.changedTouches[0].pageY),e.log("Double-click distance: %s",
r.vb(x)),10>r.vb(x)?(r=e.Zb(a.changedTouches[0]),b=!1!==e.ma.ce(r.x,r.y,a)):b=!1);b&&(a.stopPropagation(),a.preventDefault());v=new Date;x=new A(a.changedTouches[0].pageX,a.changedTouches[0].pageY)}});this.canvas.addEventListener("touchmove",function(a){e.ma.rb&&!1!==e.ma.rb(a)&&(a.stopPropagation(),a.preventDefault())});this.canvas.addEventListener("touchend",function(a){e.ma.rb&&!1!==e.ma.rb(a)&&(a.stopPropagation(),a.preventDefault())})}else if(g){this.log("Using pointer events for movement");
this.canvas.addEventListener("pointerdown",function(a){"pointerdown"===a.type&&(e.log("PointerDown"),l=new A(a.pageX,a.pageY),m=rb(),t=!0,e.ma.Ta&&(r=e.Zb(a),!1!==e.ma.Ta(r.x,r.y,a)&&(a.stopPropagation(),a.preventDefault())))});this.canvas.addEventListener("pointermove",function(a){t&&0===a.buttons&&(e.log("MISSED POINTERUP! Fixing."),I(a));e.ma.Va&&(r=e.Zb(a),!1!==e.ma.Va(r.x,r.y,a)&&(a.stopPropagation(),a.preventDefault()))});var I=function(a){if("pointerup"===a.type||"pointermove"===a.type){e.log("PointerUp");
r=e.Zb(a);e.ma.Wa&&t&&!1!==e.ma.Wa(r.x,r.y,a)&&(a.stopPropagation(),a.preventDefault());t=!1;e.log("TimeDist=%s PixelDist=%s",rb()-m,l.vb(new A(a.pageX,a.pageY)));var b=q,c=200>rb()-m&&2>l.vb(new A(a.pageX,a.pageY));e.log("Didclick: %s dbltime=%s",c,rb()-b);e.ma.Ed&&c&&(e.log("Simulate mouseclick from pointerup"),r=e.Zb(a),!1!==e.ma.Ed(r.x,r.y,a)&&(a.stopPropagation(),a.preventDefault()));e.ma.ce&&c&&300>rb()-b&&!p&&(e.log("Simulate double-click"),!1!==e.ma.ce(r.x,r.y,a)&&(a.stopPropagation(),a.preventDefault()));
c&&(q=rb(),p=!1)}};this.Ja.addEventListener(document,"pointerup",I);this.canvas.addEventListener("pointerleave",function(a){e.ma.Xn&&(r=e.Zb(a),!1!==e.ma.Xn(r.x,r.y,a)&&(a.stopPropagation(),a.preventDefault()))})}!g||f?(this.log("Using mouse events for screen movement."),this.canvas.addEventListener("mousemove",function(a){e.ma.Va&&(r=e.Zb(a),e.ma.Va(r.x,r.y,a));a.preventDefault()}),this.canvas.addEventListener("mousedown",function(a){t=!0;e.ma.Ta&&(r=e.Zb(a),e.ma.Ta(r.x,r.y,a));a.preventDefault()}),
this.Ja.addEventListener(document,"mouseup",function(a){e.ma.Wa&&t&&(r=e.Zb(a),e.ma.Wa(r.x,r.y,a));t=!1}),this.canvas.addEventListener("click",function(a){z(e.canvas).dc();e.ma.Ed&&(r=e.Zb(a),e.ma.Ed(r.x,r.y,a));a.stopPropagation();a.preventDefault()}),this.canvas.addEventListener("dblclick",function(a){z(e.canvas).dc();if(e.ma.ce||e.ma.Ed)r=e.Zb(a),vb()&&e.ma.Ed&&(e.log("Insert false mouse click for IE"),e.ma.Ed(r.x,r.y,a)),e.ma.ce&&e.ma.ce(r.x,r.y,a);a.stopPropagation();a.preventDefault()})):this.log("Not using mouse events.");
this.canvas.addEventListener("contextmenu",function(a){var b=e.Zb(a);e.ma.Vn&&!1!==e.ma.Vn(b.x,b.y,a)?(a.stopPropagation(),a.preventDefault()):e.log("Pass contextmenu to browser")});this.canvas.addEventListener("mouseenter",b);this.canvas.addEventListener("mouseleave",b);this.canvas.addEventListener("mouseover",b);this.canvas.addEventListener("mouseout",b);!window.parent&&this.fa.get("setFocus")&&this.canvas.focus();f="mousewheel";"onwheel"in document.createElement("div")&&(f="wheel");e.log("Binding to '%s' for mouse wheel",
f);this.canvas.addEventListener(f,function(a){if("wheel"===a.type||"mousewheel"===a.type){var b=a.wheelDelta||-40*a.deltaY,c=b/120*32;r=e.Zb(a);if((!e.ma.Ik||!1===e.ma.Ik(r.x,r.y,c,a))&&e.gc.Kr()){var d=e.Je();e.jb=-120>=b?Math.max(e.jb+c,-(d.bottom()*e.scale-e.canvas.clientHeight)):Math.min(e.jb+c,-d.y*e.scale);e.mc();e.ha();a.stopPropagation();a.preventDefault()}}});this.canvas.addEventListener("dragover",function(a){e.log("Dragover");a.preventDefault()});this.canvas.addEventListener("drop",a);
this.canvas.addEventListener("dragenter",a);this.canvas.addEventListener("dragleave",a)};c.prototype.Hk=function(a){function b(a){var b=new FileReader;b.readAsDataURL(a.getAsFile());b.onloadend=function(){c.bs(b.result)}}this.log("Received clipboard event: %s",a.type);if(this.fa.get("allowSystemClipboard")){var c=this;switch(a.type){case "copy":case "cut":if(!this.tn())break;this.log("Cut to system clipboard.");var e=this.Ae(!0,this.rc(!1));a.clipboardData.setData("application/zwibbler",e);a.preventDefault();
"cut"===a.type&&this.qg();break;case "paste":for(this.log("There are %s items on the clipboard",a.clipboardData.items.length),e=0;e<a.clipboardData.items.length;e++){var f=a.clipboardData.items[e];this.log("Item [%s] type is %s",e,f.type);if(0===f.type.indexOf("image/")){b(f);a.preventDefault();break}else if("application/zwibbler"===f.type){this.log("Pasting from system clipboard");f.getAsString(function(a){c.Rg(a)});a.preventDefault();break}}}}else this.log("   ignored due to allowSystemClipboard setting.")};
c.prototype.Cr=function(a,b){if(!this.za.tb)return!1;var c=0,e=0,f=this.fa.get("nudge");switch(a){case "right":c=f;break;case "left":c=-f;break;case "down":e=f;break;case "up":e=-f;break;case "enter":if(this.ma.Ed){this.za.Qa=!1;var g="click"}else this.za.Qa=!this.za.Qa,g=this.za.Qa?"mousedown":"mouseup"}if(c||e)g=this.ud(),this.za.x+=c,this.za.x=Math.max(this.za.x,0),this.za.x=Math.min(g.width,this.za.x),this.za.y+=e,this.za.y=Math.max(this.za.y,0),this.za.y=Math.min(g.height,this.za.y),this.ha(),
g="mousemove";return g?(b.preventDefault(),b.stopPropagation(),this.ha(),e=z(this.canvas).dc(),c=this.za.x+e.left-window.pageXOffset,e=this.za.y+e.top-window.pageYOffset,f=this.Za(c,e),this.log("Simulate a %s at (%s,%s)",g,c,e),"mousedown"!==g&&"click"!==g||!this.ma.Ta||this.ma.Ta(f.x,f.y,b),"mousemove"===g&&this.ma.Va&&this.ma.Va(f.x,f.y,b),"mouseup"!==g&&"click"!==g||!this.ma.Wa||this.ma.Wa(f.x,f.y,b),!0):!1};c.prototype.cl=function(a){void 0===a&&(a=!1);this.za.tb=!0;this.za.Qa=!1;this.za.Fj=a;
this.log("Showing keyboard cursor, caret=%s",a);this.ha()};c.prototype.ot=function(a){this.za.tb=!0;this.za.Fj=!1;if(0<this.selection.length){this.log("showKeyboardCursorAndStartMoving()");this.za.Qa=!0;var b=this.Qc.Vc();this.za.x=b.x;this.za.y=b.y;this.eb();this.fb(new Bd(this,new wd(qd,this.selection[0].Ea()),!1,b.x-4,b.y-4,a))}this.ha()};c.prototype.Fr=function(){this.za.tb&&(this.log("Hiding keyboard cursor"),this.za.tb=!1,this.ha())};c.prototype.Jr=function(a){var b=this.$j(),c=z(this.canvas).dc(),
e=this.gc.kk();if("changedTouches"in a){var f=a.changedTouches[0].pageX-c.left-b;a=a.changedTouches[0].pageY-c.top-b}else if("pageX"in a)f=a.pageX-c.left-b,a=a.pageY-c.top-b;else return!1;b=this.ud();return this.le&&f>b.width-this.le.width-e&&a<this.le.height};c.prototype.La=function(a,b){void 0===b&&(b=0);b=b||this.fa.get("snap")||0;this.fa.get("autoSnap");if(0<b){var c=Math.round(a.x/b)*b;var e=Math.round(a.y/b)*b}else c=a.x,e=a.y;return new A(c,e)};c.prototype.zi=function(){var a=this.rc(!1);a.length&&
this.pa([new Kc(a,Kc.Tl)])};c.prototype.yi=function(){var a=this.rc(!1);a.length&&this.pa([new Kc(a,Kc.Sl)])};c.prototype.Gh=function(){var a=this.rc(!1);a.length&&this.pa([new Kc(a,Kc.Kl)])};c.prototype.Oi=function(){var a=this.rc(!1);a.length&&this.pa([new Kc(a,Kc.mj)])};c.prototype.setProperty=function(a,b){var c=this.rc(!0);this.wa[a]=b;if(c.length){var e=[new Dc(c,a,b)];if("fillStyle"===a)for(var f=0;f<c.length;f++){var g=this.ea.va(c[f],!1);g&&(this.log("nodeType=%s closed=%s",g.type(),g.ka("closed")),
"PathNode"===g.type()&&!1===g.ka("closed")&&e.push(new Dc([c[f]],"strokeStyle",b)))}this.pa(e)}0<this.selection.length&&"lineWidth"===a&&"BrushNode"===this.selection[0].type()?this.Af=b:"textFillStyle"===a&&(this.wa.textFillStyle=b)};c.prototype.ie=function(a,b){this.ma.ie&&this.ma.ie(a,b)};c.prototype.fi=function(){return this.wa.fillStyle};c.prototype.ji=function(){return this.wa.strokeStyle};c.prototype.bl=function(a,b){this.log("setSelectionOpacity(%s, fill=%s)",a,b);for(var c=this.rc(!0),e=[],
f=b?"fillStyle":"strokeStyle",g=0;g<c.length;g++){var h=c[g],k=this.ea.va(h);k&&(k=k.ka(f))&&(k=zb(k,a),e.push(new Dc([h],f,k)),this.log("   set %s of %s to %s",f,h,k))}e.length&&this.pa(e);this.log("   Affected %s of %s nodes",e.length,c.length)};c.prototype.group=function(){var a=this.rc(!1);a.length&&this.pa([new Gc(this.ea.$a(),a)])};c.prototype.mh=function(){var a=this.rc(!1);a.length&&this.pa([new Hc(a)])};c.prototype.qg=function(){var a=this.rc(!1);a.length&&this.pa([new Cc(a)])};c.prototype.pb=
function(a){void 0===a&&(a=!1);var b=!1;0<this.selection.length&&(this.Yb+=1,this.selection.length=0,this.log("Clear selection. selectGeneration=%s",this.Yb),b=!0);null!==this.Yc&&(this.Aa.ua("selected-edit-handle",null,null),b=!0);this.xa&&(this.log("Clear selection."),this.Yc=this.xa=null,b=!0);b&&a&&(this.Mb(),this.ha())};c.prototype.te=function(a){this.hf(null);if(a.Yb!==this.Yb&&a.xd()===this.Pa){this.selection.push(a);a.Yb=this.Yb;if(a.Cn()){for(var b=a.parent,c=0;c<b.children.length;c++)this.te(b.children[c]);
this.te(b)}a.children&&0<a.children.length&&this.te(a.children[0])}};c.prototype.selectNodes=function(a){this.pb();for(var b=0;b<a.length;b++)a[b].ka("locked")||"PageNode"===a[b].type()||this.te(a[b]);this.Mb()};c.prototype.Ts=function(a,b){var c=this.ea.va(a,!1);c?c.zn()?(c!==this.xa&&this.hf(c),this.log("Select edit handle %s",b),this.Yc=b,this.Aa.ua("selected-edit-handle",a,b)):this.log("selectEditHandle: That handle is not selectable."):this.log("selectEditHandle: nodeid %s does not exist.",a)};
c.prototype.pa=function(a,b){void 0===b&&(b=!1);if(this.fa.get("readOnly")&&!b)this.log("readOnly mode: Ignoring change.");else if(0!==a.length){var c=this.ea.pa(a,b),e;this.ea.format(this.ia,this.request);if(c.ac.length&&!b){var f=[];for(e=0;e<c.ac.length;e++)f.push(this.ea.va(c.ac[e],!1));this.fa.get("autoPickTool")&&this.selectNodes(f)}else if(this.selection.length||this.xa){e=!1;for(f=0;f<a.length;f++){var g=a[f];if(g instanceof Dc&&("lockSize"===g.name||"lockRotate"===g.name||"lockPosiiton"===
g.name||"lockAspectRatio"===g.name)||g instanceof Kc){e=!0;break}}if(0<c.bf.length||e){f=0;this.Yb+=1;g=this.ea.Ra;for(e=0;e<this.selection.length;e++)e!==f&&(this.selection[f]=this.selection[e]),this.ea.Ee(this.selection[f].id)&&this.ea.ad(this.selection[f].id)===g&&(this.selection[f].Yb=this.Yb,f++);this.selection.length!==f&&(this.selection.length=f);this.xa&&!this.ea.Ee(this.xa.id)&&(this.log("EditNode %s no longer exists",this.xa.id),this.xa=null,null!==this.Yc&&this.Aa.ua("selected-edit-handle",
null,null),this.Yc=null);0!==this.selection.length||this.xa||this.pb();this.Mb();this.log("Done selecting called.")}}this.nn(c);this.Sf();this.ha();this.Aa.ua("document-changed")}};c.prototype.Ss=function(a){a=this.ea.sr(a);for(var b=0;b<a.length;b++)this.te(a[b])};c.prototype.Mb=function(){this.zf();this.Aa.ua("selected-nodes")};c.prototype.Nk=function(){for(var a=0,b=this.li;a<b.length;a++){var c=b[a];""!==c.Me&&this.ti.release(c.Me)}this.li.length=0};c.prototype.yc=function(a,b,c,e,f,g,h){this.li.push({type:g,
position:new A(a,b),offset:new A(c,e),Me:f,Cm:h});""!==f&&this.ti.add(f,f)};c.prototype.zf=function(){var a;this.Tf=this.Xg=this.Ni=!0;var b=!1;this.ff.length=0;if(0!==this.selection.length){this.Qc=this.selection[0].rect.clone();this.selection[0].ka("lockSize")&&(this.Ni=!1);this.selection[0].ka("lockRotation")&&(this.Xg=!1);this.selection[0].ka("lockPosition")&&(this.Tf=!1);this.selection[0].ka("lockAspectRatio")&&(b=!0);for(a=1;a<this.selection.length;a++)this.Qc.nh(this.selection[a].rect),this.selection[a].ka("lockSize")&&
(this.Ni=!1),this.selection[a].ka("lockRotation")&&(this.Xg=!1),this.selection[a].ka("lockAspectRatio")&&(b=!0),this.selection[a].ka("lockPosition")&&(this.Tf=!1);this.Uk=1===this.selection.length?this.selection[0].Zm():new Tb(this.Qc);var c=0<this.fa.get("snap");if(1<this.selection.length){var e=new F;a=null;var f=this.Qc}else a=this.selection[0],f=a.Oa,e=a.Ea();for(var g=0,h=this.li;g<h.length;g++){var k=h[g];if("scale"===k.type){if(!this.fa.get("allowResize"))continue;if("scale"===k.type&&(0!==
k.position.x&&1!==k.position.x||0!==k.position.y&&1!==k.position.y)&&b)continue}else if("rotate"===k.type&&!this.Xg)continue;this.ff.push(zd(k,f,e,c))}if(this.Xg&&a&&a.ka("rotationHandles"))for(b=a.ka("rotationHandles"),a=0;a<b.length;a+=4)new A(b[a],b[a+1]),g=new A(b[a+2],b[a+3]),this.ff.push(new vd(rd,e,f,g,c))}};c.prototype.Pp=function(){for(var a=0,b=0;b<this.selection.length;b++)b!==a&&(this.selection[a]=this.selection[b]),this.ea.Ee(this.selection[a].id)&&(a+=1);this.selection.length!==a&&(this.selection.length=
a);this.xa&&!this.ea.Ee(this.xa.id)&&(this.xa=null,null!==this.Yc&&this.Aa.ua("selected-edit-handle",null,null),this.Yc=null)};c.prototype.bo=function(a,b){return this.selection.length&&this.Uk.Wc(a,b)};c.prototype.tn=function(){return 0!==this.selection.length||null!==this.xa};c.prototype.Ac=function(){var a=this.selection.concat();this.xa&&a.push(this.xa);return a};c.prototype.rr=function(a){if(0===a.length)return new A(0,0);for(var b=a[0].rect.clone(),c=1;c<a.length;c++)b.nh(a[c].rect);return b.Vc()};
c.prototype.hn=function(a){for(var b=[],c=0;c<a.length;c++)this.log("Selected id=%s",a[c].id),b.push(a[c].id);return b};c.prototype.lk=function(){var a=z(this.canvas).dc();this.fa.get("showRuler")&&(a.left+=20,a.top+=20);return(new F).multiply(new Lb(1/this.scale,1/this.scale)).multiply(new E(-this.ub,-this.jb)).multiply(new E(-a.left,-a.top))};c.prototype.rc=function(a){var b=this.Ac();a||(b=this.ea.Ih(b));return this.hn(b)};c.prototype.ak=function(a){for(var b=null,c=0;c<a.length;c++){var e=this.ea.va(a[c]);
e&&(null===b?b=e.rect.clone():b.nh(e.rect))}null===b&&(b=new D(0,0,0,0));return b};c.prototype.update=function(a,b){void 0===a&&(a=!1);if(this.ea.format(this.ia,this.request)||a)this.zf(),this.ha(b)};c.prototype.Nh=function(){var a=this.fa.get("snap"),b=null,c;var e=this.fa.get("background");var f=u.bi(e),g=this.fa.get("backgroundImage");this.background=this.ue=null;this.backgroundRepeat="no-repeat";var h=this;this.log("createBackground() background=%s",e);this.log("backgroundNodeId==%s",this.Tc);
if("grid"===e){this.backgroundRepeat="repeat";a=this.fa.get("gridBlocks");g=this.fa.get("gridSpacing");var k=(a||1)*g;b=qb(document.body);b.width=k;b.height=k;e=b.getContext("2d");e.fillStyle="#ffffff";e.fillRect(0,0,k,k);e.beginPath();for(c=0;c<k;c+=g)if(c%k||1>a)e.moveTo(c+.5,0),e.lineTo(c+.5,k);for(c=0;c<k;c+=g)if(c%k||1>a)e.moveTo(0,c+.5),e.lineTo(k,c+.5);e.strokeStyle=this.fa.get("gridColour");e.lineWidth=.5;e.stroke();if(0<a){e.beginPath();for(c=0;c<=k;c+=k)e.moveTo(c,0),e.lineTo(c,k);for(c=
0;c<=k;c+=k)e.moveTo(0,c+.5),e.lineTo(k,c+.5);e.lineWidth=2;e.stroke()}}else if(g)this.request.add(0,"image",g,null,function(a){h.log("Background image finished loading");h.background=a});else if(this.Tc){if(this.log("Regenerate background image"),a=this.ea.va(this.Tc,!1))e=a.rect.clone(),b=qb(document.body),b.width=e.x+e.width,b.height=e.y+e.height,e=b.getContext("2d"),a.ha(e)}else f?(this.log("Using background colour %s",f.toString()),this.ue=function(a,b,c,d,e){a.fillStyle=f.toString();a.fillRect(b,
c,d,e)}):0<a&&"clear"!==e&&(this.backgroundRepeat="repeat",b=qb(document.body),b.width=a,b.height=a,e=b.getContext("2d"),e.beginPath(),e.moveTo(0,0),e.arc(0,0,3,0,2*Math.PI,!1),e.moveTo(a,0),e.arc(a,0,3,0,2*Math.PI,!1),e.moveTo(a,a),e.arc(a,a,3,0,2*Math.PI,!1),e.moveTo(0,a),e.arc(0,a,3,0,2*Math.PI,!1),e.fillStyle="#c0c0c0",e.fill());b&&document.body.removeChild(b);this.background=b};c.prototype.rd=function(a,b,c,e,f){a.sf=null;this.background?(a.sf=a.createPattern(this.background,this.backgroundRepeat),
a.fillStyle=a.sf||"magenta",a.fillRect(b,c,e,f)):this.ue?this.ue(a,b,c,e,f):"G_vmlCanvasManager"in window&&(a.fillStyle="rgba(0, 0, 0, 0.0)",a.fillRect(b,c,e,f))};c.prototype.nq=function(a){var b=this.ea.ik();a.beginPath();a.fillStyle="#FFFFFF";this.fa.get("pageShadow")&&(a.shadowOffsetX=3/this.scale,a.shadowOffsetY=3/this.scale,a.shadowBlur=5/this.scale,a.shadowColor="rgba(0,0,0,1.0)");a.rect(0,0,b.width,b.height);a.fill();a.shadowColor="rgba(0,0,0,0.0)";a.shadowBlur=0;a.shadowOffsetX=0;a.shadowOffsetY=
0;a.strokeStyle=this.fa.get("pageBorderColour");a.stroke();this.rd(a,0,0,b.width,b.height);this.ue&&this.ue(a,0,0,b.width,b.height)};c.prototype.Wk=function(a){a?(this.log("Setting a custom background function."),this.ue=a):this.log("Clearing custom background function.")};c.prototype.mq=function(a){if(this.za.tb){var b=this.za.x,c=this.za.y,e=this.Cg();a.save();a.setTransform(e,0,0,e,0,0);a.beginPath();this.za.Fj?(a.moveTo(b-3,c-10),a.lineTo(b+3,c-10),a.moveTo(b-3,c+10),a.lineTo(b+3,c+10),a.moveTo(b,
c-10),a.lineTo(b,c+10)):(a.moveTo(b,c-3),a.lineTo(b,c-15),a.moveTo(b,c+3),a.lineTo(b,c+15),a.moveTo(b-3,c),a.lineTo(b-15,c),a.moveTo(b+3,c),a.lineTo(b+15,c));this.za.Qa&&this.ia.arc(b,c,8,0,2*Math.PI,!1);a.lineWidth=2;a.strokeStyle="#000000";a.stroke();a.restore()}};c.prototype.Qe=function(){var a=this.fa.get("showRuler")?20:0,b=z(this.canvas).dc(),c=z(this.canvas.parentElement).dc(),e=this.canvas.clientWidth,f=this.canvas.clientHeight,g=b.left-c.left;b=b.top-c.top;c=this.$j();this.gc.moveTo(g+e-
20+c,b+c+a);this.gc.Xf(20,f-20);this.dd.moveTo(g+c+a,b+f-20+c);this.dd.Xf(e-20,20);this.Sf();this.ha()};c.prototype.Sf=function(){if(!this.uk()){var a=this.Je(),b=this.ud();b=new D(0,0,b.width,b.height);a.sd(this.Ek)&&b.sd(this.Dk)||!this.wc(this.ld)||(this.Ek=a,this.Dk=b)}};c.prototype.Dm=function(){if(this.je){var a=this.ea.ik();this.ia.save();this.ia.beginPath();this.ia.rect(0,0,a.width,a.height);this.ia.clip()}return this.je};c.prototype.ha=function(a){if(!this.uk()&&(this.Xc=a||null,!this.Uj)){this.Uj=
!0;var b=this;this.requestAnimationFrame.call(window,function(){if(!b.Aa.sg){b.Uj=!1;var a=b.Cg();a!==b.Di&&(b.log("Detected DPR change; resize canvas now"),b.uo(b.ve.width,b.ve.height),b.Di=a);var c=b.Yd(),f=c.x,g=c.y,h=c.width,k=c.height;b.ia.setTransform(1,0,0,1,0,0);b.ia.clearRect(0,0,b.canvas.width,b.canvas.height);b.je&&(b.ia.fillStyle=b.fa.get("outsidePageColour"),b.ia.fillRect(0,0,b.canvas.width,b.canvas.height));b.ia.scale(a,a);b.ia.translate(b.ub,b.jb);b.ia.scale(b.scale,b.scale);b.fa.get("showRuler")&&
b.ia.translate(20/b.scale,20/b.scale);var l=new E(b.ub,b.jb);l=l.multiply(new Lb(b.scale,b.scale));b.ia.Qo=l;b.je?b.nq(b.ia):b.rd(b.ia,f,g,Math.max(h,h-f),Math.max(k,k-f));b.ea.nt();f=b.Dm();b.ea.ha(b.ia,c);b.Aa.Xc&&(b.ia.save(),b.Aa.Xc(b.ia),b.ia.restore());0<b.selection.length&&(b.ia.save(),b.oq(b.ia),b.ia.restore());f&&b.ia.restore();b.xa&&b.xa.Xh(b.ia,1/b.scale,b.Yc);""!==b.Hf&&b.fa.get("showHints")&&(b.ia.save(),b.ia.font=10/b.scale+"px Arial",b.ia.fillStyle="#000000",b.ia.textBaseline="top",
b.ia.fillText(b.Hf,0,0),b.ia.restore());b.mq(b.ia);b.ma.Qg&&b.ma.Qg(b.ia);b.Xc&&b.Xc(b.ia);b.Aa.Cf("draw",b.ia);b.fa.get("showRuler")&&(b.ia.setTransform(a,0,0,a,0,0),c=b.fa.get("pixelsPerUnit")*b.scale,f=b.fa.get("units"),b.ia.fillStyle="#ccc",b.ia.fillRect(0,0,20,20),Pd(b.ia,new D(20,0,b.canvas.width-20,20),0,f,c,-b.ub),Pd(b.ia,new D(0,20,20,b.canvas.height-20),2,f,c,-b.jb));b.ia.setTransform(1,0,0,1,0,0);0<b.selection.length&&b.le&&b.le.naturalWidth&&(c=b.le.width,b.ia.drawImage(b.le,b.canvas.width-
c-b.gc.kk(),0));b.vg&&b.vg.complete&&b.vg.naturalWidth&&(c=b.vg.naturalWidth,b.ia.drawImage(b.vg,b.canvas.width-c-b.gc.kk(),0));b.ia.setTransform(a,0,0,a,0,0);b.ia.beginPath();b.ia.font="20px Arial";h=b.ia.measureText(Rd).width;a=b.canvas.width/a/h;b.ia.scale(a,a);b.ia.textBaseline="top";b.ia.lineWidth=4/a;b.ia.strokeStyle="rgba(128, 128, 128, 0.1)";b.ia[Ud](Rd,0,0)}})}};c.prototype.oq=function(a){a.lineWidth=1/this.scale;a.strokeStyle="#888888";a.beginPath();for(var b=0;b<this.selection.length;b++){var c=
this.selection[b];var e=c.Ea();c=new H(c.Oa);c.transform(e);c.Wh(a,[3/this.scale,3/this.scale])}a.stroke();for(b=0;b<this.ff.length;b++)this.ff[b].ha(a,this.ti,this.scale,this.Mi)};c.prototype.hf=function(a){this.xa=a};c.prototype.ck=function(){return this.xa};c.prototype.Zi=function(a){this.Mi=a};c.prototype.Ir=function(a){return a.Yb===this.Yb};c.prototype.er=function(a,b){if(this.xa)return null;for(var c=this.Rl/this.scale,e=null,f=0;f<this.ff.length;f++){var g=this.ff[f];if(g.xb(this.ti,a,b,c,
this.scale)){e=g;break}}return e};c.prototype.kb=function(){this.Jo(!1)};c.prototype.Hd=function(){this.Jo(!0)};c.prototype.Jo=function(a){if(a?this.ea.nd():this.ea.od())a=a?this.ea.Hd():this.ea.kb(),this.ea.format(this.ia,this.request),this.Pp(),this.zf(),this.Sf(),this.mc(),this.nn(a),a=this.ea.Kf,this.log("Most recent change page=%s",a),a!==this.ea.Ra?(this.log("Undo/redo switched page %s->%s",this.ea.Ra,a),this.Rb(a)):this.ha(),this.Aa.ua("document-changed")};c.prototype.Nj=function(){this.Ae();
this.qg()};c.prototype.Ae=function(a,b){void 0===a&&(a=!1);var c=b?this.ea.fk(b,!1,!1):this.Ac();var e=this.ea.Rs(c);0<c.length&&(!0!==a&&ld.setItem("clipboard",e),this.log("Reset paste offset to 0"),this.jh=this.ih=0);return e};c.prototype.duplicate=function(){var a=this.rc(!1),b=this.fa.get("pasteOffset"),c=b||this.fa.get("pasteOffsetX");b=b||this.fa.get("pasteOffsetY");0<a.length&&this.pa([new Jc(a,c,b)])};c.prototype.Rg=function(a){if(!a&&(a=ld.getItem("clipboard"),!a))return;var b=this.fa.get("pasteOffset"),
c=b||this.fa.get("pasteOffsetX");b=b||this.fa.get("pasteOffsetY");this.ih+=c;this.jh+=b;this.log("Using paste offset %s,%s",this.ih,this.jh);c=new E(this.ih,this.jh);a=this.ea.In(a,c);this.pa(a);this.update()};c.prototype.Ri=function(a){""!==a?(this.Hf=this.language.get(a),this.Aa.ua("hint",this.Hf)):(this.Hf="",this.Aa.ua("hint",""))};c.prototype.eb=function(){return this.fb(new nd(this))};c.prototype.fb=function(a){this.ma&&this.ma.Cc&&this.ma.Cc();this.ma=a;a.Hc&&a.Hc();a.cd&&this.Aa.ua("tool-changed",
a.cd());return a};c.prototype.Ef=function(){var a=null;this.ma.cd&&(a=this.ma.cd());return a};c.prototype.nl=function(a){a=new Cd(this,a);this.fb(a);return a};c.prototype.Gn=function(a,b,c){this.fb(new Hd(this,"line",void 0,a,b,c))};c.prototype.Jm=function(a){a.lineWidth=a.lineWidth||this.Af;a.strokeStyle=a.strokeStyle||this.Ub;this.fb(new Gd(this,this.ma,a,"brush"))};c.prototype.pq=function(a){a.lineWidth=a.lineWidth||this.Af;a.strokeStyle=a.strokeStyle||this.Ub;this.fb(new Gd(this,this.ma,a,"shapebrush"))};
c.prototype.Km=function(a,b){a.lineWidth=a.lineWidth||this.Af;a.strokeStyle=a.strokeStyle||this.Ub;this.fb(new Gd(this,this.ma,a,b))};c.prototype.Gm=function(a){this.fb(new Hd(this,"curve",void 0,a))};c.prototype.Ap=function(a,b){this.fb(new Hd(this,"arrow",void 0,a,b))};c.prototype.Je=function(){if(this.je){var a=this.ea.ik();a=new D(0,0,a.width,a.height);var b=this.fa.get("pageInflation");a.ed(b,b)}else a=this.ea.bd();return a};c.prototype.mc=function(){if(!this.uk())if(this.fa.get("scrollbars")){var a=
this.ud(),b=this.Je(),c=this.Yd(),e=!1,f=!1;c.y<=b.y&&c.bottom()>=b.bottom()?this.gc.Zd():(this.gc.show(),this.gc.Ao(Math.min(c.y,b.y),Math.max(c.bottom(),b.bottom()),c.height,-this.jb/this.scale),e=!0);c.x<=b.x&&c.right()>=b.right()?this.dd.Zd():(this.dd.show(),this.dd.Ao(Math.min(c.x,b.x),Math.max(c.right(),b.right()),c.width,-this.ub/this.scale),f=!0);f&&e?(this.gc.Xf(20,a.height-20),this.dd.Xf(a.width-20,20)):e?this.gc.Xf(20,a.height):f&&this.dd.Xf(a.width,20)}else this.gc.Zd(),this.dd.Zd()};
c.prototype.Uf=function(a,b,c){this.log("Set document size %s,%s",a,b);c?c.push(new Mc({width:a,height:b})):(this.ea.setProperty("width",a),this.ea.setProperty("height",b),this.mc(),this.Sf(),this.Aa.ua("document-changed"));return!0};c.prototype.Ci=function(a,b,c){if(this.Tf)if(this.za.tb)this.log("Not nudging; keyboard cursor shown.");else return a*=c/this.scale,b*=c/this.scale,this.log("Nudge selection by %s, %s",a,b),c=this.rc(!0),c.length&&(a=new E(a,b),this.pa([new Ec(c,a)]),this.Zi(a.multiply(this.Mi))),
0<c.length;else this.log("Can't nudge; selection motion is locked.")};c.prototype.oh=function(a){var b=new R;var c=new A(-50,-50);var e=new A(50,-50);var f=new A(50,50);var g=new A(-50,50);b.moveTo(c.x,c.y);b.lineTo(e.x,e.y);b.lineTo(f.x,f.y);b.lineTo(g.x,g.y);b.lineTo(c.x,c.y);b.close();a=Fb({},{commands:b.Sb(),fillStyle:this.Bb,strokeStyle:this.Lb,seed:Math.round(65535*Math.random()),lineWidth:this.jg(this.wa.lineWidth),sloppiness:this.wa.sloppiness,layer:this.Pa,wrap:this.fa.get("multilineText"),
fontSize:this.fa.get("defaultFontSize")},a);this.log("Create an item on layer %s",this.Pa);this.fb(new Id(this,"PathNode",a,100,100,"rectangle","rectangle",null))};c.prototype.Al=function(a,b,c,e){var d=new R;for(var g=0;g<=a;g++){var h=50*Math.sin(b),k=50*-Math.cos(b);g&1&&(h*=c,k*=c);"matrix"in e&&(k=e.matrix.apply(h,k),h=k.x,k=k.y);0===g?d.moveTo(h,k):d.lineTo(h,k);b+=2*Math.PI/a}d.close();"matrix"in e&&delete e.matrix;e=Fb({},{commands:d.Sb(),fillStyle:this.Bb,strokeStyle:this.Lb,seed:Math.round(65535*
Math.random()),lineWidth:this.jg(this.wa.lineWidth),sloppiness:this.wa.sloppiness,layer:this.Pa,wrap:this.fa.get("multilineText"),fontSize:this.fa.get("defaultFontSize")},e);this.log("Create an item on layer %s",this.Pa);this.fb(new Id(this,"PathNode",e,100,100,this.fa.dn(),"polygon",null))};c.prototype.ss=function(){this.fb(new Nd(this))};c.prototype.bj=function(a){var b=new A(0,0);var c=new R;c.moveTo(b.x,b.y-50);c.Be(b.x+50,b.y-50,b.x+50,b.y);c.Be(b.x+50,b.y+50,b.x,b.y+50);c.Be(b.x-50,b.y+50,b.x-
50,b.y);c.Be(b.x-50,b.y-50,b.x,b.y-50);c.closePath();b=c.Sb();a=Fb({},{commands:b,fillStyle:this.Bb,strokeStyle:this.Lb,seed:Math.round(65535*Math.random()),lineWidth:this.jg(this.wa.lineWidth),sloppiness:this.wa.sloppiness,layer:this.Pa,wrap:this.fa.get("multilineText"),fontSize:this.fa.get("defaultFontSize")},a||{});this.fb(new Id(this,"PathNode",a,100,100,this.fa.dn(),"circle",null))};c.prototype.Bl=function(a,b,c,e,f,g){this.fb(new Id(this,a,b,c,e,f,"shape",g))};c.prototype.Jt=function(a,b){this.fb(new Md(this,
a,b))};c.prototype.zl=function(a){var b=this.ea.va(a,!1);if(!b)return this.log("useEditHandleTool: node %s doesn't exist.",a),!1;if(!b.Fg())return this.log("useEditHandleTool: nodetype %s has no edit mode",b.type()),!1;this.eb();this.pb();this.Mb();this.hf(b);this.ha()};c.prototype.bs=function(a){var b=this.ea.$a();var c=this.La(new A(100,100));c=new E(c.x,c.y);this.pa([new S(b,"ImageNode",{url:a,layer:this.Pa}),new Ec([b],c)]);this.eb()};c.prototype.Gf=function(){return wb()};c.prototype.js=function(a,
b){this.ma.be?(this.log("Simulating click of colour %s",a),this.ma.be(a,b)):this.log("A colour is not needed for this tool.")};c.prototype.os=function(a,b){this.ma.de?(this.log("Simulating opacity change %s",a),this.ma.de(a,b)):this.log("An opacity is not needed for this tool.")};c.prototype.Rb=function(a){this.ea.Rb(a)&&(this.pb(),this.Mb(),this.ha(),this.Aa.ua("set-page",a))};c.prototype.$k=function(a){this.je=a;a=this.Je();this.ub=-a.x;this.jb=-a.y;this.mc();this.ha()};c.prototype.ej=function(){this.wc(this.fa.Sk(1.1*
this.scale))};c.prototype.fj=function(){this.wc(this.fa.Sk(this.scale/1.1))};c.prototype.yg=function(a,b,c){c=c||this.rr(a);b=new Mb(b,c.x,c.y);this.pa([new Ec(this.hn(a),b)])};c.prototype.Um=function(a,b){this.tn()||this.log("flipSelection: selection is empty");this.yg(this.Ac(),a,b)};c.prototype.Cg=function(){var a=this.ia;return(window.devicePixelRatio||1)/(a.Au||a.nu||a.pu||a.ru||a.ju||1)};c.prototype.ud=function(){var a=this.ve,b=this.fa.get("showRuler")?20:0;return new D(b,b,a.width-b,a.height-
b)};c.prototype.uo=function(a,b){var c=this.Cg();this.canvas.width=a*c;this.canvas.height=b*c;this.canvas.style.width=a+"px";this.canvas.style.height=b+"px";this.ve.width=a;this.ve.height=b};c.prototype.Yd=function(){var a=this.ud();return new D((0-this.ub)/this.scale,(0-this.jb)/this.scale,a.width/this.scale,a.height/this.scale)};c.prototype.ah=function(a,b,c){void 0===b&&(b=!1);void 0===c&&(c=!1);this.log("setViewRect(%s)",a);var d=this.ud(),f=Math.min(d.width/a.width,d.height/a.height),g=a.x*f,
h=a.y*f;this.ub=b?(d.width-a.width*f)/2-g:-g;this.jb=c?(d.height-a.height*f)/2-h:-h;this.ld=this.scale=f;this.mc();this.ha()};c.prototype.Lq=function(a){this.request.yf?(this.log("Formatting in progress; will call function soon"),this.request.once("done",a)):(this.log("Format already done; call function in 1 tick"),setTimeout(a,0))};c.prototype.xi=function(a){!this.tf&&a?(this.log("Locking updates."),this.tf=!0):this.tf&&!a&&(this.log("Resuming updates"),this.tf=!1,this.Sf(),this.mc(),this.ha())};
c.prototype.uk=function(){this.tf&&this.log("Updates are locked. Ignoring draw/format request");return this.tf};c.prototype.Ak=function(){function a(){e.drawImage(b.canvas,f.x*g,f.y*g,f.width*g,f.height*g,f.x*g,f.y*g,f.width*g,f.height*g);k=!0;l=b.Yd();b.log("Got new FASTDRAW buffer.")}var b=this,c=document.createElement("canvas");c.width=this.canvas.width;c.height=this.canvas.height;var e=c.getContext("2d"),f=this.ud(),g=this.Cg(),h=this,k=!1,l=new D(0,0,0,0);h.ha(a);return{ha:function(b,d){l.sd(h.Yd())||
(k=!1,h.ha(a));h.requestAnimationFrame.call(window,function(){k&&(h.ia.setTransform(1,0,0,1,0,0),h.ia.clearRect(f.x*g,f.y*g,f.width*g,f.height*g),h.ia.drawImage(c,0,0),b&&(h.ia.scale(g,g),h.ia.translate(f.x,f.y),h.ia.translate(h.ub,h.jb),h.ia.scale(h.scale,h.scale),b.call(d,h.ia)))})}}};return c}();var Zd=function(){function c(a,b,c){var d=this;this.Aa=a;this.sa=b;this.log=w.create("APP");this.Ja=new jd;this.Sc=null;this.Qn=this.Un=-1;this.Vh=[];this.ph="";this.Tk=this.wl=null;for(this.Re=[];null!==b.firstChild;)b.removeChild(b.firstChild);b=z(this.sa).Le("position");"absolute"!==b&&"fixed"!==b&&(this.sa.style.position="relative");this.sa.style.overflow="none";this.sa.style.textAlign="left";this.sa.classList.add("zwibbler-main");O.Bd(".zwibbler-main { font-size: 16px; }");this.Sh=new id(z("div").Gc({width:"300px"}).Ga,
this.Ja);this.log("Zwibbler built on "+new Date(1560516861780)+" for 'web'");this.fa=new Uc(this.Ja,c);this.language=new La("\nen:arrowhead-size:Arrowhead size\nes:arrowhead-size:Flecha tama\u00f1o\n\nen:arrowhead-size-large:Large\nes:arrowhead-size-large:Grande\n\nen:arrowhead-size-medium:Medium\nes:arrowhead-size-medium:Medio\n\nen:arrowhead-size-none:None\nes:arrowhead-size-none:Nada\n\nen:arrowhead-size-small:Small\nes:arrowhead-size-small:Peque\u00f1o\n\nen:arrowhead-size-tiny:Tiny\nes:arrowhead-size-tiny:Diminuto\n\nen:arrowhead-style:Arrowhead style\nes:arrowhead-style:Flecha estilo\n\nen:arrowhead-style-simple:Simple\nes:arrowhead-style-simple:Llanura\n\nen:arrowhead-style-solid:Solid\nes:arrowhead-style-solid:Denso\n\nen:arrow-keys:Arrow Keys\nes:arrow-keys:Teclas de flecha\n\nen:arrow-tool:Arrow tool\nes:arrow-tool:Flecha\nfr:arrow-tool:Fl\u00e8che\nnl:arrow-tool:Pijl\n\nen:break-apart-group:Break apart group\nes:break-apart-group:Dividir el grupo\n\nen:bring-to-front:Bring to front\nes:bring-to-front:Traer al frente\n\nen:brush-tool:Brush tool\nes:brush-tool:Brocha\nfr:brush-tool:Brosse\nnl:brush-tool:Penseel\n\nen:circle-tool:Circle tool\nes:circle-tool:C\u00edrculo\nfr:circle-tool:Cercle\nnl:circle-tool:Cirkel\n\nen:click-to-place-another-point-or-double-click-to-end-the-line:Click to place another point, or double-click to end the line.\nes:click-to-place-another-point-or-double-click-to-end-the-line:Haga clic para colocar otro punto, o doble clic para finalizar la l\u00ednea\nfr:click-to-place-another-point-or-double-click-to-end-the-line:Cliquez pour placer un autre point, ou double-cliquez pour terminer la ligne.\nnl:click-to-place-another-point-or-double-click-to-end-the-line:Klik op een ander punt te plaatsen, of dubbelklik om de lijn te be\u00ebindigen.\n\nen:click-to-place-first-point-of-line:Click to place first point of line\nes:click-to-place-first-point-of-line:Haga clic para colocar el primer punto de la l\u00ednea\nfr:click-to-place-the-first-point-of-line:Cliquez pour placer le premier point de la ligne\nnl:click-to-place-the-first-point-of-line:Klik om het eerste punt van de lijn te plaatsen.\n\nen:click-to-set-the-end-of-the-line:Click to set the end of the line\nes:click-to-set-the-end-of-the-line:Haga clic para colocar el extremo de la l\u00ednea\nfr:click-to-set-the-end-of-the-line:Cliquez pour d\u00e9finir la fin de la ligne\nnl:click-to-set-the-end-of-the-line:Klik hier voor het einde van de lijn in te stellen.\n\nen:copy:Copy\nes:copy:Copiar\nfr:copy:Copie\nnl:copy:Kopi\u00ebren\n\nen:curve-tool:Curve tool\nes:curve-tool:Curva\nfr:curve-tool:Courbes\nnl:curve-tool:Kromme\n\nen:delete-selection:Delete selection\nes:delete-selection:Eliminar la selecci\u00f3n\n\nen:del-key:Del\nes:del-key:Del\n\nen:double-arrows:Double arrows\nes:double-arrows:flechas dobles\n\nen:draw-curves:Draw curves\nes:draw-curves:Dibuje las curvas\n\nen:draw-lines:Draw lines\nes:draw-lines:Dibujar l\u00edneas\n\nen:duplicate-selection:Duplicate selection\nes:duplicate-selection:Duplica la selecci\u00f3n\n\nen:fill-colour:Fill colour\nes:fill-colour:Color de relleno\n\nen:font:Font\nes:font:Font\n\nen:font-size:Font size\nes:font-size:Tama\u00f1o de letra\n\nen:group-selection:Group selection\nes:group-selection:Grupo la selecci\u00f3n\n\nen:image-tool:Image tool\nes:image-tool:Imagen\nfr:image-tool:Image\nnl:image-tool:Afbeelding\n\nen:image-url:Image URL\nes:image-url:URL de la imagen\n\nen:keyboard:Keyboard\nes:keyboard:Teclado\n\nen:line-style:Line style\nes:line-style:Estilo de l\u00ednea\n\nen:line-style-long-dashes:Long dashes\nes:line-style-long-dashes:Gui\u00f3n largo\n\nen:line-style-short-dashes:Short dashes\nes:line-style-short-dashes:Gui\u00f3n corto\n\nen:line-style-solid:Solid\nes:line-style-solid:Denso\n\nen:line-tool:Line tool\nes:line-tool:Raya\nfr:line-tool:Lignes\nnl:line-tool:Lijn\n\nen:move-selection-away:Move selection away\nes:move-selection-away:Mover la selecci\u00f3n de distancia\n\nen:move-selection-closer:Move selection closer\nes:move-selection-closer:Mover la selecci\u00f3n de distancia\n\nen:move-while-zoomed:Move while zoomed\nes:move-while-zoomed:Desplazarse por la pantalla\n\nen:none:None\nes:none:Nada\n\nen:no:No\nes:no:No\n\nen:outline-colour:Outline colour\nes:outline-colour:Color del contorno\n\nen:outline-thickness:Outline thickness\nes:outline-thickness:Grosor del contorno\n\nen:page-down-key:Page Down\nes:page-down-key:Page Down\n\nen:page-up-key:Page Up\nes:page-up-key:Page Up\n\nen:paste:Paste\nes:paste:Pegar\nfr:paste:Coller\nnl:paste:Plak\n\nen:pick-tool:Pick tool\nes:pick-tool:Seleccionar\nfr:pick-tool:S\u00e9lectionner\nnl:pick-tool:Uitkiezen\n\nen:rectangle-tool:Rectangle tool\nes:rectangle-tool:rect\u00e1ngulo\nfr:rectangle-tool:Rectangle\nnl:rectangle-tool:Rechthoek\n\nen:redo:Redo\nes:redo:Rehacer\nfr:redo:Refaire\nnl:redo:Opnieuw maken\n\nen:rounded-rectangle-tool:Rounded rectangle tool\nes:rounded-rectangle-tool:Rect\u00e1ngulo redondeado\n\nen:save:Save\nes:save:Guardar\n\nen:send-to-back:Send to back\nes:send-to-back:Enviar a la parte posterior\n\nen:shadow:Shadow\nes:shadow:Sombra\n\nen:shape-brush-tool:Shape brush tool\nes:shape-brush-tool:Brush que dibuja formas\n\nen:sloppiness-artist:Artist\nes:sloppiness-artist:Artista\n\nen:sloppiness-cartoonist:Cartoonist\nes:sloppiness-cartoonist:Caricaturista\n\nen:sloppiness-child:Child\nes:sloppiness-child:Ni\u00f1o\n\nen:sloppiness-draftsman:Draftsman\nes:sloppiness-draftsman:Dibujante\n\nen:sloppiness-drunk:Drunk\nes:sloppiness-drunk:Borracho\n\nen:sloppiness:Sloppiness\nes:sloppiness:La dejadez\n\nen:smoothness-sharper:Sharper\nes:smoothness-sharper:Muy afilado\n\nen:smoothness-sharpest:Sharpest\nes:smoothness-sharpest:M\u00e1s afilado\n\nen:smoothness-sharp:Sharp\nes:smoothness-sharp:Afilado\n\nen:smoothness-smoothest:Smoothest\nes:smoothness-smoothest:Muy liso\n\nen:smoothness:Smoothness\nes:smoothness:Lisura\n\nen:smoothness-smooth:Smooth\nes:smoothness-smooth:Liso\n\nen:text-colour:Text colour\nes:text-colour:Color del texto\n\nen:text:Text\nes:text:Texto\n\nen:text-tool:Text tool\nes:text-tool:Texto\nfr:text-tool:Texte\nnl:text-tool:Tekst\n\nen:thickness-brush:Brush\nes:thickness-brush:Brocha\n\nen:thickness-marker:Marker\nes:thickness-marker:Rotulador\n\nen:thickness-pencil:Pencil\nes:thickness-pencil:L\u00e1piz\n\nen:thickness-pen:Pen\nes:thickness-pen:Pluma\n\nen:undo:Undo\nes:undo:Deshacer\nfr:undo:D\u00e9faire\nnl:undo:Ongedaan maken\n\nen:yes:Yes\nes:yes:S\u00ed\n\nen:zoom-in:Zoom in\nes:zoom-in:Zoom\n\nen:zoom-out:Zoom out\nes:zoom-out:Disminuir el zoom\n");
this.language.xo(this.fa.get("language"));this.Ej=z("div").se("zwibbler-canvas-holder").Gc({position:"absolute",overflow:"hidden"}).Ga;this.sa.appendChild(this.Ej);this.canvas=qb(this.Ej);z(this.canvas).se("zwibbler-main-canvas").Gc({outline:"0",position:"absolute",left:"0",top:"0",touchAction:"pan-x pan-y"});-1<window.navigator.userAgent.indexOf("Edge")&&(this.log("Edge detected. Set touch action none"),z(this.canvas).Gc({touchAction:"none"}));this.canvas.setAttribute("tabindex","0");this.ia=this.canvas.getContext("2d");
this.qc=new Pc;this.view=new Yd(this.canvas,new Yc,this.qc,this.fa,this.language,this.Aa,this.Ja);this.vo();this.Nr=this.lt();this.Ja.addEventListener(window,"resize",function(){d.Aa.resize()});window.$&&(this.log("jQuery detected; register for bootstrap events"),window.$(document).bind("shown.bs.modal",function(){d.log("Bootstrap modal shown; resize now");d.Aa.resize()}));null!==this.fa.Ma("backgroundImage")&&(this.Vk(this.fa.Ma("backgroundImage")),this.view.ea.Vg());this.fa.Ka("update",function(a,
b){d.Dd(a,b)});O.Bd(".zwibbler-progress-notification {\n            position: absolute;\n            top: 0;\n            right: 0;\n            box-shadow: 3px 3px 3px #444;\n            background: #ccc;\n            color: black;\n            border-bottom-left-radius: 4px;\n            font-family: arial,sans;\n        }");this.ho=z("div").se("zwibbler-progress-notification").Qd(this.sa).Ga;a.resize();this.fa.get("setFocus")&&this.focus("toolbar");this.Dd("showDebug",this.fa.get("showDebug"));
this.Aa.ua("document-changed");this.Aa.ua("set-page",this.view.ea.Ra);if(ld.Fh()){if(this.fa.get("persistent")&&(a=ld.getItem("zwibbler-document")))try{var f=hd.sh(a);if(f)this.gf(f);else throw Error("Failed to open document.");}catch(g){this.log("Failed to load persistent document: %s",g.message)}this.wl=md(function(){d.fa.get("persistent")&&(d.log("Saving document"),ld.setItem("zwibbler-document",d.Aa.save()))});this.Aa.Ka("document-changed",function(){d.wl()});this.Ja.add(function(){d.wl.cancel()})}this.Ja.add(function(){for(;d.sa.firstChild;)d.sa.removeChild(d.sa.firstChild)})}
c.prototype.rg=function(){this.Ja.rg()};c.prototype.Dd=function(a,b){var c=!1;this.log("onConfigChange %s=%s",a,b);switch(a){case "showDebug":b?(this.Sh.show(),this.ig(0,"right",this.Sh.sa)):(this.Sh.Zd(),this.Ug(this.Sh.sa));c=!0;break;case "backgroundImage":this.Vk(b);break;case "language":this.language.xo(b)}c&&this.Ah()};c.prototype.vo=function(){this.fa.Ma("sloppy")||this.view.ge("sloppiness",0);this.view.ge("smoothness",this.fa.Yq());this.view.ge("fillStyle",this.fa.Ma("defaultFillStyle"));
this.view.ge("strokeStyle",this.fa.Ma("defaultStrokeStyle"));this.view.ge("fontName",this.fa.Ma("defaultFont"));this.view.ge("fontSize",this.fa.Ma("defaultFontSize"));this.view.ge("lineWidth",this.fa.Ma("defaultLineWidth"));this.view.ge("textFillStyle",this.fa.Ma("defaultTextFillStyle"))};c.prototype.gf=function(a){this.Sc=null;this.view.gf(a);this.vo();this.Bq();this.Aa&&(this.Aa.ua("document-changed"),this.Aa.ua("set-page",a.Ra));for(a=0;a<this.Vh.length;a++){var b=this.Vh[a];this.log("Removing old DomElement of type %s",
b.tagName);z(b).remove()}this.Vh=[]};c.prototype.Bm=function(){this.view.ea.Vg()};c.prototype.lt=function(){var a=this,b=this;this.ph="none";var c=new kd;this.fa.Bp(c);c.Ka("*",function(a,c){"canvas"===b.ph?b.view.Nc(a,c):b.log("Ignore key action -- don't have focus.")});this.sa.setAttribute("tabindex","0");c.Cp(this.sa);this.Ja.add(function(){a.Nr.detach(a.sa)});this.view.Yh=!1;this.canvas.addEventListener("click",function(){vb()||b.view.Yh?b.ph="canvas":b.focus("canvas");b.view.Yh=!1});this.qc.Ka("goto-toolbar",
function(){b.fa.get("showToolbar")?b.focus("toolbar"):(a.Tk&&a.Tk.focus(),b.Aa.ua("blur"))});this.qc.Ka("goto-canvas",function(){b.focus("canvas")});this.Ja.addEventListener(this.sa,"blur",function(){"text"!==b.view.Ef()&&(b.log("Blur event received -- hide keyboard cursor"),b.view.Fr())});this.fa.Ka("allowSystemClipboard",function(b){a.log("allowSystemClipboard=>%s",b);a.fa.rk()&&(a.Ja.addEventListener(document,"cut",function(b){return a.view.Hk(b)}),a.Ja.addEventListener(document,"copy",function(b){return a.view.Hk(b)}),
a.Ja.addEventListener(document,"paste",function(b){return a.view.Hk(b)}))});return c};c.prototype.it=function(a){this.Tk=a};c.prototype.focus=function(a){this.log("Set focus to %s",a);if("toolbar"!==a&&"canvas"!==a&&"none"!==a)throw"Focus must be toolbar or canvas or none, not "+a;this.ph=a;"canvas"===this.ph&&this.fa.get("setFocus")&&this.sa.focus()};c.prototype.cl=function(a){void 0===a&&(a=!1);this.focus("canvas");this.view.cl(a)};c.prototype.createNode=function(a,b,c){var d=this.view.ea.$a();
"layer"in c||(c.layer=this.view.Pa);a.push(new S(d,b,c));return d};c.prototype.transformNode=function(a,b,c){a.push(new Ec(b,c));return!0};c.prototype.Zk=function(a,b,c,e,f,g,h,k){c=new F(c,f,e,g,h,k);a.push(new Dc(b,"matrix",c));return!0};c.prototype.lh=function(a,b,c,e){c=new E(c,e);a.push(new Ec(b,c));return!0};c.prototype.Li=function(a,b,c,e,f,g){c=new Lb(c,e,f,g);a.push(new Ec(b,c));return!0};c.prototype.zc=function(a,b){a.push(new Cc(b));return!0};c.prototype.Bq=function(){var a=this;this.Sc=
null;this.view.ea.oc(!1,function(b){"ImageNode"!==b.type()||"background"!==b.ka("layer")&&"background"!==b.ka("tag")||(a.log("Found background image at nodeid %s",b.id),a.Sc=b.id,b.he(!0))})};c.prototype.Vk=function(a){var b=[];null!==this.Sc&&this.view.ea.Ee(this.Sc)&&b.push(new Cc([this.Sc]));if(a){var c=this.view.ea.$a();b.push(new S(c,"ImageNode",{url:a,locked:!0,tag:"background",layer:this.view.Pa}));b.push(new Kc([c],Kc.mj))}this.Sc=c||null;this.view.pa(b);c&&this.view.ea.va(c,!1).he(!0);this.view.pb();
this.view.Mb()};c.prototype.Tq=function(){return null!==this.Sc&&this.view.ea.Ee(this.Sc)?this.view.ea.va(this.Sc).ka("url"):null};c.prototype.zk=function(){this.gf(new Yc);null!==this.fa.Ma("backgroundImage")&&(this.Vk(this.fa.Ma("backgroundImage")),this.view.ea.Vg())};c.prototype.Ah=function(){var a=!0;void 0===a&&(a=!1);var b=this.sa.clientWidth,c=this.sa.clientHeight;if(a||b!==this.Un||c!==this.Qn){this.log("onResize()");this.Un=b;this.Qn=c;for(var e=a=0,f=0,g=0,h=0,k=this.Re;h<k.length;h++){var l=
k[h];switch(l.position){case "left":case "right":l.sa.style.top=f+"px";l.sa.style.bottom=g+"px";break;case "top":case "bottom":l.sa.style.left=a+"px",l.sa.style.right=e+"px"}switch(l.position){case "left":l.sa.style.left=a+"px";a+=l.sa.offsetWidth;break;case "right":l.sa.style.right=e+"px";e+=l.sa.offsetWidth;break;case "top":l.sa.style.top=f+"px";f+=l.sa.offsetHeight;break;case "bottom":l.sa.style.bottom=g+"px",g+=l.sa.offsetHeight}}z(this.Ej).Gc({left:a+"px",right:e+"px",top:f+"px",bottom:g+"px"});
this.view.uo(b-e-a,c-g-f);z(this.ho).Gc({top:"0",right:e+"px"});this.view.Qe()}else this.log("Ignoring resize; div size did not change.")};c.prototype.nj=function(a,b,c){void 0===c&&(c=this.view.ea.Ra);var d=this.view.ea.Ra;this.view.ea.Rb(c);a.translate(-b.x,-b.y);this.view.rd(a,b.x,b.y,b.width,b.height);this.view.ea.ha(a);this.Aa.Xc&&this.Aa.Xc(a);this.view.ea.Rb(d)};c.prototype.no=function(a,b){if("image/svg+xml"===a||"application/pdf"===a){var c=!1;if("image/svg+xml"===a)var e=new gd(new D(0,
0,b.width,b.height));else e=new ed(new D(0,0,b.width,b.height),O.fonts),c=!0;if(c)for(c=0;c<this.view.ea.Jc();c++)0<c&&e.Zf(),this.nj(e,b,c);else this.nj(e,b);return"data:"+a+";base64,"+qa(e.toString())}c=document.createElement("canvas");c.setAttribute("width",b.width.toString());c.setAttribute("height",b.height.toString());e=c.getContext("2d");if("image/jpeg"===a||"image/bmp"===a)e.fillStyle="#ffffff",e.fillRect(0,0,b.width,b.height);this.nj(e,b);return"image/bmp"===a?Db(c):c.toDataURL(a)};c.prototype.vc=
function(a,b,c,e){this.log("External app setItemProperty %s: %s=%s",b,c,e);a.push(new Dc(b,c,e));return!0};c.prototype.Yk=function(a,b,c){var d;this.log("External app setNodeProperty %s: %s",b,c);for(d in c)c.hasOwnProperty(d)&&a.push(new Dc(b,d,c[d]));return!0};c.prototype.gi=function(a,b){var c,e;(c=this.view.ea.va(a))&&(e=c.ka(b));this.log("GetItemProperty %s: %s=%s",a,b,e);return e};c.prototype.Jj=function(a,b){var c,e;if(6>b.length)this.log("newShape: Cannot create shape with fewer than three points.");
else{var f=new R;var g=c=0;for(e=b.length-1;c<=e;g=c+=2){var h=this.view.La(new A(b[g],b[g+1]));if(0===g){f.moveTo(h.x,h.y);var k=h}else f.lineTo(h.x,h.y)}k&&(f.lineTo(k.x,k.y),f.close());return this.Oh(a,f.Sb())}};c.prototype.Oh=function(a,b){return this.createNode(a,"PathNode",{commands:b,fillStyle:this.view.Bb,strokeStyle:this.view.Lb,seed:Math.round(65535*Math.random()),lineWidth:this.view.wa.lineWidth,sloppiness:this.view.wa.sloppiness,angleArcs:this.fa.get("angleArcs")})};c.prototype.og=function(a,
b){var c=this.view.ea.$a();a.push(new Gc(c,b));return c};c.prototype.mh=function(a,b){a.push(new Hc(b));return!0};c.prototype.eq=function(a){return new Vc(this.ho,a)};c.prototype.ig=function(a,b,c){for(var d=0,f=this.Re;d<f.length;d++)if(f[d].sa===c)return;this.sa.appendChild(c);this.Re.push({order:a,sa:c,position:b});c.style.position="absolute";this.Re.sort(function(a,b){return a.order<b.order?-1:1});this.Ah()};c.prototype.Ug=function(a){for(var b=0;b<this.Re.length;b++)if(this.Re[b].sa===a){this.Re.splice(b,
1);this.sa.removeChild(a);break}this.Ah()};return c}();var $d=function(){function c(a,b){this.view=a;this.methods=b;this.log=w.create("CustomToolBehaviour");this.Xb=new Dd(a)}c.prototype.Hc=function(){this.log("Entering CustomToolBehaviour");this.methods.enter&&this.methods.enter()};c.prototype.Cc=function(){this.log("Leaving CustomToolBehaviour");this.methods.leave&&this.methods.leave()};c.prototype.Ed=function(a,b,c){return this.methods.onMouseClick?this.methods.onMouseClick(a,b,c):!1};c.prototype.Ta=function(a,b,c){return this.methods.onMouseDown?
this.methods.onMouseDown(a,b,c):!1};c.prototype.Va=function(a,b,c){return this.methods.onMouseMove?this.methods.onMouseMove(a,b,c):!1};c.prototype.Wa=function(a,b,c){return this.methods.onMouseUp?this.methods.onMouseUp(a,b,c):!1};c.prototype.Xn=function(a,b,c){return this.methods.onMouseLeave?this.methods.onMouseLeave(a,b,c):!1};c.prototype.ce=function(a,b,c){return this.methods.onDoubleClick?this.methods.onDoubleClick(a,b,c):!1};c.prototype.Vn=function(a,b,c){return this.methods.onContextMenu?this.methods.onContextMenu(a,
b,c):!1};c.prototype.be=function(a,b){return this.methods.onColour?this.methods.onColour(a,b):!1};c.prototype.de=function(a,b){return this.methods.onOpacity?this.methods.onOpacity(a,b):!1};c.prototype.Nc=function(a,b){this.log("keyboard: %s",a);this.methods.onKeyCommand&&!1===this.methods.onKeyCommand(a,b)||"cancel"!==a||(this.log("ESC pressed. Abort and go back to toolbar."),this.view.eb(),this.view.qc.ua("goto-toolbar"))};c.prototype.Qg=function(a){if(this.methods.onRedraw)this.methods.onRedraw(a)};
c.prototype.rb=function(a){if(this.methods.onTouch)return this.methods.onTouch(a);if("touchstart"===a.type||"touchmove"===a.type||"touchend"===a.type){if(a.touches&&a.touches.length)var b=a.touches[0];else a.changedTouches&&a.changedTouches.length?b=a.changedTouches[0]:(this.log("No touches!"),b={pageX:0,pageY:0});b=this.view.Za(b.pageX,b.pageY);return"touchstart"===a.type?this.Ta(b.x,b.y,a):"touchend"===a.type?this.Wa(b.x,b.y,a):"touchmove"===a.type?this.Va(b.x,b.y,a):!1}};c.prototype.bb=function(a){return this.methods.onGesture?
this.methods.onGesture(a):this.Xb.bb(a)};c.prototype.Ik=function(a,b,c,e){return this.methods.onMouseWheel?this.methods.onMouseWheel(a,b,c,e):!1};c.prototype.cd=function(){return this.methods.getToolName?this.methods.getToolName():"custom"};return c}();function ae(c){for(var a=[],b=0;b<c;b++)a.push("ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz01234567890"[Math.floor(63*Math.random())]);return a.join("")};w.create("OTDocument");
var be=function(){function c(a,b,c,e,f){void 0===e&&(e=[]);void 0===f&&(f=!1);this.Ya=a;this.sc=b;this.aj=c;this.Dc=e;this.local=f}c.prototype.clone=function(a,b){void 0===b&&(b=this.aj);for(var d=[],e=0,f=this.Dc;e<f.length;e++)d.push(f[e].clone());return new c(a,this.sc,b,d,this.local)};c.prototype.inverse=function(a,b){void 0===a&&(a=this.Ya);void 0===b&&(b=this.aj);for(var d=[],e=this.Dc.length-1;0<=e;e--)d.push(this.Dc[e].inverse());return new c(a,this.sc,b,d,this.local)};return c}(),ce=function(){function c(a,
b,c){this.Op=a;this.Gp=b;this.En=c}c.prototype.getData=function(){return this.Op};c.prototype.Dg=function(){return this.En};c.prototype.empty=function(){return this.Gp===this.En};return c}(),de=function(){function c(a,b){void 0===a&&(a=!1);this.wm=a;this.xe=b;this.log=w.create("OTDocument");this.$b=[];this.next=0;this.local=[];this.all=[];this.Gb=0;this.me={};this.Db=!1;this.lp=-1;this.vh=""}c.prototype.od=function(){return 0<this.next};c.prototype.nd=function(){return this.next<this.$b.length};c.prototype.kb=
function(){this.od()&&this.jo(this.$b[--this.next],!0)};c.prototype.Hd=function(){this.nd()&&this.jo(this.$b[this.next++],!1)};c.prototype.Bm=function(){this.next=this.$b.length=0};c.prototype.Ag=function(){return this.local.length?0===this.xe?new ce(this.encode(this.local),this.Gb.toString(),(this.Gb+this.local.length).toString()):new ce(this.encode(this.local),this.local[0].sc,this.local[this.local.length-1].Ya):new ce("","0","0")};c.prototype.If=function(a){if(0===this.xe){a=parseInt(a,10)-this.Gb;
for(var b=0;b<a;b++)this.all[this.Gb+b].Ya=(this.Gb+b+1).toString(),this.Gb+b+1<this.all.length&&(this.all[this.Gb+b+1].sc=this.all[this.Gb+b].Ya);this.Gb+=a;this.local.splice(0,a)}else for(b=this.local.length-1;0<=b;b--)if(a===this.local[b].Ya){this.local.splice(0,b+1);break}};c.prototype.Dg=function(){return this.all.length?this.all[this.all.length-1].Ya:this.$h()};c.prototype.xj=function(a){this.Db||(a.local=!0,this.$b.length=this.next,this.$b.push(a),this.next+=1,this.local.push(a),this.all.push(a),
this.wm?(this.log("Executing LOCAL %s",a.Ya),this.wg(a)):this.log("adding LOCAL %s",a.Ya),1===this.xe&&(this.me[a.Ya]=a))};c.prototype.wg=function(a){var b=0;for(a=a.Dc;b<a.length;b++)this.wb(a[b])};c.prototype.Gq=function(a){for(var b=this.all.length-1;0<=b&&this.all[b].Ya!==a;b--);return b};c.prototype.jo=function(a,b){var c=this.Gq(a.Ya);if(-1===c)this.log("ERROR");else{var e=this.Ai();b?(e=a.inverse(e,this.now()),e.sc=this.all[c].Ya):e=a.clone(e,this.now());for(c=b?c+1:c;c<this.all.length;c++)this.all[c].local||
this.vl(this.all[c],[e]);this.local.push(e);this.all.push(e);this.wm&&this.wg(e)}};c.prototype.vl=function(a,b){if(a.sc!==b[0].sc)throw Error("Error: Expected same parentage.");for(var c=0,e=a.Dc;c<e.length;c++)for(var f=e[c],g=0,h=b;g<h.length;g++){var k=h[g];f=this.Bt(f,k.Dc,a.Ya,k.Ya)}b[0].sc=a.Ya};c.prototype.Bt=function(a,b,c,e){this.log("Transform "+c+" agaisnt list "+e);for(var d=0;d<b.length;d++){var g=b[d];b[d]=this.ul(a,g,c,e);a=this.ul(g,a,e,c)}return a};c.prototype.wf=function(a){var b=
this.decode(a);if(null===b||0===b.length)return null!==b;this.log("Entering addRemoteChanges");a=this.all.length;if(0===this.xe){if(this.Gb===this.all.length)for(var c=0;c<b.length;c++)this.all.push(b[c]);else{for(this.Db=!0;a!==this.Gb;)--a,this.wg(this.all[a].inverse());this.Db=!1;var e=this.all.slice(this.Gb);this.all.length=this.Gb;for(var f=0;f<b.length;f++)c=b[f],this.vl(c,e);this.all=this.all.concat(b,e)}this.Gb+=b.length}else{for(a=0;a<b.length;a++)c=b[a],c.Ya in this.me||(this.me[c.Ya]=c);
a={};a[this.$h()]=[];for(e in this.me)a[e]=[];for(e in this.me)c=this.me[e],c.sc in a&&a[c.sc].push(c.Ya);for(e in a)a[e].sort();e=a[this.$h()];b=this.$h();for(c=0;c<this.all.length&&1===e.length&&e[0]===this.all[c].Ya;c++)b=e[0],e=a[e[0]];this.Db=!0;for(e=this.all.length-1;e>=c;e--){this.log("[%s] Executing INVERSE %s",e,this.all[e].Ya);try{this.wg(this.all[e].inverse())}catch(g){throw this.log("Error occurred HEREEEEEE %s",this.all[e].Ya),g;}}this.Db=!1;this.all.length=c;c=[];this.gk(a,b,c);a=this.all.length;
for(b=1;b<c.length;b++)this.all.push(c[b])}this.Db=!0;for(c=a;c<this.all.length;c++)this.log("[%s] Executing REMOTE %s",c,this.all[c].Ya),this.wg(this.all[c]);0<this.all.length-a&&this.pa();this.Db=!1;this.log("Done addremotechanges");return!0};c.prototype.gk=function(a,b,c){c.push(this.me[b]);for(b=a[b];1===b.length;)c.push(this.me[b[0]]),b=a[b[0]];if(0!==b.length){var d=c.length;this.gk(a,b[0],c);for(var f=1;f<b.length;f++){var g=[];this.gk(a,b[f],g);for(var h=d;h<c.length;h++)this.vl(c[h],g);c.push.apply(c,
g)}}};c.prototype.$h=function(){return(0).toString()};c.prototype.Ai=function(){return 0===this.xe?(this.lp--).toString():this.vh+Math.floor(1E6*Math.random()).toString(36)};c.prototype.show=function(){this.log("%s",JSON.stringify(this.all,null,2))};c.prototype.now=function(){return Math.floor((new Date).getTime()/1E3)};c.prototype.Us=function(a){this.vh=a};c.prototype.Am=function(a,b){if(0===this.xe){var c=parseInt(a,10),e=parseInt(b,10);return 0>c&&0>e?c>e:0<c&&0<e?c<e:0<e?!1:!0}return a<b};c.prototype.pa=
function(){};return c}(),ee=function(){function c(a,b,c){this.type=a;this.Ob=b;this.newValue=c}c.prototype.clone=function(){return new c(this.type,this.Ob,this.newValue)};c.prototype.inverse=function(){return"a"===this.type?new c("a",-this.Ob,this.newValue-this.Ob):new c("m",1/this.Ob,this.newValue/this.Ob)};return c}();
(function(c){function a(a,d){var b=c.call(this,!0,a)||this;b.prefix=d;b.value=0;b.Us(d);return b}n(a,c);a.prototype.wb=function(a){"a"===a.type?(this.log("Add to  %s  %s",this.value,a.Ob),this.value+=a.Ob):"m"===a.type&&(this.log("Multiply %s by %s",this.value,a.Ob),this.value*=a.Ob);if(this.value!==a.newValue)throw Error("Document value should be "+a.newValue+", but got "+this.value);};a.prototype.decode=function(a){a=JSON.parse(a,function(a,b){if(b instanceof Object){if(b.Ob)return new ee(b.type,
b.Ob,b.newValue);if(b.Dc)return new be(b.Ya,b.sc,b.aj,b.Dc)}return b});if(0===this.xe)for(var b=this.Gb,c=b+1,f=0;f<a.length;f++){var g=a[f];g.sc=b.toString();g.Ya=c.toString();b=c;c+=1}return a};a.prototype.encode=function(a){return JSON.stringify(a)};a.prototype.ul=function(a,c,e,f){this.log("transform %s/,%s",e,f);if(this.Am(e,f))return e=a.newValue,e="a"===c.type?e+c.Ob:e*c.Ob,new ee(c.type,c.Ob,e);e=c.newValue;e="a"===a.type?e+a.Ob:e*a.Ob;this.log("   Modified op2 with value "+e);return new ee("a",
e-a.newValue,e)};a.prototype.add=function(a){var b=this.Ai();this.xj(new be(b,this.Dg(),Math.round((new Date).getTime()/1E3),[new ee("a",a,this.value+a)]))};a.prototype.multiply=function(a){var b=this.Ai();this.xj(new be(b,this.Dg(),Math.round((new Date).getTime()/1E3),[new ee("m",a,this.value*a)]))};return a})(de);var fe=function(){function c(a,b){this.Pb=a;this.index=b}c.prototype.encode=function(){return this.Pb+";"+this.index};return c}(),he=function(){function c(a,b,c,e){this.ab=a;this.aa=e;this.type="c";this.Ia=new fe(b,c)}c.prototype.encode=function(){var a=JSON.stringify(this.aa);return"C"+this.ab+";"+this.Ia.encode()+";"+a.length+";"+a+";"};c.prototype.clone=function(){return new c(this.ab,this.Ia.Pb,this.Ia.index,this.aa)};c.prototype.inverse=function(){return new ge(this.ab,this.Ia.Pb,this.Ia.index)};
c.ne=function(a,b){var d=/C([^;]+);([^;]+);(\d+);(\d+);/g;d.lastIndex=b;var e=d.exec(a);if(e&&e.index===b){var f=parseInt(e[4],10),g=JSON.parse(a.substr(d.lastIndex,f));return{we:new c(e[1],e[2],parseInt(e[3],10),g),position:d.lastIndex+f+1}}return null};return c}(),ge=function(){function c(a,b,c){this.ab=a;this.Pb=b;this.index=c;this.aa=null;this.type="d";this.Ia=new fe(b,c)}c.prototype.clone=function(){return new c(this.ab,this.Ia.Pb,this.Ia.index)};c.prototype.inverse=function(){if(null===this.aa)throw Error("DeleteOp should have been executed before inverse");
return new he(this.ab,this.Ia.Pb,this.Ia.index,this.aa)};c.prototype.encode=function(){return"D"+this.ab+";"+this.Ia.encode()+";"};c.ne=function(a,b){var d=/D([^;]+);([^;]+);(\d+);/g;d.lastIndex=b;var e=d.exec(a);return e&&e.index===b?{we:new c(e[1],e[2],parseInt(e[3],10)),position:d.lastIndex}:null};return c}(),ie=function(){function c(a,b,c){this.ab=a;this.aa=b;this.Mf=c;this.type="s"}c.prototype.clone=function(){return new c(this.ab,this.aa,this.Mf)};c.prototype.inverse=function(){if(null===this.Mf)throw Error("SetPropertiesOp was not executed before inversion");
return new c(this.ab,this.Mf,this.aa)};c.prototype.encode=function(){var a=JSON.stringify(this.aa);return"S"+this.ab+";"+a.length+";"+a+";"};c.ne=function(a,b){var d=/S([^;]+);(\d+);/g;d.lastIndex=b;var e=d.exec(a);if(e&&e.index===b){var f=parseInt(e[2],10),g=JSON.parse(a.substr(d.lastIndex,f));return{we:new c(e[1],g,null),position:d.lastIndex+f+1}}return null};return c}(),je=function(){function c(a,b,c,e,f){this.ab=a;this.type="m";this.src=new fe(b,c);this.Ia=new fe(e,f)}c.prototype.clone=function(){return new c(this.ab,
this.src.Pb,this.src.index,this.Ia.Pb,this.Ia.index)};c.prototype.inverse=function(){return new c(this.ab,this.Ia.Pb,this.Ia.index,this.src.Pb,this.src.index)};c.prototype.encode=function(){return"M"+this.ab+";"+this.src.encode()+";"+this.Ia.encode()+";"};c.ne=function(a,b){var d=/M([^;]+);([^;]+);(\d+);([^;]+);(\d+);/g;d.lastIndex=b;var e=d.exec(a);return e&&e.index===b?{we:new c(e[1],e[2],parseInt(e[3],10),e[4],parseInt(e[5],10)),position:d.lastIndex}:null};return c}(),ke=function(c){function a(a,
d,e){void 0===e&&(e=!1);e=c.call(this,e,1)||this;e.Ld=a;e.mf=[];e.Vs(d);return e}n(a,c);a.prototype.Vs=function(a){this.vh=a};a.prototype.Vr=function(a){return"N-"+this.vh+"-"+a};a.prototype.createNode=function(a,c,e,f){this.Db||(c=new he(a,c,e,f),this.mf.push(c));return a};a.prototype.zc=function(a,c,e){this.Db||(c=new ge(a,c,e),c.aa=this.Ld.ec(a),this.mf.push(c))};a.prototype.Oe=function(a,c,e,f,g){this.Db||(a=new je(a,f,g,c,e),this.mf.push(a))};a.prototype.Jb=function(a,c,e){this.Db||(a=new ie(a,
c,e),this.mf.push(a))};a.prototype.ec=function(a){return this.Ld.ec(a)};a.prototype.pa=function(){if(!this.Db&&this.mf.length){for(var a=new be(this.Ai(),this.Dg(),this.now()),c=0,e=this.mf;c<e.length;c++)a.Dc.push(e[c]);this.xj(a)}else this.Db&&this.Ld.pa();this.mf.length=0};a.prototype.wb=function(a){this.log("Execute "+a.type);switch(a.type){case "c":this.Ld.createNode(a.ab,a.Ia.Pb,a.Ia.index,a.aa);break;case "d":-1===a.Ia.index?this.log("op was nullified."):(a.aa=this.Ld.ec(a.ab),this.Ld.zc(a.ab,
a.Ia.Pb,a.Ia.index));break;case "s":a.Mf={};var b=this.Ld.ec(a.ab),c;for(c in a.aa)a.Mf[c]=b[c];this.Ld.Jb(a.ab,a.aa,a.Mf);break;case "m":-1!==a.src.index&&this.Ld.Oe(a.ab,a.Ia.Pb,a.Ia.index,a.src.Pb,a.src.index)}};a.prototype.decode=function(a){for(var b=[],c=0,f=/B([^;]+);([^;]+);([^;]+);\d+;/g;c<a.length;){var g;switch(a[c]){case "B":f.lastIndex=c;if((g=f.exec(a))&&g.index===c){c=parseInt(g[1],36);var h=g[2];g=g[3];if(isNaN(c))return this.log("Error: TS is not a number."),null;g=new be(g,h,c);
b.push(g);c=f.lastIndex}else return null;continue;case "C":g=he.ne(a,c);break;case "D":g=ge.ne(a,c);break;case "S":g=ie.ne(a,c);break;case "M":g=je.ne(a,c);break;default:return null}if(0===b.length)return this.log("Got change outside of batch"),null;c=g.position;b[b.length-1].Dc.push(g.we)}return b};a.prototype.encode=function(a){for(var b="",c=0;c<a.length;c++){var f=a[c];b+="B"+f.aj.toString(36)+";"+f.sc+";"+f.Ya+";"+f.Dc.length+";";var g=0;for(f=f.Dc;g<f.length;g++)b+=f[g].encode()}return b};a.prototype.ul=
function(a,c,e,f){function b(b,c,e){b="c"===a.type?1:-1;switch(e.type){case "c":e=e.clone();d(c,e.Ia,b,"c");k.log("Result is "+f+":"+e.type+"."+e.Ia.index);break;case "d":e=e.clone();d(c,e.Ia,b,"d");k.log("Result is "+f+":"+e.type+"."+e.Ia.index);break;case "m":e=e.clone(),d(c,e.src,b,"d"),d(c,e.Ia,b,"c")}return e}function d(b,d,g,h){b.Pb===d.Pb&&0<=d.index&&(b.index<d.index||b.index==d.index&&0<g?(d.index+=g,k.log("Shift "+f+":"+c.type+" by "+g)):b.index===d.index&&0>g&&"d"===h?(d.index=-1,k.log("NULLIFY")):
k.log("No conflict; "+e+":"+a.type+" "+b.index+" "+f+":"+c.type+" "+d.index))}var k=this;this.log("xform "+e+":"+a.type+"/"+f+":"+c.type);if(this.Am(f,e))return this.log("Not doing anything; "+f+"<"+e),c;"c"===a.type?c=b(a.type,a.Ia,c):"d"===a.type?c=b(a.type,a.Ia,c):"m"===a.type&&(c=b("d",a.src,c),c=b("c",a.Ia,c));return c};return a}(de);
(function(){function c(){this.ra={};this.log=w.create("DebugTree");this.root={ab:"0",parent:null,children:[],aa:{name:"root"}};this.ra["0"]=this.root}c.prototype.createNode=function(a,b,c,e){this.log("create node "+a+" child of "+b);b=this.ra[b];e={ab:a,parent:b,children:[],aa:e};b.children.splice(c,0,e);this.ra[a]=e};c.prototype.zc=function(a){this.log("delete node "+a);if(a in this.ra){var b=this.ra[a].parent;if(b)for(var c=0;c<b.children.length;c++)if(b.children[c].ab===a){b.children.splice(c,
1);break}delete this.ra[a]}};c.prototype.Oe=function(a,b,c){this.log("move "+a+" to "+b+":"+c);if(a in this.ra){var d=this.ra[a];this.zc(a);this.createNode(a,b,c,d.aa)}};c.prototype.Jb=function(a,b){if(a in this.ra)for(var c in b)b.hasOwnProperty(c)&&(this.ra[a].aa[c]=b[c])};c.prototype.ec=function(a){return a in this.ra?this.ra[a].aa:{}};c.prototype.pa=function(){};c.prototype.toString=function(){return this.encode(this.root)};c.prototype.encode=function(a){for(var b="("+a.aa.name,c=0;c<a.children.length;c++)b+=
" "+this.encode(a.children[c]);return b+")"};return c})();var le="IDLE CONNECTING CONNECTED WAIT_FOR_ACK ERROR_WAIT STOPPING".split(" "),pe=function(){function c(a,b,c){this.view=a;this.sb=null;this.log=w.create("DocumentSharer");var d=new me;a=new ne(a,d);this.Ti=new ke(a,b);b=new oe(this.Ti,d);this.view.ea.yo(b,c)}c.prototype.wf=function(a){this.Ti.wf(a)};c.prototype.Er=function(){return null!==this.sb};c.prototype.Ag=function(){this.sb||(this.sb=this.Ti.Ag(),this.sb.empty()&&(this.sb=null));return this.sb?this.sb.getData():""};c.prototype.If=function(a){this.log("Marking outstanding changes sent");
if(!this.sb||this.sb.getData()!==a)throw Error("markChangesSent(): does not match outstanding changes.");this.Ti.If(this.sb.Dg());this.sb=null};c.prototype.end=function(){this.view.ea.yo(new Xc)};return c}(),qe=function(){function c(a,b){var c=this;this.name=a;this.ia=b;this.log=w.create("Sharing");this.state=0;this.paused=!1;this.k=0;this.timeout=null;this.ds=1;this.sb="";this.kg=!1;this.listener=function(a){c.log("Got some more changes to send: %s",a.substr(0,30));c.sb=a;c.kg=!1;c.so()};b.Ka("local-changes",
this.listener);this.connect()}c.prototype.jf=function(a){this.log(le[this.state]+" -> "+le[a]);this.state=a};c.prototype.connect=function(){var a=this;this.log("connect(): "+le[this.state]);0!==this.state?this.log("Bad state"):(this.jf(1),this.dh=new O.WebSocket("wss://zwibbler.com/socket/"+this.name),this.dh.onopen=function(){return a.ls()},this.dh.onclose=function(){return a.hs()},this.dh.onmessage=function(b){return a.ms(b)})};c.prototype.ls=function(){this.log("onConnected(): "+le[this.state]);
1!==this.state?this.log("Bad state"):(this.jf(2),this.so())};c.prototype.hs=function(){this.log("onClose(): "+le[this.state]);this.kg=!1;4!==this.state&&(1===this.state?(this.jf(4),this.Is()):(this.jf(0),this.paused||(this.k=0,this.connect())))};c.prototype.Is=function(){var a=this;4===this.state&&(this.timeout&&(clearTimeout(this.timeout),this.timeout=null),this.timeout=setTimeout(function(){4===a.state&&(a.log("onTimeout(): "+le[a.state]),a.timeout=null,a.jf(0),a.connect())},1E3*Math.pow(2,this.k)),
5>this.k&&(this.k+=1))};c.prototype.so=function(){var a=this,b=this.ia.Ie("latency");setTimeout(function(){if(2===a.state){if(a.paused)a.log("Currently paused; ignoring changes.");else if(""!==a.sb&&a.kg){a.log("Have outstanding changes... not sending more.");return}""!==a.sb&&(a.log("Sending outstanding changes"),a.kg=!0,a.dh.send(JSON.stringify({type:"Data",MID:""+a.ds++,oldCID:"0",newCID:"0",data:a.sb})))}},b)};c.prototype.ms=function(a){var b=JSON.parse(a.data);"Data"===b.type?(this.log("Got message from socket: %s",
a.data.substr(0,64)),this.ia.wf(b.data)):"Ack"===b.type&&""!==this.sb&&(this.log("Marking changes sent to: %s",this.sb.substr(0,30)),this.ia.If(this.sb),this.sb="",this.kg=!1)};c.prototype.pause=function(a){this.log("SharedSession.pause(): "+le[this.state]);(this.paused=a)?stop():0===this.state&&(this.jf(1),this.connect())};c.prototype.stop=function(){this.log("SharedSession.stop(): "+le[this.state]);this.paused=!0;4>this.state?this.dh.close():this.jf(0);this.ia.removeEventListener("local-changes",
this.listener)};return c}(),me=function(){function c(){this.local={};this.remote={};this.add("0",0)}c.prototype.add=function(a,b){this.local[a]=b;this.remote[b]=a};c.prototype.remove=function(a,b){delete this.local[a];delete this.remote[b]};c.prototype.$f=function(a){return this.local[a]};c.prototype.lf=function(a){a in this.remote||console.log("LocalId "+a+" has no remote");return this.remote[a]};return c}();function re(c){var a={},b;for(b in c)a[b]="matrix"===b?c[b].Sb():c[b];return a}
function se(c){var a={},b;for(b in c)a[b]="matrix"===b&&c[b]instanceof Array?new F(c[b]):c[b];return a}
var ne=function(){function c(a,b){this.view=a;this.map=b;this.Sd={};this.actions=[];this.log=w.create("Remote")}c.prototype.createNode=function(a,b,c,e){if(!e.type)throw console.log(e),Error("Tried to create node with bad type");var d=se(e),g=d.type;delete d.type;var h=this.view.ea.$a();this.log("Create node "+g+" "+a+"/"+h+" at "+b+":"+c);this.map.add(a,h);b=new S(h,g,d,this.map.$f(b),c);this.actions.push(b);this.Sd[a]=e};c.prototype.zc=function(a,b,c){var d=this.map.$f(a);this.log("Delete node "+
a+"/"+d+" from "+b+":"+c);b=new Cc([d]);this.actions.push(b);this.map.remove(a,d)};c.prototype.Oe=function(a,b,c){this.log("Move node "+a+" to "+b+":"+c);this.actions.push(new Lc(this.map.$f(a),this.map.$f(b),c))};c.prototype.Jb=function(a,b){b=se(b);var c=this.map.$f(a);this.log("Set properties for node "+a+"/"+c+" to "+JSON.stringify(b));for(var e in b)this.actions.push(new Dc([c],e,b[e]));if(a in this.Sd)for(var f in b)this.Sd[a][f]=b[f]};c.prototype.ec=function(a){var b={};if(a in this.Sd)b=this.Sd[a];
else if(a=this.view.ea.va(this.map.$f(a)))b=re(a.ec()),b.type=a.type();return b};c.prototype.pa=function(){this.Sd={};this.view.pa(this.actions,!0);this.view.zf();this.view.ha();this.actions=[]};return c}(),oe=function(){function c(a,b){this.Pc=a;this.map=b;this.log=w.create("LOCAL")}c.prototype.createNode=function(a,b,c,e){if(!this.Pc.Db){this.log("Create node "+e.type+" "+a+" at "+b+":"+c);if(!e.type)throw Error("Error: Local tried to create node with bad type.");e=re(e);var d=this.Pc.Vr(a);this.map.add(d,
a);a=this.map.lf(b);this.Pc.createNode(d,a,c,e)}};c.prototype.zc=function(a,b,c){this.Pc.Db||(this.log("Delete node "+a+" from "+b+":"+c),b=this.map.lf(b),a=this.map.lf(a),this.Pc.zc(a,b,c))};c.prototype.Oe=function(a,b,c,e,f){this.Pc.Db||(this.log("Move node "+a+" from "+e+":"+f+" to "+b+":"+c),this.Pc.Oe(this.map.lf(a),this.map.lf(b),c,this.map.lf(e),f))};c.prototype.Jb=function(a,b,c){this.Pc.Db||(this.log("Set properties for node "+a+" to "+JSON.stringify(b)),b=re(b),c=re(c),this.Pc.Jb(this.map.lf(a),
b,c))};c.prototype.pa=function(){this.Pc.Db||this.Pc.pa()};return c}();var te={style:".zwibbler-builtin-toolbar {\n    background: white;\n    width: 130px;\n    overflow-y: auto;\n    -webkit-touch-callout: none;\n    -webkit-user-select: none; \n     -khtml-user-select: none; \n       -moz-user-select: none; \n        -ms-user-select: none; \n            user-select: none; \n}\n\n.zwibbler-builtin-toolbar button {\n    font-family: inherit;\n    font-size: 100%;\n    padding: 5px;\n    background-color: white;\n    border: none;\n}\n\n.zwibbler-builtin-toolbar button img {\n    margin: 0;\n}\n\n.zwibbler-builtin-toolbar button:hover,\n.zwibbler-builtin-toolbar button.selected {\n    background-color: #9fb3e7;\n}\n",
ri:'<div class="zwibbler-builtin-toolbar">\n<button \n    z-if="getConfig(\'showPickTool\')"\n    z-click="usePickTool()"\n    z-selected="getCurrentTool()===\'pick\'"\n    title="Pick">\n    <img z-bind:src="getImageUrl(\'wd-pick.png\')">\n</button>\n<button \n    z-if="getConfig(\'showSquareTool\')"\n    z-click="useRectangleTool()"\n    z-selected="getCurrentTool()===\'rectangle\'"\n    title="Rectangle">\n    <img z-bind:src="getImageUrl(\'wd-box.png\')">\n</button>\n<button \n    z-if="getConfig(\'showRoundRectTool\')"\n    z-click="useRoundRectTool()"\n    title="Rounded Rectangle">\n    <img z-bind:src="getImageUrl(\'wd-roundrect.png\')">\n</button>\n<button \n    z-if="getConfig(\'showCircleTool\')"\n    z-click="useCircleTool()"\n    z-selected="getCurrentTool()===\'circle\'"\n    title="Circle">\n    <img z-bind:src="getImageUrl(\'wd-circle.png\')">\n</button>\n<button \n    z-if="getConfig(\'showShapeBrushTool\')"\n    z-click="useShapeBrushTool()"\n    title="Shape brush">\n    <img z-bind:src="getImageUrl(\'wd-shapebrush.png\')">\n</button>\n<button \n    z-if="getConfig(\'showBrushTool\')"\n    z-click="useBrushTool()"\n    z-selected="getCurrentTool()===\'brush\'"\n    title="Brush">\n    <img z-bind:src="getImageUrl(\'wd-brush.png\')">\n</button>\n<button \n    z-if="getConfig(\'showLineTool\')"\n    z-click="useLineTool()"\n    z-selected="getCurrentTool()===\'line\'"\n    title="Lines">\n    <img z-bind:src="getImageUrl(\'wd-line.png\')">\n</button>\n<button \n    z-if="getConfig(\'showCurveTool\')"\n    z-click="useCurveTool()"\n    z-selected="getCurrentTool()===\'curve\'"\n    title="Curves">\n    <img z-bind:src="getImageUrl(\'wd-curve.png\')">\n</button>\n<button \n    z-if="getConfig(\'showArrowTool\')"\n    z-click="useArrowTool()"\n    z-selected="getCurrentTool()===\'arrow\'"\n    title="Arrows">\n    <img z-bind:src="getImageUrl(\'wd-arrow.png\')">\n</button>\n<button \n    z-if="getConfig(\'showTextTool\')"\n    z-selected="getCurrentTool()===\'text\'"\n    z-click="useTextTool()"\n    title="Text">\n    <img z-bind:src="getImageUrl(\'wd-text.png\')">\n</button>\n<button \n    z-if="getConfig(\'showImageTool\')"\n    z-click="insertImage()"\n    title="Insert image...">\n    <img z-bind:src="getImageUrl(\'wd-image.png\')">\n</button>\n<button \n    z-if="getConfig(\'showMoveToFrontBack\')"\n    z-click="bringToFront()"\n    title="Bring to front">\n    <img z-bind:src="getImageUrl(\'wd-moveup.png\')">\n</button>\n<button \n    z-if="getConfig(\'showMoveToFrontBack\')"\n    z-click="sendToBack()"\n    title="Send to back">\n    <img z-bind:src="getImageUrl(\'wd-movedown.png\')">\n</button>\n<button \n    z-if="getConfig(\'showUndoRedo\')"\n    z-disabled="!canUndo()"\n    z-click="undo()"\n    title="Undo">\n    <img z-bind:src="getImageUrl(\'wd-undo.png\')">\n</button>\n<button \n    z-if="getConfig(\'showUndoRedo\')"\n    z-disabled="!canRedo()"\n    z-click="redo()"\n    title="Redo">\n    <img z-bind:src="getImageUrl(\'wd-redo.png\')">\n</button>\n<button \n    z-if="getConfig(\'showCopyPaste\')"\n    z-click="copy()"\n    title="Copy">\n    <img z-bind:src="getImageUrl(\'wd-copy.png\')">\n</button>\n<button \n    z-if="getConfig(\'showCopyPaste\')"\n    z-click="paste()"\n    title="Paste">\n    <img z-bind:src="getImageUrl(\'wd-paste.png\')">\n</button>\n</div>\n'};var ue={style:".zwibbler-page-selector {\n    overflow-y: scroll;\n    background: #888;\n    width: 160px;\n    text-align: center;\n}\n\n.zwibbler-page-selector [z-page] {\n    border: 3px solid transparent;\n    margin: 5px;\n    display: inline-block;\n    box-shadow: 2px 2px 2px rgba(0,0,0,0.2);\n}\n\n.zwibbler-page-selector [z-page].selected {\n    border: 3px solid #9fb3e7;\n}\n",ri:'<div class="zwibbler-page-selector">\n    <button z-if="getConfig(\'showPageSelectorControls\')"\n        z-click="setCurrentPage(insertPage(getCurrentPage()+1))">\n        Add Page\n    </button>\n    <button z-if="getConfig(\'showPageSelectorControls\')"\n        z-click="deletePage(getCurrentPage())">\n        Delete Page\n    </button>\n    <br>\n    <div z-sort="movePage($from,$to)">\n        <div z-for="page in getPageCount()"\n            draggable="TRUE"\n            z-sortable\n            z-page="page"\n            z-width="130"\n            z-height="130"\n            z-click="setCurrentPage(page)"\n            z-selected="page==getCurrentPage()">\n        </div>\n    </div>\n</div>\n'};var ve={style:".zwibbler-property-panel {\n    width: 200px;\n    background: #f5f5f5;\n    display:flex;\n    flex-flow: column nowrap;\n    overflow-y: scroll;\n    padding: 10px;\n    font-family: sans-serif;\n    -webkit-touch-callout: none;\n    -webkit-user-select: none; \n     -khtml-user-select: none; \n       -moz-user-select: none; \n        -ms-user-select: none; \n            user-select: none;     \n}\n\n.zwibbler-property-panel h3 {\n    margin-bottom: 0.5em;\n}\n\n.zwibbler-property-panel button {\n    font-family: inherit;\n    font-size: 100%;\n    padding: 5px;\n    display: block;\n    background-color: white;\n    color: black;\n    border: none;\n    border-radius: 2px;\n    border-bottom: 2px solid #ddd;\n    width: 100%;\n}\n\n.zwibbler-property-panel button[tool] {\n    display: inline-block;\n    width: 60px;\n    height: 60px;\n    font-size: 30px;\n}\n\n.zwibbler-property-panel button.zwibbler-option {\n    border: 0;\n    padding: 10px;\n    border-radius: 3px;\n    background: transparent;\n    text-align: left;\n}\n\n.zwibbler-property-panel button.selected {\n    background: #9fb3e7;\n}\n\n.zwibbler-property-panel button.hover {\n    background: #ddd;\n}\n\n.zwibbler-property-panel hr {\n    border: none;\n    border-top: 1px solid #ccc;\n}\n\n.zwibbler-property-panel select {\n    width: 100%;\n}\n\n.zwibbler-property-panel .colour-picker {\n    padding: 10px 0;\n}\n\n.zwibbler-property-panel [swatch] {\n    border: 1px solid black;\n    display: inline-block;\n    height: 2em;\n    width: 4em;\n    vertical-align:middle;\n    margin-right: 10px;\n}\n",
ri:'<div class="zwibbler-property-panel">\n<h3>Shape options</h3>\n<div z-if="!(\'AnyNode\' in summary.types)">\n    There are no selected shapes.\n</div>\n<div z-has="AnyNode">\n    <button z-click="deleteNodes()">Delete</button>                    \n    <button z-click="bringToFront()">\n        Move to front\n    </button>\n    <button z-click="sendToBack()">\n        Send to back\n    </button>\n</div>\n<div z-has="fontName">\n    <h3>Font</h3>\n    <select z-property="fontName">\n        <option z-for="font in getConfig(\'fonts\')" z-text="font" z-bind:value="font"></option>\n    </select>\n</div>\n<div z-has="fontSize">\n    <h3>Font size</h3>\n    <select z-property="fontSize">\n        <option value="8">8</option>\n        <option value="10">10</option>\n        <option value="12">12</option>\n        <option value="16">16</option>\n        <option value="20">20</option>\n        <option value="24">24</option>\n        <option value="50">50</option>\n    </select>\n</div>\n<div z-has="fillStyle">\n    <h3>Colours</h3>\n    <div class="colour-picker" z-has="fillStyle">\n        <div swatch z-property="fillStyle" z-colour></div>\n        Fill style\n    </div>\n    <div class="colour-picker" z-has="strokeStyle">\n        <div swatch z-property="strokeStyle" z-colour></div>\n        Outline\n    </div>\n    <div class="colour-picker" z-has="background">\n        <div swatch z-property="background" z-colour></div>\n        Background\n    </div>\n</div>\n<div z-has="arrowSize">\n    <h3>Arrows</h3>\n    <button class="zwibbler-option" z-property="arrowSize" z-value="0">None</button>\n    <button class="zwibbler-option" z-property="arrowSize" z-value="10">Small</button>\n    <button class="zwibbler-option" z-property="arrowSize" z-value="15">Large</button>\n    <hr>\n    <button class="zwibbler-option" z-property="arrowStyle" z-value="solid">Solid</button>\n    <button class="zwibbler-option" z-property="arrowStyle" z-value="open">Open</button>\n</div>\n<div z-has="lineWidth">\n        <h3>Line width</h3> \n        <select z-property="lineWidth">\n            <option value="0">None</option>\n            <option value="1">1</option>\n            <option value="2">2</option>\n            <option value="4">4</option>\n            <option value="8">8</option>\n        </select>\n    </div>\n<div z-has="dashes">\n    <h3>Line style</h3>\n    <button class="zwibbler-option" z-property="dashes" z-value="">Solid</button>\n    <button class="zwibbler-option" z-property="dashes" z-value="3,3">Dots</button>\n    <button class="zwibbler-option" z-property="dashes" z-value="8,2">Dashes</button>\n</div>\n<div z-has="opacity">\n    <h3>Opacity</h3>\n    <input z-property="opacity" type="range" min="0.1" max="1.0" step="0.05">\n</div>              \n'};var we=function(c){function a(a){var b=c.call(this)||this;b.ia=a;b.path=new R;b.node=0;return b}n(a,c);a.prototype.beginPath=function(){this.path=new R;this.node=0};a.prototype.closePath=function(){this.path.close()};a.prototype.moveTo=function(a,c){this.path.moveTo(a,c)};a.prototype.lineTo=function(a,c){this.path.lineTo(a,c)};a.prototype.quadraticCurveTo=function(a,c,e,f){this.path.quadraticCurveTo(a,c,e,f)};a.prototype.bezierCurveTo=function(a,c,e,f,g,h){this.path.bezierCurveTo(a,c,e,f,g,h)};a.prototype.fill=
function(){this.bm(!0)};a.prototype.stroke=function(){this.bm(!1)};a.prototype.bm=function(a){this.node||(this.node=this.ia.createNode("PathNode",{ba:this.path.Sb(),oa:this.oa.clone(),lineWidth:this.lineWidth}));a?this.ia.vc(this.node,"fillStyle",this.fillStyle):this.ia.vc(this.node,"strokeStyle",this.strokeStyle)};a.prototype.fillText=function(a,c,e){this.cm(a,c,e,!0)};a.prototype.strokeText=function(a,c,e){this.cm(a,c,e,!1)};a.prototype.cm=function(a,c,e,f){c=this.oa.multiply(new E(c,e));e=this.re(this.font);
a={text:a,matrix:c,fontName:e.fontFamily,fontSize:e.fontSize,italic:"italic"===e.fontStyle,bold:"bold"===e.fontWeight};f?a.fillStyle=this.fillStyle:a.strokeStyle=this.strokeStyle;this.ia.createNode("TextNode",a)};a.prototype.oj=function(){throw Error("drawImage: not implented");};a.prototype.measureText=function(a){var b=document.createElement("canvas").getContext("2d");b.font=this.font;return b.measureText(a)};a.prototype.clip=function(){throw Error("clip: not implemented.");};a.prototype.qj=function(){return{}};
a.prototype.tj=function(){};return a}(ad);function ye(c){return c instanceof Array?c:[c]}function ze(c,a,b,d){c.fillStyle="#ffffff";c.fillRect(a,b,d,d);c.beginPath();c.strokeStyle="#000000";c.moveTo(a,b);c.lineTo(a+d,b+d);c.moveTo(a+d,b);c.lineTo(a,b+d);c.stroke()}
function Ae(c,a,b,d){for(var e,f=0;f<d;f+=5){e=0===f/5%2;for(var g=0;g<d;g+=5)c.fillStyle=e?"#000000":"#ffffff",e=!e,c.fillRect(a+g,b+f,5,5)}e=c.createLinearGradient(a+d,b+d,a,b);e.addColorStop(0,"rgba(255, 255, 255, 1.0)");e.addColorStop(1,"rgba(255, 255, 255, 0.0)");c.fillStyle=e;c.fillRect(a,b,d,d)}
var W=function(){function c(a,b){var c=this;this.Sa={};this.yb=0;this.actions=[];this.Qh=new T;this.Pj=new T;this.Fi=0;this.Lj=-1;this.xk=null;this.uf={};this.Yf=this.nc=this.Xc=null;this.sg=!1;this.log=w.create("CONTEXT");this.rm=!1;this.Rk=0;this.Pf=null;this.Em="";this.da=new Zd(this,a,b);this.Yn();var e=this;O.qk.push(this);this.da.Ja.add(function(){c.log("Running ZwibblerContext destructor");c.gh();delete a.zwibbler;delete e.Sa;delete e.actions;delete e.da;delete e.Xc;for(var b=O.qk,d=0;d<b.length;d++)if(b[d]===
e){b.splice(d,1);break}c.Yf&&c.Yf.stop()});this.Ka("document-changed",function(){c.summary=c.ii();if(c.nc)if(c.nc.Er())c.log("Have outstanding changes; not sending more");else{var a=c.nc.Ag();""!==a&&c.ua("local-changes",a)}});this.np();this.Ka("selected-nodes",function(){c.summary=c.ii()});this.summary=this.ii();this.wh(te,"left","showToolbar");this.wh(ue,"right","showPageSelector");this.wh(ve,"right","showPropertyPanel");this.wh(Be,"bottom","showColourPanel")}c.prototype.wf=function(a){this.nc&&
this.nc.wf(a)};c.prototype.lc=function(a,b){var d=this;V.lc(a,b);V.digest();this.da.Ja.add(function(){d.log("DESTROYING A PANEL");V.detach(b)});!this.rm&&a instanceof c&&(this.rm=!0,this.Ka("tool-changed",function(){return V.digest()}),this.da.fa.Ka("update",function(){return V.digest()}),this.Ka("document-changed",function(){return V.digest()}),this.Ka("selected-nodes",function(){return V.digest()}));this.resize()};c.prototype.rp=function(){1<this.yb&&this.Ba("abortTransaction is not implemented for nested calls. Please contact support.");
this.yb=0;this.actions=[]};c.prototype.yc=function(a,b,c,e,f,g){switch(g){case "scale":case "rotate":case "translate":var d=g;break;default:if("function"===typeof g){d="click";var k=g}else{this.Ba('addSelectionHandle: action must be "scale", "rotate", "translate", or a function');return}}this.da.view.yc(a,b,c,e,f,d,k)};c.prototype.yj=function(a){this.da.language.yj(a)};c.prototype.wp=function(){if(!this.ta())return this.ui(this.Jc())};c.prototype.ig=function(a,b,c){this.da.ig(a,b,c)};c.prototype.Cj=
function(){this.yb+=1;1===this.yb?(this.actions=[],this.Pj.clear(),this.Qh.clear(),this.Fi=0,this.Lj=this.da.view.ea.Ra,this.log("beginTransaction() -- beginning new")):this.log("beginTransaction() -- already in one, bump counter")};c.prototype.Gh=function(){this.ta()||this.da.view.Gh()};c.prototype.nd=function(){return this.ta()?!1:this.da.view.ea.nd()};c.prototype.od=function(){return this.ta()?!1:this.da.view.ea.od()};c.prototype.pb=function(){this.da.view.pb();this.da.view.Mb();this.da.view.ha()};
c.prototype.Rp=function(){this.da.Bm()};c.prototype.Sp=function(a,b){if(this.ta())return!1;this.Yg(a,!b)};c.prototype.Up=function(){this.yb=Math.max(0,this.yb-1);0===this.yb?(this.da.view.pa(this.actions,!0),this.actions=[],this.log("committing irreversible transaction.")):this.log("delaying transaction commit -- nested call (count=%s)",this.yb)};c.prototype.Jh=function(){this.yb=Math.max(0,this.yb-1);0===this.yb?(this.da.view.pa(this.actions),this.actions=[],this.log("committing transaction.")):
this.log("delaying transaction commit -- nested call (count=%s)",this.yb)};c.prototype.Ae=function(a,b){void 0===a&&(a=!1);"boolean"!==typeof a&&this.Ba("First parameter of copy() must be true/false");return this.da.view.Ae(a,b)};c.prototype.bq=function(){function a(a){for(var c=30;100>c;c+=20)a.values[2]=c/100,b.push(a.toString())}var b="rgba(0,0,0,0.0) rgba(0,0,0,0.5) #000000 #ffffff #000088 #008800 #008888 #880000 #880088 #884400 #888888 #444444 #0000ff #00ff00 #00ffff #ff0000 #ff00ff #ffff00".split(" ");
a(new u(u.oe,[0,0,0,1]));for(var c=0;720>c;c+=35){var e=new u(u.oe,[c,.5,0,1]);a(e)}return b};c.prototype.og=function(a){if(this.ta())return!1;if(0<a.length)return this.Kb(this.da.og(this.actions,a))};c.prototype.Hb=function(a){void 0===a&&(a={});var b={};if(a instanceof Array)return a.concat();if(!(a instanceof Object))return a;for(var c in a)if(a.hasOwnProperty(c)){var e=a[c];"matrix"===c&&("[object Array]"===Object.prototype.toString.apply(e)&&"Matrix"===e[0]?(e.splice(0,1),e=new F(e)):e instanceof
F||(e=new F(e)));b[c]=e}return b};c.prototype.createNode=function(a,b){this.log("createNode(%s)",a);var c=this.Hb(b);return this.Kb(this.da.createNode(this.actions,a,c))};c.prototype.Oh=function(a){return this.Kb(this.da.Oh(this.actions,a))};c.prototype.wh=function(a,b,c){var d=this,f;this.da.fa.Ka(c,function(c){c?(f||(a.style&&O.Bd(a.style),c=document.createElement("div"),c.innerHTML=a.ri,f=c.firstChild,d.lc(d,f),a.controller&&a.controller(d)),d.da.ig(1,b,f)):f&&d.da.Ug(f)})};c.prototype.gq=function(a,
b){var c=pb(a);if(c){Xb(b)||this.Ba("createToolbar: second parameter must be array");O.Bd("a.zwibbler-button {\n            background-repeat: no-repeat;\n            background-position: center;\n            display: inline-block;\n            overflow: hidden;\n        }");for(var e=this,f=function(a,b){b.addEventListener("click",function(b){a.onclick.call(this,e,b)})},g=0;g<b.length;g++){var h=b[g],k=z("a").se("zwibbler-button").Ga;k.setAttribute("href","javascript:void(0)");h.toolName&&z(k).se(h.toolName);
h.onclick&&f(h,k);h.title&&k.setAttribute("title",h.title);h.background?k.style.background=h.background:h.image&&(k.style.backgroundImage="url("+h.image+")");h.html&&(k.innerHTML=h.html);c.appendChild(k)}var l;this.Ka("tool-changed",function(a){l&&l.classList.remove("zwibbler-selected");(l=c.querySelector("."+a))&&l.classList.add("zwibbler-selected")})}else this.Ba("createToolbar: Could not convert first parameter to an HTML element")};c.prototype.Jj=function(a){if(a=this.da.Jj(this.actions,a))return this.Kb(a);
this.Ba("createShape needs an array of at least 6 numbers");return null};c.prototype.Nj=function(){if(this.ta())return!1;var a=this.da.view.Ae(!1);this.Im();return a};c.prototype.rg=function(){this.da.rg();for(var a in this)this.hasOwnProperty(a)&&delete this[a];this.sg=!0};c.prototype.Kb=function(a){this.yb?"number"===typeof a&&this.Qh.add(a):(this.log("Not in a transaction. committing immediately. id=%s",a),this.Jh());return"number"===typeof a?a:0};c.prototype.zc=function(a){this.Hm(a)};c.prototype.hp=
function(a){for(var b=0;b<a.length;b++){var c=a[b],e=this.da.view.ea.va(c,!1);e&&!this.Pj.contains(c)||!e&&this.Qh.contains(c)||(a.splice(b,1),--b)}return 0<a.length};c.prototype.Hm=function(a){void 0===a&&(a=this.Ac());if(this.ta())return!1;this.log("deleteNodes()");a=ye(a);this.hp(a)&&(this.Kb(this.da.zc(this.actions,a)),this.Pj.add(a))};c.prototype.iq=function(){if(this.ta())return!1;1<this.yb&&this.Ba("deletePage is not implemented inside transactions. Please contact support.");1===this.Jc()?
this.log("Cannot remove all the pages."):(this.actions.push(new Cc([this.da.view.ea.hk().id])),this.Kb())};c.prototype.Im=function(){if(this.ta())return!1;this.da.view.qg()};c.prototype.Td=function(){1===arguments.length&&!1===arguments[0]&&this.da.view.ea.Kn();return this.da.view.ea.Td()};c.prototype.download=function(a,b,c){"jpeg"===a&&(a="jpg");var d;if("pdf"===a||"svg"===a||"png"===a||"jpg"===a||"bmp"===a||"zwibbler3"===a){var f="zwibbler3"===a?hd.th(this.da.view.ea,a,"data-uri"):this.save(a,
c);"Blob"in window&&(d=Ab(f));if(d){if(window.navigator.msSaveOrOpenBlob){this.log("Using msSaveOrOpenBlob()");window.navigator.msSaveOrOpenBlob(d,b);return}f=window.URL.createObjectURL(d);this.log("Using blob object url %s",f);this.da.Ja.add(function(){window.URL.revokeObjectURL(f)})}var g=document.createElement("a");g.innerHTML="download";g.setAttribute("href",f);g.setAttribute("download",b);g.style.display="none";document.body.appendChild(g);g.click();setTimeout(function(){document.body.removeChild(g)},
1E3)}else this.log("unsupported format for download: %s",a)};c.prototype.ha=function(a,b){void 0===b&&(b={});var c=b.page||0,e=this.da.view.ea.Ra,f=this.da.view.ea.bd();this.da.view.ea.Rb(c);this.da.view.rd(a,0,0,f.width,f.height);this.da.view.ea.ha(a);this.da.view.ea.Rb(e)};c.prototype.sq=function(a){if(this.ta())return!1;var b=this.da.view.ea.va(a,!1);b?b.ni()?(a=this.da.view.nl({}))&&a.kl(b,b.rect.x,b.rect.y):this.log("editNodeText: node %s (%s) cannot contain text.",a,b.type()):this.log("editNodeText: nodeid %s does not exist.",
a)};c.prototype.duplicate=function(){if(this.ta())return!1;this.da.view.duplicate()};c.prototype.ua=function(a){for(var b=this,c=1;c<arguments.length;c++);var e=this;if(!this.sg&&(this.Sa||(this.Sa={}),!this.gm(a))){var f=Array.prototype.slice.call(arguments,1);setTimeout(function(){var c;if(!b.sg&&a in e.Sa){var d=e.Sa[a];var k=0;for(c=d.length;k<c;k++){var l=d[k];l.apply(null,f)}}},0);return this}};c.prototype.Cf=function(a){for(var b=1;b<arguments.length;b++);if(!this.sg&&(this.Sa||(this.Sa={}),
!this.gm(a))){b=Array.prototype.slice.call(arguments,1);var c;if(a in this.Sa){var e=this.Sa[a];var f=0;for(c=e.length;f<c;f++){var g=e[f];g.apply(null,b)}}}};c.prototype.qt=function(a){this.uf[a]=a in this.uf?this.uf[a]+1:1};c.prototype.gm=function(a){return a in this.uf&&0<this.uf[a]?(this.log("Skipped %s event",a),--this.uf[a],!0):!1};c.prototype.focus=function(a,b){void 0===a&&(a=!1);void 0===b&&(b=null);this.da.it(b);a?this.da.cl("text"===this.Ef()):this.da.focus("canvas")};c.prototype.Eq=function(a){a=
this.Sm(a);return a.length?a[0]:null};c.prototype.Sm=function(a){a=this.da.view.ea.Fq(a);for(var b=[],c=0;c<a.length;c++)b.push(a[c].id);return b};c.prototype.Hq=function(a,b,c){if(this.ta())return!1;if(3===arguments.length)if("number"!==typeof b||"number"!==typeof c)this.Ba("flip: 2nd and 3rd args must be numbers.");else{var d=new A(b,c);this.da.view.Um(a/180*Math.PI,d)}else this.da.view.Um(a/180*Math.PI)};c.prototype.yg=function(a,b,c,e){if(this.ta())return!1;a=this.mm(a);"number"===typeof c&&"number"===
typeof e?(c=new A(c,e),this.da.view.yg(a,b/180*Math.PI,c)):this.da.view.yg(a,b/180*Math.PI)};c.prototype.Xm=function(a,b,c){function d(a){a.addEventListener("click contextmenu",function(b){m.call(h,a.Le("backgroundColor"),0===b.button);b.preventDefault()})}function f(a,b){return z("div").Gc({width:b+"px",height:b+"px",display:"inline-block"}).Qd(a)}function g(a,b){var c=document.createElement("canvas");c.width=a;c.height=a;b(c.getContext("2d"),0,0,a);var d=f(k,a);d.Ga.appendChild(c);return d}void 0===
c&&(c={});var h=this,k=pb(a),l;if(k){var m=c.onColour||c.onColor||h.Yg;a=g(b,ze);a.addEventListener("click contextmenu",function(a){if("click"===a.type||"contextmenu"===a.type)m.call(h,"transparent",0===a.button),a.preventDefault()});a=g(b,Ae);a.addEventListener("click contextmenu",function(a){if("click"===a.type||"contextmenu"===a.type){if(c.onOpacity)c.onOpacity(.5,0===a.button);else h.zo(.5,0===a.button);a.preventDefault()}});for(l=0;1>=l;l+=1/13){var q=(new u(u.oe,[0,0,l,1])).toString();d(f(k,
b).Gc({backgroundColor:q}))}for(l=.3;1>=l;l+=.7/14)for(a=0;360>a;a+=22.5)q=(new u(u.oe,[a,.7,l,1])).toString(),d(f(k,b).Gc({backgroundColor:q}));for(a=0;360>a;a+=22.5)q=(new u(u.oe,[a,1,1,1])).toString(),d(f(k,b).Gc({backgroundColor:q}))}};c.prototype.zg=function(){return this.da.view.zg()};c.prototype.Pq=function(){var a=[];this.da.view.ea.Ce(function(b){a.push(b.id)},this.Bg());return a};c.prototype.jp=function(){var a=[];this.da.view.ea.oc(!1,function(b){a.push(b.id)});return a};c.prototype.Sq=
function(){return this.da.Tq()};c.prototype.ak=function(a){return this.qe(this.da.view.ak(a))};c.prototype.Ie=function(a){Yb(a)||this.Ba("getConfig: Expected string");return this.da.fa.get(a)};c.prototype.getContext=function(){return new we(this)};c.prototype.Bg=function(){return this.yb?this.Lj:this.da.view.ea.Ra};c.prototype.Vq=function(){return this.da.view.fi()};c.prototype.Wq=function(){return this.da.view.ji()};c.prototype.Ef=function(){return this.da.view.Ef()};c.prototype.Xq=function(a){a=
this.da.view.ea.va(a);var b=null;a&&"CustomNode"===a.type()&&(b=a.Ua);return b};c.prototype.cn=function(a,b){var c=this.da.view.Za(a,b);return{x:c.x,y:c.y}};c.prototype.Zq=function(a){return this.da.view.ea.ka(a)};c.prototype.ci=function(){return this.qe(this.da.view.ea.bd())};c.prototype.fi=function(){return this.da.view.fi()};c.prototype.ek=function(a){return this.da.fa.ek(a)};c.prototype.ir=function(a){return this.da.language.get(a)};c.prototype.qe=function(a){return{x:a.x,y:a.y,width:a.width,
height:a.height}};c.prototype.zh=function(a){"object"!==typeof a&&this.Ba("Error: Rectangle object expected.");a=new D(a.x||0,a.y||0,a.width||0,a.height||0);a.ko();return a};c.prototype.ar=function(){return this.qe(this.da.view.ea.$m())};c.prototype.gr=function(a,b){return this.gi(a,b)};c.prototype.kr=function(){var a=[],b={};this.da.view.ea.oc(!1,function(d){!(c=d.xd())||c in b||(b[c]=1,a.push(c))});var c=this.zg();c in b||a.push(c);return a};c.prototype.jr=function(a){var b=[];this.da.view.ea.oc(!1,
function(c){c.xd()===a&&b.push(c.id)});return b};c.prototype.lr=function(a,b,c){var d=this.da.view.ea.va(a);if(null===d)return this.Ba("Error: node %s does not exist",a),null;a=this.da.view.es(d,b,c);return{x:a.x,y:a.y}};c.prototype.ad=function(a){return this.da.view.ea.ad(a)};c.prototype.gi=function(a,b){return this.da.gi(a,b)};c.prototype.mr=function(a){a=ye(a);for(var b=null,c=0;c<a.length;c++){var e=a[c],f=this.da.view.ea.va(e);null===f?this.Ba("Error: node %s does not exist",e):b?b.nh(f.rect):
b=f.rect.clone()}b||(b=new D(0,0,0,0));return this.qe(b)};c.prototype.nr=function(a){var b=this.da.view.ea.va(a);if(null===b)return this.Ba("Error: node %s does not exist",a),null;a=b.Ea().yd();return{x:a.x,y:a.y}};c.prototype.pr=function(a){a=this.da.view.ea.va(a);var b="";a&&(b=a.type(),"CustomNode"===b&&(b=a.ka("nodeType")));return b};c.prototype.qr=function(a,b){var c=this.da.view.ea.xb(a,b,this.da.view.Pa);return c?c.id:this.da.view.bo(a,b)&&(c=this.Ac(),c.length)?c[0]:null};c.prototype.Jc=function(){var a=
this.da.view.ea.Jc();this.yb&&(a+=this.Fi);return a};c.prototype.jn=function(a){return(a=this.da.view.ea.hk(a))?a.id:null};c.prototype.kn=function(a){return this.qe(this.da.view.ea.bd(a))};c.prototype.hi=function(a){var b=this.da.view.ea.va(a,!1);if(!b||"PathNode"!==b.type())return null;a=b.hi().clone().ag();var c=[];b.Ea();for(b=0;b<a.length;b++){var e=a[b];c.push(e.x);c.push(e.y)}return c};c.prototype.ur=function(a){a=this.da.view.ea.va(a,!1);if(!a||"PathNode"!==a.type())return null;a=a.hi();for(var b=
[],c=[],e=0;e<a.ba.length;){switch(a.ba[e]){case H.jc:c=[{x:a.ba[e+1],y:a.ba[e+2]}];b.push(c);break;case H.ic:c.push({x:a.ba[e+1],y:a.ba[e+2]})}e+=H.kc[a.ba[e]]}return b};c.prototype.an=function(){return this.da.view.scale};c.prototype.ck=function(){var a=this.da.view.ck();return a?a.id:0};c.prototype.vr=function(a,b,c,e){var d=this.da.view.Qj(a,b);if(void 0===c||void 0===e)return{x:d.x,y:d.y};a=this.da.view.Qj(a+c,b+e);return this.qe(new D(d.x,d.y,a.x-d.x,a.y-d.y))};c.prototype.xr=function(){return this.da.view.Yc};
c.prototype.ji=function(){return this.da.view.ji()};c.prototype.ei=function(a,b){var c=this.da.view.ea.va(a,!1);return c?c.ei(b):null};c.prototype.bt=function(a,b,c){var d=this.da.view.ea.va(a,!1);if(!d)return this.log("setEditHandle: node %s doesn't exist.",a),!1;if("PathNode"!==d.type())return this.log("setEditHandle: node %s is not a PathNode.",a),!1;d=d.ka("commands");d=Q.cp(d,b,c);if(!d)return this.log("setEditHandle: failed"),!1;this.vc(a,"commands",d);return!0};c.prototype.Ac=function(a){void 0===
a&&(a=!1);return this.da.view.rc(a)};c.prototype.ii=function(a){function b(a,b){var d=c.properties[a];void 0!==b&&(c.properties[a]=d!==b&&void 0!==d?null:b)}void 0===a&&(a=this.Ac());for(var c={properties:{},types:{},nodes:a},e=this.da.fa.get("allowTextInShape"),f=0;f<a.length;f++){var g=this.da.view.ea.va(a[f],!1);if(g){var h=g.type();c.types[h]=!0;c.types.AnyNode=!0;"PathNode"===h&&(h=g.ka("closed")?"PathNode-closed":"PathNode-open",c.types[h]=!0);g=g.ec();for(var k in g)g.hasOwnProperty(k)&&"matrix"!==
k&&("BrushNode"!==h||"fillStyle"!==k)&&("PathNode-open"!==h||"fontSize"!==k&&"fontName"!==k&&"fillStyle"!==k)&&("PathNode-closed"!==h||(e||"fontSize"!==k&&"fontName"!==k)&&"arrowSize"!==k&&"arrowStyle"!==k)&&b(k,g[k])}}!c.nodes.length||"opacity"in c.properties||(c.properties.opacity=1);"text"===this.Ef()&&(b("textFillStyle",this.Ie("defaultTextFillStyle")),b("bold",this.Ie("defaultBold")),b("italic",this.Ie("defaultItalic")),b("textDecoration",this.Ie("defaultTextDecoration")));return c};c.prototype.Ar=
function(){return this.qe(this.da.view.Yd())};c.prototype.Ba=function(a){for(var b=1;b<arguments.length;b++);b=arguments[0].split("%s");for(var c=[],e=0;e<b.length;e++)c.push(b[e]),e<b.length-1&&c.push(JSON.stringify(arguments[e+1]));var f=c.join("");this.log(f);throw{message:f,toString:function(){return f}};};c.prototype.im=function(a,b){var c=document.createElement("input");c.setAttribute("id","ZwibblerFileInput");c.setAttribute("type","file");a.accept&&c.setAttribute("accept",a.accept);c.style.display=
"none";document.body.appendChild(c);this.da.Ja.add(function(){c.parentNode&&c.parentNode.removeChild(c)});var e=new FileReader;c.addEventListener("change",function(){var b=this.files;b&&0<b.length&&("data-uri"===a.format?e.readAsDataURL(b[0]):"text"===a.format&&e.readAsText(b[0]));c.parentNode&&c.parentNode.removeChild(c)});e.addEventListener("load",function(){b(e.result)});c.value="";c.click()};c.prototype.Gr=function(){var a=this;if(this.ta())return!1;this.im({accept:"image/*",format:"data-uri"},
function(b){a.createNode("ImageNode",{url:b,iu:!0})})};c.prototype.ui=function(a){if(this.ta())return!1;var b=this.da.view.ea.$a();this.actions.push(new S(b,"PageNode",{},this.da.view.ea.root.id,a));this.Kb(b);this.yb&&(this.Fi+=1);return a};c.prototype.tk=function(a){return this.da.view.ea.tk(a)};c.prototype.load=function(a,b){void 0===b&&(b=a);var c=hd.sh(b);if(c)return this.gh(),this.da.gf(c),!0;this.log("load(): Could not open file.");return!1};c.prototype.xi=function(a){var b=this;K(a)?(this.xk&&
clearTimeout(this.xk),this.xk=setTimeout(function(){b.da.view.xi(!1)},a),b.da.view.xi(!0)):this.Ba("lockUpdates: Expected a number")};c.prototype.If=function(a){this.nc&&(this.nc.If(a),a=this.nc.Ag(),""!==a&&(this.log("Releasing buffered changes"),this.ua("local-changes",a)))};c.prototype.yi=function(){if(this.ta())return!1;this.da.view.yi()};c.prototype.Xr=function(a,b){if(this.ta())return!1;if(K(a)&&K(b)){var c=this.Jc();0>a||a>=c?this.Ba("From page must be > 0 and less than getPageCount()"):0>
b||b>=c?this.Ba("From page must be > 0 and less than getPageCount()"):(c=this.jn(a),null!==c&&(this.actions.push(new Kc([c],Kc.Vl,b)),this.Kb()))}else this.Ba("movePage: needs two valid page numbers.")};c.prototype.zi=function(){if(this.ta())return!1;this.da.view.zi()};c.prototype.zk=function(){this.gh();this.da.zk();this.Yn()};c.prototype.nextPage=function(){this.Zg(Math.min(this.Bg()+1,this.Jc()-1))};c.prototype.Ka=function(a,b){"draw"===a?this.Xc=b:a in this.Sa?this.Sa[a].push(b):this.Sa[a]=[b];
return this};c.prototype.ks=function(a){"function"===typeof a||this.Ba("Error: onComplete needs a function argument.");this.da.view.Lq(a)};c.prototype.Yn=function(){var a=this.da.fa.get("defaultPaperSize");this.log("onNewDocument()");"none"!==a&&this.al(a)};c.prototype.ps=function(a){var b=this;return new ib(function(c,e){b.im({accept:"."+a,format:"text"},function(a){b.load(a)?c(b):e(Error("Could not open the file."))})})};c.prototype.Rg=function(a){if(this.ta())return!1;this.da.view.Rg(a)};c.prototype.ys=
function(){this.Zg(Math.max(this.Bg()-1,0))};c.prototype.print=function(a,b){var c=[],e;if("number"===typeof a)c.push(a);else if(a instanceof Array)for(e=0;e<a.length;e++)if(K(a[e]))c.push(a[e]);else{this.Ba("print(): pageSpec must be array of numbers");return}else if(!a)for(e=0;e<this.Jc();e++)c.push(e);var f=b?this.zh(b):this.zh(this.ci());var g=this.Bg(),h=document.createElement("canvas");h.width=f.width;h.height=f.height;var k=h.getContext("2d");k.translate(-f.x,-f.y);e=window.location.hostname;
var l=window.open("about:blank","_blank");l.document.write("<!DOCTYPE html><html><head><title>"+e+"</title></head><body>");for(e=0;e<c.length;e++)this.Zg(c[e]),this.da.view.rd(k,f.x,f.y,f.width,f.height),this.da.view.ea.ha(k),0<e?l.document.write("<div style='page-break-before:always'>"):l.document.write("<div>"),l.document.write("<img style='width:100%' src='"),l.document.write(h.toDataURL()),l.document.write("'></div>"),k.clearRect(f.x,f.y,f.width,f.height);l.document.write("</body></html>");l.document.close();
setTimeout(function(){l.focus();l.print();setTimeout(function(){l.close()},1E3)},1E3);this.Zg(g)};c.prototype.ta=function(){return this.da.fa.get("readOnly")?(this.log("readOnly; ignore tool click."),!0):!1};c.prototype.Hd=function(){this.da.view.Hd()};c.prototype.fe=function(a){this.da.view.ha(a)};c.prototype.removeEventListener=function(a,b){if(a in this.Sa){for(var c=this.Sa[a],e=0;e<c.length;e++)if(c[e]===b){c.splice(e,1);break}0===c.length&&delete this.Sa[a]}};c.prototype.resize=function(){if(!this.Rk){var a=
this;a.Rk=setTimeout(function(){a.Rk=0;a.da.Ah()},0)}};c.prototype.save=function(a,b){void 0===a&&(a="zwibbler3");var c={jpeg:"image/jpeg",jpg:"image/jpeg",png:"image/png",bmp:"image/bmp",svg:"image/svg+xml",pdf:"application/pdf"},e=this.zh(b||this.ci());switch(a){case "list":return hd.th(this.da.view.ea,"list","object");case "png":case "jpeg":case "jpg":case "bmp":case "svg":case "pdf":return this.da.no(c[a],e);case "zwibbler3":return hd.th(this.da.view.ea,"zwibbler3","string");case "image/png":case "image/jpeg":case "image/bmp":var f=
this.da.no(a,e);f=f.substr(f.indexOf(",")+1);c="";e=0;var g={A:0,B:1,C:2,D:3,E:4,F:5,G:6,H:7,I:8,J:9,K:10,L:11,M:12,N:13,O:14,P:15,Q:16,R:17,S:18,T:19,U:20,V:21,W:22,X:23,Y:24,Z:25,a:26,b:27,c:28,d:29,e:30,f:31,g:32,h:33,i:34,j:35,k:36,l:37,m:38,n:39,o:40,p:41,q:42,r:43,s:44,t:45,u:46,v:47,w:48,x:49,y:50,z:51,0:52,1:53,2:54,3:55,4:56,5:57,6:58,7:59,8:60,9:61,"+":62,"/":63,"=":64};for(f=f.replace(/[^A-Za-z0-9\-_=\+\/]/g,"");e<f.length;){var h=g[f.charAt(e++)];var k=g[f.charAt(e++)];var l=g[f.charAt(e++)];
var m=g[f.charAt(e++)];h=h<<2|k>>4;k=(k&15)<<4|l>>2;var q=(l&3)<<6|m;c+=String.fromCharCode(h);64!==l&&(c+=String.fromCharCode(k));64!==m&&(c+=String.fromCharCode(q))}return c;default:return"Unsupported format: "+a}};c.prototype.Zs=function(a){this.da.view.canvas.style.cursor=a};c.prototype.ie=function(a,b){if(this.ta())return!1;this.da.view.ie(a,b)};c.prototype.mm=function(a){for(var b=[],c=0;c<a.length;c++){var e=this.da.view.ea.va(a[c],!1);e&&b.push(e)}return b};c.prototype.selectNodes=function(a){a=
this.mm(ye(a));this.da.view.selectNodes(a);this.da.view.Mb();this.da.view.ha()};c.prototype.Oi=function(){if(this.ta())return!1;this.da.view.Oi()};c.prototype.Pi=function(a){this.da.view.Pi(a)};c.prototype.Xs=function(a,b){"defaultPaperSize"===a&&this.al(b);return this.da.fa.set(a,b)};c.prototype.Yg=function(a,b){if(this.ta())return!1;this.da.view.js(a,b)};c.prototype.Zg=function(a){this.yb?(this.log("Set page to %s inside transaction",a),this.actions.push(new Nc(a)),this.Lj=a):this.da.view.Rb(a)};
c.prototype.Wk=function(a){this.da.view.Wk(a)};c.prototype.$s=function(a,b){this.da.view.ea.setProperty(a,b)};c.prototype.Uf=function(a,b){!K(a)&&null!==a||!K(b)&&null!==b?alert("setDocumentSize: width/height must be numbers"):this.da.view.Uf(a,b)};c.prototype.wo=function(a,b){!K(a)&&null!==a||!K(b)&&null!==b?alert("setDocumentSize: width/height must be numbers"):this.Kb(this.da.view.Uf(a,b,this.actions))};c.prototype.at=function(a,b){var c=this.da.view.ea.va(a);c?("DomNode"!==c.type()&&this.Ba("setDomElement: Node %s is not a DomNode. It is %s",
a,c.type()),c.ct(b),this.da.Vh.push(b)):this.Ba("setDomElement: Node %s does not exist",a)};c.prototype.np=function(){var a=this;this.log("Setting up dragdrop");this.da.canvas.addEventListener("drop",function(b){b.preventDefault();var c=b.dataTransfer.getData("zwibbler-src"),e=parseFloat(b.dataTransfer.getData("zwibbler-width"));a.log("DragDrop received with src=%s size=%s",c,e);c&&O.gn(c,function(d,g){var f=1;e&&(f=e/d);var k=a.cn(b.pageX,b.pageY);k.x-=d*f/2;k.y-=g*f/2;a.Cj();var l=a.createNode("ImageNode",
{url:c});a.Li(l,f,f);a.lh(l,k.x,k.y);a.Jh();a.Lo()})})};c.prototype.$q=function(a){var b=this.da.view.ea.va(a);if(!b)return this.Ba("getDomElement: Node %s does not exist",a),null;b instanceof dc||this.Ba("getDomElement: Node %s is not a DomNode. It is %s",a,b.type());return b.en()};c.prototype.gt=function(a,b){Yb(a)&&Yb(b)?(this.zg()===a&&this.Pi(b),this.da.view.ea.oc(!1,function(c){c.xd()===a&&c.setProperty("layer",b)})):this.Ba("setLayerName() needs string arguments.")};c.prototype.al=function(a,
b){var c=null,e=null,f=!0,g=!1;if(2===arguments.length)if(K(arguments[0])&&K(arguments[1])){var h=arguments[0];c=arguments[1]}else Yb(arguments[0])&&"boolean"===typeof arguments[1]?(e=arguments[0],g=arguments[1]):f=!1;else if(1===arguments.length&&Yb(arguments[0]))for(var k=arguments[0].split(" "),l=0;l<k.length;l++)"landscape"===k[l]?g=!0:"portrait"===k[l]?g=!1:e=k[l];if(!1===f)return this.log("Bad arguments to setPaperSize()."),!1;if(null===e)return this.Uf(h,c),!0;switch(e.toLowerCase()){case "letter":h=
816;c=1056;break;case "legal":h=816;c=1344;break;case "11x17":h=1056;c=1632;break;case "tabloid":h=1056;c=1632;break;case "a0":h=841/25.4*96;c=1189/25.4*96;break;case "a1":h=594/25.4*96;c=841/25.4*96;break;case "a2":h=420/25.4*96;c=594/25.4*96;break;case "a3":h=297/25.4*96;c=420/25.4*96;break;case "a4":h=210/25.4*96;c=297/25.4*96;break;case "none":c=h=null;break;default:return this.log("Invalid paper size: %s",e),!1}g&&(e=h,h=c,c=e);this.Uf(h,c);return!0};c.prototype.ft=function(a,b,c){this.vc(a,
b,c)};c.prototype.Yk=function(a,b){if(this.ta())return!1;if(2!==arguments.length)throw"Error: setNodeProperties takes 2 arguments.";return this.Kb(this.da.Yk(this.actions,ye(a),this.Hb(b)))};c.prototype.vc=function(a,b,c){if(this.ta())return!1;3!==arguments.length&&this.Ba("Error: setNodeProperty takes 3 arguments.");return this.Kb(this.da.vc(this.actions,ye(a),b,this.Hb(c)))};c.prototype.ht=function(a,b){for(var c=ye(a),e=0;e<c.length;e++){var f=this.da.view.ea.va(c[e],!0);f&&f.he(!b)}this.da.view.ha()};
c.prototype.zo=function(a,b){if(this.ta())return!1;this.da.view.os(a,b)};c.prototype.$k=function(a){this.da.view.$k(a)};c.prototype.kt=function(a){Zb(a)&&K(a.x)&&K(a.y)&&K(a.width)&&K(a.height)||this.Ba("setViewRect: arg must be an object with numeric x, y, width, height properties");0!==a.width&&0!==a.height||this.Ba("setViewRect: width and height must be non-zero.");this.da.view.ah(this.zh(a))};c.prototype.wc=function(a,b,c){if(K(a)||"page"===a||"width"===a)if(1===arguments.length)this.da.view.wc(a);
else if(3===arguments.length&&"number"===typeof a&&K(b)&&K(c)){var d=this.an()/a,f=this.da.view.Yd();f.transform(new Lb(d,d,b,c));this.da.view.ah(f)}else this.Ba("setZoom: invalid arguments.");else this.log("setZoom: invalid parameter.")};c.prototype.bh=function(a,b){void 0===b&&(b=!0);this.da.view.bh(a,b)};c.prototype.La=function(a,b,c){a=this.da.view.La(new A(a,b),c);return{x:a.x,y:a.y}};c.prototype.hh=function(a){var b=this.da.canvas;if(a)(a=pb(a))||this.Ba("toggleFullScreen: can't find element from "+
a);else for(a=b;a;){if(a instanceof HTMLElement&&(a.getAttribute("zwibbler")||"ZWIBBLER"===a.tagName)){b=a;break}a=a.parentElement}O.hh(b)};c.prototype.lh=function(a,b,c){if(this.ta())return!1;this.log("Translate node %s by %s,%s actions=%s",a,b,c,this.actions.length);return this.Kb(this.da.lh(this.actions,ye(a),b,c))};c.prototype.Ug=function(a){this.da.Ug(a)};c.prototype.Nk=function(){this.da.view.Nk()};c.prototype.Ps=function(a){if(this.ta())return!1;var b=Math.round(a/(Math.PI/2));a=b*Math.PI/
2;b=0===b%2;var c=this.jp(),e=this.ci(),f=e.width/2,g=e.height/2;this.Cj();for(var h=0;h<c.length;h++)this.mo(c[h],a,f,g),b||this.lh(c[h],g-f,f-g);b||this.wo(e.height,e.width);this.Jh()};c.prototype.mo=function(a,b,c,e){if(this.ta())return!1;this.log("Rotate nodes by %s around (%s,%s) actions=%s",b/Math.PI*180,c,e,this.actions.length);for(var d=4===arguments.length,g=ye(a),h=new A(0,0),k=0;k<g.length;k++){var l=g[k],m=this.da.view.ea.va(l);!m&&!this.Qh.contains(l)||!m&&!d?this.log("rotateNode: Node %s does not exist",
l):!d&&m&&(l=m.rect.Vc(),h.x+=l.x,h.y+=l.y)}d?(h.x=c,h.y=e):(h.x/=g.length,h.y/=g.length);d=new Kb(b,h.x,h.y);return this.Kb(this.da.transformNode(this.actions,g,d))};c.prototype.Li=function(a,b,c,e,f){void 0===e&&(e=0);void 0===f&&(f=0);if(this.ta())return!1;this.log("Scale node %s by %s,%s actions=%s",a,b,c,this.actions.length);return this.Kb(this.da.Li(this.actions,ye(a),b,c,e,f))};c.prototype.Zk=function(a,b,c,e,f,g,h){if(this.ta())return!1;7!==arguments.length&&this.Ba("setNodeTransform: requires 7 arguments");
this.log("setNodeTransform(id=%s %s %s %s %s %s %s %s)",a,b,c,e,f,g,h);return this.Kb(this.da.Zk(this.actions,ye(a),b,c,e,f,g,h))};c.prototype.Co=function(a,b,c){var d=this;if(!this.Pf){var f=document.createElement("div");f.style.width="320px";f.style.lineHeight="0";var g=this;this.Xm(f,20,{onColour:function(a){g.vc(g.Ac(),g.Em,a)}});this.Pf=O.rh(f);this.da.Ja.add(function(){d.Pf&&(d.Pf.destroy(),d.Pf=null)})}this.Em=a;this.Pf.show(b,c,!0)};c.prototype.fq=function(){var a=ae(32);this.log("Creating shared session "+
a);return this.hm(a,!0)};c.prototype.hm=function(a,b){this.log("Attach to shared session "+a);this.gh();this.nc=new pe(this.da.view,ae(4),b);"zwibbler"===this.da.fa.get("collaborationServer")&&(this.Yf=new qe(a,this));var c=this.nc.Ag();""!==c&&this.ua("local-changes",c);return a};c.prototype.Mr=function(a){void 0===a&&(a="");var b=new Yc(!0);this.da.gf(b);this.hm(a,!1)};c.prototype.gh=function(){this.nc&&(this.nc.end(),this.nc=null);this.Yf&&(this.Yf.stop(),this.Yf=null)};c.prototype.kb=function(){if(this.ta())return!1;
this.da.view.kb()};c.prototype.mh=function(a){if(this.ta())return!1;this.Kb(this.da.mh(this.actions,ye(a)))};c.prototype.upload=function(a,b){function c(){}function e(){}var f=this.da.eq(b||"Working"),g=new XMLHttpRequest,h=new FormData(a);g.upload.addEventListener("progress",function(a){f.update(a.loaded/a.total)},!1);g.addEventListener("load",function(){200===g.status?(f.done(),e(g.response,g)):(f.error("Error"),c(g))},!1);g.addEventListener("error",function(){f.error("Error");c(g)},!1);g.addEventListener("abort",
function(){f.error("Aborted");c(g)},!1);g.open(a.method,a.action);g.send(h);var k={success:function(a){e=a;return k},error:function(a){c=a;return k}};return k};c.prototype.Ct=function(a,b){void 0===b&&(b=!1);if(this.ta())return!1;this.da.view.Ap(this.Hb(a),b)};c.prototype.Dt=function(a,b){if(this.ta())return!1;2===arguments.length?this.da.view.Jm({lineWidth:b,strokeStyle:a}):this.da.view.Jm(this.Hb(arguments[0]))};c.prototype.Et=function(a){if(this.ta())return!1;this.da.view.bj(this.Hb(a))};c.prototype.Ft=
function(a){if(this.ta())return!1;this.da.view.Gm(this.Hb(a))};c.prototype.Gt=function(a){if(this.ta())return!1;Zb(a)?(a=new $d(this.da.view,a),this.da.view.fb(a)):this.Ba("useCustomTool(): requires an object as argument.")};c.prototype.zl=function(a){if(this.ta())return!1;this.da.view.zl(a)};c.prototype.bj=function(a){void 0===a&&(a={});if(this.ta())return!1;this.da.view.bj(this.Hb(a))};c.prototype.It=function(a,b,c){void 0===c&&(c="freehand");if(this.ta())return!1;Zb(a)?(a=this.Hb(a),c=b):a={strokeStyle:a,
lineWidth:b};this.da.view.Km(a,c)};c.prototype.Qt=function(a,b){void 0===b&&(b=!0);if(this.ta())return!1;var c=a;Yb(a)?c={url:a}:"url"in c||this.Ba("useStampTool: missing url in properties");this.da.view.Jt(c,1===arguments.length||!0===b)};c.prototype.Kt=function(a,b){if(this.ta())return!1;if(Zb(b)){var c=b.singleLine;var e=b.orthogonal}else c=b;this.da.view.Gn(this.Hb(a),c,e)};c.prototype.Lt=function(){this.da.view.ss()};c.prototype.Lo=function(){this.da.view.eb()};c.prototype.Al=function(a,b,c,
e){if(this.ta())return!1;K(a)||this.Ba("usePolygonTool: parameter 1 must be a number.");K(b)||this.Ba("usePolygonTool: parameter 2 must be a number.");c&&!K(c)&&this.Ba("usePolygonTool: parameter 3 must be a number.");e&&!Zb(e)&&this.Ba("usePolygonTool: parameter 4 must be a object properties.");this.da.view.Al(a,b,c||1,this.Hb(e||{}))};c.prototype.Mt=function(a){void 0===a&&(a={});if(this.ta())return!1;this.da.view.Km(this.Hb(a),"quadratic")};c.prototype.oh=function(a){void 0===a&&(a={});if(this.ta())return!1;
this.da.view.oh(this.Hb(a))};c.prototype.Nt=function(a){void 0===a&&(a={});if(this.ta())return!1;this.da.view.oh(Fb({roundRadius:this.da.fa.get("defaultRoundRectRadius")},a))};c.prototype.Ot=function(a,b){if(this.ta())return!1;var c={};Zb(a)?c=this.Hb(a):Yb(a)&&(c.stokeStyle=a);K(b)&&(c.lineWidth=b);this.da.view.pq(c)};c.prototype.Bl=function(a,b,c,e,f,g){void 0===f&&(f="rectangle-tl");void 0===g&&(g=null);if(this.ta())return!1;this.da.view.Bl(a,this.Hb(b),c,e,f,g)};c.prototype.Pt=function(a){if(this.ta())return!1;
this.da.view.oh(this.Hb(a))};c.prototype.Rt=function(a){if(this.ta())return!1;this.da.view.nl(this.Hb(a))};c.prototype.ej=function(){this.da.view.ej()};c.prototype.fj=function(){this.da.view.fj()};return c}();W.prototype.log=W.prototype.log;W.prototype.addRemoteChanges=W.prototype.wf;W.prototype.attach=W.prototype.lc;W.prototype.abortTransaction=W.prototype.rp;W.prototype.addSelectionHandle=W.prototype.yc;W.prototype.addToLanguage=W.prototype.yj;W.prototype.addPage=W.prototype.wp;
W.prototype.addPanel=W.prototype.ig;W.prototype.beginTransaction=W.prototype.Cj;W.prototype.bringToFront=W.prototype.Gh;W.prototype.canRedo=W.prototype.nd;W.prototype.canUndo=W.prototype.od;W.prototype.clearSelection=W.prototype.pb;W.prototype.clearUndo=W.prototype.Rp;W.prototype.clickColour=W.prototype.Sp;W.prototype.commitIrreversibleTransaction=W.prototype.Up;W.prototype.commitTransaction=W.prototype.Jh;W.prototype.copy=W.prototype.Ae;W.prototype.createGroup=W.prototype.og;
W.prototype.createNode=W.prototype.createNode;W.prototype.createPath=W.prototype.Oh;W.prototype.createToolbar=W.prototype.gq;W.prototype.createShape=W.prototype.Jj;W.prototype.cut=W.prototype.Nj;W.prototype.destroy=W.prototype.rg;W.prototype.deleteNode=W.prototype.zc;W.prototype.deleteNodes=W.prototype.Hm;W.prototype.deletePage=W.prototype.iq;W.prototype.deleteSelection=W.prototype.Im;W.prototype.dirty=W.prototype.Td;W.prototype.download=W.prototype.download;W.prototype.draw=W.prototype.ha;
W.prototype.editNodeText=W.prototype.sq;W.prototype.duplicate=W.prototype.duplicate;W.prototype.emit=W.prototype.ua;W.prototype.skipEvent=W.prototype.qt;W.prototype.focus=W.prototype.focus;W.prototype.findNode=W.prototype.Eq;W.prototype.findNodes=W.prototype.Sm;W.prototype.flip=W.prototype.Hq;W.prototype.flipNodes=W.prototype.yg;W.prototype.generatePalette=W.prototype.Xm;W.prototype.getActiveLayer=W.prototype.zg;W.prototype.getAllNodes=W.prototype.Pq;W.prototype.getBackgroundImage=W.prototype.Sq;
W.prototype.getBoundingRectangle=W.prototype.ak;W.prototype.getConfig=W.prototype.Ie;W.prototype.getContext=W.prototype.getContext;W.prototype.getCurrentPage=W.prototype.Bg;W.prototype.getCurrentFillColour=W.prototype.Vq;W.prototype.getCurrentOutlineColour=W.prototype.Wq;W.prototype.getCurrentTool=W.prototype.Ef;W.prototype.getCustomNode=W.prototype.Xq;W.prototype.getDocumentCoordinates=W.prototype.cn;W.prototype.getDocumentProperty=W.prototype.Zq;W.prototype.getDocumentSize=W.prototype.ci;
W.prototype.getFillColour=W.prototype.fi;W.prototype.getImageUrl=W.prototype.ek;W.prototype.getLanguageString=W.prototype.ir;W.prototype.getDrawingRectangle=W.prototype.ar;W.prototype.getItemProperty=W.prototype.gr;W.prototype.getLayers=W.prototype.kr;W.prototype.getLayerNodes=W.prototype.jr;W.prototype.getNodeCoordinates=W.prototype.lr;W.prototype.getNodePageNumber=W.prototype.ad;W.prototype.getNodeProperty=W.prototype.gi;W.prototype.getNodeRectangle=W.prototype.mr;W.prototype.getNodeScale=W.prototype.nr;
W.prototype.getNodeType=W.prototype.pr;W.prototype.getNodeUnderPoint=W.prototype.qr;W.prototype.getPageCount=W.prototype.Jc;W.prototype.getPageNode=W.prototype.jn;W.prototype.getPageRect=W.prototype.kn;W.prototype.getPathData=W.prototype.hi;W.prototype.getPathAsPoints=W.prototype.ur;W.prototype.getCanvasScale=W.prototype.an;W.prototype.getEditNode=W.prototype.ck;W.prototype.getScreenCoordinates=W.prototype.vr;W.prototype.getSelectedEditHandle=W.prototype.xr;W.prototype.getStrokeColour=W.prototype.ji;
W.prototype.getEditHandleType=W.prototype.ei;W.prototype.setEditHandle=W.prototype.bt;W.prototype.getSelectedNodes=W.prototype.Ac;W.prototype.getPropertySummary=W.prototype.ii;W.prototype.getViewRectangle=W.prototype.Ar;W.prototype.insertImage=W.prototype.Gr;W.prototype.insertPage=W.prototype.ui;W.prototype.isLayerVisible=W.prototype.tk;W.prototype.load=W.prototype.load;W.prototype.lockUpdates=W.prototype.xi;W.prototype.markChangesSent=W.prototype.If;W.prototype.moveDown=W.prototype.yi;
W.prototype.movePage=W.prototype.Xr;W.prototype.moveUp=W.prototype.zi;W.prototype.newDocument=W.prototype.zk;W.prototype.nextPage=W.prototype.nextPage;W.prototype.on=W.prototype.Ka;W.prototype.onComplete=W.prototype.ks;W.prototype.openFromComputer=W.prototype.ps;W.prototype.paste=W.prototype.Rg;W.prototype.previousPage=W.prototype.ys;W.prototype.print=W.prototype.print;W.prototype.redo=W.prototype.Hd;W.prototype.redraw=W.prototype.fe;W.prototype.removeEventListener=W.prototype.removeEventListener;
W.prototype.resize=W.prototype.resize;W.prototype.save=W.prototype.save;W.prototype.setCursor=W.prototype.Zs;W.prototype.setToolProperty=W.prototype.ie;W.prototype.selectNodes=W.prototype.selectNodes;W.prototype.sendToBack=W.prototype.Oi;W.prototype.setActiveLayer=W.prototype.Pi;W.prototype.setConfig=W.prototype.Xs;W.prototype.setColour=W.prototype.Yg;W.prototype.setCurrentPage=W.prototype.Zg;W.prototype.setCustomBackgroundFn=W.prototype.Wk;W.prototype.setDocumentProperty=W.prototype.$s;
W.prototype.setDocumentSize=W.prototype.Uf;W.prototype.setDocumentSizeInTransaction=W.prototype.wo;W.prototype.setDomElement=W.prototype.at;W.prototype.getDomElement=W.prototype.$q;W.prototype.setLayerName=W.prototype.gt;W.prototype.setPaperSize=W.prototype.al;W.prototype.setItemProperty=W.prototype.ft;W.prototype.setNodeProperties=W.prototype.Yk;W.prototype.setNodeProperty=W.prototype.vc;W.prototype.setNodeVisibility=W.prototype.ht;W.prototype.setOpacity=W.prototype.zo;W.prototype.setPageView=W.prototype.$k;
W.prototype.setViewRectangle=W.prototype.kt;W.prototype.setZoom=W.prototype.wc;W.prototype.showLayer=W.prototype.bh;W.prototype.snap=W.prototype.La;W.prototype.toggleFullscreen=W.prototype.hh;W.prototype.translateNode=W.prototype.lh;W.prototype.removePanel=W.prototype.Ug;W.prototype.removeSelectionHandles=W.prototype.Nk;W.prototype.rotateDocument=W.prototype.Ps;W.prototype.rotateNode=W.prototype.mo;W.prototype.scaleNode=W.prototype.Li;W.prototype.setNodeTransform=W.prototype.Zk;
W.prototype.showColourPicker=W.prototype.Co;W.prototype.createSharedSession=W.prototype.fq;W.prototype.joinSharedSession=W.prototype.Mr;W.prototype.stopSharing=W.prototype.gh;W.prototype.undo=W.prototype.kb;W.prototype.ungroup=W.prototype.mh;W.prototype.upload=W.prototype.upload;W.prototype.useArrowTool=W.prototype.Ct;W.prototype.useBrushTool=W.prototype.Dt;W.prototype.useCircleTool=W.prototype.Et;W.prototype.useCurveTool=W.prototype.Ft;W.prototype.useCustomTool=W.prototype.Gt;
W.prototype.useEditHandleTool=W.prototype.zl;W.prototype.useEllipseTool=W.prototype.bj;W.prototype.useFreehandTool=W.prototype.It;W.prototype.useStampTool=W.prototype.Qt;W.prototype.useLineTool=W.prototype.Kt;W.prototype.usePanTool=W.prototype.Lt;W.prototype.usePickTool=W.prototype.Lo;W.prototype.usePolygonTool=W.prototype.Al;W.prototype.useQuadraticBezierTool=W.prototype.Mt;W.prototype.useRectangleTool=W.prototype.oh;W.prototype.useRoundRectTool=W.prototype.Nt;W.prototype.useShapeBrushTool=W.prototype.Ot;
W.prototype.useShapeTool=W.prototype.Bl;W.prototype.useSquareTool=W.prototype.Pt;W.prototype.useTextTool=W.prototype.Rt;W.prototype.zoomIn=W.prototype.ej;W.prototype.zoomOut=W.prototype.fj;function X(c){var a;void 0===a&&(a="Assertion failed.");if(!c)throw Error(a);}
var Ce=function(){function c(a){var b=this;this.Ec=0;this.log=w.create("BinaryReader");if("string"===typeof a)this.length=a.length,this.getUint8=function(){X(b.Ec<a.length);return a.charCodeAt(b.Ec++)&255};else{var c=new Uint8Array(a);this.length=c.length;this.getUint8=function(){X(b.Ec<c.length);return c[b.Ec++]}}}c.prototype.seek=function(a){X(0<=a&&a<=this.length);var b=this.Ec;this.Ec=a;return b};c.prototype.getUint16=function(){return(this.getUint8()<<8|this.getUint8())>>>0};c.prototype.getUint32=
function(){return this.getInt32()>>>0};c.prototype.getInt16=function(){var a=this.getUint16();a&32768&&(a-=65536);return a};c.prototype.getInt32=function(){return this.getUint8()<<24|this.getUint8()<<16|this.getUint8()<<8|this.getUint8()};c.prototype.Ib=function(){return this.getInt16()};c.prototype.yr=function(){this.getUint16()};c.prototype.He=function(){return this.getInt16()/16384};c.prototype.dk=function(){return this.getInt32()/65536};c.prototype.mn=function(a){for(var b="",c=0;c<a;c++)b+=String.fromCharCode(this.getUint8());
return b};c.prototype.zr=function(a){for(var b="",c=0;c<a;c+=2)b+=String.fromCharCode(this.getUint16());return b};c.prototype.getDate=function(){var a=1E3*(4294967296*this.getUint32()+this.getUint32())+Date.UTC(1904,1,1);return new Date(a)};return c}(),De=function(){function c(a){this.format=0;this.um=[];this.log=w.create("CMAP0");for(var b=0;256>b;b++){var c=a.getUint8();this.log("   Glyph[%s] = %s",b,c);this.um.push(c)}}c.prototype.map=function(a){return 0<=a&&255>=a?this.um[a]:0};return c}(),Ee=
function(){function c(a){this.file=a;this.format=4;this.cache={};this.log=w.create("CMAP4");var b,c=[],e=a.getUint16()/2;a.getUint16();a.getUint16();a.getUint16();for(b=0;b<e;b++)c.push({si:0,Wi:0,Om:a.getUint16(),wn:0});a.getUint16();for(b=0;b<e;b++)c[b].Wi=a.getUint16();for(b=0;b<e;b++)c[b].wn=a.getUint16();for(b=0;b<e;b++){var f=a.getUint16();c[b].si=f?a.Ec-2+f:0}this.qa=c}c.prototype.map=function(a){if(!(a in this.cache)){for(var b=0;b<this.qa.length;b++){var c=this.qa[b];if(c.Wi<=a&&c.Om>=a){if(c.si){var e=
c.si+2*(a-c.Wi);this.file.seek(e);var f=this.file.getUint16()}else f=c.wn+a&65535;this.log("Charcode %s is between %s and %s; maps to %s (%s) roffset=%s",a,c.Wi,c.Om,e,f,c.si);this.cache[a]=f;break}}b===this.qa.length&&(this.cache[a]=0)}return this.cache[a]};return c}(),Fe=function(){function c(a,b,c){this.file=a;this.map={};this.Pe=-1;this.log=w.create("KERN0");this.vt=b&&!c||!b&&c;this.file=a;this.offset=a.Ec;this.$r=a.getUint16();a.getUint16();a.getUint16();a.getUint16();for(b=0;b<this.$r;b++){c=
a.getUint16();var d=a.getUint16(),f=a.Ib();this.map[c<<16|d]=f}this.reset()}c.prototype.reset=function(){this.Pe=-1};c.prototype.get=function(a){var b=0;if(0<=this.Pe){var c=this.Pe<<16|a;c in this.map&&(b=this.map[c])}this.Pe=a;return this.vt?{x:0,y:b}:{x:b,y:0}};return c}(),Ge=function(){function c(a){this.Gj=[];this.Hg=[];this.yl=this.flags=this.Jn=this.version=0;this.Sd=new Date;this.yn=this.Hl=this.Fl=this.Il=this.Gl=0;this.fontFamily=this.Ge="";this.Mg=0;this.log=w.create("TrueType");this.file=
new Ce(a);this.hb=this.Gs(this.file);this.Cs(this.file);this.Fs(this.file);this.As(this.file);this.Ds(this.file);this.Es(this.file);this.length=this.Br()}c.prototype.Gs=function(a){var b={};a.getUint32();var c=a.getUint16();a.getUint16();a.getUint16();a.getUint16();for(var e=0;e<c;e++){var f=a.mn(4);b[f]={Qp:a.getUint32(),offset:a.getUint32(),length:a.getUint32()};"head"!==f&&this.log("Table %s has checksum 0x%s",f,b[f].Qp.toString(16))}return b};c.prototype.Cs=function(a){X("head"in this.hb);a.seek(this.hb.head.offset);
this.version=a.dk();a.dk();a.getUint32();this.Jn=a.getUint32();X(1594834165===this.Jn);this.flags=a.getUint16();this.yl=a.getUint16();this.Sd=a.getDate();a.getDate();this.Gl=a.Ib();this.Il=a.Ib();this.Fl=a.Ib();this.Hl=a.Ib();a.getUint16();a.getUint16();a.getInt16();this.yn=a.getInt16();a.getInt16()};c.prototype.As=function(a){X("cmap"in this.hb);var b=this.hb.cmap.offset;a.seek(b);a.getUint16();for(var c=a.getUint16(),e=0;e<c;e++){var f=a.getUint16(),g=a.getUint16(),h=a.getUint32();this.log("CMap platformid=%s specificid=%s offset=%s",
f,g,h);3===f&&1>=g&&this.zs(a,b+h)}};c.prototype.zs=function(a,b){var c=a.seek(b),e=a.getUint16(),f=a.getUint16();a.getUint16();var g;this.log("    Cmap format %s length %s",e,f);0===e?g=new De(a,f):4===e&&(g=new Ee(a,f));g&&this.Gj.push(g);a.seek(c)};c.prototype.Es=function(a){if("kern"in this.hb){a.seek(this.hb.kern.offset);var b=a.getUint16(),c=a.getUint16();this.log("Kern Table version: %s",b);this.log("Kern nTables: %s",c);for(var e=0;e<c;e++){b=a.getUint16();var f=a.getUint16(),g=a.getUint16(),
h=g>>8,k=g&4,l=0===(g&1);this.log("Kerning subtable version %s format %s length %s coverage: %s",b,h,f,g);b=null;0===h?b=new Fe(a,l,0!=k):(this.log("Unknown format -- skip"),a.seek(a.Ec+f));b&&this.Hg.push(b)}}};c.prototype.Fs=function(a){X("name"in this.hb);var b=this.hb.name.offset;a.seek(b);a.getUint16();for(var c=a.getUint16(),e=a.getUint16(),f=0;f<c;f++){var g=a.getUint16(),h=a.getUint16(),k=a.getUint16(),l=a.getUint16(),m=a.getUint16(),q=a.getUint16();q=a.seek(b+e+q);m=0===g||3===g?a.zr(m):
a.mn(m);this.log("Name %s/%s id %s language %s: %s",g,h,l,k,m);a.seek(q);switch(l){case 1:this.fontFamily=m;break;case 4:this.Ge=m}}};c.prototype.Ds=function(a){X("hhea"in this.hb);a.seek(this.hb.hhea.offset);a.dk();a.Ib();a.Ib();a.Ib();a.yr();a.Ib();a.Ib();a.Ib();a.getInt16();a.getInt16();a.Ib();a.getInt16();a.getInt16();a.getInt16();a.getInt16();a.getInt16();this.Mg=a.getUint16()};c.prototype.fr=function(a){X("hmtx"in this.hb);var b=this.file;b.seek(this.hb.hmtx.offset+4);var c=this.hb.hmtx.offset;
if(a<this.Mg){var e=this.file.seek(c+4*a);var f=b.getUint16();a=b.getInt16()}else e=b.seek(c+4*(this.Mg-1)),f=b.getUint16(),b.seek(c+4*this.Mg+2*(a-this.Mg)),a=b.Ib();this.file.seek(e);return{sm:f,Or:a}};c.prototype.Br=function(){X("maxp"in this.hb);var a=this.file.seek(this.hb.maxp.offset+4),b=this.file.getUint16();this.file.seek(a);return b};c.prototype.dr=function(a){X("loca"in this.hb);var b=this.hb.loca,c=this.file;if(1===this.yn){b=c.seek(b.offset+4*a);a=c.getUint32();var e=c.getUint32()}else b=
c.seek(b.offset+2*a),a=2*c.getUint16(),e=2*c.getUint16();c.seek(b);return a===e?0:a+this.hb.glyf.offset};c.prototype.io=function(a){var b=this.dr(a);a=this.file;if(0===b||b>=this.hb.glyf.offset+this.hb.glyf.length)return null;X(b>=this.hb.glyf.offset);X(b<this.hb.glyf.offset+this.hb.glyf.length);a.seek(b);b={qd:[],Og:a.getInt16(),la:[],Gl:a.Ib(),Il:a.Ib(),Fl:a.Ib(),Hl:a.Ib()};X(-1<=b.Og);-1===b.Og?this.Bs(a,b):this.Hs(a,b);return b};c.prototype.Hs=function(a,b){function c(b,c,d){for(var f=0,k=0;k<
g;k++){var l=h[k];l&c?f=l&d?f+a.getUint8():f-a.getUint8():~l&d&&(f+=a.getInt16());e[k][b]=f}}b.qd=[];for(var e=b.la=[],f=0;f<b.Og;f++)b.qd.push(a.getUint16());a.seek(a.getUint16()+a.Ec);if(0!==b.Og){var g=Math.max.apply(null,b.qd)+1,h=[];for(f=0;f<g;f++){var k=a.getUint8();h.push(k);e.push({x:0,y:0,Nf:0<(k&1)});if(k&8){var l=a.getUint8();X(0<l);for(f+=l;l--;)h.push(k),e.push({x:0,y:0,Nf:0<(k&1)})}}c("x",2,16,b.Gl,b.Fl);c("y",4,32,b.Il,b.Hl)}};c.prototype.Bs=function(a,b){var c,e,f=32;b.qd=[];for(b.la=
[];f&32;){f=a.getUint16();var g=a.getUint16();var h=1;var k=c=0;var l=1;var m=e=0;if(f&1){var q=a.getInt16();var p=a.getInt16()}else q=a.getUint8(),p=a.getUint8();f&2&&(e=q,m=p);f&8?l=h=a.He():f&64?(h=a.He(),l=a.He()):f&128&&(h=a.He(),c=a.He(),k=a.He(),l=a.He());this.log("Read component glyph index %s",g);this.log("Transform: [%s %s %s %s %s %s]",h,c,k,l,e,m);q=a.Ec;if(g=this.io(g)){var t=b.la.length;for(p=0;p<g.qd.length;p++)b.qd.push(g.qd[p]+t);for(p=0;p<g.la.length;p++){t=g.la[p].x;var r=g.la[p].y;
t=h*t+c*r+e;r=k*t+l*r+m;b.la.push({x:t,y:r,Nf:g.la[p].Nf})}}a.seek(q)}b.Og=b.qd.length;f&256&&a.seek(a.getUint16()+a.Ec)};c.prototype.lq=function(a,b,c,e){b=this.io(b);if(null!==b)for(var d=0,g=0,h=0,k=0,l;g<b.la.length;g++){var m=b.la[g];0===d?(a.moveTo(m.x+c,m.y+e),d=1):1===d?m.Nf?a.lineTo(m.x+c,m.y+e):d=2:(l=b.la[g-1],m.Nf?(a.quadraticCurveTo(l.x+c,l.y+e,m.x+c,m.y+e),d=1):a.quadraticCurveTo(l.x+c,l.y+e,(l.x+m.x)/2+c,(l.y+m.y)/2+e));g===b.qd[h]&&(2===d&&(l=m,m=b.la[k],m.Nf?a.quadraticCurveTo(l.x+
c,l.y+e,m.x+c,m.y+e):a.quadraticCurveTo(l.x+c,l.y+e,(l.x+m.x)/2+c,(l.y+m.y)/2+e)),k=g+1,h+=1,d=0)}};c.prototype.transform=function(a,b){a.scale(b/this.yl,-b/this.yl)};c.prototype.rq=function(a,b,c,e,f){a.save();a.translate(c,e);this.transform(a,f);e=c=0;this.Ns();for(f=0;f<b.length;f++){var d=this.Wr(b.charCodeAt(f)),h=this.fr(d),k=this.cs(d);this.log("Metrics for %s code %s index %s: %s %s kern: %s,%s",b.charAt(f),b.charCodeAt(f),d,h.sm,h.Or,k.x,k.y);this.lq(a,d,c+k.x,e+k.y);c+=h.sm}a.restore()};
c.prototype.Wr=function(a){for(var b=0,c=0;c<this.Gj.length&&!(b=this.Gj[c].map(a));c++);return b};c.prototype.Ns=function(){for(var a=0;a<this.Hg.length;a++)this.Hg[a].reset()};c.prototype.cs=function(a){for(var b,c=0,e=0,f=0;f<this.Hg.length;f++)b=this.Hg[f].get(a),c+=b.x,e+=b.y;return{x:c,y:e}};return c}(),He=function(c){function a(){var a=c.call(this)||this;a.fonts={};a.Ng=0;a.Sj=[];a.log=w.create("FontCollection");return a}n(a,c);a.prototype.add=function(a,c){this.Ng+=1;var b=this;return kb({url:a,
mimeType:"text/plain; charset=x-user-defined"}).then(function(d){b.kp(a,c,d.responseText)},function(c){b.Ba(a,c.message)})};a.prototype.Jq=function(a){for(var b in this.fonts){var c=this.fonts[b];if(c.url===a)return c.font}return null};a.prototype.Ba=function(a,c){this.log("Error when fetching "+a+": "+c);--this.Ng;this.$l()};a.prototype.kp=function(a,c,e){this.log("Got font %s; result is %s bytes",a,e.length);for(var b="",d=0;d<e.length;d++)b+=String.fromCharCode(e.charCodeAt(d)&255);e=new Ge(b);
this.log("Loaded '%s'",e.Ge);for(d=0;d<e.Ge.length;d++)this.log("   %s, %s",e.Ge.charAt(d),e.Ge.charCodeAt(d));c=c||e.fontFamily;this.fonts[c]={name:e.Ge,url:a,data:b,font:e};--this.Ng;this.$l()};a.prototype.$l=function(){if(0===this.Ng){this.ua("done");for(var a=0;a<this.Sj.length;a++)this.Sj[a]();this.Sj.length=0}};a.prototype.get=function(a){this.log("Lookup font %s",a);for(var b=0;b<a.length;b++)this.log("   %s, %s",a.charAt(b),a.charCodeAt(b));if(a in this.fonts)return this.fonts[a].font;this.log("Lookup font %s; not found",
a);for(var c in this.fonts)this.log("Searched: '%s'",c)};return a}(Pc);"undefined"!==typeof jQuery&&(jQuery.fn.zwibbler=function(c){void 0===c&&(c={});var a=null;this.each(function(b,d){d.zwibbler&&jQuery(d).empty();a=new W(d,c);d.zwibbler=a});return a},jQuery.fn.zwibblerContext=function(){return this[0].zwibbler});
var Ie=function(){function c(a,b,c,e){this.scope=a;this.element=b;this.name=c;this.value=e}c.prototype.emit=function(a,b){V.ua(this.element,a,b)};c.prototype.listen=function(a,b){V.Lc(this.element,a,b)};c.prototype.watch=function(a,b){V.watch(this.scope,this.element,a,b)};c.prototype.destructor=function(a){V.Ja(this.element,a)};return c}(),Y=function(){function c(){this.qk=[];this.buttons=[];this.Mj={};this.fonts=new He;this.log=w.create("ZWIBBLER");this.WebSocket=WebSocket;this.controllers={};this.Vo=
W}c.prototype.create=function(a,b){"string"===typeof a&&0<a.length&&"."!==a.charAt(0)&&"#"!==a.charAt(0)&&(a="#"+a);var c=pb(a);return c?new W(c,b):(alert("Zwibbler.create: Cannot find an element with id "+a),null)};c.prototype.sp=function(a){for(var b=["name","image","onclick"],c=0;c<b.length;c++)if(!(b[c]in a))return alert("Zwibbler.addButton: missing "+b[c]),!1;this.buttons.push(a);return!0};c.prototype.tp=function(a,b){this.Mj[a]=b};c.prototype.$o=function(a,b){void 0===b&&(b={});return this.rh(a,
b)};c.prototype.rh=function(a,b){function c(){var a=f.offsetWidth,b=f.offsetHeight,c=Bb();z(f).Si({left:c.x+c.width/2-a/2,top:c.y+c.height/2-b/2})}function e(){m&&q.hide()}void 0===b&&(b={});var f=pb(a);if(!f)throw Error("Zwibbler.Dialog: Bad element passed in: "+a);var g=null===f.parentNode;g&&document.body.appendChild(f);"static"===z(f).Le("position")&&(f.style.position="absolute");f.style.display="none";var h=new Gb("transparent");h.insertBefore=f;var k=b.showNear,l=b.showHow,m=!1,q={hide:function(){h.Zd();
f.style.display="none";if(q.onhide)q.onhide();window.removeEventListener("resize",c)},show:function(a,b,d,e){void 0===d&&(d=!1);void 0===e&&(e=!0);var g=0,p=0,t="",r="";if("number"===typeof a&&"number"===typeof b){g=a;p=b;var v=!0}else t=a||k,r=b||l,v=!1;a=wb()+1;f.style.zIndex=a.toString();h.zIndex=a;f.style.display="block";a=f.offsetWidth;b=f.offsetHeight;if(v)r=Bb(),g={left:g,top:p},g.left=Math.min(g.left,r.x+r.width-a-2),g.top=Math.min(g.top,r.y+r.height-b-3),z(f).Si(g);else if(t&&r){if(p=pb(t))g=
f,t=r,r=z(p).dc(),t=t.toLowerCase().split(" "),2!==t.length&&(t=["tl","tl"]),0<=t[0].indexOf("b")&&(r.top+=p.offsetHeight),0<=t[0].indexOf("r")&&(r.left+=p.offsetWidth),0<=t[1].indexOf("b")&&(r.top-=g.offsetHeight),0<=t[1].indexOf("r")&&(r.left-=g.offsetWidth),g.style.position="absolute",p=Bb(),t=g.clientHeight,r.left=Math.min(r.left,p.x+p.width-g.clientWidth),r.top=Math.min(r.top,p.y+p.height-t),z(g).Si(r)}else window.addEventListener("resize",c),c();e&&h.show(q.hide);if(q.onshow)q.onshow();m=d},
destroy:function(){window.removeEventListener("resize",c);f.removeEventListener("click",e);f.removeEventListener("pointerup",e);f.removeEventListener("touchend",e);g&&z(f).remove()},onshow:b.onshow,onhide:b.onhide};f.addEventListener("click",e);return q};c.prototype.cq=function(a,b){return this.cf(a,b)};c.prototype.Cb=function(a,b){V.Cb(a,function(a,c,f,g){b(new Ie(a,c,f,g))})};c.prototype.cf=function(a,b,c){function d(){var a=r.bd(),b=1,d=0,e=0;k&&(a.y=k);q&&(a.height=q-a.y);l&&(a.x=l);m&&(a.width=
m-a.x);g&&h?b=Math.min(g/a.width,h/a.height):g?(b=g/a.width,h=a.height*b):h?(b=h/a.height,g=a.width*b):(g=a.width,h=a.height);a.width*b<g&&(d=g/2-a.width*b/2);a.height*b<h&&(e=h/2-a.height*b/2);d-=a.x*b;e-=a.y*b;p.width=Math.ceil(g);p.height=Math.ceil(h);t.translate(d,e);t.scale(b,b);r.ha(t);f.log("Drawn.");c(p)}var f=this;void 0===b&&(b={});void 0===c&&(c=function(){});var g=b.width||0,h=b.height||0,k=b.top||0,l=b.left||0,m=b.right||0,q=b.bottom||0,p=qb(null),t=p.getContext("2d"),r=hd.sh(a);if(!r)throw Error("Zwibbler.render: Could not open document");
var v=new Ld;r.format(t,v);v.Ka("reformat",function(a){r.Lg(a)});v.yf?v.Ka("done",function(){r.format(t,v);d()}):d();return p};c.prototype.save=function(a,b){return new ib(function(c,e){var d=hd.sh(a);if(d){d.sn("background")||d.setProperty("background","white");var g=qb(null).getContext("2d"),h=new Ld;h.Ka("reformat",function(a){d.Lg(a)});h.Ka("done",function(){try{d.format(g,h);var a=hd.th(d,b,"string");c(a)}catch(l){e(l)}});d.format(g,h)}else e(Error("Failed to open document"))})};c.prototype.ws=
function(a){a=u.td(a);return{r:a.values[0],g:a.values[1],b:a.values[2],a:a.values[3]}};c.prototype.Tr=function(a){return(new u(u.RGBA,[a.r,a.g,a.b,a.a])).toString()};c.prototype.Oq=function(a){var b=document.createElement("a");b.href=a;return b.href};c.prototype.Fp=function(a){return qa(a)};c.prototype.up=function(a,b){var c=this;this.fonts.add(a,b).then(function(){if(!b){var d=c.fonts.Jq(a);d&&(b=d.Ge)}b&&c.Bd('\n@font-face {\n    font-family: "'+b+'";\n    src: url("'+a+'");\n}')},function(){})};
c.prototype.Zo=function(a){return new R(a)};c.prototype.Uo=function(a){var b=new R,c;void 0===c&&(c=null);a=a.match(/[A-Z]|[-+]?[0-9]*\.?[0-9]+([eE][-+]?[0-9]+)?/gi);var e=0,f=0,g,h=0,k=0,l=[];if(a)for(g=0;g<a.length;g++){var m=a[g++];var q=a;for(l.length=0;g<q.length;g++){var p=parseFloat(q[g]);if(isNaN(p)){g--;break}else l.push(p)}if("M"===m){b.moveTo(l[0],l[1]);for(m=2;m<l.length;m+=2)b.lineTo(l[m],l[m+1]);e=l[l.length-2];f=l[l.length-1]}else if("m"===m)for(b.moveTo(l[0]+e,l[1]+f),e=l[0]+e,f=l[1]+
f,m=2;m<l.length;m+=2)b.lineTo(l[m]+e,l[m+1]+f),e=l[m]+e,f=l[m+1]+f;else if("L"===m){for(m=0;m<l.length;m+=2)b.lineTo(l[m],l[m+1]);e=l[l.length-2];f=l[l.length-1]}else if("l"===m)for(m=0;m<l.length;m+=2)b.lineTo(l[m]+e,l[m+1]+f),e=l[m]+e,f=l[m+1]+f;else if("H"===m)for(m=0;m<l.length;m+=1)b.lineTo(l[m],f),e=l[m];else if("h"===m)for(m=0;m<l.length;m+=1)b.lineTo(l[m]+e,f),e=l[m]+e;else if("V"===m)for(m=0;m<l.length;m+=1)b.lineTo(e,l[m]),f=l[m];else if("v"===m)for(m=0;m<l.length;m+=1)b.lineTo(e,l[m]+
f),f=l[m]+f;else if("Q"===m)for(m=0;m<l.length;m+=4)b.quadraticCurveTo(l[m],l[m+1],l[m+2],l[m+3]),h=l[m],k=l[m+1],e=l[m+2],f=l[m+3];else if("C"===m)for(m=0;m<l.length;m+=6)b.bezierCurveTo(l[m],l[m+1],l[m+2],l[m+3],l[m+4],l[m+5]),h=l[m+2],k=l[m+3],e=l[m+4],f=l[m+5];else if("c"===m)for(m=0;m<l.length;m+=6)b.bezierCurveTo(l[m]+e,l[m+1]+f,l[m+2]+e,l[m+3]+f,l[m+4]+e,l[m+5]+f),h=l[m+2]+e,k=l[m+3]+f,e=l[m+4]+e,f=l[m+5]+f;else if("S"===m)for(m=0;m<l.length;m+=4)h=e+e-h,k=f+f-k,b.bezierCurveTo(h,k,l[m],l[m+
1],l[m+2],l[m+3]),h=l[m],k=l[m+1],e=l[m+2],f=l[m+3];else if("s"===m)for(m=0;m<l.length;m+=4)h=e+e-h,k=f+f-k,b.bezierCurveTo(h,k,l[m]+e,l[m+1]+f,l[m+2]+e,l[m+3]+f),h=l[m]+e,k=l[m+1]+f,e=l[m+2]+e,f=l[m+3]+f;else"z"===m||"Z"===m?b.closePath():c?c(m,l):Hb("Unknown command: %s",m)}return b.Sb()};c.prototype.gn=function(a,b){var c=document.createElement("img");c.src=a;c.onload=function(){b(c.naturalWidth,c.naturalHeight,c)}};c.prototype.Ws=function(a,b){return zb(a,b)};c.prototype.zt=function(a){return this.hh(a)};
c.prototype.hh=function(a){var b=pb(a);if(!b)throw Error("Zwibbler.toggleFullScreen: "+a+" not found");a=document;this.An()?document.exitFullscreen?document.exitFullscreen():a.msExitFullscreen?a.msExitFullscreen():a.Yr?a.Yr():a.webkitExitFullscreen&&a.webkitExitFullscreen():b.requestFullscreen?b.requestFullscreen():b.msRequestFullscreen?b.msRequestFullscreen():b.ou?b.mozRequestFullScreen():b.webkitRequestFullscreen&&b.webkitRequestFullscreen(Element.ALLOW_KEYBOARD_INPUT)};c.prototype.An=function(){var a=
document;return a.fullscreenElement||a.mozFullScreenElement||a.webkitFullscreenElement||a.msFullscreenElement?!0:!1};c.prototype.uq=function(){w.tq()};c.prototype.rn=function(a){return Uc.Xo(a)};c.prototype.Bd=function(a){nb(a)};c.prototype.controller=function(a,b){this.controllers[a]=b};c.prototype.Kh=function(a,b){V.Kh(a,b)};c.prototype.lc=function(a){var b=pb(a);if(!b)throw Error("Zwibbler.attach: Cannot find element from "+a);return Je(b,!0)};return c}();
document.addEventListener("dragstart",function(c){var a=c.target;if("IMG"===a.tagName){var b=a.getAttribute("zwibbler-src");a=a.getAttribute("zwibbler-width");b&&c.dataTransfer.setData("zwibbler-src",b);a&&c.dataTransfer.setData("zwibbler-width",a)}});var O=new Y;O.instances=O.qk;Y.prototype.addButton=Y.prototype.sp;Y.prototype.addCustomNode=Y.prototype.tp;Y.prototype.Popup=Y.prototype.$o;Y.prototype.Dialog=Y.prototype.rh;Y.prototype.createPreview=Y.prototype.cq;Y.prototype.directive=Y.prototype.Cb;
Y.prototype.render=Y.prototype.cf;Y.prototype.save=Y.prototype.save;Y.prototype.parseColour=Y.prototype.ws;Y.prototype.makeColour=Y.prototype.Tr;Y.prototype.getAbsoluteUrl=Y.prototype.Oq;Y.prototype.base64Encode=Y.prototype.Fp;Y.prototype.addFont=Y.prototype.up;Y.prototype.PathCommands=Y.prototype.Zo;Y.prototype.CommandsFromSvgPath=Y.prototype.Uo;Y.prototype.getImageSize=Y.prototype.gn;Y.prototype.setColourOpacity=Y.prototype.Ws;Y.prototype.toggleFullScreen=Y.prototype.zt;
Y.prototype.toggleFullscreen=Y.prototype.hh;Y.prototype.isFullScreen=Y.prototype.An;Y.prototype.enableConsoleLogging=Y.prototype.uq;Y.prototype.hasConfig=Y.prototype.rn;Y.prototype.injectStyle=Y.prototype.Bd;Y.prototype.controller=Y.prototype.controller;Y.prototype.component=Y.prototype.Kh;Y.prototype.attach=Y.prototype.lc;Y.prototype.Context=Y.prototype.Vo;window.Zwibbler=O;var Ke=w.create("EVALJS"),Le=function(){function c(a,b){this.Uc=a;this.key=b}c.prototype.toString=function(){return"LValue("+this.key+")"};return c}(),Me=function(){function c(a,b,c){this.id=a;this.wi=b;c&&(this.$d=c)}c.prototype.$d=function(){return this};c.prototype.Fn=function(a){return a};c.prototype.toString=function(){return"Token(id='"+this.id+"', lbp="+this.wi+")"};return c}(),Ne=function(){function c(a,b){return a[b]}function a(a,b,c){a[b]=c}function b(a){if(a instanceof Le){if(a.Uc===r)return v(r,
a.key);if(a.Uc)return a.Uc[a.key]}else return a}function d(a,b){void 0===b&&(b=0);var c=I[a];c?c.wi=Math.max(c.wi,b):c=I[a]=new Me(a,b);return c}function e(a,b){var c=d(a);c.$d=function(){return b};return c}function f(a){return new Me("(literal)",0,function(){return a})}function g(a){var b=new Me("(name)",0,function(){return new Le(r,a)});b.toString=function(){return"Token(name: "+a+")"};return b}function h(a,c,d){k(a,c,function(a){return d(b(a),b(t(c-1)))})}function k(a,b,c){d(a,b).Fn=c}function l(a,
c,e){d(a,c).$d=function(){return e(b(t(c)))}}function m(a,b,c){d(a,b).$d=c}function q(){return Da<Qa.length?Qa[Da++]:I["(end)"]}function p(a){if(a&&G.id!==a)throw Error("Error: expected "+a+" but got "+G.id);return G=q()}function t(a){var b=G;G=q();for(var c=b.$d();a<G.wi;)b=G,G=q(),c=b.Fn(c);return c}var r={},v=c,x=a,I={},y=0,J,P;e("true",!0);e("false",!1);e("null",null);e("undefined",void 0);d("(end)");(function(a,c,d){k(a,c,function(a){return d(b(a),b(t(c)))})})(",",J=++y,function(a,b){return b});
k("=",P=++y,function(a){var c=t(P);if(!(a instanceof Le))throw Error("Error: lhs of = must be assignable");c=b(c);if(a.Uc===r)x(r,a.key,c);else if(a.Uc instanceof Object)a.Uc[a.key]=c;else throw Error(a.Uc+"["+a.key+"] cannot be assigned to.");return c});h("&&",++y,function(a,b){return a&&b});h("||",++y,function(a,b){return a||b});h("|",++y,function(a,b){return a|b});h("^",++y,function(a,b){return a^b});h("&",++y,function(a,b){return a&b});h("===",++y,function(a,b){return a===b});h("!==",y,function(a,
b){return a!==b});h("==",y,function(a,b){return a==b});h("!=",y,function(a,b){return a!=b});h(">",++y,function(a,b){return a>b});h(">=",y,function(a,b){return a>=b});h("<",y,function(a,b){return a<b});h("<=",y,function(a,b){return a<=b});h("in",y,function(a,b){return a in b});h("<<",++y,function(a,b){return a<<b});h(">>",y,function(a,b){return a>>b});h(">>>",y,function(a,b){return a>>>b});h("+",++y,function(a,b){return a+b});h("-",y,function(a,b){return a-b});h("*",++y,function(a,b){return a*b});
h("/",y,function(a,b){return a/b});h("%",y,function(a,b){return a%b});l("!",++y,function(a){return!a});l("~",y,function(a){return~a});l("+",y,function(a){return+a});l("-",y,function(a){return-a});l("typeof",y,function(a){return typeof a});k(".",++y,function(a){var c=G;if("(name)"!==c.id)throw Error("Error: '.' expects a name, not "+G.id);if(!(a instanceof Le))throw Error("Error: '.' must be preceded by lvalue");a.Uc=b(a);a.key=c.$d().key;p();return a});m("(",++y,function(){var a=t(0);p(")");return a});
d(")");k("(",++y,function(a){var c=[];if(")"!==G.id)for(;;){c.push(b(t(J+1)));if(","!==G.id)break;p(",")}p(")");var d=null;a instanceof Le&&(d=a.Uc);a=b(a);if("function"!==typeof a)throw Error("Tried to call a non-function; type was "+typeof a);return a.apply(d,c)});d(",");k("[",y,function(a){var c=t(0);if(!(a instanceof Le))throw Error("Error: '[]' must be preceded by lvalue");p("]");a.Uc=b(a);a.key=b(c);return a});d("]");m("{",++y,function(){for(var a={};"}"!==G.id;){if("(literal)"===G.id)var c=
G.$d();else if("(name)"===G.id)c=G.$d().key;else throw Error("Bad {}; expecting name or string constant");p();p(":");a[c]=b(t(J+1));if(","!==G.id)break;G=p(",")}p("}");return a});m("[",y,function(){for(var a=[];"]"!==G.id;){a.push(b(t(J+1)));if(","!==G.id)break;G=p(",")}p("]");return a});d(",");d(":");d("}");var la=/(\d+(\.\d+)?)|(===|!==|==|!=|\+=|-=|&&|\|\||<=|>=|<<|>>>|>>|&&|\|\||[{}\(\)\[\]\+\-\.\*\/=!,\?&\|:%~<>])|([a-zA-Z\$_][\$_a-zA-Z0-9]*)|("([^"\\]|\\.)*"|'([^'\\]|\\.)*')/g,Qa=[],Da=0,G;
return{parse:function(a){for(var b=[],c=0;c<a.length;){for(;" "===a.charAt(c);)c++;la.lastIndex=c;var d=la.exec(a);if(d&&d.index===c)if(c+=d[0].length,d[1])b.push(f(parseFloat(d[1])));else if(d[3]&&d[3]in I)b.push(I[d[3]]);else if(d[4])switch(d[4]){case "true":case "false":case "null":case "in":case "typeof":case "undefined":b.push(I[d[4]]);break;default:b.push(g(d[4]))}else{if(d[5]){d=d[5].substr(1,d[5].length-2);for(var e="",h=!1,k=0;k<d.length;k++){var l=d[k];if(h){switch(l){case "n":l="\n";break;
case "r":l="\r";break;case "t":l="\t"}e+=l;h=!1}else"\\"===l?h=!0:e+=l}b.push(f(e))}}else throw Error("Parse error: Expected stuff in "+a+" near: "+a.substr(c));}b.push(I["(end)"]);return b},evaluate:function(d,e,f,g){Da=0;Qa=e;r=d;v=f||function(a,b){return a[b]};x=g||function(a,b,c){a[b]=c};G=q();d=b(t(0));r={};v=c;x=a;return d}}}(),Oe=Ne.parse,Pe=Ne.evaluate;function Qe(c,a,b){try{return Pe(c,Oe(a),b)}catch(d){console.log("When evaluating:",a),console.log(d)}}
function Re(c,a){if(c===a)return!0;if(!(c instanceof Object&&a instanceof Object)||c.constructor!==a.constructor)return!1;for(var b in c)if(c.hasOwnProperty(b)&&(!a.hasOwnProperty(b)||c[b]!==a[b]&&("object"!==typeof c[b]||!Re(c[b],a[b]))))return!1;for(b in a)if(a.hasOwnProperty(b)&&!c.hasOwnProperty(b))return!1;return!0}
var Se=function(){function c(){this.Md={};this.ac=0;this.zj=[];this.timeout=0}c.prototype.watch=function(a,b,c){a={scope:a,parsed:Oe(b),Tn:void 0,Pn:c};b in this.Md?this.Md[b].push(a):this.Md[b]=[a];this.ac+=1};c.prototype.unwatch=function(a,b){if(a in this.Md){for(var c=this.Md[a],e=0;e<c.length;e++)if(c[e].Pn===b){c.splice(e,1);break}0===c.length&&delete this.Md[a]}};c.prototype.check=function(a){var b=this;a&&this.zj.push(a);0===this.timeout&&(this.timeout=setTimeout(function(){b.timeout=0;for(var a=
(new Date).getTime(),c=0,f=0,g=!0,h=0;10>h&&g;h++){g=!1;b.ac=0;for(var k in b.Md)for(var l=null,m=void 0,q=0;q<b.Md[k].length;q++){var p=b.Md[k][q];try{p.scope!==l?(m=Pe(p.scope,p.parsed),l=p.scope,c+=1):f+=1,Re(p.Tn,m)||(p.Tn=m,p.Pn(m),g=!0)}catch(t){console.log("Error when evaluating %s: ",k,t),console.log("Context was: %o",p.scope)}}b.ac&&(g=!0)}Ke("Evauated %s/%s watchers in %sms",c,c+f,(new Date).getTime()-a);a=0;for(c=b.zj;a<c.length;a++)(0,c[a])();b.zj.length=0},0))};return c}();var Te=w.create("DRAGSORT");
function Ue(c){var a=c.parent.gp;c.parent.gp=!0;for(var b=c.parent.children,d=0;d<b.length;d++)null!==b[d].getAttribute(c.Eh)&&b[d].setAttribute("draggable","true");if(!a){z(c.parent).addEventListener("dragstart dragover dragend drop",function(a){Te(a.type);for(var b=a.target;b.parentNode!==c.parent&&b.parentNode;)b=b.parentNode;if(1===b.nodeType&&b.getAttribute("draggable")&&"false"!==b.getAttribute("draggable").toLowerCase()&&b.parentNode===c.parent)if("dragstart"===a.type){for(var d=c.parent.children,
g=0;g<d.length;g++)console.log(c.Eh,d[g].getAttribute(c.Eh),d[g]),null!==d[g].getAttribute(c.Eh)&&d[g].setAttribute("sort-index",g.toString());a.dataTransfer.setData("text",b.id);a.dataTransfer.dropEffect="move";f=e=b;a.stopPropagation()}else"dragover"===a.type&&f&&e.parentNode===b.parentNode?(f.classList.remove(c.Kk),f=b,f.classList.add(c.Kk),a.preventDefault()):"dragend"===a.type&&f&&e.parentNode===b.parentNode?(f.classList.remove(c.Kk),b=parseInt(f.getAttribute("sort-index")||"0"),d=parseInt(e.getAttribute("sort-index")||
"0"),c.ns(d,b),a.preventDefault(),a.stopPropagation()):"drop"===a.type&&(a.preventDefault(),a.stopPropagation())});var e,f}};var Z=w.create("Zeact");function Ve(c){var a=document.createElement("div");a.innerHTML=c;c=[];for(a=a.firstChild;a;)a instanceof HTMLElement&&c.push(a),a=a.nextSibling;return c}
var V=new (function(){function c(){this.El=new Se;this.Uh={};this.Fm={}}c.prototype.Cb=function(a,b,c){void 0===c&&(c=2);this.Uh[a]={name:a,link:b,Eo:c}};c.prototype.Kh=function(a,b){this.Fm[a.toUpperCase()]=b;"string"===typeof b.template&&(b.template=b.template.trim())};c.prototype.nf=function(a,b){var c=this;this.Cb(a,function(a,d,g,h){c.watch(a,d,h,function(c){b(d,c,a)})})};c.prototype.watch=function(a,b,c,e){var d=this;this.El.watch(a,c,e);this.Ja(b,function(){d.El.unwatch(c,e)})};c.prototype.Lc=
function(a,b,c){a.addEventListener(b,c);this.Ja(a,function(){a.removeEventListener(b,c)});a.zwibblerListeners||(a.zwibblerListeners={});a.zwibblerListeners[b]||(a.zwibblerListeners[b]=[]);a.zwibblerListeners[b].push(c)};c.prototype.ua=function(a,b,c){a.zwibblerListeners&&b in a.zwibblerListeners&&setTimeout(function(){for(var d=0,f=a.zwibblerListeners[b];d<f.length;d++)f[d].call(a,c)},0)};c.prototype.Ja=function(a,b){a.gj?a.gj.push(b):a.gj=[b]};c.prototype.detach=function(a){for(var b=a.firstChild;b;)this.detach(b),
b=b.nextSibling;if(a.gj){b=0;for(var c=a.gj;b<c.length;b++)(0,c[b])();delete a.zwibblerWatchers}a.zwibblerListeners&&delete a.zwibblerListeners};c.prototype.digest=function(a){this.El.check(a)};c.prototype.Cq=function(a,b){var c=/^z-([a-z0-9@\-]+)/.exec(a.toLowerCase());if(c&&(c=c[1],c in this.Uh&&this.Uh[c].Eo===b))return this.Uh[c]};c.prototype.tm=function(a,b,c,e){void 0===e&&(e=b);for(var d=0;d<e.attributes.length&&b.parentNode;d++){var g=e.attributes[d].name,h=e.attributes[d].value,k=this.Cq(g,
c);if(k&&k.Eo===c&&(Z("Link directive for %s=%s",g,h),(g=k.link(a,b,g,h))&&g!==b))return{Ga:g,Pk:!0}}return{Ga:b,Pk:null===b.parentNode}};c.prototype.yp=function(a,b){var c=this,e=this.Fm[b.tagName];if(!e)return null;Z("Attaching component %s",b.tagName);var f=e.template;if(f instanceof HTMLElement)var g=f.cloneNode(!0);else if("string"===typeof f)if("<"===f[0]){Z("Using elementsFromString %s to instantiate component",f);var h=Ve(f);if(0===h.length)throw Error("Component "+b.tagName+": Could not interpret as HTML: "+
f);if(1<h.length)throw Error("Component "+b.tagName+": Should render as a single element, but got "+h.length);g=h[0]}else{Z("Using querySelector to instantiate component");g=document.querySelector(f);if(null===g)throw Error("Component "+b.tagName+': querySelector("'+f+'") returned null');g=g.cloneNode(!0)}else throw Error("Component "+b.tagName+": Could not interpret template "+f);b.parentNode.replaceChild(g,b);var k=this,l={$emit:function(a,b){k.ua(g,a,b)}};l.$parent=a;f=e.properties;var m={};f&&
f.forEach(function(d){m[d]=1;var e=b.getAttribute(d);e&&(Z("Bind prop %s to %s",d,e),c.watch(a,g,e,function(a){l[d]=a}))});e.style&&O.Bd(e.style);for(f=0;f<b.attributes.length;f++){h=b.attributes[f].name;var q=b.attributes[f].value;m[h]||0===h.indexOf("z-")||g.setAttribute(h,q)}for(f=1;2>=f;f++)if(h=this.tm(a,g,f,b),h.Pk)return h.Ga;this.digest(function(){if(e.controller)try{e.controller(l,new Ie(l,g,"",""))}catch(p){console.log(p),console.log("When running controller for %s",b.tagName)}c.lc(l,g)});
return g};c.prototype.lc=function(a,b){if(1===b.nodeType){if(b.fp)return b;b.fp=!0;for(var c=0;2>=c;c++){var e=this.tm(a,b,c);if(e.Pk)return e.Ga;if(0===c&&(e=this.yp(a,b)))return e}for(c=b.firstChild;c;)e=c.nextSibling,this.lc(a,c),c=e}return b};return c}());function We(c,a,b,d,e){b&&(c["this"]=b);d&&(c.$event=d);Qe(c,a,e)}V.Cb("init",function(c,a,b,d){We(c,d,a)});
V.Cb("click",function(c,a,b,d){function e(b){Z("z-click=["+d+"] received "+b.type);We(c,d,a,b,f);V.digest();b.preventDefault()}function f(a,b){a instanceof W&&0<=b.indexOf("Tool")&&(Z("Called %s",b),h=!0);return a[b]}b="ontouchstart"in window;var g="onpointerdown"in window;b?V.Lc(a,"touchend",e):g&&V.Lc(a,"pointerup",e);!g&&b&&V.Lc(a,"mouseup",e);var h;V.Lc(a,"keydown",function(b){13===b.keyCode&&(h=!1,e(b),h&&c.focus(!0,a))})});V.nf("text",function(c,a){c.textContent=a});
function Xe(c,a){var b=c.type?c.type.toLowerCase():"";if("zwibblerValue"in c)var d="zwibblerValue";else d="value",a=""+a;"radio"===b||"checkbox"===b?c.checked=c[d]===a:c[d]=a}function Ye(c){var a=c.type?c.type.toLowerCase():"";if("checkbox"===a)return c.checked;"radio"===a&&(a=c.getAttribute("name"))&&(a=document.querySelector('input[name="'+a+"]:checked"))&&(c=a);return"zwibblerValue"in c?c.zwibblerValue:c.value}
V.Cb("model",function(c,a,b,d){V.Lc(a,"input",function(){var b=Ye(a);Z("input -> model: New value for %s: %s",d,b);Qe(c,d+"="+JSON.stringify(b));V.digest()});var e;V.watch(c,a,d,function(b){Z("model(%s) -> input : new value is %s",d,b);e=b;Xe(a,e)});if(b=a.getAttribute("z-value"))V.watch(c,a,b,function(b){a.zwibblerValue=b;Xe(a,e)}),V.Ja(a,function(){delete a.zwibblerValue})});
V.Cb("has",function(c,a,b,d){V.watch(c,a,'"'+d+'" in summary.types || "'+d+'" in summary.properties',function(b){a.style.display=b?"block":"none"})});function Ze(c,a){var b=c.indexOf(a);return-1===b?"":c.substr(b+a.length+1)}V.Cb("on",function(c,a,b,d){var e=Ze(b,"on");""!==e&&(Z("Attaching native event %s => %s",e,d),V.Lc(a,e,function(b){Z("Got %s, execute %s",e,d);We(c,d,a,b);V.digest();b&&b.preventDefault&&b.preventDefault()}))});
V.Cb("bind",function(c,a,b,d){var e=Ze(b,"bind");""!==e&&V.watch(c,a,d,function(b){a.setAttribute(e,b)})},1);
V.Cb("for",function(c,a,b,d){b=d.indexOf(" in ");if(-1!==b){var e=d.substr(0,b),f=d.substr(b+4),g=[];Z("z-for '%s' in '%s'",e,f);var h=a.parentNode,k=a.nextSibling;a.parentNode.removeChild(a);V.watch(c,h,f,function(b){if("number"===typeof b){for(var d=[],l=0;l<b;l++)d.push(l);b=d}for(l=0;l<g.length;l++)d=g[l],d.parentNode&&d.parentNode.removeChild(d),V.detach(d);g.length=0;if("object"===typeof b&&"length"in b)for(l=0;l<b.length;l++){d=document.createComment("z-for "+f+"["+l+"] = "+b[l]);h.insertBefore(d,
k);g.push(d);d=Object.create(c);d.$parent=c;d[e]=b[l];var p=a.cloneNode(!0);p.removeAttribute("z-for");h.insertBefore(p,k);d=V.lc(d,p);g.push(d)}})}},0);V.Cb("if",function(c,a,b,d){var e=document.createComment(b+" "+d),f=a.parentElement,g=null;f.replaceChild(e,a);V.watch(c,f,d,function(d){d&&!g?(g=a.cloneNode(!0),g.removeAttribute(b),f.replaceChild(g,e),V.lc(c,g)):!d&&g&&(V.detach(g),f.replaceChild(e,g),g=null)})},0);V.nf("class",function(c,a){for(var b in a)z(c).sl(b,a[b])});
V.nf("style",function(c,a){for(var b in a)c.style[b]=a[b]});V.nf("selected",function(c,a){z(c).sl("selected",a)});V.nf("disabled",function(c,a){a?c.setAttribute("disabled","true"):c.removeAttribute("disabled")});V.nf("checked",function(c,a){c.checked=a?!0:!1});
V.Cb("property",function(c,a,b,d){a.getAttribute("type");b='summary.properties["'+d+'"]';var e=a.getAttribute("z-value"),f=null!==a.getAttribute("z-colour");V.watch(c,a,b,function(b){"value"in a&&(a.value=b);null!==e&&z(a).sl("selected",""+b===e);f&&(a.style.backgroundColor=b)});"BUTTON"===a.tagName?V.Lc(a,"click",function(){var b=a.getAttribute("z-value")||"";c.vc(c.Ac(),d,b)}):V.Lc(a,"change",function(){var b=Ye(a);void 0!==b&&c.vc(c.Ac(),d,b)})});
V.Cb("popup",function(c,a,b,d){var e=O.rh(a);a.getAttribute("z-position");var f=null!==a.getAttribute("z-click-dismiss");c.ee||(c.ee={});V.Ja(a.parentNode,function(){e.destroy()});e.onshow=function(){var b=a.querySelector("[z-focus]");b&&"focus"in b&&b.focus()};c.ee[d]={show:function(a,b,c){e.show(b,c,f)},hide:function(){e.hide()}};c.resize&&c.resize()});V.Cb("show-popup",function(c,a,b,d){V.Lc(a,"click",function(a){c.ee&&d in c.ee&&c.ee[d].show(this,a.pageX,a.pageY)})});
V.Cb("colour",function(c,a){V.Lc(a,"click",function(b){c.Co(a.getAttribute("z-property")||"",b.pageX,b.pageY)})});
V.Cb("page",function(c,a,b,d){function e(){var a=c.kn(g),b=Math.min(h/a.width,k/a.height);1<b&&(b=1);f.width=a.width*b|0;f.height=a.height*b|0;l.setTransform(b,0,0,b,0,0);l.fillStyle="white";l.fillRect(0,0,a.width,a.height);c.ha(l,{page:g})}if(!a.au){var f=document.createElement("canvas"),g=Qe(c,d)||0,h=parseInt(a.getAttribute("z-width")||"1000000"),k=parseInt(a.getAttribute("z-height")||"1000000");f.style.backgroundColor="white";var l=f.getContext("2d");a.parentNode&&(a.parentNode.insertBefore(f,
a),a.parentNode.removeChild(a));e();c.Ka("document-changed",e);c.Ka("resource-loaded",e);V.Ja(f,function(){c.removeEventListener("document-changed",e);c.removeEventListener("resource-loaded",e)});for(b=0;b<a.attributes.length;b++)f.setAttribute(a.attributes[b].name,a.attributes[b].value);f.au=!0;return V.lc(c,f)}});
V.Cb("sort",function(c,a,b,d){O.Bd(".zwibbler-sort-highlight { outline: 3px solid orange }");Ue({parent:a,Eh:"z-sortable",Kk:"zwibbler-sort-highlight",ns:function(a,b){c.$from=a;c.$to=b;Qe(c,d);V.digest()}})});function $e(){Z("Document loaded.");Array.prototype.forEach.call(document.querySelectorAll("zwibbler,[zwibbler]"),function(c){Je(c)})}function af(c,a,b){z(c).matches(a)&&b(c);Array.prototype.forEach.call(c.querySelectorAll(a),b)}
function Je(c,a){void 0===a&&(a=!1);"ZWIBBLER"===c.tagName&&O.Bd("zwibbler {display: block}");if(a||null===c.getAttribute("z-no-auto-init")){af(c,"[z-component]",function(a){var b=a.getAttribute("z-component"),c=a.getAttribute("z-controller"),d=(a.getAttribute("z-properties")||"").split(/[ ,]+/);if(b){var e=null;if(c)if(c in O.controllers)e=O.controllers[c];else if("function"===typeof window.zcontroller)e=window.zcontroller;else throw Error("While processing component: "+b+" could not find controller function "+
c);O.Kh(b,{template:a,properties:d,controller:e});a.parentNode.removeChild(a)}});for(var b,d={},e=0;e<c.attributes.length;e++){var f=c.attributes[e];O.rn(f.name)&&(d[f.name]=f.value)}af(c,"z-canvas,[z-canvas]",function(a){b=O.create(a,d)});var g=b;b?b.lc(b,c):(g={},V.lc(g,c));g.$digest=function(){V.digest()};g.hidePopup=function(a){g.ee&&a in g.ee&&g.ee[a].hide()};e=c.getAttribute("z-controller")||"";e in O.controllers?(Z("Running controller: %s",e),O.controllers[e](g)):"function"===typeof window[e]&&
(Z("Running controller: %s",e),window[e](g));V.digest();return g}}document.addEventListener("DOMContentLoaded",function(){$e()});var bf=w.create("ColourPanel");V.nf("clear-glyph",function(c,a,b){bf("Drawing colour panel, width=%s tag=%s",JSON.stringify(a),c.tagName);"CANVAS"===c.tagName&&(c.width=a.width,c.height=a.width,"clear"===a.style?ze(c.getContext("2d"),0,0,a.width):Ae(c.getContext("2d"),0,0,a.width),b.resize())});
var Be={style:"\n.zwibbler-colour-panel {\n    overflow:hidden;\n    border-top: 1px solid black;\n    white-space: nowrap;\n    font-size: 0;\n}\n\n.zwibbler-colour-panel div { \n    display: inline-block;\n}",ri:'<div class="zwibbler-colour-panel" z-style="{height:ColourPanelWidth()+\'px\'}">\n    <canvas z-clear-glyph="{width: ColourPanelWidth(), style:\'clear\'}"\n        z-on:click="setColour(\'rgba(0,0,0,0.0)\', true)"\n        z-on:contextmenu="setColour(\'rgba(0,0,0,0.0)\', false)">\n    </canvas>\n    <canvas z-clear-glyph="{width: ColourPanelWidth(), style:\'transparent\'}"\n        z-on:click="setOpacity(0.5, true)"\n        z-on:contextmenu="setOpacity(0.5, false)">\n    </canvas>\n    <div z-for="colour in ColourPanelColours"\n        z-style="{width: ColourPanelWidth()+\'px\', height: ColourPanelWidth()+\'px\', background: colour}"\n        z-on:click="setColour(colour, true)"\n        z-on:contextmenu="setColour(colour, false)">\n    </div>\n</div>\n',
controller:function(c){var a=c.bq();a.shift();a.shift();c.ColourPanelColours=a;c.ColourPanelWidth=function(){return c.Ie("useTouch")?40:20}}};}).call(window);
//# sourceMappingURL=zwibbler-demo.js.map
